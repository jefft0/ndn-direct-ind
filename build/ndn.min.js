/*
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
  MIT
 <a href="https://github.com/bitcoinjs/bitcoinjs-lib/blob/master/LICENSE">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
 <a href="http://kjur.github.io/jsrsasign/license/">MIT License</a>
*/
(function(fa,t){"object"===typeof exports?module.exports.printStackTrace=t():"function"===typeof define&&define.amd?define(t):fa.printStackTrace=t()})(this,function(){function fa(t){t=t||{guess:!0};var E=t.e||null,N=!!t.guess,P=t.mode||null;t=new fa.implementation;E=t.run(E,P);return N?t.guessAnonymousFunctions(E):E}fa.implementation=function(){};fa.implementation.prototype={run:function(t,E){t=t||this.createException();E=E||this.mode(t);return"other"===E?this.other(arguments.callee):this[E](t)},
createException:function(){try{this.undef()}catch(t){return t}},mode:function(t){return"undefined"!==typeof window&&-1<window.navigator.userAgent.indexOf("PhantomJS")?"phantomjs":t.arguments&&t.stack?"chrome":t.stack&&t.sourceURL?"safari":t.stack&&t.number?"ie":t.stack&&t.fileName?"firefox":t.message&&t["opera#sourceloc"]?!t.stacktrace||-1<t.message.indexOf("\n")&&t.message.split("\n").length>t.stacktrace.split("\n").length?"opera9":"opera10a":t.message&&t.stack&&t.stacktrace?0>t.stacktrace.indexOf("called from line")?
"opera10b":"opera11":t.stack&&!t.fileName?"chrome":"other"},instrumentFunction:function(t,E,N){t=t||window;var P=t[E];t[E]=function(){N.call(this,fa().slice(4));return t[E]._instrumented.apply(this,arguments)};t[E]._instrumented=P},deinstrumentFunction:function(t,E){t[E].constructor===Function&&t[E]._instrumented&&t[E]._instrumented.constructor===Function&&(t[E]=t[E]._instrumented)},chrome:function(t){return(t.stack+"\n").replace(/^[\s\S]+?\s+at\s+/," at ").replace(/^\s+(at eval )?at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,
"{anonymous}() ($1)$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}() ($1)").replace(/^(.+) \((.+)\)$/gm,"$1@$2").split("\n").slice(0,-1)},safari:function(t){return t.stack.replace(/\[native code\]\n/m,"").replace(/^(?=\w+Error\:).*$\n/m,"").replace(/^@/gm,"{anonymous}()@").split("\n")},ie:function(t){return t.stack.replace(/^\s*at\s+(.*)$/gm,"$1").replace(/^Anonymous function\s+/gm,"{anonymous}() ").replace(/^(.+)\s+\((.+)\)$/gm,"$1@$2").split("\n").slice(1)},firefox:function(t){return t.stack.replace(/(?:\n@:0)?\s+$/m,
"").replace(/^(?:\((\S*)\))?@/gm,"{anonymous}($1)@").split("\n")},opera11:function(t){var E=/^.*line (\d+), column (\d+)(?: in (.+))? in (\S+):$/;t=t.stacktrace.split("\n");for(var N=[],P=0,Q=t.length;P<Q;P+=2){var G=E.exec(t[P]);if(G){var v=G[4]+":"+G[1]+":"+G[2],G=G[3]||"global code",G=G.replace(/<anonymous function: (\S+)>/,"$1").replace(/<anonymous function>/,"{anonymous}");N.push(G+"@"+v+" -- "+t[P+1].replace(/^\s+/,""))}}return N},opera10b:function(t){var E=/^(.*)@(.+):(\d+)$/;t=t.stacktrace.split("\n");
for(var N=[],P=0,Q=t.length;P<Q;P++){var G=E.exec(t[P]);G&&N.push((G[1]?G[1]+"()":"global code")+"@"+G[2]+":"+G[3])}return N},opera10a:function(t){var E=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i;t=t.stacktrace.split("\n");for(var N=[],P=0,Q=t.length;P<Q;P+=2){var G=E.exec(t[P]);G&&N.push((G[3]||"{anonymous}")+"()@"+G[2]+":"+G[1]+" -- "+t[P+1].replace(/^\s+/,""))}return N},opera9:function(t){var E=/Line (\d+).*script (?:in )?(\S+)/i;t=t.message.split("\n");for(var N=[],P=2,Q=t.length;P<
Q;P+=2){var G=E.exec(t[P]);G&&N.push("{anonymous}()@"+G[2]+":"+G[1]+" -- "+t[P+1].replace(/^\s+/,""))}return N},phantomjs:function(t){var E=/(\S+) \((\S+)\)/i;t=t.stack.split("\n");for(var N=[],P=1,Q=t.length;P<Q;P++){t[P]=t[P].replace(/^\s+at\s+/gm,"");var G=E.exec(t[P]);G?N.push(G[1]+"()@"+G[2]):N.push("{anonymous}()@"+t[P])}return N},other:function(t){for(var E=/function(?:\s+([\w$]+))?\s*\(/,N=[],P,Q,G=Array.prototype.slice;t&&10>N.length;){P=E.test(t.toString())?RegExp.$1||"{anonymous}":"{anonymous}";
try{Q=G.call(t.arguments||[])}catch(v){Q=["Cannot access arguments: "+v]}N[N.length]=P+"("+this.stringifyArguments(Q)+")";try{t=t.caller}catch(fa){N[N.length]="Cannot access caller: "+fa;break}}return N},stringifyArguments:function(t){for(var E=[],N=Array.prototype.slice,P=0;P<t.length;++P){var Q=t[P];void 0===Q?E[P]="undefined":null===Q?E[P]="null":Q.constructor&&(E[P]=Q.constructor===Array?3>Q.length?"["+this.stringifyArguments(Q)+"]":"["+this.stringifyArguments(N.call(Q,0,1))+"..."+this.stringifyArguments(N.call(Q,
-1))+"]":Q.constructor===Object?"#object":Q.constructor===Function?"#function":Q.constructor===String?'"'+Q+'"':Q.constructor===Number?Q:"?")}return E.join(",")},sourceCache:{},ajax:function(t){var E=this.createXMLHTTPObject();if(E)try{return E.open("GET",t,!1),E.send(null),E.responseText}catch(N){}return""},createXMLHTTPObject:function(){for(var t,E=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},
function(){return new ActiveXObject("Microsoft.XMLHTTP")}],N=0;N<E.length;N++)try{return t=E[N](),this.createXMLHTTPObject=E[N],t}catch(P){}},isSameDomain:function(t){return"undefined"!==typeof location&&-1!==t.indexOf(location.hostname)},getSource:function(t){t in this.sourceCache||(this.sourceCache[t]=this.ajax(t).split("\n"));return this.sourceCache[t]},guessAnonymousFunctions:function(t){for(var E=0;E<t.length;++E){var N=/^(.*?)(?::(\d+))(?::(\d+))?(?: -- .+)?$/,P=t[E],Q=/\{anonymous\}\(.*\)@(.*)/.exec(P);
if(Q){var G=N.exec(Q[1]);G&&(N=G[1],Q=G[2],G=G[3]||0,N&&this.isSameDomain(N)&&Q&&(N=this.guessAnonymousFunction(N,Q,G),t[E]=P.replace("{anonymous}",N)))}}return t},guessAnonymousFunction:function(t,E,N){var P;try{P=this.findFunctionName(this.getSource(t),E)}catch(Q){P="getSource failed with url: "+t+", exception: "+Q.toString()}return P},findFunctionName:function(t,E){for(var N=/function\s+([^(]*?)\s*\(([^)]*)\)/,P=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*function\b/,Q=/['"]?([$_A-Za-z][$_A-Za-z0-9]*)['"]?\s*[:=]\s*(?:eval|new Function)\b/,
G="",v,fa=Math.min(E,20),Uc,mb=0;mb<fa;++mb)if(v=t[E-mb-1],Uc=v.indexOf("//"),0<=Uc&&(v=v.substr(0,Uc)),v)if(G=v+G,(v=P.exec(G))&&v[1]||(v=N.exec(G))&&v[1]||(v=Q.exec(G))&&v[1])return v[1];return"(?)"}};return fa});
(function(fa){function t(e){var k="",h,c=0,l,n;for(h=0;h<e.length&&e.charAt(h)!=ed;++h)n=Bb.indexOf(e.charAt(h)),0>n||(0==c?(k+=Cb.charAt(n>>2),l=n&3,c=1):1==c?(k+=Cb.charAt(l<<2|n>>4),l=n&15,c=2):2==c?(k+=Cb.charAt(l),k+=Cb.charAt(n>>2),l=n&3,c=3):(k+=Cb.charAt(l<<2|n>>4),k+=Cb.charAt(n&15),c=0));1==c&&(k+=Cb.charAt(l<<2));return k}function E(){this.j=this.i=0;this.S=[]}function N(){var e=(new Date).getTime();ib[wa++]^=e&255;ib[wa++]^=e>>8&255;ib[wa++]^=e>>16&255;ib[wa++]^=e>>24&255;wa>=fd&&(wa-=
fd)}function P(){}function Q(e,k){return new u(e,k)}function G(e,k,h){for(var c="",l=0;c.length<k;)c+=h(String.fromCharCode.apply(String,e.concat([(l&4278190080)>>24,(l&16711680)>>16,(l&65280)>>8,l&255]))),l+=1;return c}function v(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function od(e,k,h){for(var c="",l=0;c.length<k;)c+=h(e+String.fromCharCode.apply(String,[(l&4278190080)>>24,(l&16711680)>>16,(l&65280)>>8,l&255])),l+=1;return c}function Uc(e){var k=[],h=D.getStartPosOfV_AtObj(e,
0),c=D.getPosOfNextSibling_AtObj(e,h),l=D.getPosOfNextSibling_AtObj(e,c),n=D.getPosOfNextSibling_AtObj(e,l),a=D.getPosOfNextSibling_AtObj(e,n),b=D.getPosOfNextSibling_AtObj(e,a),d=D.getPosOfNextSibling_AtObj(e,b),g=D.getPosOfNextSibling_AtObj(e,d),f=D.getPosOfNextSibling_AtObj(e,g);k.push(h,c,l,n,a,b,d,g,f);h=D.getHexOfV_AtObj(e,k[0]);c=D.getHexOfV_AtObj(e,k[1]);l=D.getHexOfV_AtObj(e,k[2]);n=D.getHexOfV_AtObj(e,k[3]);a=D.getHexOfV_AtObj(e,k[4]);b=D.getHexOfV_AtObj(e,k[5]);d=D.getHexOfV_AtObj(e,k[6]);
g=D.getHexOfV_AtObj(e,k[7]);e=D.getHexOfV_AtObj(e,k[8]);k=[];k.push(h,c,l,n,a,b,d,g,e);return k}function mb(e,k){for(var h="",c=k/4-e.length,l=0;l<c;l++)h+="0";return h+e}function pd(e,k){var h=I.crypto.Util.hashString(e,k);return this.signWithMessageHash(h,k)}function Rd(e){return pd.call(this,e,"sha1")}function Sd(e){return pd.call(this,e,"sha256")}function Td(e,k,h){for(var c="",l=0;c.length<k;)c+=hextorstr(h(rstrtohex(e+String.fromCharCode.apply(String,[(l&4278190080)>>24,(l&16711680)>>16,(l&
65280)>>8,l&255])))),l+=1;return c}function Ud(e,k,h){e=rstrtohex(e);e=I.crypto.Util.hashHex(e,k);void 0===h&&(h=-1);return this.signWithMessageHashPSS(e,k,h)}function Ad(e){for(var k in I.crypto.Util.DIGESTINFOHEAD){var h=I.crypto.Util.DIGESTINFOHEAD[k],c=h.length;if(e.substring(0,c)==h)return[k,e.substring(c)]}return[]}function Wc(e,k){var h=Q(e,16);var c=this.n.toString(16),l=this.e.toString(16),n=new v;n.setPublic(c,l);h=n.doPublic(h).toString(16).replace(/^1f+00/,"");c=Ad(h);0==c.length?h=!1:
(h=c[1],c=I.crypto.Util.hashString(k,c[0]),h=h==c);return h}function gd(e,k){k=k.replace(qd,"");k=k.replace(/[ \n]+/g,"");var h=Q(k,16);if(h.bitLength()>this.n.bitLength())return 0;var h=this.doPublic(h).toString(16).replace(/^1f+00/,""),c=Ad(h);if(0==c.length)return!1;h=c[1];c=I.crypto.Util.hashString(e,c[0]);return h==c}function Bd(e,k,h,c){e=rstrtohex(e);e=I.crypto.Util.hashHex(e,h);void 0===c&&(c=-1);return this.verifyWithMessageHashPSS(e,k,h,c)}function Z(){this.hex=this.subjectPublicKeyRSA_hE=
this.subjectPublicKeyRSA_hN=this.subjectPublicKeyRSA=null;this.getSerialNumberHex=function(){return D.getDecendantHexVByNthList(this.hex,0,[0,1])};this.getIssuerHex=function(){return D.getDecendantHexTLVByNthList(this.hex,0,[0,3])};this.getIssuerString=function(){return Z.hex2dn(D.getDecendantHexTLVByNthList(this.hex,0,[0,3]))};this.getSubjectHex=function(){return D.getDecendantHexTLVByNthList(this.hex,0,[0,5])};this.getSubjectString=function(){return Z.hex2dn(D.getDecendantHexTLVByNthList(this.hex,
0,[0,5]))};this.getNotBefore=function(){var e=D.getDecendantHexVByNthList(this.hex,0,[0,4,0]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.getNotAfter=function(){var e=D.getDecendantHexVByNthList(this.hex,0,[0,4,1]),e=e.replace(/(..)/g,"%$1");return e=decodeURIComponent(e)};this.readCertPEM=function(e){e=Z.pemToHex(e);var k=Z.getPublicKeyHexArrayFromCertHex(e),h=new v;h.setPublic(k[0],k[1]);this.subjectPublicKeyRSA=h;this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=
k[1];this.hex=e};this.readCertPEMWithoutRSAInit=function(e){e=Z.pemToHex(e);var k=Z.getPublicKeyHexArrayFromCertHex(e);this.subjectPublicKeyRSA.setPublic(k[0],k[1]);this.subjectPublicKeyRSA_hN=k[0];this.subjectPublicKeyRSA_hE=k[1];this.hex=e}}function ca(){return new u(null)}function qb(e,k,h,c,l,n){for(;0<=--n;){var a=k*this[e++]+h[c]+l;l=Math.floor(a/67108864);h[c++]=a&67108863}return l}function Vd(e,k,h,c,l,n){var a=k&32767;for(k>>=15;0<=--n;){var b=this[e]&32767,d=this[e++]>>15,g=k*b+d*a,b=a*
b+((g&32767)<<15)+h[c]+(l&1073741823);l=(b>>>30)+(g>>>15)+k*d+(l>>>30);h[c++]=b&1073741823}return l}function Cd(e,k,h,c,l,n){var a=k&16383;for(k>>=14;0<=--n;){var b=this[e]&16383,d=this[e++]>>14,g=k*b+d*a,b=a*b+((g&16383)<<14)+h[c]+l;l=(b>>28)+(g>>14)+k*d;h[c++]=b&268435455}return l}function Dc(e,k){var h=Wd[e.charCodeAt(k)];return null==h?-1:h}function nc(e){var k=ca();k.fromInt(e);return k}function hd(e){var k=1,h;0!=(h=e>>>16)&&(e=h,k+=16);0!=(h=e>>8)&&(e=h,k+=8);0!=(h=e>>4)&&(e=h,k+=4);0!=(h=
e>>2)&&(e=h,k+=2);0!=e>>1&&(k+=1);return k}function bc(e){this.m=e}function xa(e){this.m=e;this.mp=e.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<e.DB-15)-1;this.mt2=2*e.t}function ge(e,k){return e&k}function rd(e,k){return e|k}function sd(e,k){return e^k}function Ec(e,k){return e&~k}function Fc(){}function id(e){return e}function oc(e){this.r2=ca();this.q3=ca();u.ONE.dlShiftTo(2*e.t,this.r2);this.mu=this.r2.divide(e);this.m=e}function f(e,k,h){if(!(this instanceof f))return new f(e,
k,h);var c=typeof e;if("base64"===k&&"string"===c)for(e=f.stringtrim(e);0!==e.length%4;)e+="=";var l;if("number"===c)l=f.coerce(e);else if("string"===c)l=f.byteLength(e,k);else if("object"===c)l=f.coerce(e.length);else throw Error("First argument needs to be a number, array or string.");var n;f._useTypedArrays?n=f._augment(new Uint8Array(l)):(n=this,n.length=l,n._isBuffer=!0);if(f._useTypedArrays&&"number"===typeof e.byteLength)n._set(e);else if(f.isArrayish(e))if(f.isBuffer(e))for(k=0;k<l;k++)n[k]=
e.readUInt8(k);else for(k=0;k<l;k++)n[k]=(e[k]%256+256)%256;else if("string"===c)n.write(e,0,k);else if("number"===c&&!f._useTypedArrays&&!h)for(k=0;k<l;k++)n[k]=0;return n}function M(e){if(e)return e.__proto__=M.prototype,e}function ma(e){if(e)return e.__proto__=ma.prototype,e}function rb(e){if(e)return e.__proto__=rb.prototype,e}function L(e){if(e)return e.__proto__=L.prototype,e}function cc(e){L.call(this,e)}function w(e){L.call(this,e)}function Ib(e){if(e)return e.__proto__=Ib.prototype,e}var a=
a||{},s=a;s.printStackTrace=fa.printStackTrace;var Mb=function(){var e=!1;if("undefined"!==typeof crypto&&crypto&&crypto.subtle){var k={name:"RSASSA-PKCS1-v1_5",modulusLength:2048,hash:{name:"SHA-256"},publicExponent:new Uint8Array([1,0,1])},h;crypto.subtle.generateKey(k,!0,["sign","verify"]).then(function(c){h=c;return crypto.subtle.sign(k,c.privateKey,new Uint8Array([1,2,3,4,5]))}).then(function(c){return crypto.subtle.verify(k,h.publicKey,c,new Uint8Array([1,2,3,4,5]))}).then(function(c){return crypto.subtle.exportKey("pkcs8",
h.privateKey)}).then(function(c){return crypto.subtle.importKey("pkcs8",c,k,!0,["sign"])}).then(function(c){return crypto.subtle.exportKey("spki",h.publicKey)}).then(function(c){return crypto.subtle.importKey("spki",c,k,!0,["verify"])}).then(function(c){c=new Uint8Array([1,2,3,4,5]);return crypto.subtle.digest({name:"SHA-256"},c.buffer)}).then(function(c){e=!0},function(c){console.log("DetectSubtleCrypto encountered error, not using crypto.subtle: ",c)})}return function(){return e}}();s.UseSubtleCrypto=
Mb;var Db=Db||function(e,k){var h={},c=h.lib={},l=c.Base=function(){function c(){}return{extend:function(e){c.prototype=this;var h=new c;e&&h.mixIn(e);h.hasOwnProperty("init")||(h.init=function(){h.$super.init.apply(this,arguments)});h.init.prototype=h;h.$super=this;return h},create:function(){var c=this.extend();c.init.apply(c,arguments);return c},init:function(){},mixIn:function(c){for(var e in c)c.hasOwnProperty(e)&&(this[e]=c[e]);c.hasOwnProperty("toString")&&(this.toString=c.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),
n=c.WordArray=l.extend({init:function(c,e){c=this.words=c||[];this.sigBytes=e!=k?e:4*c.length},toString:function(c){return(c||b).stringify(this)},concat:function(c){var e=this.words,h=c.words,k=this.sigBytes;c=c.sigBytes;this.clamp();if(k%4)for(var l=0;l<c;l++)e[k+l>>>2]|=(h[l>>>2]>>>24-l%4*8&255)<<24-(k+l)%4*8;else for(l=0;l<c;l+=4)e[k+l>>>2]=h[l>>>2];this.sigBytes+=c;return this},clamp:function(){var c=this.words,h=this.sigBytes;c[h>>>2]&=4294967295<<32-h%4*8;c.length=e.ceil(h/4)},clone:function(){var c=
l.clone.call(this);c.words=this.words.slice(0);return c},random:function(c){for(var h=[],k=0;k<c;k+=4)h.push(4294967296*e.random()|0);return new n.init(h,c)}}),a=h.enc={},b=a.Hex={stringify:function(c){var e=c.words;c=c.sigBytes;for(var h=[],k=0;k<c;k++){var l=e[k>>>2]>>>24-k%4*8&255;h.push((l>>>4).toString(16));h.push((l&15).toString(16))}return h.join("")},parse:function(c){for(var e=c.length,h=[],k=0;k<e;k+=2)h[k>>>3]|=parseInt(c.substr(k,2),16)<<24-k%8*4;return new n.init(h,e/2)}},d=a.Latin1=
{stringify:function(c){var e=c.words;c=c.sigBytes;for(var h=[],k=0;k<c;k++)h.push(String.fromCharCode(e[k>>>2]>>>24-k%4*8&255));return h.join("")},parse:function(c){for(var e=c.length,h=[],k=0;k<e;k++)h[k>>>2]|=(c.charCodeAt(k)&255)<<24-k%4*8;return new n.init(h,e)}},g=a.Utf8={stringify:function(c){try{return decodeURIComponent(escape(d.stringify(c)))}catch(e){throw Error("Malformed UTF-8 data");}},parse:function(c){return d.parse(unescape(encodeURIComponent(c)))}},f=c.BufferedBlockAlgorithm=l.extend({reset:function(){this._data=
new n.init;this._nDataBytes=0},_append:function(c){"string"==typeof c&&(c=g.parse(c));this._data.concat(c);this._nDataBytes+=c.sigBytes},_process:function(c){var h=this._data,k=h.words,l=h.sigBytes,a=this.blockSize,Vc=l/(4*a),Vc=c?e.ceil(Vc):e.max((Vc|0)-this._minBufferSize,0);c=Vc*a;l=e.min(4*c,l);if(c){for(var b=0;b<c;b+=a)this._doProcessBlock(k,b);b=k.splice(0,c);h.sigBytes-=l}return new n.init(b,l)},clone:function(){var c=l.clone.call(this);c._data=this._data.clone();return c},_minBufferSize:0});
c.Hasher=f.extend({cfg:l.extend(),init:function(c){this.cfg=this.cfg.extend(c);this.reset()},reset:function(){f.reset.call(this);this._doReset()},update:function(c){this._append(c);this._process();return this},finalize:function(c){c&&this._append(c);return this._doFinalize()},blockSize:16,_createHelper:function(c){return function(e,h){return(new c.init(h)).finalize(e)}},_createHmacHelper:function(c){return function(e,h){return(new m.HMAC.init(c,h)).finalize(e)}}});var m=h.algo={};return h}(Math);
s.CryptoJS=Db;var jd=a.CryptoJS;(function(e){var k=jd.lib,h=k.WordArray,c=k.Hasher,k=jd.algo,l=[],n=[];(function(){function c(h){for(var k=e.sqrt(h),l=2;l<=k;l++)if(!(h%l))return!1;return!0}function h(c){return 4294967296*(c-(c|0))|0}for(var k=2,a=0;64>a;)c(k)&&(8>a&&(l[a]=h(e.pow(k,0.5))),n[a]=h(e.pow(k,1/3)),a++),k++})();var a=[],k=k.SHA256=c.extend({_doReset:function(){this._hash=new h.init(l.slice(0))},_doProcessBlock:function(c,e){for(var h=this._hash.words,k=h[0],l=h[1],b=h[2],d=h[3],g=h[4],
f=h[5],m=h[6],q=h[7],r=0;64>r;r++){if(16>r)a[r]=c[e+r]|0;else{var p=a[r-15],Va=a[r-2];a[r]=((p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3)+a[r-7]+((Va<<15|Va>>>17)^(Va<<13|Va>>>19)^Va>>>10)+a[r-16]}p=q+((g<<26|g>>>6)^(g<<21|g>>>11)^(g<<7|g>>>25))+(g&f^~g&m)+n[r]+a[r];Va=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&l^k&b^l&b);q=m;m=f;f=g;g=d+p|0;d=b;b=l;l=k;k=p+Va|0}h[0]=h[0]+k|0;h[1]=h[1]+l|0;h[2]=h[2]+b|0;h[3]=h[3]+d|0;h[4]=h[4]+g|0;h[5]=h[5]+f|0;h[6]=h[6]+m|0;h[7]=h[7]+q|0},_doFinalize:function(){var c=
this._data,h=c.words,k=8*this._nDataBytes,l=8*c.sigBytes;h[l>>>5]|=128<<24-l%32;h[(l+64>>>9<<4)+14]=e.floor(k/4294967296);h[(l+64>>>9<<4)+15]=k;c.sigBytes=4*h.length;this._process();return this._hash},clone:function(){var e=c.clone.call(this);e._hash=this._hash.clone();return e}});jd.SHA256=c._createHelper(k);jd.HmacSHA256=c._createHmacHelper(k)})(Math);s.CryptoJS=jd;(function(){var e=Db,k=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,c){e=this._hasher=new e.init;"string"==typeof c&&(c=
k.parse(c));var l=e.blockSize,n=4*l;c.sigBytes>n&&(c=e.finalize(c));c.clamp();for(var a=this._oKey=c.clone(),b=this._iKey=c.clone(),d=a.words,g=b.words,f=0;f<l;f++)d[f]^=1549556828,g[f]^=909522486;a.sigBytes=b.sigBytes=n;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var c=this._hasher;e=c.finalize(e);c.reset();return c.finalize(this._oKey.clone().concat(e))}})})();var Bb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
ed="=";s.b64tohex=t;s.b64toBA=function(e){e=t(e);var k,h=[];for(k=0;2*k<e.length;++k)h[k]=parseInt(e.substring(2*k,2*k+2),16);return h};s.hex2b64=function(e){var k,h,c="";for(k=0;k+3<=e.length;k+=3)h=parseInt(e.substring(k,k+3),16),c+=Bb.charAt(h>>6)+Bb.charAt(h&63);k+1==e.length?(h=parseInt(e.substring(k,k+1),16),c+=Bb.charAt(h<<2)):k+2==e.length&&(h=parseInt(e.substring(k,k+2),16),c+=Bb.charAt(h>>2)+Bb.charAt((h&3)<<4));if(ed)for(;0<(c.length&3);)c+=ed;return c};E.prototype.init=function(e){var k,
h,c;for(k=0;256>k;++k)this.S[k]=k;for(k=h=0;256>k;++k)h=h+this.S[k]+e[k%e.length]&255,c=this.S[k],this.S[k]=this.S[h],this.S[h]=c;this.j=this.i=0};E.prototype.next=function(){var e;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;e=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=e;return this.S[e+this.S[this.i]&255]};var fd=256,dc,ib,wa;if(null==ib){ib=[];wa=0;var Gc;if("Netscape"==navigator.appName&&"5">navigator.appVersion&&window.crypto){var pc=window.crypto.random(32);for(Gc=0;Gc<
pc.length;++Gc)ib[wa++]=pc.charCodeAt(Gc)&255}for(;wa<fd;)Gc=Math.floor(65536*Math.random()),ib[wa++]=Gc>>>8,ib[wa++]=Gc&255;wa=0;N()}P.prototype.nextBytes=function(e){var k;for(k=0;k<e.length;++k){var h=e,c=k,l;if(null==dc){N();dc=new E;dc.init(ib);for(wa=0;wa<ib.length;++wa)ib[wa]=0;wa=0}l=dc.next();h[c]=l}};var Nb=a,sb=20;v.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)};v.prototype.setPublic=function(e,k){this.isPublic=!0;"string"!==typeof e?(this.n=e,this.e=k):null!=e&&null!=
k&&0<e.length&&0<k.length?(this.n=Q(e,16),this.e=parseInt(k,16)):alert("Invalid RSA public key")};v.prototype.encrypt=function(e){var k;k=this.n.bitLength()+7>>3;if(k<e.length+11)alert("Message too long for RSA"),k=null;else{for(var h=[],c=e.length-1;0<=c&&0<k;){var l=e.charCodeAt(c--);128>l?h[--k]=l:127<l&&2048>l?(h[--k]=l&63|128,h[--k]=l>>6|192):(h[--k]=l&63|128,h[--k]=l>>6&63|128,h[--k]=l>>12|224)}h[--k]=0;e=new P;for(c=[];2<k;){for(c[0]=0;0==c[0];)e.nextBytes(c);h[--k]=c[0]}h[--k]=2;h[--k]=0;
k=new u(h)}if(null==k)return null;k=this.doPublic(k);if(null==k)return null;k=k.toString(16);return 0==(k.length&1)?k:"0"+k};v.prototype.encryptOAEP=function(e,k){var h,c=this.n.bitLength()+7>>3;if(e.length+2*sb+2>c)throw"Message too long for RSA";var l="";for(h=0;h<c-e.length-2*sb-2;h+=1)l+="\x00";var n=rstr_sha1("")+l+"\u0001"+e,c=Array(sb);(new P).nextBytes(c);var a=G(c,n.length,k||rstr_sha1),l=[];for(h=0;h<n.length;h+=1)l[h]=n.charCodeAt(h)^a.charCodeAt(h);n=G(l,c.length,rstr_sha1);a=[0];for(h=
0;h<c.length;h+=1)a[h+1]=c[h]^n.charCodeAt(h);h=new u(a.concat(l));if(null==h)return null;h=this.doPublic(h);if(null==h)return null;h=h.toString(16);return 0==(h.length&1)?h:"0"+h};v.prototype.type="RSA";s.RSAKey=v;var Nb=a,u=Nb.BigInteger?Nb.BigInteger:Nb,v=a.RSAKey,sb=20;v.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);var k=e.mod(this.p).modPow(this.dmp1,this.p);for(e=e.mod(this.q).modPow(this.dmq1,this.q);0>k.compareTo(e);)k=k.add(this.p);return k.subtract(e).multiply(this.coeff).mod(this.p).multiply(this.q).add(e)};
v.prototype.setPrivate=function(e,k,h){this.isPrivate=!0;"string"!==typeof e?(this.n=e,this.e=k,this.d=h):null!=e&&null!=k&&0<e.length&&0<k.length?(this.n=Q(e,16),this.e=parseInt(k,16),this.d=Q(h,16)):alert("Invalid RSA private key")};v.prototype.setPrivateEx=function(e,k,h,c,l,n,a,b){this.isPrivate=!0;if(null==e)throw"RSASetPrivateEx N == null";if(null==k)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==k.length)throw"RSASetPrivateEx E.length == 0";null!=
e&&null!=k&&0<e.length&&0<k.length?(this.n=Q(e,16),this.e=parseInt(k,16),this.d=Q(h,16),this.p=Q(c,16),this.q=Q(l,16),this.dmp1=Q(n,16),this.dmq1=Q(a,16),this.coeff=Q(b,16)):alert("Invalid RSA private key in RSASetPrivateEx")};v.prototype.generate=function(e,k){var h=new P,c=e>>1;this.e=parseInt(k,16);for(var l=new u(k,16);;){for(;this.p=new u(e-c,1,h),0!=this.p.subtract(u.ONE).gcd(l).compareTo(u.ONE)||!this.p.isProbablePrime(10););for(;this.q=new u(c,1,h),0!=this.q.subtract(u.ONE).gcd(l).compareTo(u.ONE)||
!this.q.isProbablePrime(10););if(0>=this.p.compareTo(this.q)){var n=this.p;this.p=this.q;this.q=n}var n=this.p.subtract(u.ONE),a=this.q.subtract(u.ONE),b=n.multiply(a);if(0==b.gcd(l).compareTo(u.ONE)){this.n=this.p.multiply(this.q);this.d=l.modInverse(b);this.dmp1=this.d.mod(n);this.dmq1=this.d.mod(a);this.coeff=this.q.modInverse(this.p);break}}this.isPrivate=!0};v.prototype.decrypt=function(e){e=Q(e,16);e=this.doPrivate(e);if(null==e)return null;a:{var k=this.n.bitLength()+7>>3;e=e.toByteArray();
for(var h=0;h<e.length&&0==e[h];)++h;if(e.length-h!=k-1||2!=e[h])e=null;else{for(++h;0!=e[h];)if(++h>=e.length){e=null;break a}for(k="";++h<e.length;){var c=e[h]&255;128>c?k+=String.fromCharCode(c):191<c&&224>c?(k+=String.fromCharCode((c&31)<<6|e[h+1]&63),++h):(k+=String.fromCharCode((c&15)<<12|(e[h+1]&63)<<6|e[h+2]&63),h+=2)}e=k}}return e};v.prototype.decryptOAEP=function(e,k){var h=Q(e,16),h=this.doPrivate(h);if(null==h)return null;for(var c=h,l=this.n.bitLength()+7>>3,c=c.toByteArray(),h=0;h<c.length;h+=
1)c[h]&=255;for(;c.length<l;)c.unshift(0);c=String.fromCharCode.apply(String,c);if(c.length<2*sb+2)throw"Cipher too short";for(var n=c.substr(1,sb),l=c.substr(sb+1),a=od(l,sb,k||rstr_sha1),b=[],h=0;h<n.length;h+=1)b[h]=n.charCodeAt(h)^a.charCodeAt(h);n=od(String.fromCharCode.apply(String,b),c.length-sb,rstr_sha1);c=[];for(h=0;h<l.length;h+=1)c[h]=l.charCodeAt(h)^n.charCodeAt(h);c=String.fromCharCode.apply(String,c);if(c.substr(0,sb)!==rstr_sha1(""))throw"Hash mismatch";c=c.substr(sb);h=c.indexOf("\u0001");
if((-1!=h?c.substr(0,h).lastIndexOf("\x00"):-1)+1!=h)throw"Malformed data";return c.substr(h+1)};s.RSAKey=v;Db=a.CryptoJS;Nb=a;"undefined"!=typeof I&&I||(I={});"undefined"!=typeof I.crypto&&I.crypto||(I.crypto={});I.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",
md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"};this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",
SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",
SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"};this.CRYPTOJSMESSAGEDIGESTNAME={md5:"CryptoJS.algo.MD5",sha1:"CryptoJS.algo.SHA1",sha224:"CryptoJS.algo.SHA224",sha256:"CryptoJS.algo.SHA256",sha384:"CryptoJS.algo.SHA384",sha512:"CryptoJS.algo.SHA512",ripemd160:"CryptoJS.algo.RIPEMD160"};this.getDigestInfoHex=function(e,k){if("undefined"==typeof this.DIGESTINFOHEAD[k])throw"alg not supported in Util.DIGESTINFOHEAD: "+
k;return this.DIGESTINFOHEAD[k]+e};this.getPaddedDigestInfoHex=function(e,k,h){var c=this.getDigestInfoHex(e,k);e=h/4;if(c.length+22>e)throw"key is too short for SigAlg: keylen="+h+","+k;k="00"+c;h="";e=e-4-k.length;for(c=0;c<e;c+=2)h+="ff";return"0001"+h+k};this.hashString=function(e,k){return(new I.crypto.MessageDigest({alg:k})).digestString(e)};this.hashHex=function(e,k){return(new I.crypto.MessageDigest({alg:k})).digestHex(e)};this.sha1=function(e){return(new I.crypto.MessageDigest({alg:"sha1",
prov:"cryptojs"})).digestString(e)};this.sha256=function(e){return(new I.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestString(e)};this.sha256Hex=function(e){return(new I.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"})).digestHex(e)};this.sha512=function(e){return(new I.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestString(e)};this.sha512Hex=function(e){return(new I.crypto.MessageDigest({alg:"sha512",prov:"cryptojs"})).digestHex(e)};this.md5=function(e){return(new I.crypto.MessageDigest({alg:"md5",
prov:"cryptojs"})).digestString(e)};this.ripemd160=function(e){return(new I.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"})).digestString(e)};this.getCryptoJSMDByName=function(e){}};I.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,h){null!=e&&void 0===h&&(h=I.crypto.Util.DEFAULTPROVIDER[e]);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==h){try{this.md=eval(I.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e]).create()}catch(c){throw"setAlgAndProvider hash alg set fail alg="+
e+"/"+c;}this.updateString=function(c){this.md.update(c)};this.updateHex=function(c){c=Db.enc.Hex.parse(c);this.md.update(c)};this.digest=function(){return this.md.finalize().toString(Db.enc.Hex)};this.digestString=function(c){this.updateString(c);return this.digest()};this.digestHex=function(c){this.updateHex(c);return this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==h){try{this.md=new sjcl.hash.sha256}catch(l){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+l;}this.updateString=function(c){this.md.update(c)};
this.updateHex=function(c){c=sjcl.codec.hex.toBits(c);this.md.update(c)};this.digest=function(){var c=this.md.finalize();return sjcl.codec.hex.fromBits(c)};this.digestString=function(c){this.updateString(c);return this.digest()};this.digestHex=function(c){this.updateHex(c);return this.digest()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+
this.algName+"/"+this.provName;};this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName;};this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName;};void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=I.crypto.Util.DEFAULTPROVIDER[this.algName]),
this.setAlgAndProvider(this.algName,this.provName))};I.crypto.Mac=function(e){this.setAlgAndProvider=function(e,h){e=e.toLowerCase();null==e&&(e="hmacsha1");e=e.toLowerCase();if("hmac"!=e.substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===h&&(h=I.crypto.Util.DEFAULTPROVIDER[e]);this.algProv=e+"/"+h;var c=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(c)&&"cryptojs"==h){try{var l=eval(I.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[c]);this.mac=Db.algo.HMAC.create(l,
this.pass)}catch(n){throw"setAlgAndProvider hash alg set fail hashAlg="+c+"/"+n;}this.updateString=function(c){this.mac.update(c)};this.updateHex=function(c){c=Db.enc.Hex.parse(c);this.mac.update(c)};this.doFinal=function(){return this.mac.finalize().toString(Db.enc.Hex)};this.doFinalString=function(c){this.updateString(c);return this.doFinal()};this.doFinalHex=function(c){this.updateHex(c);return this.doFinal()}}};this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+
this.algProv;};this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv;};this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv;};this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv;};this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv;};this.setPassword=function(e){if("string"==typeof e){var h=e;1!=e.length%2&&e.match(/^[0-9A-Fa-f]+$/)||
(h=rstrtohex(e))}else{if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;h=null;if(void 0!==e.hex){if(0!=e.hex.length%2||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;h=e.hex}void 0!==e.utf8&&(h=utf8tohex(e.utf8));void 0!==e.rstr&&(h=rstrtohex(e.rstr));void 0!==e.b64&&(h=t(e.b64));void 0!==e.b64u&&(h=b64utohex(e.b64u));if(null==h)throw"KJUR.crypto.Mac unsupported password type: "+e;}this.pass=Db.enc.Hex.parse(h)};void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),
void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=I.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))};I.crypto.Signature=function(e){var k=null;this._setAlgNames=function(){this.algName.match(/^(.+)with(.+)$/)&&(this.mdAlgName=RegExp.$1.toLowerCase(),this.pubkeyAlgName=RegExp.$2.toLowerCase())};this._zeroPaddingOfSignature=function(c,e){for(var h="",k=e/4-c.length,a=0;a<k;a++)h+="0";return h+c};this.setAlgAndProvider=function(c,e){this._setAlgNames();
if("cryptojs/jsrsa"!=e)throw"provider not supported: "+e;if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new I.crypto.MessageDigest({alg:this.mdAlgName})}catch(h){throw"setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+h;}this.init=function(c,e){var h=null;try{h=void 0===e?KEYUTIL.getKey(c):KEYUTIL.getKey(c,e)}catch(k){throw"init failed:"+k;}if(!0===h.isPrivate)this.prvKey=h,this.state="SIGN";else if(!0===h.isPublic)this.pubKey=h,this.state=
"VERIFY";else throw"init failed.:"+h;};this.initSign=function(c){"string"==typeof c.ecprvhex&&"string"==typeof c.eccurvename?(this.ecprvhex=c.ecprvhex,this.eccurvename=c.eccurvename):this.prvKey=c;this.state="SIGN"};this.initVerifyByPublicKey=function(c){"string"==typeof c.ecpubhex&&"string"==typeof c.eccurvename?(this.ecpubhex=c.ecpubhex,this.eccurvename=c.eccurvename):c instanceof I.crypto.ECDSA?this.pubKey=c:c instanceof v&&(this.pubKey=c);this.state="VERIFY"};this.initVerifyByCertificatePEM=function(c){var e=
new Z;e.readCertPEM(c);this.pubKey=e.subjectPublicKeyRSA;this.state="VERIFY"};this.updateString=function(c){this.md.updateString(c)};this.updateHex=function(c){this.md.updateHex(c)};this.sign=function(){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecprvhex&&"undefined"!=typeof this.eccurvename)this.hSign=(new I.crypto.ECDSA({curve:this.eccurvename})).signHex(this.sHashHex,this.ecprvhex);else if(this.prvKey instanceof v&&"rsaandmgf1"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,
this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof v&&"rsa"==this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof I.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof I.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;return this.hSign};this.signString=function(c){this.updateString(c);
return this.sign()};this.signHex=function(c){this.updateHex(c);return this.sign()};this.verify=function(c){this.sHashHex=this.md.digest();if("undefined"!=typeof this.ecpubhex&&"undefined"!=typeof this.eccurvename)return(new I.crypto.ECDSA({curve:this.eccurvename})).verifyHex(this.sHashHex,c,this.ecpubhex);if(this.pubKey instanceof v&&"rsaandmgf1"==this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,c,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof v&&"rsa"==this.pubkeyAlgName||
this.pubKey instanceof I.crypto.ECDSA||this.pubKey instanceof I.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,c);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName;}}};this.init=function(c,e){throw"init(key, pass) not supported for this alg:prov="+this.algProvName;};this.initVerifyByPublicKey=function(c){throw"initVerifyByPublicKey(rsaPubKeyy) not supported for this alg:prov="+this.algProvName;};this.initVerifyByCertificatePEM=function(c){throw"initVerifyByCertificatePEM(certPEM) not supported for this alg:prov="+
this.algProvName;};this.initSign=function(c){throw"initSign(prvKey) not supported for this alg:prov="+this.algProvName;};this.updateString=function(c){throw"updateString(str) not supported for this alg:prov="+this.algProvName;};this.updateHex=function(c){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName;};this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName;};this.signString=function(c){throw"digestString(str) not supported for this alg:prov="+
this.algProvName;};this.signHex=function(c){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName;};this.verify=function(c){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName;};this.initParams=e;if(void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,this.provName=void 0===e.prov?I.crypto.Util.DEFAULTPROVIDER[this.algName]:e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&
(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{k=new v,k.readPrivateKeyFromPEMString(e.prvkeypem),this.initSign(k)}catch(h){throw"fatal error to load pem private key: "+h;}}};I.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1",
"2b81040023":"secp521r1","2b81040022":"secp384r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}};s.KJUR=I;var D=a.ASN1HEX,t=a.b64tohex,v=a.RSAKey;v.prototype.readPrivateKeyFromPEMString=function(e){e=e.replace("-----BEGIN RSA PRIVATE KEY-----","");e=e.replace("-----END RSA PRIVATE KEY-----","");e=e.replace(/[ \n]+/g,"");e=t(e);e=Uc(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};v.prototype.readPrivateKeyFromASN1HexString=
function(e){e=Uc(e);this.setPrivateEx(e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])};s.RSAKey=v;var Nb=a,u=Nb.BigInteger?Nb.BigInteger:Nb,v=a.RSAKey,qd=RegExp("");qd.compile("[^0-9a-f]","gi");v.prototype.signWithMessageHash=function(e,k){var h=I.crypto.Util.getPaddedDigestInfoHex(e,k,this.n.bitLength()),h=Q(h,16),h=this.doPrivate(h).toString(16);return mb(h,this.n.bitLength())};v.prototype.signString=pd;v.prototype.signStringWithSHA1=Rd;v.prototype.signStringWithSHA256=Sd;v.prototype.sign=pd;v.prototype.signWithSHA1=
Rd;v.prototype.signWithSHA256=Sd;v.prototype.signWithMessageHashPSS=function(e,k,h){var c=hextorstr(e);e=c.length;var l=this.n.bitLength()-1,n=Math.ceil(l/8),a=function(c){return I.crypto.Util.hashHex(c,k)};if(-1===h||void 0===h)h=e;else if(-2===h)h=n-e-2;else if(-2>h)throw"invalid salt length";if(n<e+h+2)throw"data too long";var b="";0<h&&(b=Array(h),(new P).nextBytes(b),b=String.fromCharCode.apply(String,b));for(var d=hextorstr(a(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+c+b))),g=[],c=0;c<n-
h-e-2;c+=1)g[c]=0;h=String.fromCharCode.apply(String,g)+"\u0001"+b;a=Td(d,h.length,a);b=[];for(c=0;c<h.length;c+=1)b[c]=h.charCodeAt(c)^a.charCodeAt(c);b[0]&=~(65280>>8*n-l&255);for(c=0;c<e;c++)b.push(d.charCodeAt(c));b.push(188);return mb(this.doPrivate(new u(b)).toString(16),this.n.bitLength())};v.prototype.signStringPSS=Ud;v.prototype.signPSS=Ud;v.SALT_LEN_HLEN=-1;v.SALT_LEN_MAX=-2;v.prototype.verifyWithMessageHash=function(e,k){k=k.replace(qd,"");k=k.replace(/[ \n]+/g,"");var h=Q(k,16);if(h.bitLength()>
this.n.bitLength())return 0;h=this.doPublic(h).toString(16).replace(/^1f+00/,"");h=Ad(h);return 0==h.length?!1:h[1]==e};v.prototype.verifyString=gd;v.prototype.verifyHexSignatureForMessage=Wc;v.prototype.verify=gd;v.prototype.verifyHexSignatureForByteArrayMessage=Wc;v.prototype.verifyWithMessageHashPSS=function(e,k,h,c){var l=new u(k,16);if(l.bitLength()>this.n.bitLength())return!1;k=function(c){return I.crypto.Util.hashHex(c,h)};e=hextorstr(e);var n=e.length,a=this.n.bitLength()-1,b=Math.ceil(a/
8);if(-1===c||void 0===c)c=n;else if(-2===c)c=b-n-2;else if(-2>c)throw"invalid salt length";if(b<n+c+2)throw"data too long";for(var d=this.doPublic(l).toByteArray(),l=0;l<d.length;l+=1)d[l]&=255;for(;d.length<b;)d.unshift(0);if(188!==d[b-1])throw"encoded message does not end in 0xbc";var d=String.fromCharCode.apply(String,d),g=d.substr(0,b-n-1),d=d.substr(g.length,n),f=65280>>8*b-a&255;if(0!==(g.charCodeAt(0)&f))throw"bits beyond keysize not zero";for(var m=Td(d,g.length,k),a=[],l=0;l<g.length;l+=
1)a[l]=g.charCodeAt(l)^m.charCodeAt(l);a[0]&=~f;n=b-n-c-2;for(l=0;l<n;l+=1)if(0!==a[l])throw"leftmost octets not zero";if(1!==a[n])throw"0x01 marker not found";return d===hextorstr(k(rstrtohex("\x00\x00\x00\x00\x00\x00\x00\x00"+e+String.fromCharCode.apply(String,a.slice(-c)))))};v.prototype.verifyStringPSS=Bd;v.prototype.verifyPSS=Bd;v.SALT_LEN_RECOVER=-2;s.RSAKey=v;"undefined"!=typeof I&&I||(I={});"undefined"!=typeof I.crypto&&I.crypto||(I.crypto={});I.crypto.ECDSA=function(e){var k=new P;this.type=
"EC";this.getBigRandom=function(e){return(new u(e.bitLength(),k)).mod(e.subtract(u.ONE)).add(u.ONE)};this.setNamedCurve=function(e){this.ecparams=I.crypto.ECParameterDB.getByName(e);this.pubKeyHex=this.prvKeyHex=null;this.curveName=e};this.setPrivateKeyHex=function(e){this.isPrivate=!0;this.prvKeyHex=e};this.setPublicKeyHex=function(e){this.isPublic=!0;this.pubKeyHex=e};this.generateKeyPairHex=function(){var e=this.getBigRandom(this.ecparams.n),c=this.ecparams.G.multiply(e),k=c.getX().toBigInteger(),
c=c.getY().toBigInteger(),n=this.ecparams.keylen/4,e=("0000000000"+e.toString(16)).slice(-n),k=("0000000000"+k.toString(16)).slice(-n),c=("0000000000"+c.toString(16)).slice(-n),k="04"+k+c;this.setPrivateKeyHex(e);this.setPublicKeyHex(k);return{ecprvhex:e,ecpubhex:k}};this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)};this.signHex=function(e,c){var k=new u(c,16),n=this.ecparams.n,a=new u(e,16);do var b=this.getBigRandom(n),d=this.ecparams.G.multiply(b).getX().toBigInteger().mod(n);
while(0>=d.compareTo(u.ZERO));k=b.modInverse(n).multiply(a.add(k.multiply(d))).mod(n);return I.crypto.ECDSA.biRSSigToASN1Sig(d,k)};this.sign=function(e,c){var k=this.ecparams.n,n=u.fromByteArrayUnsigned(e);do var a=this.getBigRandom(k),b=this.ecparams.G.multiply(a).getX().toBigInteger().mod(k);while(0>=b.compareTo(u.ZERO));k=a.modInverse(k).multiply(n.add(c.multiply(b))).mod(k);return this.serializeSig(b,k)};this.verifyWithMessageHash=function(e,c){return this.verifyHex(e,c,this.pubKeyHex)};this.verifyHex=
function(e,c,k){var n;n=I.crypto.ECDSA.parseSigHex(c);c=n.r;n=n.s;k=ECPointFp.decodeFromHex(this.ecparams.curve,k);e=new u(e,16);return this.verifyRaw(e,c,n,k)};this.verify=function(e,c,k){var n;if(Bitcoin.Util.isArray(c))c=this.parseSig(c),n=c.r,c=c.s;else if("object"===typeof c&&c.r&&c.s)n=c.r,c=c.s;else throw"Invalid value for signature";if(!(k instanceof ECPointFp))if(Bitcoin.Util.isArray(k))k=ECPointFp.decodeFrom(this.ecparams.curve,k);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";
e=u.fromByteArrayUnsigned(e);return this.verifyRaw(e,n,c,k)};this.verifyRaw=function(e,c,k,n){var a=this.ecparams.n,b=this.ecparams.G;if(0>c.compareTo(u.ONE)||0<=c.compareTo(a)||0>k.compareTo(u.ONE)||0<=k.compareTo(a))return!1;k=k.modInverse(a);e=e.multiply(k).mod(a);k=c.multiply(k).mod(a);return b.multiply(e).add(n.multiply(k)).getX().toBigInteger().mod(a).equals(c)};this.serializeSig=function(e,c){var k=e.toByteArraySigned(),n=c.toByteArraySigned(),a=[];a.push(2);a.push(k.length);a=a.concat(k);
a.push(2);a.push(n.length);a=a.concat(n);a.unshift(a.length);a.unshift(48);return a};this.parseSig=function(e){var c;if(48!=e[0])throw Error("Signature not a valid DERSequence");c=2;if(2!=e[c])throw Error("First element in signature must be a DERInteger");var k=e.slice(c+2,c+2+e[c+1]);c+=2+e[c+1];if(2!=e[c])throw Error("Second element in signature must be a DERInteger");e=e.slice(c+2,c+2+e[c+1]);k=u.fromByteArrayUnsigned(k);e=u.fromByteArrayUnsigned(e);return{r:k,s:e}};this.parseSigCompact=function(e){if(65!==
e.length)throw"Signature has the wrong length";var c=e[0]-27;if(0>c||7<c)throw"Invalid signature type";var k=this.ecparams.n,n=u.fromByteArrayUnsigned(e.slice(1,33)).mod(k);e=u.fromByteArrayUnsigned(e.slice(33,65)).mod(k);return{r:n,s:e,i:c}};void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve);void 0===this.curveName&&(this.curveName="secp256r1");this.setNamedCurve(this.curveName);void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))};I.crypto.ECDSA.parseSigHex=
function(e){var k=I.crypto.ECDSA.parseSigHexInHexRS(e);e=new u(k.r,16);k=new u(k.s,16);return{r:e,s:k}};I.crypto.ECDSA.parseSigHexInHexRS=function(e){if("30"!=e.substr(0,2))throw"signature is not a ASN.1 sequence";var k=D.getPosArrayOfChildren_AtObj(e,0);if(2!=k.length)throw"number of signature ASN.1 sequence elements seem wrong";var h=k[0],k=k[1];if("02"!=e.substr(h,2))throw"1st item of sequene of signature is not ASN.1 integer";if("02"!=e.substr(k,2))throw"2nd item of sequene of signature is not ASN.1 integer";
h=D.getHexOfV_AtObj(e,h);e=D.getHexOfV_AtObj(e,k);return{r:h,s:e}};I.crypto.ECDSA.asn1SigToConcatSig=function(e){var k=I.crypto.ECDSA.parseSigHexInHexRS(e);e=k.r;k=k.s;"00"==e.substr(0,2)&&8==e.length/2*8%128&&(e=e.substr(2));"00"==k.substr(0,2)&&8==k.length/2*8%128&&(k=k.substr(2));if(0!=e.length/2*8%128)throw"unknown ECDSA sig r length error";if(0!=k.length/2*8%128)throw"unknown ECDSA sig s length error";return e+k};I.crypto.ECDSA.concatSigToASN1Sig=function(e){if(0!=e.length/2*8%128)throw"unknown ECDSA concatinated r-s sig  length error";
var k=e.substr(0,e.length/2);e=e.substr(e.length/2);return I.crypto.ECDSA.hexRSSigToASN1Sig(k,e)};I.crypto.ECDSA.hexRSSigToASN1Sig=function(e,k){var h=new u(e,16),c=new u(k,16);return I.crypto.ECDSA.biRSSigToASN1Sig(h,c)};I.crypto.ECDSA.biRSSigToASN1Sig=function(e,k){var h=new I.asn1.DERInteger({bigint:e}),c=new I.asn1.DERInteger({bigint:k});return(new I.asn1.DERSequence({array:[h,c]})).getEncodedHex()};Nb=a;D=new function(){this.getByteLengthOfL_AtObj=function(e,k){if("8"!=e.substring(k+2,k+3))return 1;
var h=parseInt(e.substring(k+3,k+4));return 0==h?-1:0<h&&10>h?h+1:-2};this.getHexOfL_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 1>h?"":e.substring(k+2,k+2+2*h)};this.getIntOfL_AtObj=function(e,k){var h=this.getHexOfL_AtObj(e,k);return""==h?-1:(8>parseInt(h.substring(0,1))?new u(h,16):new u(h.substring(2),16)).intValue()};this.getStartPosOfV_AtObj=function(e,k){var h=this.getByteLengthOfL_AtObj(e,k);return 0>h?h:k+2*(h+1)};this.getHexOfV_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,
k),c=this.getIntOfL_AtObj(e,k);return e.substring(h,h+2*c)};this.getHexOfTLV_AtObj=function(e,k){var h=e.substr(k,2),c=this.getHexOfL_AtObj(e,k),l=this.getHexOfV_AtObj(e,k);return h+c+l};this.getPosOfNextSibling_AtObj=function(e,k){var h=this.getStartPosOfV_AtObj(e,k),c=this.getIntOfL_AtObj(e,k);return h+2*c};this.getPosArrayOfChildren_AtObj=function(e,k){var h=[],c=this.getStartPosOfV_AtObj(e,k);h.push(c);for(var l=this.getIntOfL_AtObj(e,k),n=c,a=0;;){n=this.getPosOfNextSibling_AtObj(e,n);if(null==
n||n-c>=2*l)break;if(200<=a)break;h.push(n);a++}return h};this.getNthChildIndex_AtObj=function(e,k,h){return this.getPosArrayOfChildren_AtObj(e,k)[h]};this.getDecendantIndexByNthList=function(e,k,h){if(0==h.length)return k;var c=h.shift();k=this.getPosArrayOfChildren_AtObj(e,k);return this.getDecendantIndexByNthList(e,k[c],h)};this.getDecendantHexTLVByNthList=function(e,k,h){k=this.getDecendantIndexByNthList(e,k,h);return this.getHexOfTLV_AtObj(e,k)};this.getDecendantHexVByNthList=function(e,k,h){k=
this.getDecendantIndexByNthList(e,k,h);return this.getHexOfV_AtObj(e,k)}};D.getVbyList=function(e,k,h,c){k=this.getDecendantIndexByNthList(e,k,h);if(void 0===k)throw"can't find nthList object";if(void 0!==c&&e.substr(k,2)!=c)throw"checking tag doesn't match: "+e.substr(k,2)+"!="+c;return this.getHexOfV_AtObj(e,k)};D.hextooidstr=function(e){var k=function(c,e){return c.length>=e?c:Array(e-c.length+1).join("0")+c},h=[],c=e.substr(0,2),c=parseInt(c,16);h[0]=new String(Math.floor(c/40));h[1]=new String(c%
40);var l=e.substr(2);e=[];for(c=0;c<l.length/2;c++)e.push(parseInt(l.substr(2*c,2),16));for(var l=[],n="",c=0;c<e.length;c++)e[c]&128?n+=k((e[c]&127).toString(2),7):(n+=k((e[c]&127).toString(2),7),l.push(new String(parseInt(n,2))),n="");k=h.join(".");0<l.length&&(k=k+"."+l.join("."));return k};D.dump=function(e,k,h,c){var l=function(c,e){return c.length<=2*e?c:c.substr(0,e)+"..(total "+c.length/2+"bytes).."+c.substr(c.length-e,e)};void 0===k&&(k={ommit_long_octet:32});void 0===h&&(h=0);void 0===
c&&(c="");var n=k.ommit_long_octet;if("01"==e.substr(h,2))return e=D.getHexOfV_AtObj(e,h),"00"==e?c+"BOOLEAN FALSE\n":c+"BOOLEAN TRUE\n";if("02"==e.substr(h,2))return e=D.getHexOfV_AtObj(e,h),c+"INTEGER "+l(e,n)+"\n";if("03"==e.substr(h,2))return e=D.getHexOfV_AtObj(e,h),c+"BITSTRING "+l(e,n)+"\n";if("04"==e.substr(h,2))return e=D.getHexOfV_AtObj(e,h),D.isASN1HEX(e)?l=c+"OCTETSTRING, encapsulates\n"+D.dump(e,k,0,c+"  "):c+"OCTETSTRING "+l(e,n)+"\n";if("05"==e.substr(h,2))return c+"NULL\n";if("06"==
e.substr(h,2)){e=D.getHexOfV_AtObj(e,h);var a=I.asn1.ASN1Util.oidHexToInt(e),n=I.asn1.x509.OID.oid2name(a);e=a.replace(/\./g," ");return""!=n?c+"ObjectIdentifier "+n+" ("+e+")\n":c+"ObjectIdentifier ("+e+")\n"}if("0c"==e.substr(h,2))return c+"UTF8String '"+hextoutf8(D.getHexOfV_AtObj(e,h))+"'\n";if("13"==e.substr(h,2))return c+"PrintableString '"+hextoutf8(D.getHexOfV_AtObj(e,h))+"'\n";if("14"==e.substr(h,2))return c+"TeletexString '"+hextoutf8(D.getHexOfV_AtObj(e,h))+"'\n";if("16"==e.substr(h,2))return c+
"IA5String '"+hextoutf8(D.getHexOfV_AtObj(e,h))+"'\n";if("17"==e.substr(h,2))return c+"UTCTime "+hextoutf8(D.getHexOfV_AtObj(e,h))+"\n";if("18"==e.substr(h,2))return c+"GeneralizedTime "+hextoutf8(D.getHexOfV_AtObj(e,h))+"\n";if("30"==e.substr(h,2)){if("3000"==e.substr(h,4))return c+"SEQUENCE {}\n";l=c+"SEQUENCE\n";h=D.getPosArrayOfChildren_AtObj(e,h);n=k;2!=h.length&&3!=h.length||"06"!=e.substr(h[0],2)||"04"!=e.substr(h[h.length-1],2)||(n=D.getHexOfV_AtObj(e,h[0]),a=I.asn1.ASN1Util.oidHexToInt(n),
n=I.asn1.x509.OID.oid2name(a),k=JSON.parse(JSON.stringify(k)),k.x509ExtName=n,n=k);for(a=0;a<h.length;a++)l+=D.dump(e,n,h[a],c+"  ");return l}if("31"==e.substr(h,2)){l=c+"SET\n";h=D.getPosArrayOfChildren_AtObj(e,h);for(a=0;a<h.length;a++)l+=D.dump(e,k,h[a],c+"  ");return l}n=parseInt(e.substr(h,2),16);if(0!=(n&128)){l=n&31;if(0!=(n&32))for(l=c+"["+l+"]\n",h=D.getPosArrayOfChildren_AtObj(e,h),a=0;a<h.length;a++)l+=D.dump(e,k,h[a],c+"  ");else e=D.getHexOfV_AtObj(e,h),"68747470"==e.substr(0,8)&&(e=
hextoutf8(e)),"subjectAltName"===k.x509ExtName&&2==l&&(e=hextoutf8(e)),l=c+"["+l+"] "+e+"\n";return l}return c+"UNKNOWN("+e.substr(h,2)+") "+D.getHexOfV_AtObj(e,h)+"\n"};D.isASN1HEX=function(e){if(1==e.length%2)return!1;var k=D.getIntOfL_AtObj(e,0),h=e.substr(0,2),c=D.getHexOfL_AtObj(e,0);return e.length-h.length-c.length==2*k?!0:!1};s.ASN1HEX=D;t=a.b64tohex;v=a.RSAKey;D=a.ASN1HEX;Z.pemToBase64=function(e){e=e.replace("-----BEGIN CERTIFICATE-----","");e=e.replace("-----END CERTIFICATE-----","");return e=
e.replace(/[ \n]+/g,"")};Z.pemToHex=function(e){e=Z.pemToBase64(e);return t(e)};Z.getSubjectPublicKeyPosFromCertHex=function(e){var k=Z.getSubjectPublicKeyInfoPosFromCertHex(e);if(-1==k)return-1;k=D.getPosArrayOfChildren_AtObj(e,k);if(2!=k.length)return-1;k=k[1];if("03"!=e.substring(k,k+2))return-1;k=D.getStartPosOfV_AtObj(e,k);return"00"!=e.substring(k,k+2)?-1:k+2};Z.getSubjectPublicKeyInfoPosFromCertHex=function(e){var k=D.getStartPosOfV_AtObj(e,0),k=D.getPosArrayOfChildren_AtObj(e,k);return 1>
k.length?-1:"a003020102"==e.substring(k[0],k[0]+10)?6>k.length?-1:k[6]:5>k.length?-1:k[5]};Z.getPublicKeyHexArrayFromCertHex=function(e){var k=Z.getSubjectPublicKeyPosFromCertHex(e),h=D.getPosArrayOfChildren_AtObj(e,k);if(2!=h.length)return[];k=D.getHexOfV_AtObj(e,h[0]);e=D.getHexOfV_AtObj(e,h[1]);return null!=k&&null!=e?[k,e]:[]};Z.getHexTbsCertificateFromCert=function(e){return D.getStartPosOfV_AtObj(e,0)};Z.getPublicKeyHexArrayFromCertPEM=function(e){e=Z.pemToHex(e);return Z.getPublicKeyHexArrayFromCertHex(e)};
Z.hex2dn=function(e){for(var k="",h=D.getPosArrayOfChildren_AtObj(e,0),c=0;c<h.length;c++)var l=D.getHexOfTLV_AtObj(e,h[c]),k=k+"/"+Z.hex2rdn(l);return k};Z.hex2rdn=function(e){var k=D.getDecendantHexTLVByNthList(e,0,[0,0]),h=D.getDecendantHexVByNthList(e,0,[0,1]);e="";try{e=Z.DN_ATTRHEX[k]}catch(c){e=k}h=h.replace(/(..)/g,"%$1");k=decodeURIComponent(h);return e+"="+k};Z.DN_ATTRHEX={"0603550406":"C","060355040a":"O","060355040b":"OU","0603550403":"CN","0603550405":"SN","0603550408":"ST","0603550407":"L"};
Z.getPublicKeyFromCertPEM=function(e){var k=Z.getPublicKeyInfoPropOfCertPEM(e);if("2a864886f70d010101"==k.algoid){var h=KEYUTIL.parsePublicRawRSAKeyHex(k.keyhex);e=new v;e.setPublic(h.n,h.e);return e}if("2a8648ce3d0201"==k.algoid)return e=new I.crypto.ECDSA({curve:I.crypto.OID.oidhex2name[k.algparam],info:k.keyhex}),e.setPublicKeyHex(k.keyhex),e;if("2a8648ce380401"==k.algoid){var h=D.getVbyList(k.algparam,0,[0],"02"),c=D.getVbyList(k.algparam,0,[1],"02"),l=D.getVbyList(k.algparam,0,[2],"02"),k=D.getHexOfV_AtObj(k.keyhex,
0),k=k.substr(2);e=new I.crypto.DSA;e.setPublic(new u(h,16),new u(c,16),new u(l,16),new u(k,16));return e}throw"unsupported key";};Z.getPublicKeyInfoPropOfCertPEM=function(e){var k={algparam:null};e=Z.pemToHex(e);var h=D.getPosArrayOfChildren_AtObj(e,0);if(3!=h.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(h[0],2))throw"malformed X.509 certificate PEM (code:002)";h=D.getPosArrayOfChildren_AtObj(e,h[0]);if(7>h.length)throw"malformed X.509 certificate PEM (code:003)";h=
D.getPosArrayOfChildren_AtObj(e,h[6]);if(2!=h.length)throw"malformed X.509 certificate PEM (code:004)";var c=D.getPosArrayOfChildren_AtObj(e,h[0]);if(2!=c.length)throw"malformed X.509 certificate PEM (code:005)";k.algoid=D.getHexOfV_AtObj(e,c[0]);"06"==e.substr(c[1],2)?k.algparam=D.getHexOfV_AtObj(e,c[1]):"30"==e.substr(c[1],2)&&(k.algparam=D.getHexOfTLV_AtObj(e,c[1]));if("03"!=e.substr(h[1],2))throw"malformed X.509 certificate PEM (code:006)";e=D.getHexOfV_AtObj(e,h[1]);k.keyhex=e.substr(2);return k};
Z.getPublicKeyInfoPosOfCertHEX=function(e){var k=D.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:002)";e=D.getPosArrayOfChildren_AtObj(e,k[0]);if(7>e.length)throw"malformed X.509 certificate PEM (code:003)";return e[6]};Z.getV3ExtInfoListOfCertHex=function(e){var k=D.getPosArrayOfChildren_AtObj(e,0);if(3!=k.length)throw"malformed X.509 certificate PEM (code:001)";if("30"!=e.substr(k[0],
2))throw"malformed X.509 certificate PEM (code:002)";k=D.getPosArrayOfChildren_AtObj(e,k[0]);if(8>k.length)throw"malformed X.509 certificate PEM (code:003)";if("a3"!=e.substr(k[7],2))throw"malformed X.509 certificate PEM (code:004)";k=D.getPosArrayOfChildren_AtObj(e,k[7]);if(1!=k.length)throw"malformed X.509 certificate PEM (code:005)";if("30"!=e.substr(k[0],2))throw"malformed X.509 certificate PEM (code:006)";for(var k=D.getPosArrayOfChildren_AtObj(e,k[0]),h=k.length,c=Array(h),l=0;l<h;l++)c[l]=
Z.getV3ExtItemInfo_AtObj(e,k[l]);return c};Z.getV3ExtItemInfo_AtObj=function(e,k){var h={};h.posTLV=k;var c=D.getPosArrayOfChildren_AtObj(e,k);if(2!=c.length&&3!=c.length)throw"malformed X.509v3 Ext (code:001)";if("06"!=e.substr(c[0],2))throw"malformed X.509v3 Ext (code:002)";var l=D.getHexOfV_AtObj(e,c[0]);h.oid=D.hextooidstr(l);h.critical=!1;3==c.length&&(h.critical=!0);c=c[c.length-1];if("04"!=e.substr(c,2))throw"malformed X.509v3 Ext (code:003)";h.posV=D.getStartPosOfV_AtObj(e,c);return h};Z.getHexOfTLV_V3ExtValue=
function(e,k){var h=Z.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":D.getHexOfTLV_AtObj(e,h)};Z.getHexOfV_V3ExtValue=function(e,k){var h=Z.getPosOfTLV_V3ExtValue(e,k);return-1==h?"":D.getHexOfV_AtObj(e,h)};Z.getPosOfTLV_V3ExtValue=function(e,k){var h=k;k.match(/^[0-9.]+$/)||(h=I.asn1.x509.OID.name2oid(k));if(""==h)return-1;for(var c=Z.getV3ExtInfoListOfCertHex(e),l=0;l<c.length;l++){var n=c[l];if(n.oid==h)return n.posV}return-1};Z.KEYUSAGE_NAME="digitalSignature nonRepudiation keyEncipherment dataEncipherment keyAgreement keyCertSign cRLSign encipherOnly decipherOnly".split(" ");
Z.getExtKeyUsageBin=function(e){var k=Z.getHexOfV_V3ExtValue(e,"keyUsage");if(""==k)return"";if(0!=k.length%2||2>=k.length)throw"malformed key usage value";e=parseInt(k.substr(0,2));k=parseInt(k.substr(2),16).toString(2);return k.substr(0,k.length-e)};Z.getExtKeyUsageString=function(e){e=Z.getExtKeyUsageBin(e);for(var k=[],h=0;h<e.length;h++)"1"==e.substr(h,1)&&k.push(Z.KEYUSAGE_NAME[h]);return k.join(",")};Z.getExtAIAInfo=function(e){var k={ocsp:[],caissuer:[]},h=Z.getPosOfTLV_V3ExtValue(e,"authorityInfoAccess");
if(-1==h)return null;if("30"!=e.substr(h,2))throw"malformed AIA Extn Value";for(var h=D.getPosArrayOfChildren_AtObj(e,h),c=0;c<h.length;c++){var l=D.getPosArrayOfChildren_AtObj(e,h[c]);if(2!=l.length)throw"malformed AccessDescription of AIA Extn";var n=l[0],l=l[1];"2b06010505073001"==D.getHexOfV_AtObj(e,n)&&"86"==e.substr(l,2)&&k.ocsp.push(hextoutf8(D.getHexOfV_AtObj(e,l)));"2b06010505073002"==D.getHexOfV_AtObj(e,n)&&"86"==e.substr(l,2)&&k.caissuer.push(hextoutf8(D.getHexOfV_AtObj(e,l)))}return k};
s.X509=Z;var ec,u=function(e,k,h){null!=e&&("number"==typeof e?this.fromNumber(e,k,h):null==k&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,k))};"Microsoft Internet Explorer"==navigator.appName?(u.prototype.am=Vd,ec=30):"Netscape"!=navigator.appName?(u.prototype.am=qb,ec=26):(u.prototype.am=Cd,ec=28);u.prototype.DB=ec;u.prototype.DM=(1<<ec)-1;u.prototype.DV=1<<ec;u.prototype.FV=Math.pow(2,52);u.prototype.F1=52-ec;u.prototype.F2=2*ec-52;var Cb="0123456789abcdefghijklmnopqrstuvwxyz",
Wd=[],qc,Eb;qc=48;for(Eb=0;9>=Eb;++Eb)Wd[qc++]=Eb;qc=97;for(Eb=10;36>Eb;++Eb)Wd[qc++]=Eb;qc=65;for(Eb=10;36>Eb;++Eb)Wd[qc++]=Eb;bc.prototype.convert=function(e){return 0>e.s||0<=e.compareTo(this.m)?e.mod(this.m):e};bc.prototype.revert=function(e){return e};bc.prototype.reduce=function(e){e.divRemTo(this.m,null,e)};bc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};bc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};xa.prototype.convert=function(e){var k=ca();e.abs().dlShiftTo(this.m.t,
k);k.divRemTo(this.m,null,k);0>e.s&&0<k.compareTo(u.ZERO)&&this.m.subTo(k,k);return k};xa.prototype.revert=function(e){var k=ca();e.copyTo(k);this.reduce(k);return k};xa.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var k=0;k<this.m.t;++k){var h=e[k]&32767,c=h*this.mpl+((h*this.mph+(e[k]>>15)*this.mpl&this.um)<<15)&e.DM,h=k+this.m.t;for(e[h]+=this.m.am(0,c,e,k,0,this.m.t);e[h]>=e.DV;)e[h]-=e.DV,e[++h]++}e.clamp();e.drShiftTo(this.m.t,e);0<=e.compareTo(this.m)&&e.subTo(this.m,e)};
xa.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};xa.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};u.prototype.copyTo=function(e){for(var k=this.t-1;0<=k;--k)e[k]=this[k];e.t=this.t;e.s=this.s};u.prototype.fromInt=function(e){this.t=1;this.s=0>e?-1:0;0<e?this[0]=e:-1>e?this[0]=e+this.DV:this.t=0};u.prototype.fromString=function(e,k){var h;if(16==k)h=4;else if(8==k)h=3;else if(256==k)h=8;else if(2==k)h=1;else if(32==k)h=5;else if(4==k)h=2;else{this.fromRadix(e,k);return}this.s=
this.t=0;for(var c=e.length,l=!1,n=0;0<=--c;){var a=8==h?e[c]&255:Dc(e,c);0>a?"-"==e.charAt(c)&&(l=!0):(l=!1,0==n?this[this.t++]=a:n+h>this.DB?(this[this.t-1]|=(a&(1<<this.DB-n)-1)<<n,this[this.t++]=a>>this.DB-n):this[this.t-1]|=a<<n,n+=h,n>=this.DB&&(n-=this.DB))}8==h&&0!=(e[0]&128)&&(this.s=-1,0<n&&(this[this.t-1]|=(1<<this.DB-n)-1<<n));this.clamp();l&&u.ZERO.subTo(this,this)};u.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t};u.prototype.dlShiftTo=function(e,
k){var h;for(h=this.t-1;0<=h;--h)k[h+e]=this[h];for(h=e-1;0<=h;--h)k[h]=0;k.t=this.t+e;k.s=this.s};u.prototype.drShiftTo=function(e,k){for(var h=e;h<this.t;++h)k[h-e]=this[h];k.t=Math.max(this.t-e,0);k.s=this.s};u.prototype.lShiftTo=function(e,k){var h=e%this.DB,c=this.DB-h,l=(1<<c)-1,n=Math.floor(e/this.DB),a=this.s<<h&this.DM,b;for(b=this.t-1;0<=b;--b)k[b+n+1]=this[b]>>c|a,a=(this[b]&l)<<h;for(b=n-1;0<=b;--b)k[b]=0;k[n]=a;k.t=this.t+n+1;k.s=this.s;k.clamp()};u.prototype.rShiftTo=function(e,k){k.s=
this.s;var h=Math.floor(e/this.DB);if(h>=this.t)k.t=0;else{var c=e%this.DB,l=this.DB-c,n=(1<<c)-1;k[0]=this[h]>>c;for(var a=h+1;a<this.t;++a)k[a-h-1]|=(this[a]&n)<<l,k[a-h]=this[a]>>c;0<c&&(k[this.t-h-1]|=(this.s&n)<<l);k.t=this.t-h;k.clamp()}};u.prototype.subTo=function(e,k){for(var h=0,c=0,l=Math.min(e.t,this.t);h<l;)c+=this[h]-e[h],k[h++]=c&this.DM,c>>=this.DB;if(e.t<this.t){for(c-=e.s;h<this.t;)c+=this[h],k[h++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;h<e.t;)c-=e[h],k[h++]=c&this.DM,
c>>=this.DB;c-=e.s}k.s=0>c?-1:0;-1>c?k[h++]=this.DV+c:0<c&&(k[h++]=c);k.t=h;k.clamp()};u.prototype.multiplyTo=function(e,k){var h=this.abs(),c=e.abs(),l=h.t;for(k.t=l+c.t;0<=--l;)k[l]=0;for(l=0;l<c.t;++l)k[l+h.t]=h.am(0,c[l],k,l,0,h.t);k.s=0;k.clamp();this.s!=e.s&&u.ZERO.subTo(k,k)};u.prototype.squareTo=function(e){for(var k=this.abs(),h=e.t=2*k.t;0<=--h;)e[h]=0;for(h=0;h<k.t-1;++h){var c=k.am(h,k[h],e,2*h,0,1);(e[h+k.t]+=k.am(h+1,2*k[h],e,2*h+1,c,k.t-h-1))>=k.DV&&(e[h+k.t]-=k.DV,e[h+k.t+1]=1)}0<
e.t&&(e[e.t-1]+=k.am(h,k[h],e,2*h,0,1));e.s=0;e.clamp()};u.prototype.divRemTo=function(e,k,h){var c=e.abs();if(!(0>=c.t)){var l=this.abs();if(l.t<c.t)null!=k&&k.fromInt(0),null!=h&&this.copyTo(h);else{null==h&&(h=ca());var n=ca(),a=this.s;e=e.s;var b=this.DB-hd(c[c.t-1]);0<b?(c.lShiftTo(b,n),l.lShiftTo(b,h)):(c.copyTo(n),l.copyTo(h));c=n.t;l=n[c-1];if(0!=l){var d=l*(1<<this.F1)+(1<c?n[c-2]>>this.F2:0),g=this.FV/d,d=(1<<this.F1)/d,f=1<<this.F2,m=h.t,q=m-c,r=null==k?ca():k;n.dlShiftTo(q,r);0<=h.compareTo(r)&&
(h[h.t++]=1,h.subTo(r,h));u.ONE.dlShiftTo(c,r);for(r.subTo(n,n);n.t<c;)n[n.t++]=0;for(;0<=--q;){var p=h[--m]==l?this.DM:Math.floor(h[m]*g+(h[m-1]+f)*d);if((h[m]+=n.am(0,p,h,q,0,c))<p)for(n.dlShiftTo(q,r),h.subTo(r,h);h[m]<--p;)h.subTo(r,h)}null!=k&&(h.drShiftTo(c,k),a!=e&&u.ZERO.subTo(k,k));h.t=c;h.clamp();0<b&&h.rShiftTo(b,h);0>a&&u.ZERO.subTo(h,h)}}}};u.prototype.invDigit=function(){if(1>this.t)return 0;var e=this[0];if(0==(e&1))return 0;var k=e&3,k=k*(2-(e&15)*k)&15,k=k*(2-(e&255)*k)&255,k=k*(2-
((e&65535)*k&65535))&65535,k=k*(2-e*k%this.DV)%this.DV;return 0<k?this.DV-k:-k};u.prototype.isEven=function(){return 0==(0<this.t?this[0]&1:this.s)};u.prototype.exp=function(e,k){if(4294967295<e||1>e)return u.ONE;var h=ca(),c=ca(),l=k.convert(this),n=hd(e)-1;for(l.copyTo(h);0<=--n;)if(k.sqrTo(h,c),0<(e&1<<n))k.mulTo(c,l,h);else var a=h,h=c,c=a;return k.revert(h)};u.prototype.toString=function(e){if(0>this.s)return"-"+this.negate().toString(e);if(16==e)e=4;else if(8==e)e=3;else if(2==e)e=1;else if(32==
e)e=5;else if(4==e)e=2;else return this.toRadix(e);var k=(1<<e)-1,h,c=!1,l="",n=this.t,a=this.DB-n*this.DB%e;if(0<n--)for(a<this.DB&&0<(h=this[n]>>a)&&(c=!0,l=Cb.charAt(h));0<=n;)a<e?(h=(this[n]&(1<<a)-1)<<e-a,h|=this[--n]>>(a+=this.DB-e)):(h=this[n]>>(a-=e)&k,0>=a&&(a+=this.DB,--n)),0<h&&(c=!0),c&&(l+=Cb.charAt(h));return c?l:"0"};u.prototype.negate=function(){var e=ca();u.ZERO.subTo(this,e);return e};u.prototype.abs=function(){return 0>this.s?this.negate():this};u.prototype.compareTo=function(e){var k=
this.s-e.s;if(0!=k)return k;var h=this.t,k=h-e.t;if(0!=k)return 0>this.s?-k:k;for(;0<=--h;)if(0!=(k=this[h]-e[h]))return k;return 0};u.prototype.bitLength=function(){return 0>=this.t?0:this.DB*(this.t-1)+hd(this[this.t-1]^this.s&this.DM)};u.prototype.mod=function(e){var k=ca();this.abs().divRemTo(e,null,k);0>this.s&&0<k.compareTo(u.ZERO)&&e.subTo(k,k);return k};u.prototype.modPowInt=function(e,k){var h;h=256>e||k.isEven()?new bc(k):new xa(k);return this.exp(e,h)};u.ZERO=nc(0);u.ONE=nc(1);Fc.prototype.convert=
id;Fc.prototype.revert=id;Fc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h)};Fc.prototype.sqrTo=function(e,k){e.squareTo(k)};oc.prototype.convert=function(e){if(0>e.s||e.t>2*this.m.t)return e.mod(this.m);if(0>e.compareTo(this.m))return e;var k=ca();e.copyTo(k);this.reduce(k);return k};oc.prototype.revert=function(e){return e};oc.prototype.reduce=function(e){e.drShiftTo(this.m.t-1,this.r2);e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,
this.m.t+1,this.r2);0>e.compareTo(this.r2);)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)};oc.prototype.mulTo=function(e,k,h){e.multiplyTo(k,h);this.reduce(h)};oc.prototype.sqrTo=function(e,k){e.squareTo(k);this.reduce(k)};var eb=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,
313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],we=67108864/eb[eb.length-1];u.prototype.chunkSize=function(e){return Math.floor(Math.LN2*
this.DB/Math.log(e))};u.prototype.toRadix=function(e){null==e&&(e=10);if(0==this.signum()||2>e||36<e)return"0";var k=this.chunkSize(e),k=Math.pow(e,k),h=nc(k),c=ca(),l=ca(),n="";for(this.divRemTo(h,c,l);0<c.signum();)n=(k+l.intValue()).toString(e).substr(1)+n,c.divRemTo(h,c,l);return l.intValue().toString(e)+n};u.prototype.fromRadix=function(e,k){this.fromInt(0);null==k&&(k=10);for(var h=this.chunkSize(k),c=Math.pow(k,h),l=!1,n=0,a=0,b=0;b<e.length;++b){var d=Dc(e,b);0>d?"-"==e.charAt(b)&&0==this.signum()&&
(l=!0):(a=k*a+d,++n>=h&&(this.dMultiply(c),this.dAddOffset(a,0),a=n=0))}0<n&&(this.dMultiply(Math.pow(k,n)),this.dAddOffset(a,0));l&&u.ZERO.subTo(this,this)};u.prototype.fromNumber=function(e,k,h){if("number"==typeof k)if(2>e)this.fromInt(1);else for(this.fromNumber(e,h),this.testBit(e-1)||this.bitwiseTo(u.ONE.shiftLeft(e-1),rd,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(k);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(u.ONE.shiftLeft(e-1),this);else{h=[];var c=e&7;h.length=
(e>>3)+1;k.nextBytes(h);h[0]=0<c?h[0]&(1<<c)-1:0;this.fromString(h,256)}};u.prototype.bitwiseTo=function(e,k,h){var c,l,n=Math.min(e.t,this.t);for(c=0;c<n;++c)h[c]=k(this[c],e[c]);if(e.t<this.t){l=e.s&this.DM;for(c=n;c<this.t;++c)h[c]=k(this[c],l);h.t=this.t}else{l=this.s&this.DM;for(c=n;c<e.t;++c)h[c]=k(l,e[c]);h.t=e.t}h.s=k(this.s,e.s);h.clamp()};u.prototype.changeBit=function(e,k){var h=u.ONE.shiftLeft(e);this.bitwiseTo(h,k,h);return h};u.prototype.addTo=function(e,k){for(var h=0,c=0,l=Math.min(e.t,
this.t);h<l;)c+=this[h]+e[h],k[h++]=c&this.DM,c>>=this.DB;if(e.t<this.t){for(c+=e.s;h<this.t;)c+=this[h],k[h++]=c&this.DM,c>>=this.DB;c+=this.s}else{for(c+=this.s;h<e.t;)c+=e[h],k[h++]=c&this.DM,c>>=this.DB;c+=e.s}k.s=0>c?-1:0;0<c?k[h++]=c:-1>c&&(k[h++]=this.DV+c);k.t=h;k.clamp()};u.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t);++this.t;this.clamp()};u.prototype.dAddOffset=function(e,k){if(0!=e){for(;this.t<=k;)this[this.t++]=0;for(this[k]+=e;this[k]>=this.DV;)this[k]-=
this.DV,++k>=this.t&&(this[this.t++]=0),++this[k]}};u.prototype.multiplyLowerTo=function(e,k,h){var c=Math.min(this.t+e.t,k);h.s=0;for(h.t=c;0<c;)h[--c]=0;var l;for(l=h.t-this.t;c<l;++c)h[c+this.t]=this.am(0,e[c],h,c,0,this.t);for(l=Math.min(e.t,k);c<l;++c)this.am(0,e[c],h,c,0,k-c);h.clamp()};u.prototype.multiplyUpperTo=function(e,k,h){--k;var c=h.t=this.t+e.t-k;for(h.s=0;0<=--c;)h[c]=0;for(c=Math.max(k-this.t,0);c<e.t;++c)h[this.t+c-k]=this.am(k-c,e[c],h,0,0,this.t+c-k);h.clamp();h.drShiftTo(1,h)};
u.prototype.modInt=function(e){if(0>=e)return 0;var k=this.DV%e,h=0>this.s?e-1:0;if(0<this.t)if(0==k)h=this[0]%e;else for(var c=this.t-1;0<=c;--c)h=(k*h+this[c])%e;return h};u.prototype.millerRabin=function(e){var k=this.subtract(u.ONE),h=k.getLowestSetBit();if(0>=h)return!1;var c=k.shiftRight(h);e=e+1>>1;e>eb.length&&(e=eb.length);for(var l=ca(),n=0;n<e;++n){l.fromInt(eb[Math.floor(Math.random()*eb.length)]);var a=l.modPow(c,this);if(0!=a.compareTo(u.ONE)&&0!=a.compareTo(k)){for(var b=1;b++<h&&0!=
a.compareTo(k);)if(a=a.modPowInt(2,this),0==a.compareTo(u.ONE))return!1;if(0!=a.compareTo(k))return!1}}return!0};u.prototype.clone=function(){var e=ca();this.copyTo(e);return e};u.prototype.intValue=function(){if(0>this.s){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]};u.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24};u.prototype.shortValue=function(){return 0==
this.t?this.s:this[0]<<16>>16};u.prototype.signum=function(){return 0>this.s?-1:0>=this.t||1==this.t&&0>=this[0]?0:1};u.prototype.toByteArray=function(){var e=this.t,k=[];k[0]=this.s;var h=this.DB-e*this.DB%8,c,l=0;if(0<e--)for(h<this.DB&&(c=this[e]>>h)!=(this.s&this.DM)>>h&&(k[l++]=c|this.s<<this.DB-h);0<=e;)if(8>h?(c=(this[e]&(1<<h)-1)<<8-h,c|=this[--e]>>(h+=this.DB-8)):(c=this[e]>>(h-=8)&255,0>=h&&(h+=this.DB,--e)),0!=(c&128)&&(c|=-256),0==l&&(this.s&128)!=(c&128)&&++l,0<l||c!=this.s)k[l++]=c;
return k};u.prototype.equals=function(e){return 0==this.compareTo(e)};u.prototype.min=function(e){return 0>this.compareTo(e)?this:e};u.prototype.max=function(e){return 0<this.compareTo(e)?this:e};u.prototype.and=function(e){var k=ca();this.bitwiseTo(e,ge,k);return k};u.prototype.or=function(e){var k=ca();this.bitwiseTo(e,rd,k);return k};u.prototype.xor=function(e){var k=ca();this.bitwiseTo(e,sd,k);return k};u.prototype.andNot=function(e){var k=ca();this.bitwiseTo(e,Ec,k);return k};u.prototype.not=
function(){for(var e=ca(),k=0;k<this.t;++k)e[k]=this.DM&~this[k];e.t=this.t;e.s=~this.s;return e};u.prototype.shiftLeft=function(e){var k=ca();0>e?this.rShiftTo(-e,k):this.lShiftTo(e,k);return k};u.prototype.shiftRight=function(e){var k=ca();0>e?this.lShiftTo(-e,k):this.rShiftTo(e,k);return k};u.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e]){var k=e*this.DB;e=this[e];if(0==e)e=-1;else{var h=0;0==(e&65535)&&(e>>=16,h+=16);0==(e&255)&&(e>>=8,h+=8);0==(e&15)&&(e>>=4,h+=
4);0==(e&3)&&(e>>=2,h+=2);0==(e&1)&&++h;e=h}return k+e}return 0>this.s?this.t*this.DB:-1};u.prototype.bitCount=function(){for(var e=0,k=this.s&this.DM,h=0;h<this.t;++h){for(var c=this[h]^k,l=0;0!=c;)c&=c-1,++l;e+=l}return e};u.prototype.testBit=function(e){var k=Math.floor(e/this.DB);return k>=this.t?0!=this.s:0!=(this[k]&1<<e%this.DB)};u.prototype.setBit=function(e){return this.changeBit(e,rd)};u.prototype.clearBit=function(e){return this.changeBit(e,Ec)};u.prototype.flipBit=function(e){return this.changeBit(e,
sd)};u.prototype.add=function(e){var k=ca();this.addTo(e,k);return k};u.prototype.subtract=function(e){var k=ca();this.subTo(e,k);return k};u.prototype.multiply=function(e){var k=ca();this.multiplyTo(e,k);return k};u.prototype.divide=function(e){var k=ca();this.divRemTo(e,k,null);return k};u.prototype.remainder=function(e){var k=ca();this.divRemTo(e,null,k);return k};u.prototype.divideAndRemainder=function(e){var k=ca(),h=ca();this.divRemTo(e,k,h);return[k,h]};u.prototype.modPow=function(e,k){var h=
e.bitLength(),c,l=nc(1),n;if(0>=h)return l;c=18>h?1:48>h?3:144>h?4:768>h?5:6;n=8>h?new bc(k):k.isEven()?new oc(k):new xa(k);var a=[],b=3,d=c-1,g=(1<<c)-1;a[1]=n.convert(this);if(1<c)for(h=ca(),n.sqrTo(a[1],h);b<=g;)a[b]=ca(),n.mulTo(h,a[b-2],a[b]),b+=2;for(var f=e.t-1,m,q=!0,r=ca(),h=hd(e[f])-1;0<=f;){h>=d?m=e[f]>>h-d&g:(m=(e[f]&(1<<h+1)-1)<<d-h,0<f&&(m|=e[f-1]>>this.DB+h-d));for(b=c;0==(m&1);)m>>=1,--b;0>(h-=b)&&(h+=this.DB,--f);if(q)a[m].copyTo(l),q=!1;else{for(;1<b;)n.sqrTo(l,r),n.sqrTo(r,l),b-=
2;0<b?n.sqrTo(l,r):(b=l,l=r,r=b);n.mulTo(r,a[m],l)}for(;0<=f&&0==(e[f]&1<<h);)n.sqrTo(l,r),b=l,l=r,r=b,0>--h&&(h=this.DB-1,--f)}return n.revert(l)};u.prototype.modInverse=function(e){var k=e.isEven();if(this.isEven()&&k||0==e.signum())return u.ZERO;for(var h=e.clone(),c=this.clone(),l=nc(1),n=nc(0),a=nc(0),b=nc(1);0!=h.signum();){for(;h.isEven();)h.rShiftTo(1,h),k?(l.isEven()&&n.isEven()||(l.addTo(this,l),n.subTo(e,n)),l.rShiftTo(1,l)):n.isEven()||n.subTo(e,n),n.rShiftTo(1,n);for(;c.isEven();)c.rShiftTo(1,
c),k?(a.isEven()&&b.isEven()||(a.addTo(this,a),b.subTo(e,b)),a.rShiftTo(1,a)):b.isEven()||b.subTo(e,b),b.rShiftTo(1,b);0<=h.compareTo(c)?(h.subTo(c,h),k&&l.subTo(a,l),n.subTo(b,n)):(c.subTo(h,c),k&&a.subTo(l,a),b.subTo(n,b))}if(0!=c.compareTo(u.ONE))return u.ZERO;if(0<=b.compareTo(e))return b.subtract(e);if(0>b.signum())b.addTo(e,b);else return b;return 0>b.signum()?b.add(e):b};u.prototype.pow=function(e){return this.exp(e,new Fc)};u.prototype.gcd=function(e){var k=0>this.s?this.negate():this.clone();
e=0>e.s?e.negate():e.clone();if(0>k.compareTo(e)){var h=k,k=e;e=h}var h=k.getLowestSetBit(),c=e.getLowestSetBit();if(0>c)return k;h<c&&(c=h);0<c&&(k.rShiftTo(c,k),e.rShiftTo(c,e));for(;0<k.signum();)0<(h=k.getLowestSetBit())&&k.rShiftTo(h,k),0<(h=e.getLowestSetBit())&&e.rShiftTo(h,e),0<=k.compareTo(e)?(k.subTo(e,k),k.rShiftTo(1,k)):(e.subTo(k,e),e.rShiftTo(1,e));0<c&&e.lShiftTo(c,e);return e};u.prototype.isProbablePrime=function(e){var k,h=this.abs();if(1==h.t&&h[0]<=eb[eb.length-1]){for(k=0;k<eb.length;++k)if(h[0]==
eb[k])return!0;return!1}if(h.isEven())return!1;for(k=1;k<eb.length;){for(var c=eb[k],l=k+1;l<eb.length&&c<we;)c*=eb[l++];for(c=h.modInt(c);k<l;)if(0==c%eb[k++])return!1}return h.millerRabin(e)};u.prototype.square=function(){var e=ca();this.squareTo(e);return e};s.BigInteger=u;var D=a.ASN1HEX,I=a.KJUR,v=a.RSAKey,t=a.b64tohex,s=a=a||{};s.createHash=function(e){if("sha256"!=e)throw Error("createHash: unsupported algorithm.");e={};e.md=new I.crypto.MessageDigest({alg:"sha256",prov:"cryptojs"});e.update=
function(e){this.md.updateHex(e.toString("hex"))};e.digest=function(e){var h=this.md.digest();return"hex"==e?h:"base64"==e?(new f(h,"hex")).toString("base64"):new f(h,"hex")};return e};s.createHmac=function(e,k){if("sha256"!==e)throw Error("createHmac: unsupported algorithm.");var h={};h.md=new I.crypto.Mac({alg:"HmacSHA256",pass:{hex:k.toString("hex")}});h.update=function(c){this.md.updateHex(c.toString("hex"))};h.digest=function(c){var e=this.md.doFinal();return"hex"==c?e:"base64"==c?(new f(e,"hex")).toString("base64"):
new f(e,"hex")};return h};s.createSign=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");return{arr:[],update:function(e){this.arr.push(e)},sign:function(e){var h=new v;h.readPrivateKeyFromPEMString(e);e=new I.crypto.Signature({alg:"SHA256withRSA",prov:"cryptojs/jsrsa"});e.initSign(h);for(h=0;h<this.arr.length;++h)e.updateHex(this.arr[h].toString("hex"));return new f(e.sign(),"hex")}}};s.createVerify=function(e){if("RSA-SHA256"!=e)throw Error("createSign: unsupported algorithm.");
return{arr:[],update:function(e){this.arr.push(e)},verify:function(e,h){for(var c=e.split("\n"),l="",n=1;n<c.length-1;n++)l+=c[n];c=(new f(l,"base64")).toString("hex");l=D.getPosArrayOfChildren_AtObj(c,0);2!=l.length?l=-1:(l=l[1],"03"!=c.substring(l,l+2)?l=-1:(l=D.getStartPosOfV_AtObj(c,l),l="00"!=c.substring(l,l+2)?-1:l+2));n=D.getPosArrayOfChildren_AtObj(c,l);2!=n.length?l=null:(l=D.getHexOfV_AtObj(c,n[0]),c=D.getHexOfV_AtObj(c,n[1]),n=new v,n.setPublic(l,c),l=n);c=new I.crypto.Signature({alg:"SHA256withRSA",
prov:"cryptojs/jsrsa"});c.initVerifyByPublicKey(l);for(l=0;l<this.arr.length;l++)c.updateHex(this.arr[l].toString("hex"));l=h.toString("hex");return c.verify(l)}}};s.randomBytes=function(e){for(var k=new f(e),h=0;h<e;++h)k[h]=Math.floor(256*Math.random());return k};s.toByteArray=function(e){var k=[];t(e).replace(/(..)/g,function(e){k.push(parseInt(e,16))});return k};var Hc={};(function(e){function k(e){e=e.charCodeAt(0);if(e===c)return 62;if(e===l)return 63;if(e<n)return-1;if(e<n+10)return e-n+52;
if(e<b+26)return e-b;if(e<a+26)return e-a+26}var h="undefined"!==typeof Uint8Array?Uint8Array:Array,c=43,l=47,n=48,a=97,b=65;e.toByteArray=function(c){function e(c){d[Vc++]=c}var l,n,a,b,d;if(0<c.length%4)throw Error("Invalid string. Length must be a multiple of 4");l=c.length;b="="===c.charAt(l-2)?2:"="===c.charAt(l-1)?1:0;d=new h(3*c.length/4-b);n=0<b?c.length-4:c.length;var Vc=0;for(l=0;l<n;l+=4)a=k(c.charAt(l))<<18|k(c.charAt(l+1))<<12|k(c.charAt(l+2))<<6|k(c.charAt(l+3)),e((a&16711680)>>16),
e((a&65280)>>8),e(a&255);2===b?(a=k(c.charAt(l))<<2|k(c.charAt(l+1))>>4,e(a&255)):1===b&&(a=k(c.charAt(l))<<10|k(c.charAt(l+1))<<4|k(c.charAt(l+2))>>2,e(a>>8&255),e(a&255));return d};e.fromByteArray=function(c){var e,h=c.length%3,k="",l,n;e=0;for(n=c.length-h;e<n;e+=3)l=(c[e]<<16)+(c[e+1]<<8)+c[e+2],l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>18&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>12&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
6&63)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l&63),k+=l;switch(h){case 1:l=c[c.length-1];k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>2);k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<4&63);k+="==";break;case 2:l=(c[c.length-2]<<8)+c[c.length-1],k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>10),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>
4&63),k+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l<<2&63),k+="="}return k}})(Hc);s.ieee={read:function(e,k,h,c,l){var n;n=8*l-c-1;var a=(1<<n)-1,b=a>>1,d=-7;l=h?l-1:0;var g=h?-1:1,f=e[k+l];l+=g;h=f&(1<<-d)-1;f>>=-d;for(d+=n;0<d;h=256*h+e[k+l],l+=g,d-=8);n=h&(1<<-d)-1;h>>=-d;for(d+=c;0<d;n=256*n+e[k+l],l+=g,d-=8);if(0===h)h=1-b;else{if(h===a)return n?NaN:Infinity*(f?-1:1);n+=Math.pow(2,c);h-=b}return(f?-1:1)*n*Math.pow(2,h-c)},write:function(e,k,h,c,l,n){var a,b=8*
n-l-1,d=(1<<b)-1,g=d>>1,f=23===l?Math.pow(2,-24)-Math.pow(2,-77):0;n=c?0:n-1;var m=c?1:-1,r=0>k||0===k&&0>1/k?1:0;k=Math.abs(k);isNaN(k)||Infinity===k?(k=isNaN(k)?1:0,c=d):(c=Math.floor(Math.log(k)/Math.LN2),1>k*(a=Math.pow(2,-c))&&(c--,a*=2),k=1<=c+g?k+f/a:k+f*Math.pow(2,1-g),2<=k*a&&(c++,a/=2),c+g>=d?(k=0,c=d):1<=c+g?(k=(k*a-1)*Math.pow(2,l),c+=g):(k=k*Math.pow(2,g-1)*Math.pow(2,l),c=0));for(;8<=l;e[h+n]=k&255,n+=m,k/=256,l-=8);c=c<<l|k;for(b+=l;0<b;e[h+n]=c&255,n+=m,c/=256,b-=8);e[h+n-m]|=128*
r}};var ua=a.ieee;s.Buffer=f;s.SlowBuffer=f;s.INSPECT_MAX_BYTES=50;f.poolSize=8192;f._useTypedArrays=function(){try{var e=new ArrayBuffer(0),k=new Uint8Array(e);k.foo=function(){return 42};return 42===k.foo()&&"function"===typeof k.subarray}catch(h){return!1}}();f.isEncoding=function(e){switch(String(e).toLowerCase()){case "hex":case "utf8":case "utf-8":case "ascii":case "binary":case "base64":case "raw":case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":return!0;default:return!1}};f.isBuffer=
function(e){return!(null===e||void 0===e||!e._isBuffer)};f.byteLength=function(e,k){var h;e=e.toString();switch(k||"utf8"){case "hex":h=e.length/2;break;case "utf8":case "utf-8":h=f.utf8ToBytes(e).length;break;case "ascii":case "binary":case "raw":h=e.length;break;case "base64":h=f.base64ToBytes(e).length;break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":h=2*e.length;break;default:throw Error("Unknown encoding");}return h};f.concat=function(e,k){f.assert(f.isArray(e),"Usage: Buffer.concat(list[, length])");
if(0===e.length)return new f(0);if(1===e.length)return e[0];var h;if(void 0===k)for(h=k=0;h<e.length;h++)k+=e[h].length;var c=new f(k),l=0;for(h=0;h<e.length;h++){var n=e[h];n.copy(c,l);l+=n.length}return c};f.compare=function(e,k){f.assert(f.isBuffer(e)&&f.isBuffer(k),"Arguments must be Buffers");for(var h=e.length,c=k.length,l=0,n=Math.min(h,c);l<n&&e[l]===k[l];l++);l!==n&&(h=e[l],c=k[l]);return h<c?-1:c<h?1:0};f.hexWrite=function(e,k,h,c){h=Number(h)||0;var l=e.length-h;c?(c=Number(c),c>l&&(c=
l)):c=l;l=k.length;f.assert(0===l%2,"Invalid hex string");c>l/2&&(c=l/2);for(l=0;l<c;l++){var n=parseInt(k.substr(2*l,2),16);f.assert(!isNaN(n),"Invalid hex string");e[h+l]=n}return l};f.utf8Write=function(e,k,h,c){return f.blitBuffer(f.utf8ToBytes(k),e,h,c)};f.asciiWrite=function(e,k,h,c){return f.blitBuffer(f.asciiToBytes(k),e,h,c)};f.binaryWrite=function(e,k,h,c){return f.asciiWrite(e,k,h,c)};f.base64Write=function(e,k,h,c){return f.blitBuffer(f.base64ToBytes(k),e,h,c)};f.utf16leWrite=function(e,
k,h,c){return f.blitBuffer(f.utf16leToBytes(k),e,h,c)};f.prototype.write=function(e,k,h,c){if(isFinite(k))isFinite(h)||(c=h,h=void 0);else{var l=c;c=k;k=h;h=l}k=Number(k)||0;l=this.length-k;h?(h=Number(h),h>l&&(h=l)):h=l;c=String(c||"utf8").toLowerCase();switch(c){case "hex":e=f.hexWrite(this,e,k,h);break;case "utf8":case "utf-8":e=f.utf8Write(this,e,k,h);break;case "ascii":e=f.asciiWrite(this,e,k,h);break;case "binary":e=f.binaryWrite(this,e,k,h);break;case "base64":e=f.base64Write(this,e,k,h);break;
case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=f.utf16leWrite(this,e,k,h);break;default:throw Error("Unknown encoding");}return e};f.prototype.toString=function(e,k,h){e=String(e||"utf8").toLowerCase();k=Number(k)||0;h=void 0===h?this.length:Number(h);if(h===k)return"";switch(e){case "hex":e=f.hexSlice(this,k,h);break;case "utf8":case "utf-8":e=f.utf8Slice(this,k,h);break;case "ascii":e=f.asciiSlice(this,k,h);break;case "binary":e=f.binarySlice(this,k,h);break;case "base64":e=f.base64Slice(this,
k,h);break;case "ucs2":case "ucs-2":case "utf16le":case "utf-16le":e=this.slice(k,h);k="";for(h=0;h<e.length;h+=2)k+=String.fromCharCode(e[h]+256*e[h+1]);e=k;break;default:throw Error("Unknown encoding");}return e};f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};f.prototype.equals=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");return 0===f.compare(this,e)};f.prototype.compare=function(e){f.assert(f.isBuffer(e),"Argument must be a Buffer");
return f.compare(this,e)};f.prototype.copy=function(e,k,h,c){h||(h=0);c||0===c||(c=this.length);k||(k=0);if(c!==h&&0!==e.length&&0!==this.length)if(f.assert(c>=h,"sourceEnd < sourceStart"),f.assert(0<=k&&k<e.length,"targetStart out of bounds"),f.assert(0<=h&&h<this.length,"sourceStart out of bounds"),f.assert(0<=c&&c<=this.length,"sourceEnd out of bounds"),c>this.length&&(c=this.length),e.length-k<c-h&&(c=e.length-k+h),c-=h,100>c||!f._useTypedArrays)for(var l=0;l<c;l++)e[l+k]=this[l+h];else e._set(this.subarray(h,
h+c),k)};f.base64Slice=function(e,k,h){return 0===k&&h===e.length?Hc.fromByteArray(e):Hc.fromByteArray(e.slice(k,h))};f.utf8Slice=function(e,k,h){var c="",l="";for(h=Math.min(e.length,h);k<h;k++)127>=e[k]?(c+=f.decodeUtf8Char(l)+String.fromCharCode(e[k]),l=""):l+="%"+e[k].toString(16);return c+f.decodeUtf8Char(l)};f.asciiSlice=function(e,k,h){var c="";for(h=Math.min(e.length,h);k<h;k++)c+=String.fromCharCode(e[k]);return c};f.binarySlice=function(e,k,h){return f.asciiSlice(e,k,h)};f.hexSlice=function(e,
k,h){var c=e.length;if(!k||0>k)k=0;if(!h||0>h||h>c)h=c;for(c="";k<h;k++)c+=f.toHex(e[k]);return c};f.prototype.slice=function(e,k){var h=this.length;e=f.clamp(e,h,0);k=f.clamp(k,h,h);if(f._useTypedArrays)return f._augment(this.subarray(e,k));for(var h=k-e,c=new f(h,void 0,!0),l=0;l<h;l++)c[l]=this[l+e];return c};f.prototype.get=function(e){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(e)};f.prototype.set=function(e,k){console.log(".set() is deprecated. Access using array indexes instead.");
return this.writeUInt8(e,k)};f.prototype.readUInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]};f.readUInt16=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));c=e.length;if(!(k>=c))return h?(h=e[k],k+1<c&&(h|=e[k+1]<<8)):(h=e[k]<<8,k+1<c&&
(h|=e[k+1])),h};f.prototype.readUInt16LE=function(e,k){return f.readUInt16(this,e,!0,k)};f.prototype.readUInt16BE=function(e,k){return f.readUInt16(this,e,!1,k)};f.readUInt32=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));c=e.length;if(!(k>=c)){var l;h?(k+2<c&&(l=e[k+2]<<16),k+1<c&&(l|=e[k+1]<<8),l|=e[k],k+3<c&&(l+=e[k+3]<<24>>>0)):(k+1<c&&(l=e[k+1]<<16),
k+2<c&&(l|=e[k+2]<<8),k+3<c&&(l|=e[k+3]),l+=e[k]<<24>>>0);return l}};f.prototype.readUInt32LE=function(e,k){return f.readUInt32(this,e,!0,k)};f.prototype.readUInt32BE=function(e,k){return f.readUInt32(this,e,!1,k)};f.prototype.readInt8=function(e,k){k||(f.assert(void 0!==e&&null!==e,"missing offset"),f.assert(e<this.length,"Trying to read beyond buffer length"));if(!(e>=this.length))return this[e]&128?-1*(255-this[e]+1):this[e]};f.readInt16=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),
f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+1<e.length,"Trying to read beyond buffer length"));if(!(k>=e.length))return e=f.readUInt16(e,k,h,!0),e&32768?-1*(65535-e+1):e};f.prototype.readInt16LE=function(e,k){return f.readInt16(this,e,!0,k)};f.prototype.readInt16BE=function(e,k){return f.readInt16(this,e,!1,k)};f.readInt32=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));
if(!(k>=e.length))return e=f.readUInt32(e,k,h,!0),e&2147483648?-1*(4294967295-e+1):e};f.prototype.readInt32LE=function(e,k){return f.readInt32(this,e,!0,k)};f.prototype.readInt32BE=function(e,k){return f.readInt32(this,e,!1,k)};f.readFloat=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+3<e.length,"Trying to read beyond buffer length"));return ua.read(e,k,h,23,4)};f.prototype.readFloatLE=function(e,k){return f.readFloat(this,e,!0,k)};f.prototype.readFloatBE=
function(e,k){return f.readFloat(this,e,!1,k)};f.readDouble=function(e,k,h,c){c||(f.assert("boolean"===typeof h,"missing or invalid endian"),f.assert(k+7<e.length,"Trying to read beyond buffer length"));return ua.read(e,k,h,52,8)};f.prototype.readDoubleLE=function(e,k){return f.readDouble(this,e,!0,k)};f.prototype.readDoubleBE=function(e,k){return f.readDouble(this,e,!1,k)};f.prototype.writeUInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),
f.assert(k<this.length,"trying to write beyond buffer length"),f.verifuint(e,255));if(!(k>=this.length))return this[k]=e,k+1};f.writeUInt16=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"trying to write beyond buffer length"),f.verifuint(k,65535));var n=e.length;if(!(h>=n)){l=0;for(n=Math.min(n-h,2);l<n;l++)e[h+l]=(k&255<<8*(c?l:1-l))>>>8*(c?l:1-
l);return h+2}};f.prototype.writeUInt16LE=function(e,k,h){return f.writeUInt16(this,e,k,!0,h)};f.prototype.writeUInt16BE=function(e,k,h){return f.writeUInt16(this,e,k,!1,h)};f.writeUInt32=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"trying to write beyond buffer length"),f.verifuint(k,4294967295));var n=e.length;if(!(h>=n)){l=0;for(n=Math.min(n-
h,4);l<n;l++)e[h+l]=k>>>8*(c?l:3-l)&255;return h+4}};f.prototype.writeUInt32LE=function(e,k,h){return f.writeUInt32(this,e,k,!0,h)};f.prototype.writeUInt32BE=function(e,k,h){return f.writeUInt32(this,e,k,!1,h)};f.prototype.writeInt8=function(e,k,h){h||(f.assert(void 0!==e&&null!==e,"missing value"),f.assert(void 0!==k&&null!==k,"missing offset"),f.assert(k<this.length,"Trying to write beyond buffer length"),f.verifsint(e,127,-128));if(!(k>=this.length))return 0<=e?this.writeUInt8(e,k,h):this.writeUInt8(255+
e+1,k,h),k+1};f.writeInt16=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+1<e.length,"Trying to write beyond buffer length"),f.verifsint(k,32767,-32768));if(!(h>=e.length))return 0<=k?f.writeUInt16(e,k,h,c,l):f.writeUInt16(e,65535+k+1,h,c,l),h+2};f.prototype.writeInt16LE=function(e,k,h){return f.writeInt16(this,e,k,!0,h)};f.prototype.writeInt16BE=function(e,
k,h){return f.writeInt16(this,e,k,!1,h)};f.writeInt32=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifsint(k,2147483647,-2147483648));if(!(h>=e.length))return 0<=k?f.writeUInt32(e,k,h,c,l):f.writeUInt32(e,4294967295+k+1,h,c,l),h+4};f.prototype.writeInt32LE=function(e,k,h){return f.writeInt32(this,e,k,
!0,h)};f.prototype.writeInt32BE=function(e,k,h){return f.writeInt32(this,e,k,!1,h)};f.writeFloat=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+3<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,3.4028234663852886E38,-3.4028234663852886E38));if(!(h>=e.length))return ua.write(e,k,h,c,23,4),h+4};f.prototype.writeFloatLE=function(e,k,h){return f.writeFloat(this,
e,k,!0,h)};f.prototype.writeFloatBE=function(e,k,h){return f.writeFloat(this,e,k,!1,h)};f.writeDouble=function(e,k,h,c,l){l||(f.assert(void 0!==k&&null!==k,"missing value"),f.assert("boolean"===typeof c,"missing or invalid endian"),f.assert(void 0!==h&&null!==h,"missing offset"),f.assert(h+7<e.length,"Trying to write beyond buffer length"),f.verifIEEE754(k,1.7976931348623157E308,-1.7976931348623157E308));if(!(h>=e.length))return ua.write(e,k,h,c,52,8),h+8};f.prototype.writeDoubleLE=function(e,k,h){return f.writeDouble(this,
e,k,!0,h)};f.prototype.writeDoubleBE=function(e,k,h){return f.writeDouble(this,e,k,!1,h)};f.prototype.fill=function(e,k,h){e||(e=0);k||(k=0);h||(h=this.length);f.assert(h>=k,"end < start");if(h!==k&&0!==this.length){f.assert(0<=k&&k<this.length,"start out of bounds");f.assert(0<=h&&h<=this.length,"end out of bounds");if("number"===typeof e)for(;k<h;k++)this[k]=e;else{e=f.utf8ToBytes(e.toString());for(var c=e.length;k<h;k++)this[k]=e[k%c]}return this}};f.prototype.inspect=function(){for(var e=[],k=
this.length,h=0;h<k;h++)if(e[h]=f.toHex(this[h]),h===s.INSPECT_MAX_BYTES){e[h+1]="...";break}return"<Buffer "+e.join(" ")+">"};f.prototype.toArrayBuffer=function(){if("undefined"!==typeof Uint8Array){if(f._useTypedArrays)return(new f(this)).buffer;for(var e=new Uint8Array(this.length),k=0,h=e.length;k<h;k+=1)e[k]=this[k];return e.buffer}throw Error("Buffer.toArrayBuffer not supported in this browser");};var X=f.prototype;f._augment=function(e){e._isBuffer=!0;e._get=e.get;e._set=e.set;e.get=X.get;
e.set=X.set;e.write=X.write;e.toString=X.toString;e.toLocaleString=X.toString;e.toJSON=X.toJSON;e.equals=X.equals;e.compare=X.compare;e.copy=X.copy;e.slice=X.slice;e.readUInt8=X.readUInt8;e.readUInt16LE=X.readUInt16LE;e.readUInt16BE=X.readUInt16BE;e.readUInt32LE=X.readUInt32LE;e.readUInt32BE=X.readUInt32BE;e.readInt8=X.readInt8;e.readInt16LE=X.readInt16LE;e.readInt16BE=X.readInt16BE;e.readInt32LE=X.readInt32LE;e.readInt32BE=X.readInt32BE;e.readFloatLE=X.readFloatLE;e.readFloatBE=X.readFloatBE;e.readDoubleLE=
X.readDoubleLE;e.readDoubleBE=X.readDoubleBE;e.writeUInt8=X.writeUInt8;e.writeUInt16LE=X.writeUInt16LE;e.writeUInt16BE=X.writeUInt16BE;e.writeUInt32LE=X.writeUInt32LE;e.writeUInt32BE=X.writeUInt32BE;e.writeInt8=X.writeInt8;e.writeInt16LE=X.writeInt16LE;e.writeInt16BE=X.writeInt16BE;e.writeInt32LE=X.writeInt32LE;e.writeInt32BE=X.writeInt32BE;e.writeFloatLE=X.writeFloatLE;e.writeFloatBE=X.writeFloatBE;e.writeDoubleLE=X.writeDoubleLE;e.writeDoubleBE=X.writeDoubleBE;e.fill=X.fill;e.inspect=X.inspect;
e.toArrayBuffer=X.toArrayBuffer;return e};f.stringtrim=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")};f.clamp=function(e,k,h){if("number"!==typeof e)return h;e=~~e;if(e>=k)return k;if(0<=e)return e;e+=k;return 0<=e?e:0};f.coerce=function(e){e=~~Math.ceil(+e);return 0>e?0:e};f.isArray=function(e){return(Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)})(e)};f.isArrayish=function(e){return f.isArray(e)||f.isBuffer(e)||e&&"object"===typeof e&&"number"===
typeof e.length};f.toHex=function(e){return 16>e?"0"+e.toString(16):e.toString(16)};f.utf8ToBytes=function(e){for(var k=[],h=0;h<e.length;h++){var c=e.charCodeAt(h);if(127>=c)k.push(c);else{var l=h;55296<=c&&57343>=c&&h++;c=encodeURIComponent(e.slice(l,h+1)).substr(1).split("%");for(l=0;l<c.length;l++)k.push(parseInt(c[l],16))}}return k};f.asciiToBytes=function(e){for(var k=[],h=0;h<e.length;h++)k.push(e.charCodeAt(h)&255);return k};f.utf16leToBytes=function(e){for(var k,h,c=[],l=0;l<e.length;l++)k=
e.charCodeAt(l),h=k>>8,k%=256,c.push(k),c.push(h);return c};f.base64ToBytes=function(e){return Hc.toByteArray(e)};f.blitBuffer=function(e,k,h,c){for(var l=0;l<c&&!(l+h>=k.length||l>=e.length);l++)k[l+h]=e[l];return l};f.decodeUtf8Char=function(e){try{return decodeURIComponent(e)}catch(k){return String.fromCharCode(65533)}};f.verifuint=function(e,k){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(0<=e,"specified a negative value for writing an unsigned value");f.assert(e<=
k,"value is larger than maximum value for type");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifsint=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(e<=k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value");f.assert(Math.floor(e)===e,"value has a fractional component")};f.verifIEEE754=function(e,k,h){f.assert("number"===typeof e,"cannot write a non-number as a number");f.assert(e<=
k,"value larger than maximum allowed value");f.assert(e>=h,"value smaller than minimum allowed value")};f.assert=function(e,k){if(!e)throw Error(k||"Failed assertion");};var rc=function(){};s.Log=rc;rc.LOG=0;var Ic=a.printStackTrace,U={};s.NdnCommon=U;U.MAX_NDN_PACKET_SIZE=8800;U.getErrorWithStackTrace=function(e){return e+"\n"+Ic({e:e}).join("\n")};U.checkIndexedDb=function(e){try{var k=new Dexie("test-Dexie-support");k.version(1).stores({});k.open();setTimeout(function(){try{e(k.isOpen())}catch(c){e(!1)}},
200)}catch(h){e(!1)}};var U=a.NdnCommon,Xc=function(e,k,h,c){c=c||{};this.face=e;this.callerOnData=k;this.callerOnTimeout=h;this.maxInterestLifetime=c.maxInterestLifetime||16E3};s.ExponentialReExpress=Xc;Xc.makeOnTimeout=function(e,k,h,c){var l=new Xc(e,k,h,c);return function(c){l.onTimeout(c)}};Xc.prototype.onTimeout=function(e){var k=e.getInterestLifetimeMilliseconds();if(null==k){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(h){console.log("Error in onTimeout: "+U.getErrorWithStackTrace(h))}}else if(k*=
2,k>this.maxInterestLifetime){if(this.callerOnTimeout)try{this.callerOnTimeout(e)}catch(c){console.log("Error in onTimeout: "+U.getErrorWithStackTrace(c))}}else{e=e.clone();e.setInterestLifetimeMilliseconds(k);var l=this;this.face.expressInterest(e,this.callerOnData,function(c){l.onTimeout(c)})}};var p=function k(h,c){null==c&&(c=!0);null==h?this.buffer=null:"object"===typeof h&&h instanceof k?this.buffer=h.buffer:"string"===typeof h?this.buffer=new f(h,"utf8"):c?this.buffer=new f(h):f.isBuffer(h)?
this.buffer=h:this.buffer=new f(h);this.length=null!=this.buffer?this.buffer.length:0};s.Blob=p;p.prototype.size=function(){return null!=this.buffer?this.buffer.length:0};p.prototype.buf=function(){return this.buffer};p.prototype.isNull=function(){return null==this.buffer};p.prototype.toHex=function(){return null==this.buffer?"":this.buffer.toString("hex")};p.prototype.toString=function(){return null==this.buffer?"":this.buffer.toString("utf8")};p.prototype.equals=function(k){if(this.isNull())return k.isNull();
if(k.isNull())return!1;if(this.buffer!==k.buffer){if(this.buffer.length!=k.buffer.length)return!1;for(var h=0;h<this.buffer.length;++h)if(this.buffer[h]!=k.buffer[h])return!1}return!0};var p=a.Blob,Ka=function h(c,l,n){p.call(this,c);null==this.buffer?this.signedPortionEndOffset=this.signedPortionBeginOffset=0:"object"===typeof c&&c instanceof h?(this.signedPortionBeginOffset=null==l?c.signedPortionBeginOffset:l,this.signedPortionEndOffset=null==n?c.signedPortionEndOffset:n):(this.signedPortionBeginOffset=
l||0,this.signedPortionEndOffset=n||0);this.signedBuffer=null==this.buffer?null:this.buffer.slice(this.signedPortionBeginOffset,this.signedPortionEndOffset)};Ka.prototype=new p;Ka.prototype.name="SignedBlob";s.SignedBlob=Ka;Ka.prototype.signedSize=function(){return null!=this.signedBuffer?this.signedBuffer.length:0};Ka.prototype.signedBuf=function(){return this.signedBuffer};Ka.prototype.getSignedPortionBeginOffset=function(){return this.signedPortionBeginOffset};Ka.prototype.getSignedPortionEndOffset=
function(){return this.signedPortionEndOffset};var Qa=function(h){h||(h=16);this.array=new f(h)};s.DynamicBuffer=Qa;Qa.prototype.ensureLength=function(h){if(!(this.array.length>=h)){var c=2*this.array.length;h>c&&(c=h);h=new f(c);this.array.copy(h);this.array=h}};Qa.prototype.copy=function(h,c){this.ensureLength(h.length+c);f.isBuffer(h)?h.copy(this.array,c):(new f(h)).copy(this.array,c);return c+h.length};Qa.prototype.ensureLengthFromBack=function(h){if(!(this.array.length>=h)){var c=2*this.array.length;
h>c&&(c=h);h=new f(c);this.array.copy(h,h.length-this.array.length);this.array=h}};Qa.prototype.copyFromBack=function(h,c){this.ensureLengthFromBack(c);f.isBuffer(h)?h.copy(this.array,this.array.length-c):(new f(h)).copy(this.array,this.array.length-c)};Qa.prototype.slice=function(h,c){return void 0==c?this.array.slice(h):this.array.slice(h,c)};var ha=function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};s.ChangeCounter=ha;ha.prototype.get=function(){return this.target};ha.prototype.set=
function(h){this.target=h;this.changeCount=null==h?0:h.getChangeCount()};ha.prototype.checkChanged=function(){if(null==this.target)return!1;var h=this.target.getChangeCount();return this.changeCount!=h?(this.changeCount=h,!0):!1};var U=a.NdnCommon,g=function(h,c){this.value=h;this.isRejected=c};s.SyncPromise=g;g.prototype.then=function(h,c){if(this.isRejected)if(c)try{return c(this.value)}catch(l){return new g(l,!0)}else return this;else if(h)try{return h(this.value)}catch(n){return new g(n,!0)}else return this};
g.prototype.catch=function(h){return this.then(void 0,h)};g.resolve=function(h){return new g(h,!1)};g.reject=function(h){return new g(h,!0)};g.getValue=function(h){if(h instanceof g){if(h.isRejected)throw h.value;return h.value}throw Error("Cannot return immediately because promise is not a SyncPromise");};g.complete=function(h,c,l){var n;l?n=c:(l=c,n=null);if(h)l.then(function(c){try{h(c)}catch(l){console.log("Error in onComplete: "+U.getErrorWithStackTrace(l))}},function(c){if(n)try{n(c)}catch(h){console.log("Error in onError: "+
U.getErrorWithStackTrace(h))}else{if(l instanceof g)throw c;console.log("Uncaught exception from a Promise: "+U.getErrorWithStackTrace(c))}});else return g.getValue(l)};var H={};s.DataUtils=H;H.keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";H.stringtoBase64=function(h){var c="",l,n,a="",b,d,g="",f=0;do l=h.charCodeAt(f++),n=h.charCodeAt(f++),a=h.charCodeAt(f++),b=l>>2,l=(l&3)<<4|n>>4,d=(n&15)<<2|a>>6,g=a&63,isNaN(n)?d=g=64:isNaN(a)&&(g=64),c=c+H.keyStr.charAt(b)+H.keyStr.charAt(l)+
H.keyStr.charAt(d)+H.keyStr.charAt(g);while(f<h.length);return c};H.base64toString=function(h){var c="",l,n,a="",b,d="",g=0;/[^A-Za-z0-9\+\/\=]/g.exec(h)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding.");h=h.replace(/[^A-Za-z0-9\+\/\=]/g,"");do l=H.keyStr.indexOf(h.charAt(g++)),n=H.keyStr.indexOf(h.charAt(g++)),b=H.keyStr.indexOf(h.charAt(g++)),d=H.keyStr.indexOf(h.charAt(g++)),l=l<<2|n>>4,n=(n&
15)<<4|b>>2,a=(b&3)<<6|d,c+=String.fromCharCode(l),64!=b&&(c+=String.fromCharCode(n)),64!=d&&(c+=String.fromCharCode(a));while(g<h.length);return c};H.toHex=function(h){return h.toString("hex")};H.stringToHex=function(h){for(var c="",l=0;l<h.length;++l)var n=h.charCodeAt(l),c=c+((16>n?"0":"")+n.toString(16));return c};H.toString=function(h){return h.toString("binary")};H.toNumbers=function(h){return new f(h,"hex")};H.hexToRawString=function(h){if("string"==typeof h){var c="";h.replace(/(..)/g,function(h){c+=
String.fromCharCode(parseInt(h,16))});return c}};H.toNumbersFromString=function(h){return new f(h,"binary")};H.toNumbersIfString=function(h){return"string"===typeof h?new f(h,"binary"):h};H.stringToUtf8Array=function(h){return new f(h,"utf8")};H.concatArrays=function(h){return f.concat(h)};H.decodeUtf8=function(h){for(var c="",l=0,n=0,a=0;l<h.length;)if(n=h.charCodeAt(l),128>n)c+=String.fromCharCode(n),l++;else if(191<n&&224>n)a=h.charCodeAt(l+1),c+=String.fromCharCode((n&31)<<6|a&63),l+=2;else var a=
h.charCodeAt(l+1),b=h.charCodeAt(l+2),c=c+String.fromCharCode((n&15)<<12|(a&63)<<6|b&63),l=l+3;return c};H.arraysEqual=function(h,c){if(!h.slice)throw Error("DataUtils.arraysEqual: a1 is not an array");if(!c.slice)throw Error("DataUtils.arraysEqual: a2 is not an array");if(h.length!=c.length)return!1;for(var l=0;l<h.length;++l)if(h[l]!=c[l])return!1;return!0};H.bigEndianToUnsignedInt=function(h){for(var c=0,l=0;l<h.length;++l)c*=256,c+=h[l];return c};H.nonNegativeIntToBigEndian=function(h){h=Math.round(h);
if(0>=h)return new f(0);for(var c=new f(8),l=0;0!=h;)++l,c[8-l]=h&255,h=Math.floor(h/256);return c.slice(8-l,8)};H.shuffle=function(h){for(var c=h.length-1;1<=c;--c){var l=Math.floor(Math.random()*(c+1)),n=h[c];h[c]=h[l];h[l]=n}};H.privateKeyPemToDer=function(h){h=h.split("\n");for(var c="",l=1;l<h.length-1;l++)c+=h[l];return new f(c,"base64")};M.prototype=Error();M.prototype.name="DecodingException";s.DecodingException=M;var m=function(){};s.Tlv=m;m.Interest=5;m.Data=6;m.Name=7;m.ImplicitSha256DigestComponent=
1;m.ParametersSha256DigestComponent=2;m.NameComponent=8;m.Selectors=9;m.Nonce=10;m.InterestLifetime=12;m.MinSuffixComponents=13;m.MaxSuffixComponents=14;m.PublisherPublicKeyLocator=15;m.Exclude=16;m.ChildSelector=17;m.MustBeFresh=18;m.Any=19;m.MetaInfo=20;m.Content=21;m.SignatureInfo=22;m.SignatureValue=23;m.ContentType=24;m.FreshnessPeriod=25;m.FinalBlockId=26;m.SignatureType=27;m.KeyLocator=28;m.KeyLocatorDigest=29;m.ForwardingHint=30;m.SelectedDelegation=32;m.CanBePrefix=33;m.HopLimit=34;m.ApplicationParameters=
36;m.SignatureType_DigestSha256=0;m.SignatureType_SignatureSha256WithRsa=1;m.SignatureType_SignatureSha256WithEcdsa=3;m.SignatureType_SignatureHmacWithSha256=4;m.ContentType_Default=0;m.ContentType_Link=1;m.ContentType_Key=2;m.NfdCommand_ControlResponse=101;m.NfdCommand_StatusCode=102;m.NfdCommand_StatusText=103;m.ControlParameters_ControlParameters=104;m.ControlParameters_FaceId=105;m.ControlParameters_Uri=114;m.ControlParameters_LocalUri=129;m.ControlParameters_LocalControlFeature=110;m.ControlParameters_Origin=
111;m.ControlParameters_Cost=106;m.ControlParameters_Capacity=131;m.ControlParameters_Count=132;m.ControlParameters_BaseCongestionMarkingInterval=135;m.ControlParameters_DefaultCongestionThreshold=136;m.ControlParameters_Mtu=137;m.ControlParameters_Flags=108;m.ControlParameters_Mask=112;m.ControlParameters_Strategy=107;m.ControlParameters_ExpirationPeriod=109;m.LpPacket_LpPacket=100;m.LpPacket_Fragment=80;m.LpPacket_Sequence=81;m.LpPacket_FragIndex=82;m.LpPacket_FragCount=83;m.LpPacket_Nack=800;m.LpPacket_NackReason=
801;m.LpPacket_NextHopFaceId=816;m.LpPacket_IncomingFaceId=817;m.LpPacket_CachePolicy=820;m.LpPacket_CachePolicyType=821;m.LpPacket_CongestionMark=832;m.LpPacket_IGNORE_MIN=800;m.LpPacket_IGNORE_MAX=959;m.Link_Preference=30;m.Link_Delegation=31;m.Encrypt_EncryptedContent=130;m.Encrypt_EncryptionAlgorithm=131;m.Encrypt_EncryptedPayload=132;m.Encrypt_InitialVector=133;m.Encrypt_EncryptedPayloadKey=134;m.SafeBag_SafeBag=128;m.SafeBag_EncryptedKeyBag=129;m.Encrypt_StartDate=134;m.Encrypt_EndDate=135;
m.Encrypt_IntervalStartHour=136;m.Encrypt_IntervalEndHour=137;m.Encrypt_NRepeats=138;m.Encrypt_RepeatUnit=139;m.Encrypt_RepetitiveInterval=140;m.Encrypt_WhiteIntervalList=141;m.Encrypt_BlackIntervalList=142;m.Encrypt_Schedule=143;m.ValidityPeriod_ValidityPeriod=253;m.ValidityPeriod_NotBefore=254;m.ValidityPeriod_NotAfter=255;m.getHighBytes=function(h){return(h-h%4294967296)/4294967296};var Qa=a.DynamicBuffer,m=a.Tlv,la=function(h){this.output=new Qa(h||16);this.length=0};s.TlvEncoder=la;la.prototype.getLength=
function(){return this.length};la.prototype.writeVarNumber=function(h){if(253>h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=3;this.output.ensureLengthFromBack(this.length);var c=this.output.array.length-this.length;this.output.array[c]=253;this.output.array[c+1]=h>>8&255;this.output.array[c+2]=h&255}else if(4294967295>=h)this.length+=5,this.output.ensureLengthFromBack(this.length),c=this.output.array.length-
this.length,this.output.array[c]=254,this.output.array[c+1]=h>>24&255,this.output.array[c+2]=h>>16&255,this.output.array[c+3]=h>>8&255,this.output.array[c+4]=h&255;else{this.length+=9;this.output.ensureLengthFromBack(this.length);c=this.output.array.length-this.length;this.output.array[c]=255;var l=m.getHighBytes(h);this.output.array[c+1]=l>>24&255;this.output.array[c+2]=l>>16&255;this.output.array[c+3]=l>>8&255;this.output.array[c+4]=l&255;this.output.array[c+5]=h>>24&255;this.output.array[c+6]=
h>>16&255;this.output.array[c+7]=h>>8&255;this.output.array[c+8]=h&255}};la.prototype.writeTypeAndLength=function(h,c){this.writeVarNumber(c);this.writeVarNumber(h)};la.prototype.writeNonNegativeInteger=function(h){if(0>h)throw Error("TLV integer value may not be negative");h=Math.round(h);if(255>=h)this.length+=1,this.output.ensureLengthFromBack(this.length),this.output.array[this.output.array.length-this.length]=h&255;else if(65535>=h){this.length+=2;this.output.ensureLengthFromBack(this.length);
var c=this.output.array.length-this.length;this.output.array[c]=h>>8&255;this.output.array[c+1]=h&255}else if(4294967295>=h)this.length+=4,this.output.ensureLengthFromBack(this.length),c=this.output.array.length-this.length,this.output.array[c]=h>>24&255,this.output.array[c+1]=h>>16&255,this.output.array[c+2]=h>>8&255,this.output.array[c+3]=h&255;else{this.length+=8;this.output.ensureLengthFromBack(this.length);var c=this.output.array.length-this.length,l=m.getHighBytes(h);this.output.array[c]=l>>
24&255;this.output.array[c+1]=l>>16&255;this.output.array[c+2]=l>>8&255;this.output.array[c+3]=l&255;this.output.array[c+4]=h>>24&255;this.output.array[c+5]=h>>16&255;this.output.array[c+6]=h>>8&255;this.output.array[c+7]=h&255}};la.prototype.writeNonNegativeIntegerTlv=function(h,c){var l=this.length;this.writeNonNegativeInteger(c);this.writeTypeAndLength(h,this.length-l)};la.prototype.writeOptionalNonNegativeIntegerTlv=function(h,c){null!=c&&0<=c&&this.writeNonNegativeIntegerTlv(h,c)};la.prototype.writeBuffer=
function(h){null!=h&&(this.length+=h.length,this.output.copyFromBack(h,this.length))};la.prototype.writeBlobTlv=function(h,c){null==c?this.writeTypeAndLength(h,0):(this.writeBuffer(c),this.writeTypeAndLength(h,c.length))};la.prototype.writeOptionalBlobTlv=function(h,c){null!=c&&0<c.length&&this.writeBlobTlv(h,c)};la.prototype.getOutput=function(){return this.output.array.slice(this.output.array.length-this.length)};var M=a.DecodingException,ja=function(h){this.input=h;this.offset=0};s.TlvDecoder=
ja;ja.prototype.readVarNumber=function(){var h=this.input[this.offset];this.offset+=1;return 253>h?h:this.readExtendedVarNumber(h)};ja.prototype.readExtendedVarNumber=function(h){253==h?(h=(this.input[this.offset]<<8)+this.input[this.offset+1],this.offset+=2):254==h?(h=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3],this.offset+=4):(h=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+
2]<<8)+this.input[this.offset+3])+(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7],this.offset+=8);return h};ja.prototype.readTypeAndLength=function(h){if(this.readVarNumber()!=h)throw new M(Error("Did not get the expected TLV type"));h=this.readVarNumber();if(this.offset+h>this.input.length)throw new M(Error("TLV length exceeds the buffer length"));return h};ja.prototype.readNestedTlvsStart=function(h){return this.readTypeAndLength(h)+
this.offset};ja.prototype.finishNestedTlvs=function(h,c){if(this.offset!=h){for(void 0==c&&(c=!1);this.offset<h;){var l=this.readVarNumber();if((31>=l||1==(l&1))&&!c)throw new M(Error("Unrecognized critical type code "+l));l=this.readVarNumber();this.offset+=l;if(this.offset>this.input.length)throw new M(Error("TLV length exceeds the buffer length"));}if(this.offset!=h)throw new M(Error("TLV length does not equal the total length of the nested TLVs"));}};ja.prototype.peekType=function(h,c){if(this.offset>=
c)return!1;var l=this.offset,n=this.readVarNumber();this.offset=l;return n==h};ja.prototype.readNonNegativeInteger=function(h){var c;if(1==h)c=this.input[this.offset];else if(2==h)c=(this.input[this.offset]<<8)+this.input[this.offset+1];else if(4==h)c=Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<8)+this.input[this.offset+3];else if(8==h)c=4294967296*(Math.abs(this.input[this.offset]<<24)+(this.input[this.offset+1]<<16)+(this.input[this.offset+2]<<
8)+this.input[this.offset+3])+Math.abs(this.input[this.offset+4]<<24)+(this.input[this.offset+5]<<16)+(this.input[this.offset+6]<<8)+this.input[this.offset+7];else throw new M(Error("Invalid length for a TLV nonNegativeInteger"));this.offset+=h;return c};ja.prototype.readNonNegativeIntegerTlv=function(h){h=this.readTypeAndLength(h);return this.readNonNegativeInteger(h)};ja.prototype.readOptionalNonNegativeIntegerTlv=function(h,c){return this.peekType(h,c)?this.readNonNegativeIntegerTlv(h):null};ja.prototype.readBlobTlv=
function(h){h=this.readTypeAndLength(h);var c=this.input.slice(this.offset,this.offset+h);this.offset+=h;return c};ja.prototype.readOptionalBlobTlv=function(h,c){return this.peekType(h,c)?this.readBlobTlv(h):null};ja.prototype.readBooleanTlv=function(h,c){if(this.peekType(h,c)){var l=this.readTypeAndLength(h);this.offset+=l;return!0}return!1};ja.prototype.skipTlv=function(h){h=this.readTypeAndLength(h);this.offset+=h};ja.prototype.skipOptionalTlv=function(h,c){this.peekType(h,c)&&this.skipTlv(h)};
ja.prototype.getOffset=function(){return this.offset};ja.prototype.seek=function(h){this.offset=h};ja.prototype.getSlice=function(h,c){return this.input.slice(h,c)};var ja=a.TlvDecoder,C=function c(){this.gotElementEnd_=!1;this.offset_=0;this.state_=c.READ_TYPE;this.headerLength_=0;this.useHeaderBuffer_=!1;this.headerBuffer_=new f(8);this.nBytesToRead_=0};s.TlvStructureDecoder=C;C.READ_TYPE=0;C.READ_TYPE_BYTES=1;C.READ_LENGTH=2;C.READ_LENGTH_BYTES=3;C.READ_VALUE_BYTES=4;C.prototype.findElementEnd=
function(c){if(this.gotElementEnd_)return!0;for(var l=new ja(c);;){if(this.offset_>=c.length)return!1;if(this.state_==C.READ_TYPE){var n=c[this.offset_];this.offset_+=1;253>n?this.state_=C.READ_LENGTH:(this.nBytesToRead_=253==n?2:254==n?4:8,this.state_=C.READ_TYPE_BYTES)}else if(this.state_==C.READ_TYPE_BYTES){n=c.length-this.offset_;if(n<this.nBytesToRead_)return this.offset_+=n,this.nBytesToRead_-=n,!1;this.offset_+=this.nBytesToRead_;this.state_=C.READ_LENGTH}else if(this.state_==C.READ_LENGTH)if(n=
c[this.offset_],this.offset_+=1,253>n){this.nBytesToRead_=n;if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=C.READ_VALUE_BYTES}else this.nBytesToRead_=253==n?2:254==n?4:8,this.firstOctet_=n,this.state_=C.READ_LENGTH_BYTES;else if(this.state_==C.READ_LENGTH_BYTES){n=c.length-this.offset_;if(!this.useHeaderBuffer_&&n>=this.nBytesToRead_)l.seek(this.offset_),this.nBytesToRead_=l.readExtendedVarNumber(this.firstOctet_),this.offset_=l.getOffset();else{this.useHeaderBuffer_=!0;var a=
this.nBytesToRead_-this.headerLength_;if(a>n){if(this.headerLength_+n>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");c.slice(this.offset_,this.offset_+n).copy(this.headerBuffer_,this.headerLength_);this.offset_+=n;this.headerLength_+=n;return!1}if(this.headerLength_+a>this.headerBuffer_.length)throw Error("Cannot store more header bytes than the size of headerBuffer");c.slice(this.offset_,this.offset_+a).copy(this.headerBuffer_,this.headerLength_);
this.offset_+=a;this.nBytesToRead_=(new ja(this.headerBuffer_)).readExtendedVarNumber(this.firstOctet_)}if(0==this.nBytesToRead_)return this.gotElementEnd_=!0;this.state_=C.READ_VALUE_BYTES}else{if(this.state_==C.READ_VALUE_BYTES){n=c.length-this.offset_;if(n<this.nBytesToRead_)return this.offset_+=n,this.nBytesToRead_-=n,!1;this.offset_+=this.nBytesToRead_;return this.gotElementEnd_=!0}throw Error("findElementEnd: unrecognized state");}}};C.prototype.getOffset=function(){return this.offset_};C.prototype.seek=
function(c){this.offset_=c};var la=a.TlvEncoder,ja=a.TlvDecoder,p=a.Blob,b=a.Name,Ra=function(){};s.ProtobufTlv=Ra;Ra._Field=null;Ra.establishField=function(){if(null===Ra._Field)try{Ra._Field=dcodeIO.ProtoBuf.Reflect.Message.Field}catch(c){Ra._Field=a.Reflect.Message.Field}};Ra.encode=function(c,l){Ra.establishField();c.encodeAB();var n=new la;Ra._encodeMessageValue(c,l,n);return new p(n.getOutput(),!1)};Ra.decode=function(c,l,n){Ra.establishField();n="object"===typeof n&&n instanceof p?n.buf():
n;var a=new ja(n);Ra._decodeMessageValue(c,l,a,n.length)};Ra._encodeMessageValue=function(c,l,n){l=l.getChildren(Ra._Field);for(var a=l.length-1;0<=a;--a){var b=l[a],d=b.id,g;if(b.repeated)g=c[b.name];else if(null!=c[b.name])g=[c[b.name]];else continue;for(var m=g.length-1;0<=m;--m){var r=g[m];if("message"==b.type.name){var q=n.getLength();Ra._encodeMessageValue(r,b.resolvedType,n);n.writeTypeAndLength(d,n.getLength()-q)}else if("uint32"==b.type.name||"uint64"==b.type.name)n.writeNonNegativeIntegerTlv(d,
r);else if("enum"==b.type.name){if(0>r)throw Error("ProtobufTlv.encode: ENUM value may not be negative");n.writeNonNegativeIntegerTlv(d,r)}else if("bytes"==b.type.name)q=r.toBuffer(),void 0==q.length&&(q=new Uint8Array(r.toArrayBuffer())),n.writeBlobTlv(d,q);else if("string"==b.type.name)n.writeBlobTlv(d,(new p(r,!1)).buf());else if("bool"==b.type.name)r&&n.writeTypeAndLength(d,0);else if("double"==b.type.name)q=new f(8),q.writeDoubleLE(r,0),n.writeBlobTlv(d,q);else throw Error("ProtobufTlv.encode: Unknown field type");
}}};Ra._decodeMessageValue=function(c,l,n,a){l=l.getChildren(Ra._Field);for(var b=0;b<l.length;++b){var d=l[b],g=d.id;if(d.required||n.peekType(g,a))if(d.repeated)for(;n.peekType(g,a);)if("message"==d.type.name){var f=n.readNestedTlvsStart(g),m=new (d.resolvedType.build());c.add(d.name,m);Ra._decodeMessageValue(m,d.resolvedType,n,f);n.finishNestedTlvs(f)}else c.add(d.name,Ra._decodeFieldValue(d,g,n,a));else"message"==d.type.name?(f=n.readNestedTlvsStart(g),m=new (d.resolvedType.build()),c.set(d.name,
m),Ra._decodeMessageValue(m,d.resolvedType,n,f),n.finishNestedTlvs(f)):c.set(d.name,Ra._decodeFieldValue(d,g,n,a))}};Ra._decodeFieldValue=function(c,l,n,a){if("uint32"==c.type.name||"uint64"==c.type.name||"enum"==c.type.name)return n.readNonNegativeIntegerTlv(l);if("bytes"==c.type.name)return n.readBlobTlv(l);if("string"==c.type.name)return n.readBlobTlv(l).toString();if("bool"==c.type.name)return n.readBooleanTlv(l,a);if("double"==c.type.name)return n.readBlobTlv(l).readDoubleLE(0);throw Error("ProtobufTlv.decode: Unknown field type");
};Ra.toName=function(c){for(var l=new b,n=0;n<c.length;++n)l.append(new p(new f(c[n].toBinary(),"binary"),!1));return l};var La=function(c){if("string"===typeof c){c=c.split(".");this.oid=[];for(var l=0;l<c.length;++l)this.oid.push(parseInt(c[l]))}else this.oid=c.slice(0,c.length)};s.OID=La;La.prototype.getIntegerList=function(){return this.oid};La.prototype.setIntegerList=function(c){this.oid=c.slice(0,c.length)};La.prototype.toString=function(){for(var c="",l=0;l<this.oid.length;++l)0!==l&&(c+=
"."),c+=this.oid[l];return c};La.prototype.equals=function(c){if(!(c instanceof La)||this.oid.length!==c.oid.length)return!1;for(var l=0;l<this.oid.length;++l)if(this.oid[l]!=c.oid[l])return!1;return!0};var r=function(){};s.WireFormat=r;r.prototype.encodeName=function(c){throw Error("encodeName is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeName=function(c,l,n){throw Error("decodeName is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeInterest=function(c){throw Error("encodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeInterest=function(c,l,n){throw Error("decodeInterest is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeData=function(c){throw Error("encodeData is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeData=function(c,l,n){throw Error("decodeData is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeControlParameters=function(c){throw Error("encodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeControlParameters=function(c,l,n){throw Error("decodeControlParameters is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeControlResponse=function(c){throw Error("encodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.decodeControlResponse=function(c,l,n){throw Error("decodeControlResponse is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.encodeSignatureInfo=function(c){throw Error("encodeSignatureInfo is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeSignatureInfoAndValue=function(c,l,n){throw Error("decodeSignatureInfoAndValue is unimplemented in the base WireFormat class.  You should use a derived class.");
};r.prototype.encodeSignatureValue=function(c){throw Error("encodeSignatureValue is unimplemented in the base WireFormat class.  You should use a derived class.");};r.prototype.decodeLpPacket=function(c,l,n){throw Error("decodeLpPacket is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.encodeDelegationSet=function(c){throw Error("encodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.decodeDelegationSet=
function(c,l,n){throw Error("decodeDelegationSet is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.encodeEncryptedContentV2=function(c){throw Error("encodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};r.prototype.decodeEncryptedContentV2=function(c,l,n){throw Error("decodeEncryptedContentV2 is unimplemented in the base WireFormat class. You should use a derived class.");};r.setDefaultWireFormat=function(c){r.defaultWireFormat=
c};r.getDefaultWireFormat=function(){return r.defaultWireFormat};r.toIsoString=function(c){c=new Date(Math.round(c));return c.getUTCFullYear()+r.to2DigitString(c.getUTCMonth()+1)+r.to2DigitString(c.getUTCDate())+"T"+r.to2DigitString(c.getUTCHours())+r.to2DigitString(c.getUTCMinutes())+r.to2DigitString(c.getUTCSeconds())};r.to2DigitString=function(c){c=c.toString();return 1===c.length?"0"+c:c};r.fromIsoString=function(c){if(15!=c.length||"T"!=c.substr(8,1))throw Error("fromIsoString: Format is not the expected yyyymmddThhmmss");
return Date.UTC(parseInt(c.substr(0,4)),parseInt(c.substr(4,2)-1),parseInt(c.substr(6,2)),parseInt(c.substr(9,2)),parseInt(c.substr(11,2)),parseInt(c.substr(13,2)))};var ab=a.TlvWireFormat,H=a.DataUtils,m=a.Tlv,C=a.TlvStructureDecoder,M=a.DecodingException,U=a.NdnCommon,d=a.Log.LOG,fc=function(c){this.elementListener_=c;this.dataParts_=[];this.tlvStructureDecoder_=new C};s.ElementReader=fc;fc.prototype.onReceivedData=function(c){for(;;){var l,n;try{if(0===this.dataParts_.length&&0>=c.length)break;
this.tlvStructureDecoder_.seek(0);l=this.tlvStructureDecoder_.findElementEnd(c);n=this.tlvStructureDecoder_.getOffset()}catch(a){throw this.dataParts_=[],this.tlvStructureDecoder_=new C,a;}if(l){var b;0===this.dataParts_.length?b=c.slice(0,n):(this.dataParts_.push(c.slice(0,n)),b=H.concatArrays(this.dataParts_),this.dataParts_=[]);c=c.slice(n,c.length);this.tlvStructureDecoder_=new C;this.elementListener_.onReceivedElement(b);if(0==c.length)break}else{l=c.length;for(n=0;n<this.dataParts_.length;++n)l+=
this.dataParts_[n].length;if(l>U.MAX_NDN_PACKET_SIZE)throw this.dataParts_=[],this.tlvStructureDecoder_=new C,new M(Error("The incoming packet exceeds the maximum limit Face.getMaxNdnPacketSize()"));this.dataParts_.push(new f(c));3<d&&console.log("Incomplete packet received. Length "+c.length+". Wait for more input.");break}}};ma.prototype=Error();ma.prototype.name="DerDecodingException";s.DerDecodingException=ma;rb.prototype=Error();rb.prototype.name="DerEncodingException";s.DerEncodingException=
rb;var A=function(){};s.DerNodeType=A;A.Eoc=0;A.Boolean=1;A.Integer=2;A.BitString=3;A.OctetString=4;A.Null=5;A.ObjectIdentifier=6;A.ObjectDescriptor=7;A.External=40;A.Real=9;A.Enumerated=10;A.EmbeddedPdv=43;A.Utf8String=12;A.RelativeOid=13;A.Sequence=48;A.Set=49;A.NumericString=18;A.PrintableString=19;A.T61String=20;A.VideoTexString=21;A.Ia5String=22;A.UtcTime=23;A.GeneralizedTime=24;A.GraphicString=25;A.VisibleString=26;A.GeneralString=27;A.UniversalString=28;A.CharacterString=29;A.BmpString=30;
var Qa=a.DynamicBuffer,p=a.Blob,ma=a.DerDecodingException,rb=a.DerEncodingException,A=a.DerNodeType,q=function(c){this.nodeType_=c;this.parent_=null;this.header_=new f(0);this.payload_=new Qa(0);this.payloadPosition_=0};s.DerNode=q;q.prototype.getSize=function(){return this.header_.length+this.payloadPosition_};q.prototype.encodeHeader=function(c){var l=new Qa(10),n=0;l.array[n++]=this.nodeType_;if(0>c)throw Error("encodeHeader: DER object has negative length");if(127>=c)l.array[n++]=c&255;else{var a=
new Qa(10),b=c;for(c=0;0!=b;)++c,a.ensureLengthFromBack(c),a.array[a.array.length-c]=b&255,b>>=8;b=c+1;a.ensureLengthFromBack(b);a.array[a.array.length-b]=(128|c)&255;l.copy(a.slice(a.array.length-b),n);n+=b}this.header_=l.slice(0,n)};q.prototype.decodeHeader=function(c,l){var n=l,a=c[n]&255,n=n+1;this.nodeType_=a;var b=c[n]&255,n=n+1,d=new Qa(10),g=0;d.array[g++]=a;a=d.array[g++]=b;if(0!=(b&128))for(b&=127,a=0;0<b;){if(c.length<=n)throw new ma("DerNode.decodeHeader: The input length is too small");
var f=c[n],n=n+1;d.ensureLength(g+1);d.array[g++]=f;a=256*a+(f&255);b-=1}this.header_=d.slice(0,g);return a};q.prototype.encode=function(){var c=new f(this.getSize());this.header_.copy(c);this.payload_.slice(0,this.payloadPosition_).copy(c,this.header_.length);return new p(c,!1)};q.prototype.decode=function(c,l){var n=l,a=this.decodeHeader(c,n),b=this.header_.length;0<a&&(n+=b,this.payloadAppend(c.slice(n,n+a)))};q.prototype.payloadAppend=function(c){this.payloadPosition_=this.payload_.copy(c,this.payloadPosition_)};
q.parse=function(c,l){void 0==l&&(l=0);if(c.length<=l)throw new ma("DerNode.parse: The input length is too small");var n=c[l]&255;if(n===A.Boolean)n=new q.DerBoolean;else if(n===A.Integer)n=new q.DerInteger;else if(n===A.BitString)n=new q.DerBitString;else if(n===A.OctetString)n=new q.DerOctetString;else if(n===A.Null)n=new q.DerNull;else if(n===A.ObjectIdentifier)n=new q.DerOid;else if(n===A.Sequence)n=new q.DerSequence;else if(n===A.PrintableString)n=new q.DerPrintableString;else if(n===A.GeneralizedTime)n=
new q.DerGeneralizedTime;else throw new ma(Error("Unimplemented DER type "+n));n.decode(c,l);return n};q.prototype.toVal=function(){return this.encode()};q.prototype.getPayload=function(){return new p(this.payload_.slice(0,this.payloadPosition_),!0)};q.prototype.getChildren=function(){throw new ma(Error("getChildren: This DerNode is not DerSequence"));};q.getSequence=function(c,l){if(0>l||l>=c.length)throw new ma(Error("getSequence: Child index is out of bounds"));if(!(c[l]instanceof q.DerSequence))throw new ma(Error("getSequence: Child DerNode is not a DerSequence"));
return c[l]};q.DerStructure=function(c){q.call(this,c);this.childChanged_=!1;this.nodeList_=[];this.size_=0};q.DerStructure.prototype=new q;q.DerStructure.prototype.name="DerStructure";q.DerStructure.prototype.getSize=function(){this.childChanged_&&(this.updateSize(),this.childChanged_=!1);this.encodeHeader(this.size_);return this.size_+this.header_.length};q.DerStructure.prototype.getChildren=function(){return this.nodeList_};q.DerStructure.prototype.updateSize=function(){for(var c=0,l=0;l<this.nodeList_.length;++l)c+=
this.nodeList_[l].getSize();this.size_=c;this.childChanged_=!1};q.DerStructure.prototype.addChild=function(c,l){c.parent_=this;this.nodeList_.push(c);l&&null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};q.DerStructure.prototype.setChildChanged=function(){null!=this.parent_&&this.parent_.setChildChanged();this.childChanged_=!0};q.DerStructure.prototype.encode=function(){var c=new Qa(10),l=0;this.updateSize();this.encodeHeader(this.size_);for(var l=c.copy(this.header_,l),n=0;n<
this.nodeList_.length;++n)var a=this.nodeList_[n].encode(),l=c.copy(a.buf(),l);return new p(c.slice(0,l),!1)};q.DerStructure.prototype.decode=function(c,l){var n=l;this.size_=this.decodeHeader(c,n);for(var n=n+this.header_.length,a=0;a<this.size_;){var b=q.parse(c,n),d=b.getSize(),n=n+d,a=a+d;this.addChild(b,!1)}};q.DerByteString=function(c,l){q.call(this,l);null!=c&&(this.payloadAppend(c),this.encodeHeader(c.length))};q.DerByteString.prototype=new q;q.DerByteString.prototype.name="DerByteString";
q.DerByteString.prototype.toVal=function(){return this.getPayload()};q.DerBoolean=function(c){q.call(this,A.Boolean);void 0!=c&&(c=c?255:0,this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=c,this.encodeHeader(1))};q.DerBoolean.prototype=new q;q.DerBoolean.prototype.name="DerBoolean";q.DerBoolean.prototype.toVal=function(){return 0!=this.payload_.array[0]};q.DerInteger=function(c){q.call(this,A.Integer);if(void 0!=c){if(f.isBuffer(c)){if(0<c.length&&128<=
c[0])throw new rb(Error("DerInteger: Negative integers are not currently supported"));0==c.length?this.payloadAppend(new f([0])):this.payloadAppend(c)}else{c=Math.round(c);if(0>c)throw new rb(Error("DerInteger: Negative integers are not currently supported"));for(var l=new Qa(10),n=0;!(++n,l.ensureLengthFromBack(n),l.array[l.array.length-n]=c&255,c>>=8,0>=c););128<=l.array[l.array.length-n]&&(++n,l.ensureLengthFromBack(n),l.array[l.array.length-n]=0);this.payloadAppend(l.slice(l.array.length-n))}this.encodeHeader(this.payloadPosition_)}};
q.DerInteger.prototype=new q;q.DerInteger.prototype.name="DerInteger";q.DerInteger.prototype.toVal=function(){if(0<this.payloadPosition_&&128<=this.payload_.array[0])throw new ma(Error("DerInteger: Negative integers are not currently supported"));for(var c=0,l=0;l<this.payloadPosition_;++l)c<<=8,c+=this.payload_.array[l];return c};q.DerBitString=function(c,l){q.call(this,A.BitString);void 0!=c&&(this.payload_.ensureLength(this.payloadPosition_+1),this.payload_.array[this.payloadPosition_++]=l&255,
this.payloadAppend(c),this.encodeHeader(this.payloadPosition_))};q.DerBitString.prototype=new q;q.DerBitString.prototype.name="DerBitString";q.DerOctetString=function(c){q.DerByteString.call(this,c,A.OctetString)};q.DerOctetString.prototype=new q.DerByteString;q.DerOctetString.prototype.name="DerOctetString";q.DerNull=function(){q.call(this,A.Null);this.encodeHeader(0)};q.DerNull.prototype=new q;q.DerNull.prototype.name="DerNull";q.DerOid=function(c){q.call(this,A.ObjectIdentifier);if(void 0!=c)if("string"===
typeof c){c=c.split(".");for(var l=[],n=0;n<c.length;++n)l.push(parseInt(c[n]));this.prepareEncoding(l)}else this.prepareEncoding(c.getIntegerList())};q.DerOid.prototype=new q;q.DerOid.prototype.name="DerOid";q.DerOid.prototype.prepareEncoding=function(c){var l;if(0==c.length)throw new rb(Error("No integer in OID"));if(0<=c[0]&&2>=c[0])l=40*c[0];else throw new rb(Error("First integer in OID is out of range"));if(2<=c.length)if(0<=c[1]&&39>=c[1])l+=c[1];else throw new rb(Error("Second integer in OID is out of range"));
var n=new Qa(10),a=0,a=n.copy(q.DerOid.encode128(l),a);if(2<c.length)for(l=2;l<c.length;++l)a=n.copy(q.DerOid.encode128(c[l]),a);this.encodeHeader(a);this.payloadAppend(n.slice(0,a))};q.DerOid.encode128=function(c){var l=new Qa(10),n=0;if(128>c)++n,l.array[l.array.length-n]=c&127;else for(++n,l.array[l.array.length-n]=c&127,c>>=7;0!=c;)++n,l.ensureLengthFromBack(n),l.array[l.array.length-n]=c&127|128,c>>=7;return l.slice(l.array.length-n)};q.DerOid.prototype.decode128=function(c,l){for(var n=0,a=
c;0!=(this.payload_.array[c]&128);)n=128*n+(this.payload_.array[c]&255)-128,c+=1;n=128*n+(this.payload_.array[c]&255);l[0]=c-a+1;return n};q.DerOid.prototype.toVal=function(){for(var c=0,l=[];c<this.payloadPosition_;){var n=[0],a=this.decode128(c,n),c=c+n[0];l.push(a)}c=l[0];c=Math.floor(c/40)+"."+c%40;for(n=1;n<l.length;++n)c+="."+l[n];return c};q.DerSequence=function(){q.DerStructure.call(this,A.Sequence)};q.DerSequence.prototype=new q.DerStructure;q.DerSequence.prototype.name="DerSequence";q.DerPrintableString=
function(c){q.DerByteString.call(this,c,A.PrintableString)};q.DerPrintableString.prototype=new q.DerByteString;q.DerPrintableString.prototype.name="DerPrintableString";q.DerGeneralizedTime=function(c){q.call(this,A.GeneralizedTime);void 0!=c&&(c=q.DerGeneralizedTime.toDerTimeString(c),this.payloadAppend((new p(c)).buf()),this.encodeHeader(this.payloadPosition_))};q.DerGeneralizedTime.prototype=new q;q.DerGeneralizedTime.prototype.name="DerGeneralizedTime";q.DerGeneralizedTime.toDerTimeString=function(c){c=
new Date(Math.round(c));return c.getUTCFullYear()+q.DerGeneralizedTime.to2DigitString(c.getUTCMonth()+1)+q.DerGeneralizedTime.to2DigitString(c.getUTCDate())+q.DerGeneralizedTime.to2DigitString(c.getUTCHours())+q.DerGeneralizedTime.to2DigitString(c.getUTCMinutes())+q.DerGeneralizedTime.to2DigitString(c.getUTCSeconds())+"Z"};q.DerGeneralizedTime.to2DigitString=function(c){c=c.toString();return 1===c.length?"0"+c:c};q.DerGeneralizedTime.prototype.toVal=function(){var c=this.payload_.slice(0,this.payloadPosition_).toString();
return Date.UTC(parseInt(c.substr(0,4)),parseInt(c.substr(4,2)-1),parseInt(c.substr(6,2)),parseInt(c.substr(8,2)),parseInt(c.substr(10,2)),parseInt(c.substr(12,2)))};var sc=a,Jb=function(c,l){this.subtrees=[];this.value=c;this.parent=l;this.lastChild=null};Jb.prototype.addSubtree=function(c,l){var n=this.find(c);null!==n?n.push(l):this.subtrees.push({key:c,value:[l]});l.parent=this;this.lastChild=l};Jb.prototype.createSubtree=function(c,l){var n=new Jb(l,this);this.addSubtree(c,n);return n};Jb.prototype.get=
function(c){c=c.replace(/^\/+/,"");if(0===c.length)return[this];var l=c.split("/");c=this.find(l[0]);if(null===c)return[];if(1==l.length)return c.slice(0);for(var l=l.slice(1).join("/"),n=[],a=0;a<c.length;++a)var b=c[a].get(l),n=n.concat(b);return n};Jb.prototype.getFirstValue=function(c){c=this.get(c);return 1<=c.length?c[0].value:null};Jb.prototype.getValue=function(){return this.value};Jb.prototype.getParent=function(){return this.parent};Jb.prototype.getLastChild=function(){return this.lastChild};
Jb.prototype.prettyPrint=function(c){c=c||1;var l=Array(c+1).join(" "),n="";null!=this.parent&&(this.value&&0<this.value.length&&(n+='"'+this.value+'"'),n+="\n");if(0<this.subtrees.length){this.parent&&(n+=l+"{\n");for(var a=Array(c+2+1).join(" "),b=0;b<this.subtrees.length;++b)for(var d=0;d<this.subtrees[b].value.length;++d)n+=a+this.subtrees[b].key+" "+this.subtrees[b].value[d].prettyPrint(c+2);this.parent&&(n+=l+"}\n")}return n};Jb.prototype.toString=function(){return this.prettyPrint()};Jb.prototype.find=
function(c){for(var l=0;l<this.subtrees.length;++l)if(this.subtrees[l].key==c)return this.subtrees[l].value;return null};var tc=function(){this.root=new Jb};s.BoostInfoParser=tc;s.BoostInfoTree=Jb;tc.prototype.read=function(c,l){var n;"string"==typeof l?n=c:(l=c,n=sc.readFileSync(c).toString());var a=this.root,b=this;n.split(/\r?\n/).forEach(function(c){a=b.parseLine(c.trim(),a)})};tc.prototype.write=function(c){sc.writeFileSync(c,""+this.root)};tc.prototype.getRoot=function(){return this.root};tc.shlex_split=
function(c){var l=[];if(""==c)return l;for(var n=0;;){for(;0<=" \t\n\r".indexOf(c[n]);)if(n+=1,n>=c.length)return l;for(var a=n,b=!1,d="";;){if("\\"==c[a]){if(d+=c.substring(n,a),a=n=a+1,a>=c.length)break}else if(b)'"'==c[a]&&(d+=c.substring(n,a),n=a+1,b=!1);else if('"'==c[a])d+=c.substring(n,a),n=a+1,b=!0;else if(0<=" \t\n\r".indexOf(c[a]))break;a+=1;if(a>=c.length)break}d+=c.substring(n,a);l.push(d);if(a>=c.length)return l;n=a}};tc.prototype.parseLine=function(c,l){var n=c.indexOf(";");0<=n&&(c=
c.substring(0,n).trim());if(0==c.length)return l;for(var n=tc.shlex_split(c),a=!1,b=!1,d=0;d<n.length;++d)a=a||"{"==n[d],b=b||"}"==n[d];if(!a&&!b){var a=n[0],g;1<n.length&&(g=n[1]);l.createSubtree(a,g);return l}n=c.indexOf("{");if(0<n)return g=c.substring(0,n),n=c.substring(n),g=this.parseLine(g,l),this.parseLine(n,g);if("{"==c[0])return l=l.getLastChild();if("}"==c[0])return l=l.getParent();throw runtime_error("BoostInfoParser: input line is malformed");};var b=a.Name,gc=a.InterestFilter,na=a.RegistrationOptions,
r=a.WireFormat,d=a.Log.LOG,ya=function(c,l){l=l||1E3;this.face=c;this.cleanupIntervalMilliseconds=l;this.nextCleanupTime=(new Date).getTime()+l;this.onDataNotFoundForPrefix={};this.interestFilterIdList=[];this.registeredPrefixIdList=[];this.noStaleTimeCache=[];this.staleTimeCache=[];this.emptyComponent=new b.Component;this.pendingInterestTable=[];this.minimumCacheLifetime_=0;var n=this;this.storePendingInterestCallback=function(c,l,a,b,d){n.storePendingInterest(l,a)}};s.MemoryContentCache=ya;ya.prototype.registerPrefix=
function(c,l,n,a,b,d){var g=n,f=a,m=b;n="object"===typeof g&&1===g.length&&"function"===typeof g[0]?g[0]:null;a="function"===typeof g?g:"function"===typeof f?f:null;b=g instanceof na?g:f instanceof na?f:m instanceof na?m:new na;d=g instanceof r?g:f instanceof r?f:m instanceof r?m:d instanceof r?d:r.getDefaultWireFormat();a&&(this.onDataNotFoundForPrefix[c.toUri()]=a);c=this.face.registerPrefix(c,this.onInterest.bind(this),l,n,b,d);this.registeredPrefixIdList.push(c)};ya.prototype.setInterestFilter=
function(c,l){if(l){var n;n="object"===typeof c&&c instanceof gc?c.getPrefix():c;this.onDataNotFoundForPrefix[n.toUri()]=l}n=this.face.setInterestFilter(c,this.onInterest.bind(this));this.interestFilterIdList.push(n)};ya.prototype.unregisterAll=function(){for(var c=0;c<this.interestFilterIdList.length;++c)this.face.unsetInterestFilter(this.interestFilterIdList[c]);this.interestFilterIdList=[];for(c=0;c<this.registeredPrefixIdList.length;++c)this.face.removeRegisteredPrefix(this.registeredPrefixIdList[c]);
this.registeredPrefixIdList=[];this.onDataNotFoundForPrefix={}};ya.prototype.add=function(c){var l=(new Date).getTime();this.doCleanup(l);if(null!=c.getMetaInfo().getFreshnessPeriod()&&0<=c.getMetaInfo().getFreshnessPeriod()){for(var n=new ya.StaleTimeContent(c,l,this.minimumCacheLifetime_),a=this.staleTimeCache.length-1;0<=a&&!(this.staleTimeCache[a].cacheRemovalTimeMilliseconds_<=n.cacheRemovalTimeMilliseconds_);)--a;this.staleTimeCache.splice(a+1,0,n)}else this.noStaleTimeCache.push(new ya.Content(c));
for(a=this.pendingInterestTable.length-1;0<=a;--a)if(this.pendingInterestTable[a].isTimedOut(l))this.pendingInterestTable.splice(a,1);else if(this.pendingInterestTable[a].getInterest().matchesName(c.getName())){try{3<d&&console.log("MemoryContentCache:  Reply w/ add Data "+c.getName().toUri()),this.pendingInterestTable[a].getFace().send(c.wireEncode().buf())}catch(b){0<d&&console.log(""+b);break}this.pendingInterestTable.splice(a,1)}};ya.prototype.storePendingInterest=function(c,l){this.pendingInterestTable.push(new ya.PendingInterest(c,
l))};ya.prototype.getStorePendingInterest=function(){return this.storePendingInterestCallback};ya.prototype.getMinimumCacheLifetime=function(){return this.minimumCacheLifetime_};ya.prototype.setMinimumCacheLifetime=function(c){this.minimumCacheLifetime_=c};ya.prototype.onInterest=function(c,l,n,a,b){3<d&&console.log("MemoryContentCache:  Received Interest "+l.toUri());var g=(new Date).getTime();this.doCleanup(g);for(var f=null,m=null,r=this.staleTimeCache.length+this.noStaleTimeCache.length,q=0;q<
r;++q){var p,C=!0;q<this.staleTimeCache.length?(p=this.staleTimeCache[q],C=p.isFresh(g)):p=this.noStaleTimeCache[q-this.staleTimeCache.length];if(l.matchesName(p.getName())&&(!l.getMustBeFresh()||C)){if(null==l.getChildSelector()){3<d&&console.log("MemoryContentCache:         Reply Data "+p.getName().toUri());n.send(p.getDataEncoding());return}var C=p.getName().size()>l.getName().size()?p.getName().get(l.getName().size()):this.emptyComponent,s=!1;null===m?s=!0:0==l.getChildSelector()?0>C.compare(f)&&
(s=!0):0<C.compare(f)&&(s=!0);s&&(f=C,m=p.getDataEncoding())}}null!==m?(3<d&&console.log("MemoryContentCache: Reply Data to Interest "+l.toUri()),n.send(m)):(3<d&&console.log("MemoryContentCache: onDataNotFound for "+l.toUri()),(g=this.onDataNotFoundForPrefix[c.toUri()])&&g(c,l,n,a,b))};ya.prototype.doCleanup=function(c){if(c>=this.nextCleanupTime){for(;0<this.staleTimeCache.length&&this.staleTimeCache[0].isPastRemovalTime(c);)this.staleTimeCache.shift();this.nextCleanupTime=c+this.cleanupIntervalMilliseconds}};
ya.Content=function(c){c&&(this.name=new b(c.getName()),this.dataEncoding=c.wireEncode().buf())};ya.Content.prototype.getName=function(){return this.name};ya.Content.prototype.getDataEncoding=function(){return this.dataEncoding};ya.StaleTimeContent=function(c,l,n){ya.Content.call(this,c);this.cacheRemovalTimeMilliseconds_=l+Math.max(c.getMetaInfo().getFreshnessPeriod(),n);this.freshnessExpiryTimeMilliseconds_=l+c.getMetaInfo().getFreshnessPeriod()};ya.StaleTimeContent.prototype=new ya.Content;ya.StaleTimeContent.prototype.name=
"StaleTimeContent";ya.StaleTimeContent.prototype.isPastRemovalTime=function(c){return this.cacheRemovalTimeMilliseconds_<=c};ya.StaleTimeContent.prototype.isFresh=function(c){return this.freshnessExpiryTimeMilliseconds_>c};ya.PendingInterest=function(c,l){this.interest=c;this.face=l;var n=this.interest.getInterestLifetimeMilliseconds();if(null==n||0>n)n=4E3;this.timeoutMilliseconds=(new Date).getTime()+n};ya.PendingInterest.prototype.getInterest=function(){return this.interest};ya.PendingInterest.prototype.getFace=
function(){return this.face};ya.PendingInterest.prototype.isTimedOut=function(c){return c>=this.timeoutTimeMilliseconds};var z=a.Interest,y=a.KeyChain,Ob=a.PipelineFixed,Ca=a.PipelineCubic,Yc=function(){};s.SegmentFetcher=Yc;Yc.ErrorCode={INTEREST_TIMEOUT:1,DATA_HAS_NO_SEGMENT:2,SEGMENT_VERIFICATION_FAILED:3,INVALID_KEYCHAIN:4,INVALID_PIPELINE:5};Yc.DontVerifySegment=function(c){return!0};Yc.fetch=function(c,l,n,a,b,d,g){null!=n?b(Yc.ErrorCode.INVALID_KEYCHAIN,"Debug: validatorKeyChain is temporarily not supported. Use null."):
null==d||void 0===d.pipeline||"cubic"===d.pipeline?null==n||n instanceof y?(new Ca(l,c,d,n,a,b,g)).run():b(Yc.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):"fixed"===d.pipeline?null==n||n instanceof y?(new Ob(l,c,d,n,a,b,g)).run():b(Yc.ErrorCode.INVALID_KEYCHAIN,"validatorKeyChain should be either a KeyChain instance or null."):b(Yc.ErrorCode.INVALID_PIPELINE,d.pipeline+" is not a valid pipeline type")};var z=a.Interest,U=a.NdnCommon,R=function(c){this.baseInterest=
c;this.numberOfSatisfiedSegments=this.nextSegmentNo=0;this.finalBlockId=Number.MAX_SAFE_INTEGER;this.versionNo=NaN;this.versionIsProvided=!1;0<c.getName().components.length&&c.getName().get(-1).isVersion()&&(this.versionNo=c.getName().get(-1).toVersion(),this.versionIsProvided=!0);this.hasFinalBlockId=this.hasFailure=this.isStopped=!1;this.failedSegNo=0;this.failureReason;this.failureErrorCode;this.contentParts=[]};s.Pipeline=R;R.ErrorCode={INTEREST_TIMEOUT:1,INTEREST_LIFETIME_EXPIRATION:2,DATA_HAS_NO_VERSION:3,
DATA_HAS_NO_SEGMENT:4,SEGMENT_VERIFICATION_FAILED:5,NACK_RECEIVED:6,NO_FINALBLOCK:7,MAX_NACK_TIMEOUT_RETRIES:8,MISC:9};R.prototype.cancel=function(){this.isStopped||(this.isStopped=!0)};R.prototype.makeInterest=function(c){var l=new z(this.baseInterest);Number.isNaN(this.versionNo)||(!1===this.versionIsProvided?l.setName((new b(this.baseInterest.getName())).appendVersion(this.versionNo).appendSegment(c)):l.setName((new b(this.baseInterest.getName())).appendSegment(c)));return l};R.prototype.getNextSegmentNo=
function(){return this.nextSegmentNo++};R.op=function(c,l,n){return null!=n&&n.hasOwnProperty(c)?n[c]:l};R.reportWarning=function(c,l){console.log("Warning "+c+" : "+l)};R.reportError=function(c,l,n){try{c(l,n)}catch(a){console.log("Error in onError: "+U.getErrorWithStackTrace(a))}};R.prototype.onFailure=function(c,l,n,a){null==a?this.cancel():a();R.reportError(n,c,l)};var z=a.Interest,p=a.Blob,y=a.KeyChain,U=a.NdnCommon,Fb=a.RttEstimator,Zc=a.DataFetcher,R=a.Pipeline,d=a.Log.LOG,Ob=function(c,l,
n,a,b,d,g){this.face=l;this.validatorKeyChain=a;this.onComplete=b;this.onError=d;this.pipeline=new R(c);this.nInFlight=0;this.windowSize=R.op("windowSize",10,n);this.maxRetriesOnTimeoutOrNack=R.op("maxRetriesOnTimeoutOrNack",3,n);this.segmentInfo=[];this.dataFetchersContainer=[];this.rttEstimator=new Fb(n);this.stats=null!=g?g:{};this.stats.nTimeouts=0;this.stats.nNacks=0;this.stats.nRetransmitted=0};s.PipelineFixed=Ob;Ob.prototype.run=function(){this.stats.pipelineStartTime=Date.now();var c=this.pipeline.makeInterest(0);
Number.isNaN(this.pipeline.versionNo)?c.setMustBeFresh(!0):c.setMustBeFresh(!1);this.sendInterest(c)};Ob.prototype.sendInterest=function(c){if(!this.pipeline.isStopped&&!this.pipeline.hasFailure){var l=0;0<c.getName().components.length&&c.getName().get(-1).isSegment()&&(l=c.getName().get(-1).toSegment());this.dataFetchersContainer[l]=new Zc(this.face,c,this.maxRetriesOnTimeoutOrNack,this.handleData.bind(this),this.handleFailure.bind(this),this.segmentInfo,this.stats);this.dataFetchersContainer[l].fetch()}};
Ob.prototype.sendNextInterests=function(){if(!this.pipeline.isStopped)for(;this.pipeline.nextSegmentNo<=this.pipeline.finalBlockId&&this.nInFlight<=this.windowSize;)if(void 0!==this.pipeline.contentParts[this.pipeline.nextSegmentNo])this.pipeline.getNextSegmentNo();else{var c=this.pipeline.makeInterest(this.pipeline.getNextSegmentNo());c.setMustBeFresh(!1);c.refreshNonce();this.sendInterest(c);this.nInFlight++}};Ob.prototype.cancelInFlightSegmentsGreaterThan=function(c){var l=this.dataFetchersContainer.length;
for(c+=1;c<l;++c)null!==this.dataFetchersContainer[c]&&this.face.removePendingInterest(this.dataFetchersContainer[c].getPendingInterestId())};Ob.prototype.handleData=function(c,l){if(null!==this.validatorKeyChain)try{var n=this;this.validatorKeyChain.verifyData(l,function(c){n.onData(c)},this.onValidationFailed.bind(this))}catch(a){R.reportError(this.onError,R.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+a)}else this.onData(l)};Ob.prototype.onData=function(c){if(!this.pipeline.isStopped){var l=
0;try{l=c.getName().get(-1).toSegment()}catch(n){this.handleFailure(l,R.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the segment number "+c.getName().get(-1).toEscapedString()+": "+n);return}if(Number.isNaN(this.pipeline.versionNo))try{this.pipeline.versionNo=c.getName().get(-2).toVersion()}catch(a){this.handleFailure(l,R.ErrorCode.DATA_HAS_NO_VERSION,"Error while decoding the version number "+c.getName().get(-2).toEscapedString()+": "+a);return}if(0<c.getMetaInfo().getFinalBlockId().getValue().size()){try{this.pipeline.finalBlockId=
c.getMetaInfo().getFinalBlockId().toSegment(),this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId)}catch(b){R.reportError(this.onError,R.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the FinalBlockId field "+c.getMetaInfo().getFinalBlockId().toEscapedString()+": "+b);return}this.pipeline.hasFinalBlockId=!0}this.pipeline.contentParts[l]=c.getContent().buf();if(this.pipeline.hasFailure&&this.pipeline.hasFinalBlockId){if(this.pipeline.finalBlockId>=this.pipeline.failedSegNo)return this.pipeline.onFailure(this.pipeline.failureErrorCode,
this.pipeline.failureReason,this.onError);this.pipeline.hasFailure=!1}var g=this.segmentInfo[l];if(void 0!==g){c=Date.now()-g.timeSent;g=Date.now()-g.initTimeSent;1<d&&console.log("Received segment #"+l+", rtt="+c+"ms");if("normal"===this.segmentInfo[l].stat){var m=Math.max(this.nInFlight+1>>1,1);0>=m&&this.handleFailure(-1,R.ErrorCode.MISC,"nExpectedSamples is less than or equal to ZERO.");this.rttEstimator.addMeasurement(l,c,m)}this.rttEstimator.addDelayMeasurement(l,Math.max(c,g));this.pipeline.numberOfSatisfiedSegments++;
if(this.pipeline.hasFinalBlockId&&this.pipeline.numberOfSatisfiedSegments>this.pipeline.finalBlockId){l=f.concat(this.pipeline.contentParts);this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId);this.stats.avgRtt=this.rttEstimator.getAvgRtt().toPrecision(3);this.stats.avgJitter=this.rttEstimator.getAvgJitter().toPrecision(3);this.stats.nSegments=this.pipeline.numberOfSatisfiedSegments;this.stats.completionTime=Date.now()-this.stats.pipelineStartTime;try{this.pipeline.cancel(),this.printSummary(),
this.onComplete(new p(l,!1))}catch(r){console.log("Error in onComplete: "+U.getErrorWithStackTrace(r))}}else this.nInFlight=Math.max(this.nInFlight-1,0),this.sendNextInterests()}}};Ob.prototype.handleFailure=function(c,l,n){if(!this.pipeline.isStopped)if(-1===c)this.pipeline.onFailure(l,n,this.onError);else{if(0===c||this.pipeline.hasFinalBlockId&&c<=this.pipeline.finalBlockId)return this.pipeline.onFailure(l,n,this.onError);if(!this.pipeline.hasFinalBlockId)if(this.nInFlight--,0>=this.nInFlight)this.pipeline.onFailure(R.ErrorCode.NO_FINALBLOCK,
"Fetching terminated at segment "+c+" but no finalBlockId has been found",this.onError);else this.cancelInFlightSegmentsGreaterThan(c),this.pipeline.hasFailure=!0,this.pipeline.failedSegNo=c,this.pipeline.failureErrorCode=l,this.pipeline.failureReason=n}};Ob.prototype.onValidationFailed=function(c,l){R.reportError(this.onError,R.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+c.getName().toUri()+" . Reason: "+l)};Ob.prototype.printSummary=function(){if(!(2>d)){var c="",c=
this.rttEstimator.getMinRtt()===Number.MAX_VALUE||this.rttEstimator.getMaxRtt()===Number.NEGATIVE_INFINITY?"stats unavailable":"min/avg/max = "+this.rttEstimator.getMinRtt().toPrecision(3)+"/"+this.rttEstimator.getAvgRtt().toPrecision(3)+"/"+this.rttEstimator.getMaxRtt().toPrecision(3)+" ms";console.log("Timeouts: "+this.stats.nTimeouts+" Nacks: "+this.stats.nNacks+"\nRetransmitted segments: "+this.stats.nRetransmitted+"\nRTT "+c+"\nAverage jitter: "+this.rttEstimator.getAvgJitter().toPrecision(3)+
" ms\nCompletion time: "+this.stats.completionTime+"ms")}};z=a.Interest;b=a.Name;p=a.Blob;y=a.KeyChain;U=a.NdnCommon;Fb=a.RttEstimator;R=a.Pipeline;d=a.Log.LOG;Ca=function(c,l,n,a,b,d,g){this.pipeline=new R(c);this.face=l;this.validatorKeyChain=a;this.onComplete=b;this.onError=d;this.initCwnd=R.op("initCwnd",1,n);this.cwnd=R.op("cwnd",this.initCwnd,n);this.ssthresh=R.op("ssthresh",Number.MAX_VALUE,n);this.rtoCheckInterval=R.op("rtoCheckInterval",10,n);this.disableCwa=R.op("disableCwa",!1,n);this.maxRetriesOnTimeoutOrNack=
R.op("maxRetriesOnTimeoutOrNack",3,n);this.enableFastConv=R.op("enableFastConv",!1,n);this.cubicBeta=R.op("cubicBeta",0.7,n);this.wmax=R.op("wmax",0,n);this.lastWmax=R.op("lastWmax",0,n);this.lastDecrease=Date.now();this.cubic_c=0.4;this.nSent=this.nRetransmitted=this.nSkippedRetx=this.nNacks=this.nTimeouts=this.nLossDecr=this.nInFlight=this.recPoint=this.highInterest=this.highData=0;this.segmentInfo=[];this.retxQueue=[];this.retxCount=[];this.rttEstimator=new Fb(n);this.stats=null!=g?g:{}};s.PipelineCubic=
Ca;Ca.SegmentState={FirstTimeSent:1,InRetxQueue:2,Retransmitted:3};Ca.prototype.increaseWindow=function(){if(this.cwnd<this.ssthresh)this.cwnd+=1;else{this.wmax<this.initCwnd&&(this.wmax=this.cwnd);var c=(Date.now()-this.lastDecrease)/1E3,l=Math.cbrt(this.wmax*(1-this.cubicBeta)/this.cubic_c),c=this.cubic_c*Math.pow(c-l,3)+this.wmax,c=Math.max(c,0)-this.cwnd,c=Math.max(0,c);this.cwnd+=c/this.cwnd}};Ca.prototype.decreaseWindow=function(){this.enableFastConv&&this.cwnd<this.lastWmax?(this.lastWmax=
this.cwnd,this.wmax=this.cwnd*(1+this.cubicBeta)/2):this.wmax=this.lastWmax=this.cwnd;this.cwnd=this.ssthresh=Math.max(this.initCwnd,this.cwnd*this.cubicBeta);this.lastDecrease=Date.now()};Ca.prototype.run=function(){this.stats.pipelineStartTime=Date.now();setTimeout(this.checkRto.bind(this),this.rtoCheckInterval);this.sendInterest(this.pipeline.getNextSegmentNo(),!1)};Ca.prototype.cancel=function(){this.pipeline.cancel();this.segmentInfo.length=0};Ca.prototype.sendInterest=function(c,l){if(!(this.pipeline.isStopped||
this.pipeline.hasFinalBlockId&&c>this.pipeline.finalBlockId||!l&&this.pipeline.hasFailure)){if(l){if(void 0===this.retxCount[c])this.retxCount[c]=1;else if(this.retxCount[c]++,this.retxCount[c]>this.maxRetriesOnTimeoutOrNack)return this.handleFailure(c,R.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+c);1<d&&console.log("Retransmitting segment #"+c+" ("+this.retxCount[c]+")")}1<d&&!l&&console.log("Requesting segment #"+
c);var n=this.pipeline.makeInterest(c);Number.isNaN(this.pipeline.versionNo)?n.setMustBeFresh(!0):n.setMustBeFresh(!1);var a={};a.pendingInterestId=this.face.expressInterest(n,this.handleData.bind(this),this.handleLifetimeExpiration.bind(this),this.handleNack.bind(this));l&&void 0===a.initTimeSent&&(a.initTimeSent=a.timeSent);a.timeSent=Date.now();a.rto=this.rttEstimator.getEstimatedRto();this.nInFlight++;this.nSent++;l?(a.state=Ca.SegmentState.Retransmitted,this.nRetransmitted++):(this.highInterest=
c,a.state=Ca.SegmentState.FirstTimeSent);this.segmentInfo[c]=a}};Ca.prototype.schedulePackets=function(){if(0>this.nInFlight)this.handleFailure(-1,R.ErrorCode.MISC,"Number of in flight Interests is negative.");else for(var c=this.cwnd-this.nInFlight;0<c;){if(0!=this.retxQueue.length){var l=this.retxQueue.shift();if(void 0===this.segmentInfo[l]){this.nSkippedRetx++;continue}this.sendInterest(l,!0)}else this.sendInterest(this.pipeline.getNextSegmentNo(),!1);c--}};Ca.prototype.handleData=function(c,
l){if(null!==this.validatorKeyChain)try{var n=this;this.validatorKeyChain.verifyData(l,function(c){n.onData(c)},this.onValidationFailed.bind(this))}catch(a){R.reportError(this.onError,R.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Error in KeyChain.verifyData: "+a)}else this.onData(l)};Ca.prototype.onData=function(c){if(!this.pipeline.isStopped){var l=0;try{l=c.getName().get(-1).toSegment()}catch(n){this.handleFailure(l,R.ErrorCode.DATA_HAS_NO_SEGMENT,"Error while decoding the segment number "+c.getName().get(-1).toEscapedString()+
": "+n);return}if(Number.isNaN(this.pipeline.versionNo))try{this.pipeline.versionNo=c.getName().get(-2).toVersion()}catch(a){this.handleFailure(l,R.ErrorCode.DATA_HAS_NO_VERSION,"Error while decoding the version number "+c.getName().get(-2).toEscapedString()+": "+a);return}if(!this.pipeline.hasFinalBlockId&&0<c.getMetaInfo().getFinalBlockId().getValue().size()){try{this.pipeline.finalBlockId=c.getMetaInfo().getFinalBlockId().toSegment()}catch(b){this.handleFailure(l,R.ErrorCode.DATA_HAS_NO_SEGMENT,
"Error while decoding FinalBlockId field "+c.getName().get(-1).toEscapedString()+": "+b);return}this.pipeline.hasFinalBlockId=!0}this.pipeline.contentParts[l]=c.getContent().buf();if(this.pipeline.hasFailure&&this.pipeline.hasFinalBlockId){if(this.pipeline.finalBlockId>=this.pipeline.failedSegNo)return this.pipeline.onFailure(this.pipeline.failureErrorCode,this.pipeline.failureReason,this.onError,this.cancel.bind(this));this.pipeline.hasFailure=!1}var g=this.segmentInfo[l];if(void 0!==g){c=Date.now()-
g.timeSent;var m=0;void 0!==g.initTimeSent&&(m=Date.now()-g.initTimeSent);1<d&&console.log("Received segment #"+l+", rtt="+c+"ms, rto="+g.rto+"ms");this.highData<l&&(this.highData=l);g.state!==Ca.SegmentState.InRetxQueue&&this.nInFlight--;g.state!==Ca.SegmentState.FirstTimeSent&&g.state!==Ca.SegmentState.InRetxQueue||void 0!==this.retxCount[l]||(g=Math.max(this.nInFlight+1>>1,1),0>=g&&this.handleFailure(-1,R.ErrorCode.MISC,"nExpectedSamples is less than or equal to ZERO."),this.rttEstimator.addMeasurement(l,
c,g));this.rttEstimator.addDelayMeasurement(l,Math.max(c,m));this.segmentInfo[l]=void 0;this.pipeline.numberOfSatisfiedSegments++;if(this.pipeline.hasFinalBlockId&&this.pipeline.numberOfSatisfiedSegments>this.pipeline.finalBlockId){l=f.concat(this.pipeline.contentParts);this.cancelInFlightSegmentsGreaterThan(this.pipeline.finalBlockId);this.stats.nTimeouts=this.nTimeouts;this.stats.nNacks=this.nNacks;this.stats.nRetransmitted=this.nRetransmitted;this.stats.avgRtt=this.rttEstimator.getAvgRtt().toPrecision(3);
this.stats.avgJitter=this.rttEstimator.getAvgJitter().toPrecision(3);this.stats.nSegments=this.pipeline.numberOfSatisfiedSegments;this.stats.completionTime=Date.now()-this.stats.pipelineStartTime;try{this.cancel(),this.printSummary(),this.onComplete(new p(l,!1))}catch(r){this.handleFailure(-1,R.ErrorCode.MISC,"Error in onComplete: "+U.getErrorWithStackTrace(r))}}else this.increaseWindow(),this.schedulePackets()}}};Ca.prototype.checkRto=function(){if(!this.pipeline.isStopped){for(var c=!1,l=0;l<this.segmentInfo.length;++l)if(void 0!==
this.segmentInfo[l]){var n=this.segmentInfo[l];n.state!==Ca.SegmentState.InRetxQueue&&Date.now()-n.timeSent>n.rto&&(this.nTimeouts++,c=!0,this.onWarning(R.ErrorCode.INTEREST_TIMEOUT,"handle timeout for segment "+l),this.enqueueForRetransmission(l))}c&&(this.recordTimeout(),this.schedulePackets());setTimeout(this.checkRto.bind(this),this.rtoCheckInterval)}};Ca.prototype.enqueueForRetransmission=function(c){0>=this.nInFlight?this.handleFailure(-1,R.ErrorCode.MISC,"Number of in flight Interests <= 0."):
(this.nInFlight--,this.retxQueue.push(c),this.segmentInfo[c].state=Ca.SegmentState.InRetxQueue)};Ca.prototype.recordTimeout=function(){if(this.disableCwa||this.highData>this.recPoint)this.recPoint=this.highInterest,this.decreaseWindow(),this.rttEstimator.backoffRto(),this.nLossDecr++,1<d&&console.log("Packet loss event, new cwnd = "+this.cwnd+", ssthresh = "+this.ssthresh)};Ca.prototype.cancelInFlightSegmentsGreaterThan=function(c){for(c+=1;c<this.segmentInfo.length;++c)void 0!==this.segmentInfo[c]&&
this.face.removePendingInterest(this.segmentInfo[c].pendingInterestId),this.segmentInfo[c]=void 0,this.nInFlight--};Ca.prototype.handleFailure=function(c,l,n){if(!this.pipeline.isStopped)if(-1===c)this.pipeline.onFailure(l,n,this.onError,this.cancel.bind(this));else{if(0===c||this.pipeline.hasFinalBlockId&&c<=this.pipeline.finalBlockId)return this.pipeline.onFailure(l,n,this.onError,this.cancel.bind(this));if(!this.pipeline.hasFinalBlockId){this.segmentInfo[c]=void 0;this.nInFlight--;for(var a=!0,
b=0;b<this.segmentInfo.length;++b)if(void 0!==this.segmentInfo[b]){a=!1;break}if(a)this.pipeline.onFailure(R.ErrorCode.NO_FINALBLOCK,"Fetching terminated at segment "+c+" but no finalBlockId has been found",this.onError,this.cancel.bind(this));else this.cancelInFlightSegmentsGreaterThan(c),this.pipeline.hasFailure=!0,this.pipeline.failedSegNo=c,this.pipeline.failureErrorCode=l,this.pipeline.failureReason=n}}};Ca.prototype.handleLifetimeExpiration=function(c){if(!this.pipeline.isStopped){this.nTimeouts++;
var l=0;0<c.getName().components.length&&c.getName().get(-1).isSegment()&&(l=c.getName().get(-1).toSegment());this.enqueueForRetransmission(l);this.onWarning(R.ErrorCode.INTEREST_LIFETIME_EXPIRATION,"handle interest lifetime expiration for segment "+l);this.recordTimeout();this.schedulePackets()}};Ca.prototype.handleNack=function(c){if(!this.pipeline.isStopped){this.nNacks++;var l=0;0<c.getName().components.length&&c.getName().get(-1).isSegment()&&(l=c.getName().get(-1).toSegment());this.enqueueForRetransmission(l);
this.onWarning(R.ErrorCode.NACK_RECEIVED,"handle nack for segment "+l);this.recordTimeout();this.schedulePackets()}};Ca.prototype.onValidationFailed=function(c,l){R.reportError(this.onError,R.ErrorCode.SEGMENT_VERIFICATION_FAILED,"Segment verification failed for "+c.getName().toUri()+" . Reason: "+l)};Ca.prototype.onWarning=function(c,l){2<d&&R.reportWarning(c,l)};Ca.prototype.printSummary=function(){if(!(2>d)){var c="",c=this.rttEstimator.getMinRtt()===Number.MAX_VALUE||this.rttEstimator.getMaxRtt()===
Number.NEGATIVE_INFINITY?"stats unavailable":"min/avg/max = "+this.rttEstimator.getMinRtt().toPrecision(3)+"/"+this.rttEstimator.getAvgRtt().toPrecision(3)+"/"+this.rttEstimator.getMaxRtt().toPrecision(3)+" ms";console.log("Timeouts: "+this.nTimeouts+" (caused "+this.nLossDecr+" window decreases)\nNacks: "+this.nNacks+"\nRetransmitted segments: "+this.nRetransmitted+" ("+(0==this.nSent?0:this.nRetransmitted/this.nSent*100)+"%), skipped: "+this.nSkippedRetx+"\nRTT "+c+"\nAverage jitter: "+this.rttEstimator.getAvgJitter().toPrecision(3)+
" ms\nCompletion time: "+this.stats.completionTime+"ms")}};R=a.Pipeline;Fb=function(c){this.alpha=R.op("alpha",0.125,c);this.beta=R.op("beta",0.25,c);this.k=R.op("k",8,c);this.initialRto=R.op("initialRto",1E3,c);this.minRto=R.op("minRto",200,c);this.maxRto=R.op("maxRto",2E4,c);this.rtoBackoffMultiplier=R.op("rtoBackoffMultiplier",2,c);this.delayArr=[];this.rttVar=this.sRtt=NaN;this.rto=this.initialRto;this.rttMin=Number.MAX_VALUE;this.rttMax=Number.NEGATIVE_INFINITY;this.nRttSamples=this.rttAvg=0};
s.RttEstimator=Fb;Fb.prototype.clamp=function(c,l,n){if(l<c&&c<n)return c;if(c<l)return l;if(n<c)return n};Fb.prototype.addMeasurement=function(c,l,n){0>=n&&console.log("ERROR: nExpectedSamples is less than or equal to ZERO");0===this.nRttSamples?(this.sRtt=l,this.rttVar=this.sRtt/2):(c=this.alpha/n,n=this.beta/n,this.rttVar=(1-n)*this.rttVar+n*Math.abs(this.sRtt-l),this.sRtt=(1-c)*this.sRtt+c*l);this.rto=this.sRtt+this.k*this.rttVar;this.rto=this.clamp(this.rto,this.minRto,this.maxRto);this.rttAvg=
(this.nRttSamples*this.rttAvg+l)/(this.nRttSamples+1);this.rttMax=Math.max(l,this.rttMax);this.rttMin=Math.min(l,this.rttMin);this.nRttSamples++};Fb.prototype.addDelayMeasurement=function(c,l){this.delayArr[c]=l};Fb.prototype.getAvgJitter=function(){for(var c=0,l=0,n=0,a=0;a<this.delayArr.length;++a)void 0!==this.delayArr[a]&&(0<c&&(l=(l*c+Math.abs(n-this.delayArr[a]))/(c+1)),n=this.delayArr[a],c++);return l};Fb.prototype.backoffRto=function(){this.rto=this.clamp(this.rto*this.rtobackoffmultiplier,
this.minrto,this.maxrto)};Fb.prototype.getEstimatedRto=function(){return this.rto};Fb.prototype.getMinRtt=function(){return this.rttMin};Fb.prototype.getMaxRtt=function(){return this.rttMax};Fb.prototype.getAvgRtt=function(){return this.rttAvg};z=a.Interest;d=a.Log.LOG;R=a.Pipeline;Zc=function(c,l,n,a,b,d,g){this.face=c;this.interest=l;this.maxRetriesOnTimeoutOrNack=n;this.onData=a;this.handleFailure=b;this.segmentInfo=d;this.stats=g;this.segmentNo=0;0<l.getName().components.length&&l.getName().get(-1).isSegment()&&
(this.segmentNo=l.getName().get(-1).toSegment());this.nNackRetries=this.nTimeoutRetries=0;this.segmentInfo[this.segmentNo]={};this.segmentInfo[this.segmentNo].stat="normal";this.segmentInfo[this.segmentNo].initTimeSent=Date.now();this.pendingInterestId=null};s.DataFetcher=Zc;Zc.prototype.fetch=function(){this.segmentInfo[this.segmentNo].timeSent=Date.now();this.pendingInterestId=this.face.expressInterest(this.interest,this.handleData.bind(this),this.handleLifetimeExpiration.bind(this),this.handleNack.bind(this))};
Zc.prototype.getPendingInterestId=function(){return this.pendingInterestId};Zc.prototype.handleData=function(c,l){this.stats.nTimeouts+=this.nTimeoutRetries;this.stats.nNacks+=this.nNackRetries;this.stats.nRetransmitted+=this.nNackRetries+this.nTimeoutRetries;this.onData(c,l)};Zc.prototype.handleLifetimeExpiration=function(c){this.nTimeoutRetries++;this.segmentInfo[this.segmentNo].stat="retx";if(this.nTimeoutRetries<=this.maxRetriesOnTimeoutOrNack){var l=new z(c);l.refreshNonce();this.interest=l;
3<d&&console.log("handle lifetime expiration for interest "+c.getName());this.fetch()}else l=0,0<c.getName().components.length&&c.getName().get(-1).isSegment()&&(l=c.getName().get(-1).toSegment()),this.handleFailure(this.segmentNo,R.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+l)};Zc.prototype.handleNack=function(c){this.nNackRetries+=1;this.segmentInfo[this.segmentNo].stat="retx";if(this.nNackRetries<=this.maxRetriesOnTimeoutOrNack){var l=
new z(c);l.refreshNonce();this.interest=l;3<d&&console.log("handle nack for interest "+c.getName());setTimeout(this.fetch.bind(this),40+20*Math.random())}else l=0,0<c.getName().components.length&&c.getName().get(-1).isSegment()&&(l=c.getName().get(-1).toSegment()),this.handleFailure(this.segmentNo,R.ErrorCode.MAX_NACK_TIMEOUT_RETRIES,"Reached the maximum number of retries ("+this.maxRetriesOnTimeoutOrNack+") while retrieving segment #"+l)};var uc=function(){this.backrefs_=[]};s.NdnRegexBackrefManager=
uc;uc.prototype.pushRef=function(c){last=this.backrefs_.length;this.backrefs_.push(c);return last};uc.prototype.popRef=function(){this.backrefs_.pop()};uc.prototype.size=function(){return this.backrefs_.length};uc.prototype.getBackref=function(c){return this.backrefs_[c]};var uc=a.NdnRegexBackrefManager,T=function(c,l,n){this.matchers_=[];this.matchResult_=[];this.expr_=c;this.type_=l;void 0==n&&(n=new uc);this.backrefManager_=n};s.NdnRegexMatcherBase=T;T.Error=function(c){if(c)return c.__proto__=
T.Error.prototype,c};T.Error.prototype=Error();T.Error.prototype.name="NdnRegexMatcherBaseError";T.NdnRegexExprType={TOP:0,PATTERN_LIST:1,REPEAT_PATTERN:2,BACKREF:3,COMPONENT_SET:4,COMPONENT:5,PSEUDO:6};T.prototype.match=function(c,l,n){var a=!1;this.matchResult_=[];if(this.recursiveMatch_(0,c,l,n)){for(a=l;a<l+n;)this.matchResult_.push(c.get(a)),++a;a=!0}else a=!1;return a};T.prototype.getMatchResult=function(){return this.matchResult_};T.prototype.getExpr=function(){return this.expr_};T.prototype.compile_=
function(){throw Error("NdnRegexMatcherBase.compile is not implemented");};T.prototype.recursiveMatch_=function(c,l,n,a){var b=a;if(c>=this.matchers_.length)return 0==a;for(var d=this.matchers_[c];0<=b;){if(d.match(l,n,b)&&this.recursiveMatch_(c+1,l,n+b,a-b))return!0;--b}return!1};var T=a.NdnRegexMatcherBase,Jc=function(c,l){T.call(this,c,T.NdnRegexExprType.BACKREF,l)};Jc.prototype=new T;Jc.prototype.name="NdnRegexBackrefMatcher";s.NdnRegexBackrefMatcher=Jc;Jc.prototype.lateCompile=function(){this.compile_()};
Jc.prototype.compile_=function(){if(2>this.expr_.length)throw new T.Error(Error("Unrecognized format: "+this.expr_));var c=this.expr_.length-1;if("("===this.expr_[0]&&")"===this.expr_[c])c=new Pb(this.expr_.substring(1,c),this.backrefManager_),this.matchers_.push(c);else throw new T.Error(Error("Unrecognized format: "+this.expr_));};var Pb=a.NdnRegexPatternListMatcher,T=a.NdnRegexMatcherBase,Kc=a.NdnRegexPseudoMatcher,$c=function(c,l,n){T.call(this,c,T.NdnRegexExprType.COMPONENT,l);void 0===n&&(n=
!0);this.componentRegex_=null;this.pseudoMatchers_=[];this.isExactMatch_=n;this.compile_()};$c.prototype=new T;$c.prototype.name="NdnRegexComponentMatcher";s.NdnRegexComponentMatcher=$c;$c.prototype.match=function(c,l,n){this.matchResult_=[];if(""==this.expr_)return this.matchResult_.push(c.get(l)),!0;if(this.isExactMatch_){if(n=c.get(l).toEscapedString().match(this.componentRegex_),null!==n){for(var a=1;a<n.length;++a)this.pseudoMatchers_[a].resetMatchResult(),this.pseudoMatchers_[a].setMatchResult(n[a]);
this.matchResult_.push(c.get(l));return!0}}else throw new T.Error(Error("Non-exact component search is not supported yet"));return!1};$c.prototype.compile_=function(){this.componentRegex_=new RegExp(this.expr_);this.pseudoMatchers_=[];this.pseudoMatchers_.push(new Kc);if(0<=this.expr_.indexOf("\\("))throw new T.Error(Error("Can't count subexpressions in regex with escaped parentheses: "+expr_));for(var c=0,l=0;l<this.expr_.length;++l)"("===this.expr_[l]&&++c;for(l=1;l<=c;++l){var a=new Kc;this.pseudoMatchers_.push(a);
this.backrefManager_.pushRef(a)}};var T=a.NdnRegexMatcherBase,vc=function(c,l){T.call(this,c,T.NdnRegexExprType.COMPONENT_SET,l);this.components_=[];this.isInclusion_=!0;this.compile_()};vc.prototype=new T;vc.prototype.name="NdnRegexComponentSetMatcher";s.NdnRegexComponentSetMatcher=vc;vc.prototype.match=function(c,l,a){isMatched=!1;if(1!==a)return!1;for(var b=0;b<this.components_.length;++b)if(this.components_[b].match(c,l,a)){isMatched=!0;break}this.matchResult_=[];return(this.isInclusion_?isMatched:
!isMatched)?(this.matchResult_.push(c.get(l)),!0):!1};vc.prototype.compile_=function(){if(2>this.expr_.length)throw new T.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));if("<"===this.expr_[0])this.compileSingleComponent_();else if("["===this.expr_[0]){var c=this.expr_.length-1;if("]"!==this.expr_[c])throw new T.Error(Error("Regexp compile error (no matching ']' in "+this.expr_+")"));"^"===this.expr_[1]?(this.isInclusion_=!1,this.compileMultipleComponents_(2,c)):this.compileMultipleComponents_(1,
c)}else throw new T.Error(Error("Regexp compile error (cannot parse "+this.expr_+")"));};vc.prototype.extractComponent_=function(c){for(var l=1,a=0;l>a;){if(c>=this.expr_.length)throw new T.Error(Error("Error: angle brackets mismatch"));"<"===this.expr_[c]?l+=1:">"===this.expr_[c]&&(a+=1);c+=1}return c};vc.prototype.compileSingleComponent_=function(){var c=this.extractComponent_(1);if(this.expr_.length!==c)throw new T.Error(Error("Component expr error "+this.expr_));component=new $c(this.expr_.substring(1,
c-1),this.backrefManager_);this.components_.push(component)};vc.prototype.compileMultipleComponents_=function(c,l){for(var a=c,b=c;a<l;){if("<"!==this.expr_[a])throw new T.Error(Error("Component expr error "+this.expr_));b=a+1;a=this.extractComponent_(b);component=new $c(this.expr_.substring(b,a-1),this.backrefManager_);this.components_.push(component)}if(a!=l)throw new T.Error(Error("Not sufficient expr to parse "+this.expr_));};$c=a.NdnRegexComponentMatcher;T=a.NdnRegexMatcherBase;Pb=function(c,
l){T.call(this,c,T.NdnRegexExprType.PATTERN_LIST,l);this.compile_()};Pb.prototype=new T;Pb.prototype.name="NdnRegexPatternListMatcher";s.NdnRegexPatternListMatcher=Pb;Pb.prototype.compile_=function(){for(var c=this.expr_.length,l=[0],a=l[0];l[0]<c;)if(a=l[0],!this.extractPattern_(a,l))throw new T.Error(Error("Compile error"));};Pb.prototype.extractPattern_=function(c,l){var a=c,b=c,d=c;if("("===this.expr_[c])d=c=this.extractSubPattern_("(",")",c+1),b=this.extractRepetition_(c),d===b?(a=new Jc(this.expr_.substring(a,
b),this.backrefManager_),this.backrefManager_.pushRef(a),a.lateCompile(),this.matchers_.push(a)):this.matchers_.push(new hc(this.expr_.substring(a,b),this.backrefManager_,d-a));else if("<"===this.expr_[c])c+=1,d=c=this.extractSubPattern_("<",">",c),b=this.extractRepetition_(c),this.matchers_.push(new hc(this.expr_.substring(a,b),this.backrefManager_,d-a));else if("["===this.expr_[c])c+=1,d=c=this.extractSubPattern_("[","]",c),b=this.extractRepetition_(c),this.matchers_.push(new hc(this.expr_.substring(a,
b),this.backrefManager_,d-a));else throw new T.Error(Error("Unexpected syntax"));l[0]=b;return!0};Pb.prototype.extractSubPattern_=function(c,l,a){for(var b=1,d=0;b>d;){if(a>=this.expr_.length)throw new T.Error(Error("Parenthesis mismatch"));c==this.expr_[a]&&(b+=1);l==this.expr_[a]&&(d+=1);a+=1}return a};Pb.prototype.extractRepetition_=function(c){var l=this.expr_.length;if(c===l)return c;if("+"==this.expr_[c]||"?"==this.expr_[c]||"*"==this.expr_[c])return++c,c;if("{"==this.expr_[c]){for(;"}"!=this.expr_[c]&&
(++c,c!==l););if(c===l)throw new T.Error(Error("Missing right brace bracket"));++c}return c};var Jc=a.NdnRegexBackrefMatcher,hc=a.NdnRegexRepeatMatcher,b=a.Name,T=a.NdnRegexMatcherBase,Kc=function(){T.call(this,"",T.NdnRegexExprType.PSEUDO)};Kc.prototype=new T;Kc.prototype.name="NdnRegexPseudoMatcher";s.NdnRegexPseudoMatcher=Kc;Kc.prototype.compile_=function(){};Kc.prototype.setMatchResult=function(c){this.matchResult_.push(new b.Component(c))};Kc.prototype.resetMatchResult=function(){this.matchResult_=
[]};T=a.NdnRegexMatcherBase;hc=function(c,l,a){T.call(this,c,T.NdnRegexExprType.REPEAT_PATTERN,l);this.repeatMax_=this.repeatMin_=0;this.indicator_=a;this.compile_()};hc.prototype=new T;hc.prototype.name="NdnRegexRepeatMatcher";s.NdnRegexRepeatMatcher=hc;hc.prototype.match=function(c,l,a){this.matchResult_=[];if(0===this.repeatMin_&&0===a)return!0;if(this.recursiveMatch2_(0,c,l,a)){for(var b=l;b<l+a;++b)this.matchResult_.push(c.get(b));return!0}return!1};hc.prototype.compile_=function(){var c;"("==
this.expr_[0]?(c=new Jc(this.expr_.substring(0,this.indicator_),this.backrefManager_),this.backrefManager_.pushRef(c),c.lateCompile()):c=new vc(this.expr_.substring(0,this.indicator_),this.backrefManager_);this.matchers_.push(c);this.parseRepetition_()};hc.prototype.parseRepetition_=function(){var c=this.expr_.length;if(c===this.indicator_)return this.repeatMax_=this.repeatMin_=1,!0;if(c===this.indicator_+1){if("?"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=1,!0;if("+"==
this.expr_[this.indicator_])return this.repeatMin_=1,this.repeatMax_=32767,!0;if("*"==this.expr_[this.indicator_])return this.repeatMin_=0,this.repeatMax_=32767,!0}else{var c=this.expr_.substring(this.indicator_,c),l=c.length,a=0,b=0;if(null!=c.match(/\{[0-9]+,[0-9]+\}/))separator=c.indexOf(","),a=parseInt(c.substring(1,separator)),b=parseInt(c.substring(separator+1,l-1));else if(null!=c.match(/\{,[0-9]+\}/))separator=c.indexOf(","),a=0,b=parseInt(c.substring(separator+1,l-1));else if(null!=c.match(/\{[0-9]+,\}/))separator=
c.indexOf(","),a=parseInt(c.substring(1,separator)),b=32767;else if(null!=c.match(/\{[0-9]+\}/))b=a=parseInt(c.substring(1,l-1));else throw new T.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Unrecognized format "+this.expr_));if(32767<a||32767<b||a>b)throw new T.Error(Error("Error: RegexRepeatMatcher.ParseRepetition(): Wrong number "+this.expr_));this.repeatMin_=a;this.repeatMax_=b;return!0}return!1};hc.prototype.recursiveMatch2_=function(c,l,a,b){var d=b,g=this.matchers_[0];if(0<b&&
c>=this.repeatMax_||0===b&&c<this.repeatMin_)return!1;if(0==b&&c>=this.repeatMin_)return!0;for(;0<=d;){if(g.match(l,a,d)&&this.recursiveMatch2_(c+1,l,a+d,b-d))return!0;--d}return!1};var Jc=a.NdnRegexBackrefMatcher,vc=a.NdnRegexComponentSetMatcher,b=a.Name,T=a.NdnRegexMatcherBase,uc=a.NdnRegexBackrefManager,Pb=a.NdnRegexPatternListMatcher,fb=function(c,l){T.call(this,c,T.NdnRegexExprType.TOP);void 0==l&&(l="");this.secondaryMatcher_=this.primaryMatcher_=null;this.primaryBackrefManager_=new uc;this.secondaryBackrefManager_=
new uc;this.isSecondaryUsed_=!1;this.expand_=l;this.compile_()};fb.prototype=new T;fb.prototype.name="NdnRegexTopMatcher";s.NdnRegexTopMatcher=fb;fb.prototype.match=function(c,l,a){this.isSecondaryUsed_=!1;this.matchResult_=[];if(this.primaryMatcher_.match(c,0,c.size())){this.matchResult_=[];c=this.primaryMatcher_.getMatchResult();for(l=0;l<c.length;++l)this.matchResult_.push(c[l]);return!0}if(null!=this.secondaryMatcher_&&this.secondaryMatcher_.match(c,0,c.size())){this.matchResult_=[];c=this.secondaryMatcher_.getMatchResult();
for(l=0;l<c.length;++l)this.matchResult_.push(c[l]);return this.isSecondaryUsed_=!0}return!1};fb.prototype.expand=function(c){void 0==c&&(c="");var l=new b,a=this.isSecondaryUsed_?this.secondaryBackrefManager_:this.primaryBackrefManager_,d=a.size();c=""!=c?c:this.expand_;for(var g=[0];g[0]<c.length;){var f=fb.getItemFromExpand_(c,g);"<"==f[0]&&l.append(f.substring(1,f.length-1));if("\\"==f[0])if(f=parseInt(f.substring(1,f.length)),0===f)for(f=0;f<this.matchResult_.length;++f)l.append(this.matchResult_[f]);
else if(f<=d)for(var m=a.getBackref(f-1).getMatchResult(),f=0;f<m.length;++f)l.append(m[f]);else throw new T.Error(Error("Exceeded the range of back reference"));}return l};fb.fromName=function(c,l){void 0==l&&(l=!1);for(var a="^",b=0;b<c.size();++b)a+="<",a+=fb.convertSpecialChar_(c.get(b).toEscapedString()),a+=">";l&&(a+="$");return new fb(a)};fb.prototype.compile_=function(){var c=this.expr_,c="$"!=c[c.length-1]?c+"<.*>*":c.substring(0,c.length-1);"^"!=c[0]?this.secondaryMatcher_=new Pb("<.*>*"+
c,this.secondaryBackrefManager_):c=c.substring(1);this.primaryMatcher_=new Pb(c,this.primaryBackrefManager_)};fb.getItemFromExpand_=function(c,l){var a=l[0];if("\\"==c[l[0]]){++l[0];if(l[0]>=c.length)throw new T.Error(Error("Wrong format of expand string!"));for(;l[0]<c.length&&"9">=c[l[0]]&&"0"<=c[l[0]];)if(++l[0],l[0]>c.length)throw new T.Error(Error("Wrong format of expand string!"));if(l[0]>a+1)return c.substring(a,l[0])}else if("<"==c[l[0]]){++l[0];if(l[0]>=c.length)throw new T.Error(Error("Wrong format of expand string!"));
for(var b=1,d=0;d<b;)if("<"==c[l[0]]&&++b,">"==c[l[0]]&&++d,++l[0],l[0]>=c.length)throw new T.Error(Error("Wrong format of expand string!"));return c.substring(a,l[0])}throw new T.Error(Error("Wrong format of expand string!"));};fb.convertSpecialChar_=function(c){newStr="";for(var l=0;l<c.length;++l){var a=c[l];if("."==a||"["==a||"{"==a||"}"==a||"("==a||")"==a||"\\"==a||"*"==a||"+"==a||"?"==a||"|"==a||"^"==a||"$"==a)newStr+="\\";newStr+=a}return newStr};var jb=function(){};s.Transport=jb;jb.ConnectionInfo=
function(){};jb.prototype.isLocal=function(c,a,n){n("Transport.isLocal is not implemented")};var Qb=function(){jb.call(this);this.onReceivedObject=this.connectionInfo=this.elementReader=null;var c=this;window.addEventListener("message",function(a){if(a.source==window&&a.data.type&&"FromMicroForwarderStub"==a.data.type)if(a=a.data.object,a.type&&"Buffer"==a.type){if(null!=c.elementReader)c.elementReader.onReceivedData(new f(a.data))}else if(c.onReceivedObject)c.onReceivedObject(a)},!1)};Qb.prototype=
new jb;Qb.prototype.name="MicroForwarderTransport";Qb.ConnectionInfo=function(){jb.ConnectionInfo.call(this)};Qb.ConnectionInfo.prototype=new jb.ConnectionInfo;Qb.ConnectionInfo.prototype.name="MicroForwarderTransport.ConnectionInfo";Qb.ConnectionInfo.prototype.equals=function(c){return null==c?!1:!0};Qb.ConnectionInfo.prototype.toString=function(){return"{}"};Qb.prototype.setOnReceivedObject=function(c){this.onReceivedObject=c};Qb.prototype.isLocal=function(c,a,n){a(!0)};Qb.prototype.connect=function(c,
a,n,b){this.elementReader=new fc(a);this.connectionInfo=c;n()};Qb.prototype.sendObject=function(c){window.postMessage({type:"FromMicroForwarderTransport",object:c},"*")};Qb.prototype.send=function(c){null==this.connectionInfo?console.log("MicroForwarderTransport connection is not established."):this.sendObject(c.toJSON())};var Rb=function(c){jb.call(this);this.connectionInfo=this.elementReader=null;this.onReceivedObject=c;this.port=null};Rb.prototype=new jb;Rb.prototype.name="RuntimePortTransport";
Rb.ConnectionInfo=function(c){jb.ConnectionInfo.call(this);this.port=c};Rb.ConnectionInfo.prototype=new jb.ConnectionInfo;Rb.ConnectionInfo.prototype.name="RuntimePortTransport.ConnectionInfo";Rb.ConnectionInfo.prototype.equals=function(c){return null==c||void 0==c.port?!1:this.port==c.port};Rb.ConnectionInfo.prototype.toString=function(){return"{}"};Rb.prototype.setOnReceivedObject=function(c){this.onReceivedObject=c};Rb.prototype.isLocal=function(c,a,n){a(!0)};Rb.prototype.connect=function(c,a,
n,b){this.elementReader=new fc(a);this.connectionInfo=c;this.port=this.connectionInfo.port;var d=this;this.port.onMessage.addListener(function(c){if("Buffer"==c.type)d.elementReader.onReceivedData(f.isBuffer(c.data)?c.data:new f(c.data));else if(null!=d.onReceivedObject)d.onReceivedObject(c)});this.port.onDisconnect.addListener(function(){d.port=null;null!=b&&b()});n()};Rb.prototype.sendObject=function(c){null==this.port?console.log("RuntimePortTransport connection is not established."):this.port.postMessage(c)};
Rb.prototype.send=function(c){this.sendObject(c.toJSON())};var fc=a.ElementReader,d=a.Log.LOG,jb=a.Transport,V,nb=function l(){jb.call(this);if(!WebSocket)throw Error("WebSocket support is not available on this platform.");this.elementReader=this.connectionInfo=this.ws=null;this.defaultGetConnectionInfo=V.makeShuffledHostGetConnectionInfo("A.ws.ndn.ucla.edu B.ws.ndn.ucla.edu C.ws.ndn.ucla.edu D.ws.ndn.ucla.edu E.ws.ndn.ucla.edu F.ws.ndn.ucla.edu G.ws.ndn.ucla.edu H.ws.ndn.ucla.edu I.ws.ndn.ucla.edu J.ws.ndn.ucla.edu K.ws.ndn.ucla.edu L.ws.ndn.ucla.edu M.ws.ndn.ucla.edu N.ws.ndn.ucla.edu".split(" "),
9696,function(a,b){return new l.ConnectionInfo(a,b)})};nb.prototype=new jb;nb.prototype.name="WebSocketTransport";nb.importFace=function(a){V=a};s.WebSocketTransport=nb;nb.ConnectionInfo=function(a,n){jb.ConnectionInfo.call(this);this.host=a;this.port=void 0!==n?n:9696};nb.ConnectionInfo.prototype=new jb.ConnectionInfo;nb.ConnectionInfo.prototype.name="WebSocketTransport.ConnectionInfo";nb.ConnectionInfo.prototype.equals=function(a){return null==a||void 0==a.host||void 0==a.port?!1:this.host==a.host&&
this.port==a.port};nb.ConnectionInfo.prototype.toString=function(){return this.hostIsUri()?"{ uri: "+this.host+" }":"{ host: "+this.host+", port: "+this.port+" }"};nb.ConnectionInfo.prototype.hostIsUri=function(){return"ws:"==this.host.substr(0,3)||"wss:"==this.host.substr(0,4)};nb.prototype.isLocal=function(a,n,b){n(!1)};nb.prototype.connect=function(a,n,b,g){this.close();var m=a.hostIsUri()?a.host:"ws://"+a.host+":"+a.port;this.ws=new WebSocket(m);0<d&&console.log("ws connection created.");this.connectionInfo=
a;this.ws.binaryType="arraybuffer";this.elementReader=new fc(n);var r=this;this.ws.onmessage=function(a){a=a.data;if(null==a||void 0==a||""==a)console.log("INVALID ANSWER");else if(a instanceof ArrayBuffer){a=new f(new Uint8Array(a));3<d&&console.log("BINARY RESPONSE IS "+a.toString("hex"));try{r.elementReader.onReceivedData(a)}catch(l){console.log("NDN.ws.onmessage exception: "+l)}}};this.ws.onopen=function(a){3<d&&console.log(a);3<d&&console.log("ws.onopen: WebSocket connection opened.");3<d&&console.log("ws.onopen: ReadyState: "+
this.readyState);b()};this.ws.onerror=function(a){console.log("ws.onerror: ReadyState: "+this.readyState);console.log(a);console.log("ws.onerror: WebSocket error: "+a.data)};this.ws.onclose=function(a){console.log("ws.onclose: WebSocket connection closed.");r.ws=null;null!=g&&g()}};nb.prototype.connectByFace=function(a,n){this.connect(a.connectionInfo,a,n,function(){a.closeByTransport()})};nb.prototype.send=function(a){if(null!=this.ws){var n=new Uint8Array(a.length);n.set(a);this.ws.send(n.buffer);
3<d&&console.log("ws.send() returned.")}else console.log("WebSocket connection is not established.")};nb.prototype.close=function(){null!=this.ws&&delete this.ws};s.TcpTransport=a.WebSocketTransport;var p=a.Blob,H=a.DataUtils,d=a.Log.LOG,M=a.DecodingException,b=function n(a){if("string"==typeof a)3<d&&console.log("Content Name String "+a),this.components=n.createNameArray(a);else if("object"===typeof a)if(this.components=[],a instanceof n)this.append(a);else for(var b=0;b<a.length;++b)this.append(a[b]);
else null==a?this.components=[]:1<d&&console.log("NO CONTENT NAME GIVEN");this.changeCount=0},Wa={IMPLICIT_SHA256_DIGEST:1,PARAMETERS_SHA256_DIGEST:2,GENERIC:8,OTHER_CODE:32767};s.Name=b;s.ComponentType=Wa;b.Component=function(a,d,g){if("object"===typeof a&&a instanceof b.Component)this.value_=a.value_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_;else{this.value_=a?"object"===typeof a&&"undefined"!==typeof ArrayBuffer&&a instanceof ArrayBuffer?new p(new f(new Uint8Array(a)),!1):"object"===
typeof a&&a instanceof p?a:new p(a):new p([]);if(d===Wa.OTHER_CODE){if(void 0==g)throw Error("To use an other code, call Name.Component(value, ComponentType.OTHER_CODE, otherTypeCode)");if(0>g)throw Error("Name.Component other type code must be non-negative");this.otherTypeCode_=g}else this.otherTypeCode_=-1;this.type_=void 0==d?Wa.GENERIC:d}};b.Component.prototype.getValue=function(){return this.value_};b.Component.prototype.getValueAsBuffer=function(){return this.value_.buf()};b.Component.prototype.getType=
function(){return this.type_};b.Component.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Object.defineProperty(b.Component.prototype,"value",{get:function(){return this.getValueAsBuffer()}});b.Component.prototype.toEscapedString=function(){return this.type_===Wa.IMPLICIT_SHA256_DIGEST?"sha256digest="+this.value_.toHex():this.type_===Wa.PARAMETERS_SHA256_DIGEST?"params-sha256="+this.value_.toHex():(this.type_===Wa.GENERIC?"":(this.type_===Wa.OTHER_CODE?this.otherTypeCode_:this.type_)+
"=")+b.toEscapedString(this.value_.buf())};b.Component.prototype.isSegment=function(){return 1<=this.value_.size()&&0==this.value_.buf()[0]&&this.isGeneric()};b.Component.prototype.isSegmentOffset=function(){return 1<=this.value_.size()&&251==this.value_.buf()[0]&&this.isGeneric()};b.Component.prototype.isVersion=function(){return 1<=this.value_.size()&&253==this.value_.buf()[0]&&this.isGeneric()};b.Component.prototype.isTimestamp=function(){return 1<=this.value_.size()&&252==this.value_.buf()[0]&&
this.isGeneric()};b.Component.prototype.isSequenceNumber=function(){return 1<=this.value_.size()&&254==this.value_.buf()[0]&&this.isGeneric()};b.Component.prototype.isGeneric=function(){return this.type_===Wa.GENERIC};b.Component.prototype.isImplicitSha256Digest=function(){return this.type_===Wa.IMPLICIT_SHA256_DIGEST};b.Component.prototype.isParametersSha256Digest=function(){return this.type_===Wa.PARAMETERS_SHA256_DIGEST};b.Component.prototype.toNumber=function(){return H.bigEndianToUnsignedInt(this.value_.buf())};
b.Component.prototype.toNumberWithMarker=function(a){if(0==this.value_.size()||this.value_.buf()[0]!=a)throw Error("Name component does not begin with the expected marker");return H.bigEndianToUnsignedInt(this.value_.buf().slice(1))};b.Component.prototype.toSegment=function(){return this.toNumberWithMarker(0)};b.Component.prototype.toSegmentOffset=function(){return this.toNumberWithMarker(251)};b.Component.prototype.toVersion=function(){return this.toNumberWithMarker(253)};b.Component.prototype.toTimestamp=
function(){return this.toNumberWithMarker(252)};b.Component.prototype.toSequenceNumber=function(){return this.toNumberWithMarker(254)};b.Component.fromNumber=function(a,d,g){var f=new la(8);f.writeNonNegativeInteger(a);return new b.Component(new p(f.getOutput(),!1),d,g)};b.Component.fromNumberWithMarker=function(a,d){var g=new la(9);g.writeNonNegativeInteger(a);g.writeNonNegativeInteger(d);return new b.Component(new p(g.getOutput(),!1))};b.Component.fromSegment=function(a){return b.Component.fromNumberWithMarker(a,
0)};b.Component.fromSegmentOffset=function(a){return b.Component.fromNumberWithMarker(a,251)};b.Component.fromVersion=function(a){return b.Component.fromNumberWithMarker(a,253)};b.Component.fromTimestamp=function(a){return b.Component.fromNumberWithMarker(a,252)};b.Component.fromSequenceNumber=function(a){return b.Component.fromNumberWithMarker(a,254)};b.Component.fromImplicitSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new M("Name.Component.fromImplicitSha256Digest: The digest length must be 32 bytes");
a=new b.Component(digestBlob);a.type_=Wa.IMPLICIT_SHA256_DIGEST;return a};b.Component.fromParametersSha256Digest=function(a){digestBlob="object"===typeof a&&a instanceof p?a:new p(a,!0);if(32!==digestBlob.size())throw new M("Name.Component.fromParametersSha256Digest: The digest length must be 32 bytes");a=new b.Component(digestBlob);a.type_=Wa.PARAMETERS_SHA256_DIGEST;return a};b.Component.prototype.getSuccessor=function(){for(var a=new f(this.value_.size()+1),d=!0,g=this.value_.size()-1;0<=g;--g)d?
(a[g]=this.value_.buf()[g]+1&255,d=0===a[g]):a[g]=this.value_.buf()[g];d?a[a.length-1]=0:a=a.slice(0,this.value_.size());return new b.Component(new p(a,!1),this.type_,this.otherTypeCode_)};b.Component.prototype.equals=function(a){return"object"===typeof a&&a instanceof b.Component?this.type_===Wa.OTHER_CODE?this.value_.equals(a.value_)&&a.type_===Wa.OTHER_CODE&&this.otherTypeCode_==a.otherTypeCode_:this.value_.equals(a.value_)&&this.type_===a.type_:!1};b.Component.prototype.compare=function(a){var d=
this.type_===Wa.OTHER_CODE?this.otherTypeCode_:this.type_,g=a.type_===Wa.OTHER_CODE?a.otherTypeCode_:a.type_;return d<g?-1:d>g?1:b.Component.compareBuffers(this.value_.buf(),a.value_.buf())};b.Component.compareBuffers=function(a,b){if(a.length<b.length)return-1;if(a.length>b.length)return 1;for(var d=0;d<a.length;++d){if(a[d]<b[d])return-1;if(a[d]>b[d])return 1}return 0};b.prototype.getName=function(){return this.toUri()};b.createNameArray=function(a){a=a.trim();if(0>=a.length)return[];var d=a.indexOf(":");
if(0<=d){var g=a.indexOf("/");if(0>g||d<g)a=a.substr(d+1,a.length-d-1).trim()}if("/"==a[0])if(2<=a.length&&"/"==a[1]){d=a.indexOf("/",2);if(0>d)return[];a=a.substr(d+1,a.length-d-1).trim()}else a=a.substr(1,a.length-1).trim();d=a.split("/");for(g=0;g<d.length;++g){var m=d[g];if("sha256digest="==m.substr(0,13))m=m.substr(13).trim(),m=b.Component.fromImplicitSha256Digest(new p(new f(m,"hex")),!1);else if("params-sha256="==m.substr(0,14))m=m.substr(14).trim(),m=b.Component.fromParametersSha256Digest(new p(new f(m,
"hex")),!1);else{var r=Wa.GENERIC,q=-1,C=m.indexOf("=");if(0<=C){r=m.substring(0,C);q=parseInt(r);if(isNaN(q))throw Error("Can't parse decimal Name Component type: "+r+" in URI "+a);r=q==Wa.GENERIC||q==Wa.IMPLICIT_SHA256_DIGEST||q==Wa.PARAMETERS_SHA256_DIGEST?q:Wa.OTHER_CODE;m=m.substring(C+1)}m=new b.Component(b.fromEscapedString(m),r,q)}m.getValue().isNull()?(d.splice(g,1),--g):d[g]=m}return d};b.prototype.set=function(a){this.components=b.createNameArray(a);++this.changeCount};b.prototype.append=
function(a,d,g){if("object"==typeof a&&a instanceof b)for(a=a==this?this.components.slice(0,this.components.length):a.components,d=0;d<a.length;++d)this.components.push(new b.Component(a[d]));else"object"===typeof a&&a instanceof b.Component?this.components.push(a):this.components.push(new b.Component(a,d,g));++this.changeCount;return this};b.prototype.add=function(a){return this.append(a)};b.prototype.clear=function(){this.components=[];++this.changeCount};b.prototype.toUri=function(a){if(0==this.size())return a?
"ndn:/":"/";a=a?"ndn:":"";for(var b=0;b<this.size();++b)a+="/"+this.components[b].toEscapedString();return a};b.prototype.to_uri=function(){return this.toUri()};b.prototype.toString=function(){return this.toUri()};b.prototype.appendSegment=function(a){return this.append(b.Component.fromSegment(a))};b.prototype.appendSegmentOffset=function(a){return this.append(b.Component.fromSegmentOffset(a))};b.prototype.appendVersion=function(a){return this.append(b.Component.fromVersion(a))};b.prototype.appendTimestamp=
function(a){return this.append(b.Component.fromTimestamp(a))};b.prototype.appendSequenceNumber=function(a){return this.append(b.Component.fromSequenceNumber(a))};b.prototype.appendImplicitSha256Digest=function(a){return this.append(b.Component.fromImplicitSha256Digest(a))};b.prototype.appendParametersSha256Digest=function(a){return this.append(b.Component.fromParametersSha256Digest(a))};b.prototype.addSegment=function(a){return this.appendSegment(a)};b.prototype.getSubName=function(a,d){0>a&&(a=this.components.length-
-a);void 0==d&&(d=this.components.length-a);for(var g=new b,f=a+d,m=a;m<f&&m<this.components.length;++m)g.components.push(this.components[m]);return g};b.prototype.getPrefix=function(a){return 0>a?this.getSubName(0,this.components.length+a):this.getSubName(0,a)};b.prototype.cut=function(a){return new b(this.components.slice(0,this.components.length-a))};b.prototype.size=function(){return this.components.length};b.prototype.get=function(a){if(0<=a){if(a>=this.components.length)throw Error("Name.get: Index is out of bounds");
return this.components[a]}if(a<-this.components.length)throw Error("Name.get: Index is out of bounds");return this.components[this.components.length- -a]};b.prototype.getComponentCount=function(){return this.components.length};b.prototype.getComponent=function(a){return new f(this.components[a].getValue().buf())};b.prototype.indexOfFileName=function(){for(var a=this.size()-1;0<=a;--a){var b=this.components[a].getValue().buf();if(!(0>=b.length||0==b[0]||192==b[0]||193==b[0]||245<=b[0]&&255>=b[0]))return a}return-1};
b.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeName(this)};b.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeName(this,a.buf(),!1):b.decodeName(this,a,!0)};b.prototype.compare=function(a,d,g,f,m){a instanceof b&&(g=a,a=0,d=this.size());void 0==f&&(f=0);void 0==m&&(m=g.size());0>a&&(a=this.size()- -a);0>f&&(f=g.size()- -f);d=Math.min(d,this.size()-a);m=Math.min(m,g.size()-f);for(var r=Math.min(d,m),q=0;q<
r;++q){var p=this.components[a+q].compare(g.components[f+q]);if(0!=p)return p}return d<m?-1:d>m?1:0};b.prototype.equals=function(a){if(this.components.length!=a.components.length)return!1;for(var b=this.components.length-1;0<=b;--b)if(!this.components[b].equals(a.components[b]))return!1;return!0};b.prototype.equalsName=function(a){return this.equals(a)};b.prototype.getContentDigestValue=function(){for(var a=this.size()-1;0<=a;--a){var d=b.getComponentContentDigestValue(this.components[a]);if(null!=
d)return d}return null};b.getComponentContentDigestValue=function(a){"object"==typeof a&&a instanceof b.Component&&(a=a.getValue().buf());return a.length==b.ContentDigestPrefix.length+32+b.ContentDigestSuffix.length&&H.arraysEqual(a.slice(0,b.ContentDigestPrefix.length),b.ContentDigestPrefix)&&H.arraysEqual(a.slice(a.length-b.ContentDigestSuffix.length,a.length),b.ContentDigestSuffix)?a.slice(b.ContentDigestPrefix.length,b.ContentDigestPrefix.length+32):null};b.ContentDigestPrefix=new f([193,46,77,
46,71,193,1,170,2,133]);b.ContentDigestSuffix=new f([0]);b.toEscapedString=function(a){"object"==typeof a&&a instanceof b.Component?a=a.getValue().buf():"object"===typeof a&&a instanceof p&&(a=a.buf());for(var d="",g=!1,f=0;f<a.length;++f)if(46!=a[f]){g=!0;break}if(g)for(f=0;f<a.length;++f)g=a[f],d=48<=g&&57>=g||65<=g&&90>=g||97<=g&&122>=g||43==g||45==g||46==g||95==g?d+String.fromCharCode(g):d+("%"+(16>g?"0":"")+g.toString(16).toUpperCase());else for(d="...",f=0;f<a.length;++f)d+=".";return d};b.fromEscapedString=
function(a){a=unescape(a.trim());return null==a.match(/[^.]/)?2>=a.length?new p:new p(H.toNumbersFromString(a.substr(3,a.length-3)),!1):new p(H.toNumbersFromString(a),!1)};b.fromEscapedStringAsBuffer=function(a){return b.fromEscapedString(a).buf()};b.prototype.getSuccessor=function(){return 0==this.size()?new b("/sha256digest=0000000000000000000000000000000000000000000000000000000000000000"):this.getPrefix(-1).append(this.get(-1).getSuccessor())};b.prototype.match=function(a){var b=this.components;
a=a.components;if(b.length>a.length)return!1;for(var d=b.length-1;0<=d;--d)if(!b[d].equals(a[d]))return!1;return!0};b.prototype.isPrefixOf=function(a){return this.match(a)};b.prototype.findParametersSha256Digest=function(){for(var a=-1,b=0;b<this.components.length;++b)if(this.components[b].isParametersSha256Digest()){if(-1!==a)return-2;a=b}return a};b.prototype.getChangeCount=function(){return this.changeCount};var la=a.TlvEncoder,r=a.WireFormat,p=a.Blob,ha=a.ChangeCounter,b=a.Name,Da={KEYNAME:1,
KEY_LOCATOR_DIGEST:2};s.KeyLocatorType=Da;var Y=function Vc(a,d){"object"===typeof a&&a instanceof Vc?(this.type_=a.type_,this.keyName_=new ha(new b(a.getKeyName())),this.keyData_=a.keyData_):(this.type_=d,this.keyName_=new ha(new b),this.keyData_=new p,d==Da.KEYNAME?this.keyName_.set("object"===typeof a&&a instanceof b?new b(a):new b):d==Da.KEY_LOCATOR_DIGEST&&(this.keyData_=new p(a)));this.changeCount_=0};s.KeyLocator=Y;Y.prototype.getType=function(){return this.type_};Y.prototype.getKeyName=function(){return this.keyName_.get()};
Y.prototype.getKeyData=function(){return this.keyData_};Y.prototype.getKeyDataAsBuffer=function(){return this.getKeyData().buf()};Y.prototype.setType=function(a){this.type_=a;++this.changeCount_};Y.prototype.setKeyName=function(a){this.keyName_.set("object"===typeof a&&a instanceof b?new b(a):new b);++this.changeCount_};Y.prototype.setKeyData=function(a){this.keyData_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Y.prototype.clear=function(){this.type_=null;this.keyName_.set(new b);
this.keyData_=new p;++this.changeCount_};Y.prototype.equals=function(a){if(this.type_!=a.type_)return!1;if(this.type_==Da.KEYNAME){if(!this.getKeyName().equals(a.getKeyName()))return!1}else if(this.type_==Da.KEY_LOCATOR_DIGEST&&!this.getKeyData().equals(a.getKeyData()))return!1;return!0};Y.canGetFromSignature=function(a){return a instanceof za||a instanceof Xa||a instanceof cb};Y.getFromSignature=function(a){if(a instanceof za||a instanceof Xa||a instanceof cb)return a.getKeyLocator();throw Error("KeyLocator.getFromSignature: Signature type does not have a KeyLocator");
};Y.prototype.getChangeCount=function(){this.keyName_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(Y.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(Y.prototype,"keyData",{get:function(){return this.getKeyDataAsBuffer()},set:function(a){this.setKeyData(a)}});var za=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,cb=a.HmacWithSha256Signature,b=a.Name,pa={BLOB:0,LINK:1,KEY:2,NACK:3,OTHER_CODE:32767};
s.ContentType=pa;var Ma=function ne(a,b,d,g,f,m){if(b)throw Error("MetaInfo constructor: timestamp support has been removed.");if(g)throw Error("MetaInfo constructor: locator support has been removed.");if("object"===typeof a&&a instanceof ne)this.publisher_=a.publisher_,this.type_=a.type_,this.otherTypeCode_=a.otherTypeCode_,this.freshnessPeriod_=a.freshnessPeriod_,this.finalBlockId_=a.finalBlockId_;else{if(a)throw Error("MetaInfo constructor: publisher support has been removed.");this.type=null==
d||0>d?pa.BLOB:d;this.otherTypeCode_=-1;this.freshnessSeconds=f;this.setFinalBlockId(m)}this.changeCount_=0};s.MetaInfo=Ma;Ma.prototype.getType=function(){return this.type_};Ma.prototype.getOtherTypeCode=function(){return this.otherTypeCode_};Ma.prototype.getFreshnessPeriod=function(){return this.freshnessPeriod_};Ma.prototype.getFinalBlockId=function(){return this.finalBlockId_};Ma.prototype.getFinalBlockID=function(){return this.getFinalBlockId()};Ma.prototype.getFinalBlockIDAsBuffer=function(){return this.finalBlockId_.getValue().buf()};
Ma.prototype.setType=function(a){this.type_=null==a||0>a?pa.BLOB:a;++this.changeCount_};Ma.prototype.setOtherTypeCode=function(a){if(0>a)throw Error("MetaInfo other type code must be non-negative");this.otherTypeCode_=a;++this.changeCount_};Ma.prototype.setFreshnessPeriod=function(a){this.freshnessPeriod_=null==a||0>a?null:a;++this.changeCount_};Ma.prototype.setFinalBlockId=function(a){this.finalBlockId_="object"===typeof a&&a instanceof b.Component?a:new b.Component(a);++this.changeCount_};Ma.prototype.setFinalBlockID=
function(a){this.setFinalBlockId(a)};Ma.prototype.clear=function(){this.type=pa.BLOB;this.otherTypeCode_=-1;this.freshnessSeconds=null;this.finalBlockId_=new b.Component;++this.changeCount_};Ma.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Ma.prototype,"type",{get:function(){return this.getType()},set:function(a){this.setType(a)}});Object.defineProperty(Ma.prototype,"freshnessSeconds",{get:function(){return null==this.freshnessPeriod_||0>this.freshnessPeriod_?
null:this.freshnessPeriod_/1E3},set:function(a){this.freshnessPeriod_=null==a||0>a?null:1E3*a;++this.changeCount_}});Object.defineProperty(Ma.prototype,"finalBlockID",{get:function(){return this.getFinalBlockIDAsBuffer()},set:function(a){this.setFinalBlockId(a)}});var p=a.Blob,ha=a.ChangeCounter,Y=a.KeyLocator,qa=a.ValidityPeriod,Xa=function oe(a){"object"===typeof a&&a instanceof oe?(this.keyLocator_=new ha(new Y(a.getKeyLocator())),this.validityPeriod_=new ha(new qa(a.getValidityPeriod())),this.signature_=
a.signature_):(this.keyLocator_=new ha(new Y),this.validityPeriod_=new ha(new qa),this.signature_=new p);this.changeCount_=0};s.Sha256WithEcdsaSignature=Xa;Xa.prototype.clone=function(){return new Xa(this)};Xa.prototype.getKeyLocator=function(){return this.keyLocator_.get()};Xa.prototype.getValidityPeriod=function(){return this.validityPeriod_.get()};Xa.prototype.getSignature=function(){return this.signature_};Xa.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof
Y?new Y(a):new Y);++this.changeCount_};Xa.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof qa?new qa(a):new qa);++this.changeCount_};Xa.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Xa.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};p=a.Blob;ha=a.ChangeCounter;Y=
a.KeyLocator;qa=a.ValidityPeriod;za=function pe(a){"object"===typeof a&&a instanceof pe?(this.keyLocator_=new ha(new Y(a.getKeyLocator())),this.validityPeriod_=new ha(new qa(a.getValidityPeriod())),this.signature_=a.signature_):(this.keyLocator_=new ha(new Y),this.validityPeriod_=new ha(new qa),this.signature_=new p);this.changeCount_=0};s.Sha256WithRsaSignature=za;za.prototype.clone=function(){return new za(this)};za.prototype.getKeyLocator=function(){return this.keyLocator_.get()};za.prototype.getValidityPeriod=
function(){return this.validityPeriod_.get()};za.prototype.getSignature=function(){return this.signature_};za.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};za.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof Y?new Y(a):new Y);++this.changeCount_};za.prototype.setValidityPeriod=function(a){this.validityPeriod_.set("object"===typeof a&&a instanceof qa?new qa(a):new qa);++this.changeCount_};za.prototype.setSignature=function(a){this.signature_=
"object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};za.prototype.getChangeCount=function(){var a=this.keyLocator_.checkChanged();(a=this.validityPeriod_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};Object.defineProperty(za.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(za.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});
var p=a.Blob,Gb=function qe(a){"object"===typeof a&&a instanceof qe?(this.signature_=a.signature_,this.signatureInfoEncoding_=a.signatureInfoEncoding_,this.typeCode_=a.typeCode_):(this.signature_=new p,this.signatureInfoEncoding_=new p,this.typeCode_=null);this.changeCount_=0};s.GenericSignature=Gb;Gb.prototype.clone=function(){return new Gb(this)};Gb.prototype.getSignature=function(){return this.signature_};Gb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};Gb.prototype.getSignatureInfoEncoding=
function(){return this.signatureInfoEncoding_};Gb.prototype.getTypeCode=function(){return this.typeCode_};Gb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};Gb.prototype.setSignatureInfoEncoding=function(a,b){this.signatureInfoEncoding_="object"===typeof a&&a instanceof p?a:new p(a);this.typeCode_=b;++this.changeCount_};Gb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(Gb.prototype,"signature",
{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});p=a.Blob;ha=a.ChangeCounter;Y=a.KeyLocator;cb=function ue(a){"object"===typeof a&&a instanceof ue?(this.keyLocator_=new ha(new Y(a.getKeyLocator())),this.signature_=a.signature_):(this.keyLocator_=new ha(new Y),this.signature_=new p);this.changeCount_=0};s.HmacWithSha256Signature=cb;cb.prototype.clone=function(){return new cb(this)};cb.prototype.getKeyLocator=function(){return this.keyLocator_.get()};cb.prototype.getSignature=
function(){return this.signature_};cb.prototype.getSignatureAsBuffer=function(){return this.signature_.buf()};cb.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof Y?new Y(a):new Y);++this.changeCount_};cb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};cb.prototype.getChangeCount=function(){this.keyLocator_.checkChanged()&&++this.changeCount_;return this.changeCount_};Object.defineProperty(cb.prototype,
"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(cb.prototype,"signature",{get:function(){return this.getSignatureAsBuffer()},set:function(a){this.setSignature(a)}});var p=a.Blob,vb=function re(a){this.signature_="object"===typeof a&&a instanceof re?a.signature_:new p;this.changeCount_=0};s.DigestSha256Signature=vb;vb.prototype.clone=function(){return new vb(this)};vb.prototype.getSignature=function(){return this.signature_};
vb.prototype.setSignature=function(a){this.signature_="object"===typeof a&&a instanceof p?a:new p(a);++this.changeCount_};vb.prototype.getChangeCount=function(){return this.changeCount_};Object.defineProperty(vb.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});var p=a.Blob,Ka=a.SignedBlob,ha=a.ChangeCounter,b=a.Name,za=a.Sha256WithRsaSignature,Ma=a.MetaInfo,ic=a.IncomingFaceId,Lc=a.CongestionMark,r=a.WireFormat,da=a,O=function se(a,d,g){a instanceof
se?(this.name_=new ha(new b(a.getName())),this.metaInfo_=new ha(new Ma(a.getMetaInfo())),this.signature_=new ha(a.getSignature().clone()),this.content_=a.content_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultFullName_=new b(a.defaultFullName_),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_="string"===typeof a?new ha(new b(a)):new ha("object"===typeof a&&a instanceof b?new b(a):new b),"object"===typeof d&&d instanceof Ma?(a=d,d=g):a=null,this.metaInfo_=
new ha("object"===typeof a&&a instanceof Ma?new Ma(a):new Ma),this.content_="object"===typeof d&&d instanceof p?d:new p(d,!0),this.signature_=new ha(new za),this.defaultWireEncoding_=new Ka,this.defaultFullName_=new b,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=0;this.lpPacket_=null};s.Data=O;O.prototype.getName=function(){return this.name_.get()};O.prototype.getMetaInfo=function(){return this.metaInfo_.get()};O.prototype.getSignature=function(){return this.signature_.get()};
O.prototype.getContent=function(){return this.content_};O.prototype.getContentAsBuffer=function(){return this.content_.buf()};O.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Ka,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};O.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};O.prototype.getIncomingFaceId=
function(){var a=null===this.lpPacket_?null:ic.getFirstHeader(this.lpPacket_);return null===a?null:a.getFaceId()};O.prototype.getCongestionMark=function(){var a=null===this.lpPacket_?null:Lc.getFirstHeader(this.lpPacket_);return null===a?0:a.getCongestionMark()};O.prototype.getFullName=function(a){a=a||r.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&0<this.defaultFullName_.size()&&this.getDefaultWireEncodingFormat()==a)return this.defaultFullName_;var d=new b(this.getName()),
g=da.createHash("sha256");g.update(this.wireEncode(a).buf());d.appendImplicitSha256Digest(new p(g.digest(),!1));a==r.getDefaultWireFormat()&&(this.defaultFullName_=d);return d};O.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof b?new b(a):new b);++this.changeCount_;return this};O.prototype.setMetaInfo=function(a){this.metaInfo_.set("object"===typeof a&&a instanceof Ma?new Ma(a):new Ma);++this.changeCount_;return this};O.prototype.setSignature=function(a){this.signature_.set(null==
a?new za:a.clone());++this.changeCount_;return this};O.prototype.setContent=function(a){this.content_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};O.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeData(this),b=new Ka(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==r.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,
r.getDefaultWireFormat());return b};O.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();var d;d="object"===typeof a&&a instanceof p?b.decodeData(this,a.buf(),!1):b.decodeData(this,a,!0);b==r.getDefaultWireFormat()?this.setDefaultWireEncoding(new Ka(new p(a,!0),d.signedPortionBeginOffset,d.signedPortionEndOffset),r.getDefaultWireFormat()):this.setDefaultWireEncoding(new Ka,null)};O.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};O.prototype.getChangeCount=function(){var a=
this.name_.checkChanged(),a=this.metaInfo_.checkChanged()||a;(a=this.signature_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};O.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(O.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(O.prototype,"metaInfo",{get:function(){return this.getMetaInfo()},
set:function(a){this.setMetaInfo(a)}});Object.defineProperty(O.prototype,"signature",{get:function(){return this.getSignature()},set:function(a){this.setSignature(a)}});Object.defineProperty(O.prototype,"content",{get:function(){return this.getContentAsBuffer()},set:function(a){this.setContent(a)}});L.prototype=Error();L.prototype.name="SecurityException";s.SecurityException=L;cc.prototype=new L;cc.prototype.name="UnrecognizedKeyFormatException";s.UnrecognizedKeyFormatException=cc;w.prototype=new L;
w.prototype.name="UnrecognizedDigestAlgorithmException";s.UnrecognizedDigestAlgorithmException=w;Ib.prototype=Error();Ib.prototype.name="InvalidArgumentException";s.InvalidArgumentException=Ib;var ga=function(){};s.KeyType=ga;ga.RSA=0;ga.EC=1;ga.ECDSA=1;ga.AES=128;var Yd=function(){};s.KeyClass=Yd;Yd.PUBLIC=1;Yd.PRIVATE=2;Yd.SYMMETRIC=3;var Na=function(){};s.DigestAlgorithm=Na;Na.SHA256=1;var da=a,z=a.Interest,r=a.WireFormat,la=a.TlvEncoder,p=a.Blob,Mc=function(){this.lastUsedTimestamp_=Math.round((new Date).getTime());
this.nowOffsetMilliseconds_=0};s.CommandInterestPreparer=Mc;Mc.prototype.prepareCommandInterestName=function(a,b){void 0==b&&r.getDefaultWireFormat();for(var d=(new Date).getTime()+this.nowOffsetMilliseconds_,d=Math.round(d);d<=this.lastUsedTimestamp_;)d+=1;this.lastUsedTimestamp_=d;var g=new la(8);g.writeNonNegativeInteger(d);a.getName().append(new p(g.getOutput(),!1));a.getName().append(new p(da.randomBytes(8),!1))};Mc.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=
a};var z=a.Interest,r=a.WireFormat,S=a.SigningInfo,Mc=a.CommandInterestPreparer,Sb=function(a){Mc.call(this);this.keyChain_=a};Sb.prototype=new Mc;Sb.prototype.name="CommandInterestSigner";s.CommandInterestSigner=Sb;Sb.POS_SIGNATURE_VALUE=-1;Sb.POS_SIGNATURE_INFO=-2;Sb.POS_NONCE=-3;Sb.POS_TIMESTAMP=-4;Sb.MINIMUM_SIZE=4;Sb.prototype.makeCommandInterest=function(a,b,d,g,f){var m=b,q=d,Va=g;b=m instanceof S?m:void 0;d=m instanceof r?m:q instanceof r?q:void 0;"function"===typeof m?(g=m,f=q):"function"===
typeof q?(g=q,f=Va):"function"===typeof Va?g=Va:f=g=void 0;void 0==b&&(b=new S);void 0==d&&(d=r.getDefaultWireFormat());a=new z(a);this.prepareCommandInterestName(a,d);return this.keyChain_.sign(a,b,d,g,f)};var gb=function(){};s.KeyIdType=gb;gb.USER_SPECIFIED=0;gb.SHA256=1;gb.RANDOM=2;var b=a.Name,gb=a.KeyIdType,ga=a.KeyType,ob=function(a,d){this.keyType_=a;if(d instanceof b.Component){if(0==d.getValue().size())throw Error("KeyParams: keyId is empty");this.keyIdType_=gb.USER_SPECIFIED;this.keyId_=
d}else{if(d==gb.USER_SPECIFIED)throw Error("KeyParams: KeyIdType is USER_SPECIFIED");this.keyIdType_=d;this.keyId_=new b.Component}};s.KeyParams=ob;ob.prototype.getKeyType=function(){return this.keyType_};ob.prototype.getKeyIdType=function(){return this.keyIdType_};ob.prototype.getKeyId=function(){return this.keyId_};ob.prototype.setKeyId=function(a){this.keyId_=a};var Nc=function Dd(a,d){if(a instanceof b.Component)ob.call(this,Dd.getType(),a),this.size_=void 0==d?Dd.getDefaultSize():d;else if(void 0!=
a){var g=void 0!=d?d:gb.RANDOM;ob.call(this,Dd.getType(),g);this.size_=a}else ob.call(this,Dd.getType(),gb.RANDOM),this.size_=Dd.getDefaultSize()};Nc.prototype=new ob;Nc.prototype.name="RsaKeyParams";s.RsaKeyParams=Nc;Nc.prototype.getKeySize=function(){return this.size_};Nc.getDefaultSize=function(){return 2048};Nc.getType=function(){return ga.RSA};var wc=function Ed(a,d){if(a instanceof b.Component)ob.call(this,Ed.getType(),a),this.size_=void 0==d?Ed.getDefaultSize():d;else if(void 0!=a){var g=void 0!=
d?d:gb.RANDOM;ob.call(this,Ed.getType(),g);this.size_=a}else ob.call(this,Ed.getType(),gb.RANDOM),this.size_=Ed.getDefaultSize()};wc.prototype=new ob;wc.prototype.name="EcKeyParams";s.EcKeyParams=wc;wc.prototype.getKeySize=function(){return this.size_};wc.getDefaultSize=function(){return 256};wc.getType=function(){return ga.EC};var Gd=function(a,b){wc.call(this,a,b)};Gd.prototype=new wc;Gd.prototype.name="EcdsaKeyParams";s.EcdsaKeyParams=Gd;Gd.getDefaultSize=function(){return wc.getDefaultSize()};
Gd.getType=function(){return wc.getType()};var td=function Fd(a,d){if(a instanceof b.Component)ob.call(this,Fd.getType(),a),this.size_=void 0==d?Fd.getDefaultSize():d;else if(void 0!=a){var g=void 0!=d?d:gb.RANDOM;ob.call(this,Fd.getType(),g);this.size_=a}else ob.call(this,Fd.getType(),gb.RANDOM),this.size_=Fd.getDefaultSize()};td.prototype=new ob;td.prototype.name="AesKeyParams";s.AesKeyParams=td;td.prototype.getKeySize=function(){return this.size_};td.getDefaultSize=function(){return 64};td.getType=
function(){return ga.AES};var b=a.Name,O=a.Data,pa=a.ContentType,za=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,Y=a.KeyLocator,Da=a.KeyLocatorType,r=a.WireFormat,Na=a.DigestAlgorithm,ga=a.KeyType,qa=a.ValidityPeriod,J=a.CertificateV2,g=a.SyncPromise,Oa=a.Tpm,Hb=a.TpmBackEndMemory,p=a.Blob,m=a.Tlv,la=a.TlvEncoder,ja=a.TlvDecoder,ab=a.TlvWireFormat,Ya=a.PublicKey,xc=function te(a,d,Va,aa,Kb,g){a instanceof b?(void 0==Kb&&(Kb=Na.SHA256),void 0==g&&(g=r.getDefaultWireFormat()),this.certificate_=
te.makeSelfSignedCertificate_(a,d,Va,aa,Kb,g),this.privateKeyBag_=d):a instanceof O?(this.certificate_=new O(a),this.privateKeyBag_=d):this.wireDecode(a)};s.SafeBag=xc;xc.prototype.getCertificate=function(){return this.certificate_};xc.prototype.getPrivateKeyBag=function(){return this.privateKeyBag_};xc.prototype.wireDecode=function(a){"object"===typeof a&&a instanceof p&&(a=a.buf());a=new ja(a);var b=a.readNestedTlvsStart(m.SafeBag_SafeBag),d=a.getOffset(),Va=a.readNestedTlvsStart(m.Data);a.seek(Va);
this.certificate_=new O;this.certificate_.wireDecode(a.getSlice(d,Va),ab.get());this.privateKeyBag_=new p(a.readBlobTlv(m.SafeBag_EncryptedKeyBag),!0);a.finishNestedTlvs(b)};xc.prototype.wireEncode=function(){var a=new la(256),b=a.getLength();a.writeBlobTlv(m.SafeBag_EncryptedKeyBag,this.privateKeyBag_.buf());a.writeBuffer(this.certificate_.wireEncode(ab.get()).buf());a.writeTypeAndLength(m.SafeBag_SafeBag,a.getLength()-b);return new p(a.getOutput(),!1)};xc.makeSelfSignedCertificate_=function(a,d,
f,Va,aa,Kb){var sa=new J,x=(new Date).getTime(),Fa=new b(a);Fa.append("self").appendVersion(x);sa.setName(Fa);sa.getMetaInfo().setType(pa.KEY);sa.getMetaInfo().setFreshnessPeriod(36E5);Fa=new Ya(f);sa.setContent(Fa.getKeyDer());f=new Oa("","",new Hb);g.complete(null,f.importPrivateKeyPromise_(a,d.buf(),Va,!0));if(Fa.getKeyType()==ga.RSA)sa.setSignature(new za);else if(Fa.getKeyType()==ga.EC)sa.setSignature(new Xa);else throw Error("Unsupported key type");d=sa.getSignature();Y.getFromSignature(d).setType(Da.KEYNAME);
Y.getFromSignature(d).setKeyName(a);qa.getFromSignature(d).setPeriod(x,x+63072E7);x=sa.wireEncode(Kb);a=g.complete(null,f.signPromise(x.signedBuf(),a,aa,!0));d.setSignature(a);sa.wireEncode(Kb);return sa};var b=a.Name,tb=a.PibIdentity,ia=a.PibKey,Na=a.DigestAlgorithm,qa=a.ValidityPeriod,S=function Xd(a,Va){this.validityPeriod_=new qa;if(void 0==a)this.reset(Xd.SignerType.NULL),this.digestAlgorithm_=Na.SHA256;else if(a instanceof Xd)this.type_=a.type_,this.name_=new b(a.name_),this.identity_=a.identity_,
this.key_=a.key_,this.digestAlgorithm_=a.digestAlgorithm_,this.validityPeriod_=new qa(a.validityPeriod_);else if("number"===typeof a)this.reset(a),void 0!=Va&&(this.name_=new b(Va)),this.digestAlgorithm_=Na.SHA256;else if(a instanceof tb)this.digestAlgorithm_=Na.SHA256,this.setPibIdentity(a);else if(a instanceof ia)this.digestAlgorithm_=Na.SHA256,this.setPibKey(a);else if("string"===typeof a){if(signingString=a,this.reset(Xd.SignerType.NULL),this.digestAlgorithm_=Na.SHA256,""!=signingString){var aa=
signingString.indexOf(":");if(0>aa)throw Error("Invalid signing string cannot represent SigningInfo");var d=signingString.substring(0,aa),aa=signingString.substring(aa+1);if("id"==d)aa==Xd.getDigestSha256Identity().toUri()?this.setSha256Signing():this.setSigningIdentity(new b(aa));else if("key"==d)this.setSigningKeyName(new b(aa));else if("cert"==d)this.setSigningCertificateName(new b(aa));else throw Error("Invalid signing string scheme");}}else throw Error("SigningInfo: Unrecognized type");};s.SigningInfo=
S;S.SignerType=function(){};S.SignerType.NULL=0;S.SignerType.ID=1;S.SignerType.KEY=2;S.SignerType.CERT=3;S.SignerType.SHA256=4;S.prototype.setSigningIdentity=function(a){this.reset(S.SignerType.ID);this.name_=new b(a);return this};S.prototype.setSigningKeyName=function(a){this.reset(S.SignerType.KEY);this.name_=new b(a);return this};S.prototype.setSigningCertificateName=function(a){this.reset(S.SignerType.CERT);this.name_=new b(a);return this};S.prototype.setSha256Signing=function(){this.reset(S.SignerType.SHA256);
this.digestAlgorithm_=Na.SHA256;return this};S.prototype.setPibIdentity=function(a){this.reset(S.SignerType.ID);null!=a&&(this.name_=a.getName());this.identity_=a;return this};S.prototype.setPibKey=function(a){this.reset(S.SignerType.KEY);null!=a&&(this.name_=a.getName());this.key_=a;return this};S.prototype.getSignerType=function(){return this.type_};S.prototype.getSignerName=function(){return this.name_};S.prototype.getPibIdentity=function(){if(this.type_!=S.SignerType.ID)throw Error("getPibIdentity: The signer type is not SignerType.ID");
return this.identity_};S.prototype.getPibKey=function(){if(this.type_!=S.SignerType.KEY)throw Error("getPibKey: The signer type is not SignerType.KEY");return this.key_};S.prototype.setDigestAlgorithm=function(a){this.digestAlgorithm_=a;return this};S.prototype.getDigestAlgorithm=function(){return this.digestAlgorithm_};S.prototype.setValidityPeriod=function(a){this.validityPeriod_=new qa(a);return this};S.prototype.getValidityPeriod=function(){return this.validityPeriod_};S.prototype.toString=function(){if(this.type_==
S.SignerType.NULL)return"";if(this.type_==S.SignerType.ID)return"id:"+this.getSignerName().toUri();if(this.type_==S.SignerType.KEY)return"key:"+this.getSignerName().toUri();if(this.type_==S.SignerType.CERT)return"cert:"+this.getSignerName().toUri();if(this.type_==S.SignerType.SHA256)return"id:"+S.getDigestSha256Identity().toUri();throw Error("Unknown signer type");};S.getDigestSha256Identity=function(){return new b("/localhost/identity/digest-sha256")};S.prototype.reset=function(a){if(a!=S.SignerType.NULL&&
a!=S.SignerType.ID&&a!=S.SignerType.KEY&&a!=S.SignerType.CERT&&a!=S.SignerType.SHA256)throw Error("SigningInfo: The signerType is not valid");this.type_=a;this.name_=new b;this.key_=this.identity_=null;this.validityPeriod_=new qa};qa=function ve(a,b){this.changeCount_=0;"object"===typeof a&&a instanceof ve?(validityPeriod=a,this.notBefore_=validityPeriod.notBefore_,this.notAfter_=validityPeriod.notAfter_):void 0!=b?(notBefore=a,this.setPeriod(notBefore,b)):this.clear()};s.ValidityPeriod=qa;qa.prototype.hasPeriod=
function(){return!(this.notBefore_===Number.MAX_VALUE&&this.notAfter_===-Number.MAX_VALUE)};qa.prototype.getNotBefore=function(){return this.notBefore_};qa.prototype.getNotAfter=function(){return this.notAfter_};qa.prototype.clear=function(){this.notBefore_=Number.MAX_VALUE;this.notAfter_=-Number.MAX_VALUE;++this.changeCount_};qa.prototype.setPeriod=function(a,b){this.notBefore_=Math.round(1E3*Math.ceil(Math.round(a)/1E3));this.notAfter_=Math.round(1E3*Math.floor(Math.round(b)/1E3));++this.changeCount_;
return this};qa.prototype.isValid=function(a){void 0==a&&(a=Math.round(1E3*Math.ceil(Math.round((new Date).getTime())/1E3)));return this.notBefore_<=a&&a<=this.notAfter_};qa.canGetFromSignature=function(a){return void 0!=a.constructor&&("Sha256WithRsaSignature"===a.constructor.name||"Sha256WithEcdsaSignature"===a.constructor.name)};qa.getFromSignature=function(a){if(void 0==a.constructor||"Sha256WithRsaSignature"!==a.constructor.name&&"Sha256WithEcdsaSignature"!==a.constructor.name)throw Error("ValidityPeriod.getFromSignature: Signature type does not have a ValidityPeriod");
return a.getValidityPeriod()};qa.prototype.getChangeCount=function(){return this.changeCount_};var da=a,g=a.SyncPromise,p=a.Blob,r=a.WireFormat,ga=a.KeyType,Na=a.DigestAlgorithm,Mb=a.UseSubtleCrypto,J=a.CertificateV2,Ya=a.PublicKey,Ia=function(){};s.VerificationHelpers=Ia;Ia.verifySignaturePromise=function(a,b,aa,d,sa){"boolean"===typeof d&&(sa=d,d=void 0);a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());if(!(aa instanceof Ya))try{aa instanceof p||(aa=new p(aa)),aa=new Ya(aa)}catch(x){return g.reject(Error("verifySignaturePromise: Error decoding public key DER: "+
x))}void 0==d&&(d=Na.SHA256);if(d==Na.SHA256)if(aa.getKeyType()==ga.RSA){if(Mb()&&!sa){var f={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};return crypto.subtle.importKey("spki",aa.getKeyDer().buf().buffer,f,!0,["verify"]).then(function(aa){return crypto.subtle.verify(f,aa,b,a)})}try{null===Ia.verifyUsesString_&&Ia.setVerifyUsesString_();for(var m=aa.getKeyDer().buf().toString("base64"),Sa="-----BEGIN PUBLIC KEY-----\n",q=0;q<m.length;q+=64)Sa+=m.substr(q,64)+"\n";var Sa=Sa+"-----END PUBLIC KEY-----",
r=da.createVerify("RSA-SHA256");r.update(a);var C=Ia.verifyUsesString_?b.toString("binary"):b;return g.resolve(r.verify(Sa,C))}catch(s){return g.reject(Error("verifySignaturePromise: Error is RSA verify: "+s))}}else if(aa.getKeyType()==ga.EC)try{null===Ia.verifyUsesString_&&Ia.setVerifyUsesString_();m=aa.getKeyDer().buf().toString("base64");Sa="-----BEGIN PUBLIC KEY-----\n";for(q=0;q<m.length;q+=64)Sa+=m.substr(q,64)+"\n";Sa+="-----END PUBLIC KEY-----";r=da.createVerify("sha256");r.update(a);C=Ia.verifyUsesString_?
b.toString("binary"):b;return g.resolve(r.verify(Sa,C))}catch(A){return g.reject(Error("verifySignaturePromise: Error is ECDSA verify: "+A))}else return g.reject(Error("verifySignaturePromise: Invalid key type"));else return g.reject(Error("verifySignaturePromise: Invalid digest algorithm"))};Ia.verifySignature=function(a,b,aa,d,sa,x){"function"===typeof d&&(x=sa,sa=d,d=void 0);return g.complete(sa,x,this.verifySignaturePromise(a,b,aa,d,!sa))};Ia.verifyDataSignaturePromise=function(a,b,aa,d,sa){var x=
aa,f=d;aa="number"===typeof x?x:void 0;d=x instanceof r?x:f instanceof r?f:void 0;sa="boolean"===typeof x?x:"boolean"===typeof f?f:"boolean"===typeof sa?sa:!1;var m;if(b instanceof J)try{m=b.getPublicKey()}catch(Sa){return g.resolve(!1)}else m=b;b=a.wireEncode(d);return Ia.verifySignaturePromise(b.signedBuf(),a.getSignature().getSignature(),m,aa,sa)};Ia.verifyInterestSignaturePromise=function(a,b,aa,d,sa){var x=aa,f=d;aa="number"===typeof x?x:void 0;d=x instanceof r?x:f instanceof r?f:void 0;sa="boolean"===
typeof x?x:"boolean"===typeof f?f:"boolean"===typeof sa?sa:!1;var m;if(b instanceof J)try{m=b.getPublicKey()}catch(Sa){return g.resolve(!1)}else m=b;void 0==d&&(d=r.getDefaultWireFormat());b=Ia.extractSignature_(a,d);if(null==b)return g.resolve(!1);a=a.wireEncode(d);return Ia.verifySignaturePromise(a.signedBuf(),b.getSignature(),m,aa,sa)};Ia.verifyDigest=function(a,b,aa){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());if(aa==Na.SHA256){aa=da.createHash("sha256");aa.update(a);a=aa.digest();
if(b.length!=a.length)return!1;for(aa=0;aa<b.length;++aa)if(b[aa]!=a[aa])return!1;return!0}throw Error("verifyDigest: Invalid digest algorithm");};Ia.extractSignature_=function(a,b){if(2>a.getName().size())return null;try{return b.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf(),!1)}catch(aa){return null}};Ia.verifyUsesString_=null;Ia.setVerifyUsesString_=function(){var a=da.createHash("sha256").digest();Ia.verifyUsesString_="string"===typeof a};
var Hd=a.constants,da=a,p=a.Blob,q=a.DerNode,L=a.SecurityException,cc=a.UnrecognizedKeyFormatException,ga=a.KeyType,Ea=a.EncryptAlgorithmType,g=a.SyncPromise,Mb=a.UseSubtleCrypto,Na=a.DigestAlgorithm,Ya=function Va(a){if(a){this.keyDer=a;var b=null;try{var d=q.parse(a.buf(),0).getChildren(),b=q.getSequence(d,0).getChildren()[0].toVal()}catch(g){throw new cc(Error("PublicKey.decodeKeyType: Error decoding the public key: "+g.message));}b==Va.RSA_ENCRYPTION_OID?this.keyType=ga.RSA:b==Va.EC_ENCRYPTION_OID&&
(this.keyType=ga.EC)}else this.keyDer=new p,this.keyType=null};s.PublicKey=Ya;Ya.prototype.toDer=function(){return q.parse(this.keyDer.buf())};Ya.prototype.getKeyType=function(){return this.keyType};Ya.prototype.getDigest=function(a){void 0==a&&(a=Na.SHA256);if(a==Na.SHA256)return a=da.createHash("sha256"),a.update(this.keyDer.buf()),new p(a.digest(),!1);throw new L(Error("Wrong format!"));};Ya.prototype.getKeyDer=function(){return this.keyDer};Ya.prototype.encryptPromise=function(a,b,d){"object"===
typeof a&&a instanceof p&&(a=a.buf());if(Mb()&&!d&&b!=Ea.RsaPkcs)return b==Ea.RsaOaep?this.keyType!=ga.RSA?Promise.reject(Error("The key type must be RSA")):crypto.subtle.importKey("spki",this.keyDer.buf(),{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["encrypt"]).then(function(b){return crypto.subtle.encrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported padding scheme"));var sa=this.keyDer.buf().toString("base64");d="-----BEGIN PUBLIC KEY-----\n";
for(var x=0;x<sa.length;x+=64)d+=sa.substr(x,64)+"\n";d+="-----END PUBLIC KEY-----";if(b==Ea.RsaPkcs){if(this.keyType!=ga.RSA)return g.reject(Error("The key type must be RSA"));b=Hd.RSA_PKCS1_PADDING}else if(b==Ea.RsaOaep){if(this.keyType!=ga.RSA)return g.reject(Error("The key type must be RSA"));b=Hd.RSA_PKCS1_OAEP_PADDING}else return g.reject(Error("unsupported padding scheme"));try{return g.resolve(new p(da.publicEncrypt({key:d,padding:b},a),!1))}catch(f){return g.reject(f)}};Ya.prototype.encrypt=
function(a,b){return g.getValue(this.encryptPromise(a,b,!0))};Ya.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";Ya.EC_ENCRYPTION_OID="1.2.840.10045.2.1";var q=a.DerNode,La=a.OID,ad=function(a,b,d){this.extensionId="string"===typeof a?new La(a):a;this.isCritical=b;this.extensionValue=d};s.CertificateExtension=ad;ad.prototype.toDer=function(){var a=new q.DerSequence,b=new q.DerOid(this.extensionId),d=new q.DerBoolean(this.isCritical),g=new q.DerOctetString(this.extensionValue.buf());a.addChild(b);a.addChild(d);
a.addChild(g);a.getSize();return a};ad.prototype.toDerBlob=function(){return this.toDer().encode()};ad.prototype.getOid=function(){return this.extensionId};ad.prototype.getIsCritical=function(){return this.isCritical};ad.prototype.getValue=function(){return this.extensionValue};var p=a.Blob,La=a.OID,q=a.DerNode,ud=function(a,b){this.oid="string"===typeof a?new La(a):a;this.value=b};s.CertificateSubjectDescription=ud;ud.prototype.toDer=function(){var a=new q.DerSequence,b=new q.DerOid(this.oid),d=
new q.DerPrintableString((new p(this.value)).buf());a.addChild(b);a.addChild(d);return a};ud.prototype.getOidString=function(){return this.oid.toString()};ud.prototype.getValue=function(){return this.value};var O=a.Data,pa=a.ContentType,r=a.WireFormat,q=a.DerNode,ga=a.KeyType,Ya=a.PublicKey,ud=a.CertificateSubjectDescription,ad=a.CertificateExtension,va=function(a){void 0!=a?O.call(this,a):O.call(this);this.subjectDescriptionList=[];this.extensionList=[];this.notBefore=Number.MAX_VALUE;this.notAfter=
-Number.MAX_VALUE;this.key=new Ya;void 0!=a&&this.decode()};va.prototype=new O;va.prototype.name="Certificate";s.Certificate=va;va.prototype.encode=function(){var a=this.toDer();this.setContent(a.encode());this.getMetaInfo().setType(pa.KEY)};va.prototype.addSubjectDescription=function(a){this.subjectDescriptionList.push(a)};va.prototype.getSubjectDescriptionList=function(){return this.subjectDescriptionList};va.prototype.addExtension=function(a){this.extensionList.push(a)};va.prototype.getExtensionList=
function(){return this.extensionList};va.prototype.setNotBefore=function(a){this.notBefore=a};va.prototype.getNotBefore=function(){return this.notBefore};va.prototype.setNotAfter=function(a){this.notAfter=a};va.prototype.getNotAfter=function(){return this.notAfter};va.prototype.setPublicKeyInfo=function(a){this.key=a};va.prototype.getPublicKeyInfo=function(){return this.key};va.prototype.getPublicKeyDer=function(){if(this.key.getKeyDer().isNull())throw Error("The public key is not set");return this.key.getKeyDer()};
va.prototype.isTooEarly=function(){return(new Date).getTime()<this.getNotBefore()};va.prototype.isTooLate=function(){return(new Date).getTime()>this.getNotAfter()};va.prototype.isInValidityPeriod=function(a){return this.getSignature().getValidityPeriod().isValid(a)};va.prototype.toDer=function(){var a=new q.DerSequence,b=new q.DerSequence,d=new q.DerGeneralizedTime(this.getNotBefore()),g=new q.DerGeneralizedTime(this.getNotAfter());b.addChild(d);b.addChild(g);a.addChild(b);d=new q.DerSequence;for(b=
0;b<this.subjectDescriptionList.length;++b)d.addChild(this.subjectDescriptionList[b].toDer());a.addChild(d);a.addChild(this.key.toDer());if(0<this.extensionList.length){d=new q.DerSequence;for(b=0;b<this.extensionList.length;++b)d.addChild(this.extensionList[b].toDer());a.addChild(d)}return a};va.prototype.decode=function(){var a=q.parse(this.getContent().buf()).getChildren(),b=q.getSequence(a,0).getChildren();this.notBefore=b[0].toVal();this.notAfter=b[1].toVal();for(var d=q.getSequence(a,1).getChildren(),
b=0;b<d.length;++b){var g=q.getSequence(d,b).getChildren(),x=g[0].toVal(),g=g[1].toVal().buf().toString("binary");this.addSubjectDescription(new ud(x,g))}b=a[2].encode();this.key=new Ya(b);if(3<a.length)for(a=q.getSequence(a,3).getChildren(),b=0;b<a.length;++b)g=q.getSequence(a,b).getChildren(),x=g[0].toVal(),d=g[1].toVal(),g=g[2].toVal(),this.addExtension(new ad(x,d,g))};va.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();O.prototype.wireDecode.call(this,a,b);this.decode()};va.prototype.toString=
function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";var b=va.toIsoString(Math.round(this.getNotBefore())),d=va.toIsoString(Math.round(this.getNotAfter()));a=a+("  NotBefore: "+b+"\n")+("  NotAfter: "+d+"\n");for(b=0;b<this.subjectDescriptionList.length;++b)d=this.subjectDescriptionList[b],a+="Subject Description:\n",a+="  "+d.getOidString()+": "+d.getValue()+"\n";a+="Public key bits:\n";d=this.getPublicKeyDer().buf().toString("base64");for(b=0;b<d.length;b+=
64)a+=d.substring(b,Math.min(b+64,d.length))+"\n";if(0<this.extensionList.length)for(a+="Extensions:\n",b=0;b<this.extensionList.length;++b)d=this.extensionList[b],a+="  OID: "+d.getOid()+"\n",a+="  Is critical: "+(d.getIsCritical()?"Y":"N")+"\n",a+="  Value: "+d.getValue().toHex()+"\n";return a};va.toIsoString=function(a){a=new Date(Math.round(a));return a.getUTCFullYear()+va.to2DigitString(a.getUTCMonth()+1)+va.to2DigitString(a.getUTCDate())+"T"+va.to2DigitString(a.getUTCHours())+va.to2DigitString(a.getUTCMinutes())+
va.to2DigitString(a.getUTCSeconds())};va.to2DigitString=function(a){a=a.toString();return 1===a.length?"0"+a:a};var b=a.Name,g=a.SyncPromise,J=a.CertificateV2,yc=function(a,d,g){this.certificates_={};this.keyName_=new b(a);this.pibImpl_=d;if(null==d)throw Error("The pibImpl is null");this.certificateNameUris_=[];for(var f in g)this.certificateNameUris_.push(g[f].toUri())};s.PibCertificateContainer=yc;yc.makePromise=function(a,b,d){return null==b?g.reject(Error("The pibImpl is null")):b.getCertificatesOfKeyPromise(a,
d).then(function(d){return g.resolve(new yc(a,b,d))})};yc.prototype.size=function(){return this.certificateNameUris_.length};yc.prototype.addPromise=function(a,b){if(!this.keyName_.equals(a.getKeyName()))return g.reject(Error("The certificate name `"+a.getKeyName().toUri()+"` does not match the key name"));var d=a.getName().toUri();0>this.certificateNameUris_.indexOf(d)&&this.certificateNameUris_.push(d);this.certificates_[d]=new J(a);return this.pibImpl_.addCertificatePromise(a,b)};yc.prototype.removePromise=
function(a,b){if(!J.isValidName(a)||!J.extractKeyNameFromCertName(a).equals(this.keyName_))return g.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var d=a.toUri(),f=this.certificateNameUris_.indexOf(d);0<=f&&this.certificateNameUris_.splice(f,1);delete this.certificates_[d];return this.pibImpl_.removeCertificatePromise(a,b)};yc.prototype.getPromise=function(a,b){var d=a.toUri(),f=this.certificates_[d];if(void 0!=f)return g.resolve(new J(f));if(!J.isValidName(a)||
!J.extractKeyNameFromCertName(a).equals(this.keyName_))return g.reject(Error("Certificate name `"+a.toUri()+"` is invalid or does not match key name"));var x=this;return this.pibImpl_.getCertificatePromise(a,b).then(function(a){x.certificates_[d]=a;return g.resolve(new J(a))})};var b=a.Name,tb=a.PibIdentity,Tb=a.PibIdentityImpl,g=a.SyncPromise,jc=function(a,b){this.identities_={};this.pibImpl_=a;if(null==a)throw Error("The pibImpl is null");this.identityNameUris_=[];for(var d in b)this.identityNameUris_.push(b[d].toUri())};
s.PibIdentityContainer=jc;jc.makePromise=function(a,b){return null==a?g.reject(Error("The pibImpl is null")):a.getIdentitiesPromise(b).then(function(b){return g.resolve(new jc(a,b))})};jc.prototype.size=function(){return this.identityNameUris_.length};jc.prototype.addPromise=function(a,b){var d=a.toUri();if(0>this.identityNameUris_.indexOf(d)){var g=this;this.identityNameUris_.push(d);return Tb.makePromise(a,this.pibImpl_,!0,b).then(function(x){g.identities_[d]=x;return g.getPromise(a,b)})}return this.getPromise(a,
b)};jc.prototype.removePromise=function(a,b){var d=a.toUri(),g=this.identityNameUris_.indexOf(d);0<=g&&this.identityNameUris_.splice(g,1);delete this.identities_[d];return this.pibImpl_.removeIdentityPromise(a,b)};jc.prototype.getPromise=function(a,b){var d=a.toUri(),f=this.identities_[d];if(void 0==f){var x=this;return Tb.makePromise(a,this.pibImpl_,!1,b).then(function(a){x.identities_[d]=a;return g.resolve(new tb(a))})}return g.resolve(new tb(f))};jc.prototype.resetPromise=function(a){var b=this;
this.identities_={};return this.pibImpl_.getIdentitiesPromise(a).then(function(a){b.identityNameUris_=[];for(var d in a)b.identityNameUris_.push(a[d].toUri());return g.resolve()})};g=a.SyncPromise;tb=function(a){this.impl_=a};s.PibIdentity=tb;tb.prototype.getName=function(){return this.lock_().getName()};tb.prototype.getKeyPromise=function(a,b){try{return this.lock_().getKeyPromise(a,b)}catch(d){return g.reject(d)}};tb.prototype.getKey=function(a,b,d){return g.complete(b,d,this.getKeyPromise(a,!b))};
tb.prototype.getDefaultKeyPromise=function(a){try{return this.lock_().getDefaultKeyPromise(a)}catch(b){return g.reject(b)}};tb.prototype.getDefaultKey=function(a,b){return g.complete(a,b,this.getDefaultKeyPromise(!a))};tb.prototype.addKeyPromise_=function(a,b,d){try{return this.lock_().addKeyPromise(a,b,d)}catch(f){return g.reject(f)}};tb.prototype.removeKeyPromise_=function(a,b){try{return this.lock_().removeKeyPromise(a,b)}catch(d){return g.reject(d)}};tb.prototype.setDefaultKeyPromise_=function(a,
b,d){try{return this.lock_().setDefaultKeyPromise(a,b,d)}catch(f){return g.reject(f)}};tb.prototype.getKeys_=function(){return this.lock_().keys_};tb.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var g=a.SyncPromise,W=function(){};s.PibImpl=W;W.Error=function(a){if(a)return a.__proto__=W.Error.prototype,a};W.Error.prototype=Error();W.Error.prototype.name="PibImplError";W.prototype.setTpmLocatorPromise=function(a,b){return g.reject(Error("PibImpl.setTpmLocatorPromise is not implemented"))};
W.prototype.getTpmLocatorPromise=function(a){return g.reject(Error("PibImpl.getTpmLocatorPromise is not implemented"))};W.prototype.hasIdentityPromise=function(a,b){return g.reject(Error("PibImpl.hasIdentityPromise is not implemented"))};W.prototype.addIdentityPromise=function(a,b){return g.reject(Error("PibImpl.addIdentityPromise is not implemented"))};W.prototype.removeIdentityPromise=function(a,b){return g.reject(Error("PibImpl.removeIdentityPromise is not implemented"))};W.prototype.clearIdentitiesPromise=
function(a){return g.reject(Error("PibImpl.clearIdentitiesPromise is not implemented"))};W.prototype.getIdentitiesPromise=function(a){return g.reject(Error("PibImpl.getIdentitiesPromise is not implemented"))};W.prototype.setDefaultIdentityPromise=function(a,b){return g.reject(Error("PibImpl.setDefaultIdentityPromise is not implemented"))};W.prototype.getDefaultIdentityPromise=function(a){return g.reject(Error("PibImpl.getDefaultIdentityPromise is not implemented"))};W.prototype.hasKeyPromise=function(a,
b){return g.reject(Error("PibImpl.hasKeyPromise is not implemented"))};W.prototype.addKeyPromise=function(a,b,d,f){return g.reject(Error("PibImpl.addKeyPromise is not implemented"))};W.prototype.removeKeyPromise=function(a,b){return g.reject(Error("PibImpl.removeKeyPromise is not implemented"))};W.prototype.getKeyBitsPromise=function(a,b){return g.reject(Error("PibImpl.getKeyBitsPromise is not implemented"))};W.prototype.getKeysOfIdentityPromise=function(a,b){return g.reject(Error("PibImpl.getKeysOfIdentityPromise is not implemented"))};
W.prototype.setDefaultKeyOfIdentityPromise=function(a,b,d){return g.reject(Error("PibImpl.setDefaultKeyOfIdentityPromise is not implemented"))};W.prototype.getDefaultKeyOfIdentityPromise=function(a,b){return g.reject(Error("PibImpl.getDefaultKeyOfIdentityPromise is not implemented"))};W.prototype.hasCertificatePromise=function(a,b){return g.reject(Error("PibImpl.hasCertificatePromise is not implemented"))};W.prototype.addCertificatePromise=function(a,b){return g.reject(Error("PibImpl.addCertificatePromise is not implemented"))};
W.prototype.addCertificate=function(a,b,d){return g.complete(b,d,this.addCertificatePromise(a,!b))};W.prototype.removeCertificatePromise=function(a,b){return g.reject(Error("PibImpl.removeCertificatePromise is not implemented"))};W.prototype.getCertificatePromise=function(a,b){return g.reject(Error("PibImpl.getCertificatePromise is not implemented"))};W.prototype.getCertificatesOfKeyPromise=function(a,b){return g.reject(Error("PibImpl.getCertificatesOfKeyPromise is not implemented"))};W.prototype.setDefaultCertificateOfKeyPromise=
function(a,b,d){return g.reject(Error("PibImpl.setDefaultCertificateOfKeyPromise is not implemented"))};W.prototype.getDefaultCertificateOfKeyPromise=function(a,b){return g.reject(Error("PibImpl.getDefaultCertificateOfKeyPromise is not implemented"))};var Ja=function(){W.call(this);this.database=new Dexie("pib");this.database.version(1).stores({globals:"key",identities:"identityNameUri",keys:"keyNameUri",certificates:"certificateNameUri"});this.database.open()};Ja.prototype=new W;Ja.prototype.name=
"PibIndexedDb";s.PibIndexedDb=Ja;Ja.getScheme=function(){return"pib-indexeddb"};Ja.prototype.setTpmLocatorPromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.setTpmLocatorPromise is only supported for async"))):this.database.globals.put({key:"tpmLocator",value:a})};Ja.prototype.getTpmLocatorPromise=function(a){return a?Promise.reject(new W.Error(Error("PibIndexedDb.getTpmLocatorPromise is only supported for async"))):this.database.globals.get("tpmLocator").then(function(a){return a?
Promise.resolve(a.value):Promise.resolve("")})};Ja.prototype.hasIdentityPromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.hasIdentityPromise is only supported for async"))):this.database.identities.where("identityNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Ja.prototype.addIdentityPromise=function(a,b){if(b)return Promise.reject(new W.Error(Error("PibIndexedDb.addIdentityPromise is only supported for async")));var d=this;return this.hasIdentityPromise(a).then(function(b){return b?
Promise.resolve():d.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return d.database.globals.get("defaultIdentityUri")}).then(function(b){return b?Promise.resolve():d.setDefaultIdentityPromise(a)})};Ja.prototype.removeIdentityPromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.removeIdentityPromise is only supported for async")));var g=a.toUri(),f=this;return this.database.certificates.each(function(d){J.extractIdentityFromCertName(new b(d.certificateNameUri)).equals(a)&&
f.database.certificates.delete(d.certificateNameUri)}).then(function(){return f.database.keys.each(function(d){ia.extractIdentityFromKeyName(new b(d.keyNameUri)).equals(a)&&f.database.keys.delete(d.keyNameUri)})}).then(function(){return f.database.identities.delete(g)}).then(function(){return f.database.globals.get("defaultIdentityUri")}).then(function(a){return a&&a.value==g?f.database.globals.delete("defaultIdentityUri"):Promise.resolve()})};Ja.prototype.clearIdentitiesPromise=function(a){if(a)return Promise.reject(new W.Error(Error("PibIndexedDb.clearIdentitiesPromise is only supported for async")));
var b=this;return this.database.globals.delete("defaultIdentityUri").then(function(){return b.database.certificates.clear()}).then(function(){return b.database.keys.clear()}).then(function(){return b.database.identities.clear()})};Ja.prototype.getIdentitiesPromise=function(a){if(a)return Promise.reject(new W.Error(Error("PibIndexedDb.getIdentitiesPromise is only supported for async")));var d=[];return this.database.identities.each(function(a){d.push(new b(a.identityNameUri))}).then(function(){return Promise.resolve(d)})};
Ja.prototype.setDefaultIdentityPromise=function(a,b){if(b)return Promise.reject(new W.Error(Error("PibIndexedDb.setDefaultIdentityPromise is only supported for async")));var d=this;return this.hasIdentityPromise(a).then(function(b){return b?Promise.resolve():d.database.identities.put({identityNameUri:a.toUri(),defaultKeyUri:null})}).then(function(){return d.database.globals.put({key:"defaultIdentityUri",value:a.toUri()})})};Ja.prototype.getDefaultIdentityPromise=function(a){return a?Promise.reject(new W.Error(Error("PibIndexedDb.getDefaultIdentityPromise is only supported for async"))):
this.database.globals.get("defaultIdentityUri").then(function(a){return a?Promise.resolve(new b(a.value)):Promise.reject(new ea.Error(Error("No default identity")))})};Ja.prototype.hasKeyPromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.hasKeyPromise is only supported for async"))):this.database.keys.where("keyNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Ja.prototype.addKeyPromise=function(a,d,g,f){if(f)return Promise.reject(new W.Error(Error("PibIndexedDb.addKeyPromise is only supported for async")));
var x=this;return this.addIdentityPromise(a).then(function(){return x.hasKeyPromise(d)}).then(function(a){return a?x.database.keys.update(d.toUri(),{keyDer:g}):x.database.keys.put({keyNameUri:d.toUri(),keyDer:g,defaultCertificateUri:null})}).then(function(){return x.database.identities.get(a.toUri())}).then(function(a){return a&&null!=a.defaultKeyUri?x.hasKeyPromise(new b(a.defaultKeyUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():x.setDefaultKeyOfIdentityPromise(a,d)})};Ja.prototype.removeKeyPromise=
function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.removeKeyPromise is only supported for async")));var g=this;return this.database.certificates.each(function(d){J.extractKeyNameFromCertName(new b(d.certificateNameUri)).equals(a)&&g.database.certificates.delete(d.certificateNameUri)}).then(function(){return g.database.keys.delete(a.toUri())})};Ja.prototype.getKeyBitsPromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.getKeyBitsPromise is only supported for async"))):
this.database.keys.get(a.toUri()).then(function(b){return b?Promise.resolve(new p(b.keyDer)):Promise.reject(new ea.Error(Error("Key `"+a.toUri()+"` does not exist")))})};Ja.prototype.getKeysOfIdentityPromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.getKeysOfIdentityPromise is only supported for async")));var g=[];return this.database.keys.each(function(d){d=new b(d.keyNameUri);ia.extractIdentityFromKeyName(d).equals(a)&&g.push(d)}).then(function(){return Promise.resolve(g)})};
Ja.prototype.setDefaultKeyOfIdentityPromise=function(a,b,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.setDefaultKeyOfIdentityPromise is only supported for async")));var g=this;return this.hasKeyPromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ea.Error(Error("Key `"+b.toUri()+"` does not exist")))}).then(function(){return g.database.identities.update(a.toUri(),{defaultKeyUri:b.toUri()})})};Ja.prototype.getDefaultKeyOfIdentityPromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.getDefaultKeyOfIdentityPromise is only supported for async")));
var g=this;return this.database.identities.get(a.toUri()).then(function(d){if(d){if(null!=d.defaultKeyUri){var aa=new b(d.defaultKeyUri);return g.hasKeyPromise(aa).then(function(b){return b?Promise.resolve(aa):Promise.reject(new ea.Error(Error("No default key for identity `"+a.toUri()+"`")))})}return Promise.reject(new ea.Error(Error("No default key for identity `"+a.toUri()+"`")))}return Promise.reject(new ea.Error(Error("Identity `"+a.toUri()+"` does not exist")))})};Ja.prototype.hasCertificatePromise=
function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.hasCertificatePromise is only supported for async"))):this.database.certificates.where("certificateNameUri").equals(a.toUri()).count().then(function(a){return Promise.resolve(0<a)})};Ja.prototype.addCertificatePromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.addCertificatePromise is only supported for async")));var g=a.getKeyName(),f=g.toUri(),x=this,m=a.getContent();return this.addKeyPromise(a.getIdentity(),
g,m.buf()).then(function(){return x.database.certificates.put({certificateNameUri:a.getName().toUri(),encoding:a.wireEncode().buf()})}).then(function(){return x.database.keys.get(f)}).then(function(a){return a&&null!=a.defaultCertificateUri?x.hasCertificatePromise(new b(a.defaultCertificateUri)):Promise.resolve(!1)}).then(function(b){return b?Promise.resolve():x.setDefaultCertificateOfKeyPromise(g,a.getName())})};Ja.prototype.removeCertificatePromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.removeCertificatePromise is only supported for async"))):
this.database.certificates.delete(a.toUri())};Ja.prototype.getCertificatePromise=function(a,b){return b?Promise.reject(new W.Error(Error("PibIndexedDb.getCertificatePromise is only supported for async"))):this.database.certificates.get(a.toUri()).then(function(b){if(b){var d=new J;d.wireDecode(b.encoding);return Promise.resolve(d)}return Promise.reject(new ea.Error(Error("Certificate `"+a.toUri()+"` does not exit")))})};Ja.prototype.getCertificatesOfKeyPromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.getCertificatesOfKeyPromise is only supported for async")));
var g=[];return this.database.certificates.each(function(d){d=new b(d.certificateNameUri);J.extractKeyNameFromCertName(d).equals(a)&&g.push(d)}).then(function(){return Promise.resolve(g)})};Ja.prototype.setDefaultCertificateOfKeyPromise=function(a,b,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.setDefaultCertificateOfKeyPromise is only supported for async")));var g=this;return this.hasCertificatePromise(b).then(function(a){return a?Promise.resolve():Promise.reject(new ea.Error(Error("Certificate `"+
b.toUri()+"` does not exist")))}).then(function(){return g.database.keys.update(a.toUri(),{defaultCertificateUri:b.toUri()})})};Ja.prototype.getDefaultCertificateOfKeyPromise=function(a,d){if(d)return Promise.reject(new W.Error(Error("PibIndexedDb.getDefaultCertificateOfKeyPromise is only supported for async")));var g=this;return this.database.keys.get(a.toUri()).then(function(d){return d&&null!=d.defaultCertificateUri?g.getCertificatePromise(new b(d.defaultCertificateUri)):Promise.reject(new ea.Error(Error("No default certificate for key `"+
a.toUri()+"`")))})};var b=a.Name,ia=a.PibKey,xb=a.PibKeyImpl,g=a.SyncPromise,zc=function(a,d,g){this.keys_={};this.identityName_=new b(a);this.pibImpl_=d;if(null==d)throw Error("The pibImpl is null");this.keyNameUris_=[];for(var f in g)this.keyNameUris_.push(g[f].toUri())};s.PibKeyContainer=zc;zc.makePromise=function(a,b,d){return null==b?g.reject(Error("The pibImpl is null")):b.getKeysOfIdentityPromise(a,d).then(function(d){return g.resolve(new zc(a,b,d))})};zc.prototype.size=function(){return this.keyNameUris_.length};
zc.prototype.addPromise=function(a,b,d){if(!this.identityName_.equals(ia.extractIdentityFromKeyName(b)))return g.reject(Error("The key name `"+b.toUri()+"` does not match the identity name `"+this.identityName_.toUri()+"`"));var f=b.toUri();0>this.keyNameUris_.indexOf(f)&&this.keyNameUris_.push(f);var x=this;return xb.makePromise(b,a,this.pibImpl_,d).then(function(a){x.keys_[f]=a;return x.getPromise(b,d)})};zc.prototype.removePromise=function(a,b){if(!this.identityName_.equals(ia.extractIdentityFromKeyName(a)))return g.reject(Error("Key name `"+
a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var d=a.toUri(),f=this.keyNameUris_.indexOf(d);0<=f&&this.keyNameUris_.splice(f,1);delete this.keys_[d];return this.pibImpl_.removeKeyPromise(a,b)};zc.prototype.getPromise=function(a,b){if(!this.identityName_.equals(ia.extractIdentityFromKeyName(a)))return g.reject(Error("Key name `"+a.toUri()+"` does not match identity `"+this.identityName_.toUri()+"`"));var d=a.toUri(),f=this.keys_[d];if(void 0==f){var x=this;return xb.makePromise(a,
this.pibImpl_,b).then(function(a){x.keys_[d]=a;return g.resolve(new ia(a))})}return g.resolve(new ia(f))};zc.prototype.getKeyNames=function(){var a=[],d;for(d in this.keys_)a.push(new b(d));return a};b=a.Name;J=a.CertificateV2;g=a.SyncPromise;ia=function(a){this.impl_=a};s.PibKey=ia;ia.prototype.getName=function(){return this.lock_().getName()};ia.prototype.getIdentityName=function(){return this.lock_().getIdentityName()};ia.prototype.getKeyType=function(){return this.lock_().getKeyType()};ia.prototype.getPublicKey=
function(){return this.lock_().getPublicKey()};ia.prototype.getCertificatePromise=function(a,b){try{return this.lock_().getCertificatePromise(a,b)}catch(d){return g.reject(d)}};ia.prototype.getCertificate=function(a,b,d){return g.complete(b,d,this.getCertificatePromise(a,!b))};ia.prototype.getDefaultCertificatePromise=function(a){try{return this.lock_().getDefaultCertificatePromise(a)}catch(b){return g.reject(b)}};ia.prototype.getDefaultCertificate=function(a,b){return g.complete(a,b,this.getDefaultCertificatePromise(!a))};
ia.constructKeyName=function(a,d){var g=new b(a);g.append(J.KEY_COMPONENT).append(d);return g};ia.isValidKeyName=function(a){return a.size()>J.MIN_KEY_NAME_LENGTH&&a.get(-J.MIN_KEY_NAME_LENGTH).equals(J.KEY_COMPONENT)};ia.extractIdentityFromKeyName=function(a){if(!ia.isValidKeyName(a))throw Error("Key name `"+a.toUri()+"` does not follow the naming conventions");return a.getPrefix(-J.MIN_KEY_NAME_LENGTH)};ia.prototype.addCertificatePromise_=function(a,b){return this.lock_().addCertificatePromise(a,
b)};ia.prototype.removeCertificatePromise_=function(a,b){return this.lock_().removeCertificatePromise(a,b)};ia.prototype.setDefaultCertificatePromise_=function(a,b){return this.lock_().setDefaultCertificatePromise(a,b)};ia.prototype.getCertificates_=function(){return this.lock_().certificates_};ia.prototype.lock_=function(){if(null==this.impl_)throw Error("Invalid key instance");return this.impl_};var b=a.Name,p=a.Blob,J=a.CertificateV2,ea=a.Pib,ia=a.PibKey,g=a.SyncPromise,W=a.PibImpl,oa=function(){W.call(this);
this.tpmLocator_="";this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={}};oa.prototype=new W;oa.prototype.name="PibMemory";s.PibMemory=oa;oa.getScheme=function(){return"pib-memory"};oa.prototype.setTpmLocatorPromise=function(a){this.tpmLocator_=a;return g.resolve()};oa.prototype.getTpmLocatorPromise=function(){return g.resolve(this.tpmLocator_)};oa.prototype.hasIdentityPromise=function(a){return g.resolve(this.hasIdentity_(a))};
oa.prototype.hasIdentity_=function(a){for(var b in this.identityNames_)if(this.identityNames_[b].equals(a))return!0;return!1};oa.prototype.addIdentityPromise=function(a){this.addIdentity_(a);return g.resolve()};oa.prototype.addIdentity_=function(a){a=new b(a);this.hasIdentity_(a)||this.identityNames_.push(a);null===this.defaultIdentityName_&&(this.defaultIdentityName_=a)};oa.prototype.removeIdentityPromise=function(a){for(var b=this.identityNames_.length-1;0<=b;--b)this.identityNames_[b].equals(a)&&
this.identityNames_.splice(b,1);null!==this.defaultIdentityName_&&a.equals(this.defaultIdentityName_)&&(this.defaultIdentityName_=null);a=this.getKeysOfIdentity_(a);for(b in a)this.removeKey_(a[b]);return g.resolve()};oa.prototype.clearIdentitiesPromise=function(){this.defaultIdentityName_=null;this.identityNames_=[];this.defaultKeyNames_={};this.keys_={};this.defaultCertificateNames_={};this.certificates_={};return g.resolve()};oa.prototype.getIdentitiesPromise=function(){var a=[],d;for(d in this.identityNames_)a.push(new b(this.identityNames_[d]));
return g.resolve(a)};oa.prototype.setDefaultIdentityPromise=function(a){this.addIdentity_(a);this.defaultIdentityName_=new b(a);return g.resolve()};oa.prototype.getDefaultIdentityPromise=function(){return null!==this.defaultIdentityName_?g.resolve(new b(this.defaultIdentityName_)):g.reject(new ea.Error(Error("No default identity")))};oa.prototype.hasKeyPromise=function(a){return g.resolve(this.hasKey_(a))};oa.prototype.hasKey_=function(a){return a.toUri()in this.keys_};oa.prototype.addKeyPromise=
function(a,b,d){this.addKey_(a,b,d);return g.resolve()};oa.prototype.addKey_=function(a,d,g){this.addIdentity_(a);d=new b(d);this.keys_[d.toUri()]=new p(g,!0);a=a.toUri();a in this.defaultKeyNames_||(this.defaultKeyNames_[a]=d)};oa.prototype.removeKeyPromise=function(a){this.removeKey_(a);return g.resolve()};oa.prototype.removeKey_=function(a){var b=ia.extractIdentityFromKeyName(a);delete this.keys_[a.toUri()];delete this.defaultKeyNames_[b.toUri()];a=this.getCertificatesOfKey_(a);for(var d in a)this.removeCertificate_(a[d])};
oa.prototype.getKeyBitsPromise=function(a){if(!this.hasKey_(a))return g.reject(new ea.Error(Error("Key `"+a.toUri()+"` not found")));a=this.keys_[a.toUri()];return g.resolve(a)};oa.prototype.getKeysOfIdentityPromise=function(a){return g.resolve(this.getKeysOfIdentity_(a))};oa.prototype.getKeysOfIdentity_=function(a){var d=[],g;for(g in this.keys_){var f=new b(g);a.equals(ia.extractIdentityFromKeyName(f))&&d.push(f)}return d};oa.prototype.setDefaultKeyOfIdentityPromise=function(a,d){if(!this.hasKey_(d))return g.reject(new ea.Error(Error("Key `"+
d.toUri()+"` not found")));this.defaultKeyNames_[a.toUri()]=new b(d);return g.resolve()};oa.prototype.getDefaultKeyOfIdentityPromise=function(a){var d=this.defaultKeyNames_[a.toUri()];return void 0==d?g.reject(new ea.Error(Error("No default key for identity `"+a.toUri()+"`"))):g.resolve(new b(d))};oa.prototype.hasCertificatePromise=function(a){return g.resolve(this.hasCertificate_(a))};oa.prototype.hasCertificate_=function(a){return a.toUri()in this.certificates_};oa.prototype.addCertificatePromise=
function(a){var d=new b(a.getName()),f=a.getKeyName(),m=a.getIdentity();this.addKey_(m,f,a.getContent().buf());this.certificates_[d.toUri()]=new J(a);a=f.toUri();a in this.defaultCertificateNames_||(this.defaultCertificateNames_[a]=d);return g.resolve()};oa.prototype.removeCertificatePromise=function(a){this.removeCertificate_(a);return g.resolve()};oa.prototype.removeCertificate_=function(a){delete this.certificates_[a.toUri()];var b=J.extractKeyNameFromCertName(a).toUri(),d=this.defaultCertificateNames_[b];
void 0!=d&&d.equals(a)&&delete this.defaultCertificateNames_[b]};oa.prototype.getCertificatePromise=function(a){return this.hasCertificate_(a)?g.resolve(new J(this.certificates_[a.toUri()])):g.reject(new ea.Error(Error("Certificate `"+a.toUri()+"` does not exist")))};oa.prototype.getCertificatesOfKeyPromise=function(a){return g.resolve(this.getCertificatesOfKey_(a))};oa.prototype.getCertificatesOfKey_=function(a){var d=[],g;for(g in this.certificates_)J.extractKeyNameFromCertName(this.certificates_[g].getName()).equals(a)&&
d.push(new b(g));return d};oa.prototype.setDefaultCertificateOfKeyPromise=function(a,d){if(!this.hasCertificate_(d))return g.reject(new ea.Error(Error("Certificate `"+d.toUri()+"` does not exist")));this.defaultCertificateNames_[a.toUri()]=new b(d);return g.resolve()};oa.prototype.getDefaultCertificateOfKeyPromise=function(a){var b=this.defaultCertificateNames_[a.toUri()];if(void 0==b)return g.reject(new ea.Error(Error("No default certificate for key `"+a.toUri()+"`")));a=this.certificates_[b.toUri()];
return g.resolve(new J(a))};var Id=a.ConfigFile,g=a.SyncPromise,ea=function(a,b,d){this.defaultIdentity_=null;this.scheme_=a;this.location_=b;this.identities_=null;this.pibImpl_=d;this.initializeTpmLocator_=this.initializePibLocator_=this.initializeTpm_=null;this.isInitialized_=this.initializeAllowReset_=!1;if(null==d)throw Error("The pibImpl is null");};s.Pib=ea;ea.Error=function(a){if(a)return a.__proto__=ea.Error.prototype,a};ea.Error.prototype=Error();ea.Error.prototype.name="PibError";ea.prototype.getScheme=
function(){return this.scheme_};ea.prototype.getPibLocator=function(){return this.scheme_+":"+this.location_};ea.prototype.setTpmLocatorPromise=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.doSetTpmLocatorPromise_(a,b)})};ea.prototype.doSetTpmLocatorPromise_=function(a,b){var d=this;return this.pibImpl_.getTpmLocatorPromise(b).then(function(f){return a==f?g.resolve():d.resetPromise_(b).then(function(){return d.pibImpl_.setTpmLocatorPromise(a,b)})})};ea.prototype.getTpmLocatorPromise=
function(a){var b=this;return this.initializePromise_(a).then(function(){return b.pibImpl_.getTpmLocatorPromise(a)}).then(function(a){return""==a?g.reject(new ea.Error(Error("TPM info does not exist"))):g.resolve(a)})};ea.prototype.getIdentityPromise=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.identities_.getPromise(a,b)})};ea.prototype.getIdentity=function(a,b,d){return g.complete(b,d,this.getIdentityPromise(a,!b))};ea.prototype.getDefaultIdentityPromise=function(a){if(null==
this.defaultIdentity_){var b=this;return this.initializePromise_(a).then(function(){return b.pibImpl_.getDefaultIdentityPromise(a)}).then(function(d){return b.identities_.getPromise(d,a)}).then(function(a){b.defaultIdentity_=a;return g.resolve(b.defaultIdentity_)})}return g.resolve(this.defaultIdentity_)};ea.prototype.getDefaultIdentity=function(a,b){return g.complete(a,b,this.getDefaultIdentityPromise(!a))};ea.prototype.resetPromise_=function(a){var b=this;return this.pibImpl_.clearIdentitiesPromise(a).then(function(){return b.pibImpl_.setTpmLocatorPromise("",
a)}).then(function(){b.defaultIdentity_=null;return jc.makePromise(b.pibImpl_,a)}).then(function(d){b.identities_=d;return b.identities_.resetPromise(a)})};ea.prototype.addIdentityPromise_=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.identities_.addPromise(a,b)})};ea.prototype.removeIdentityPromise_=function(a,b){null!=this.defaultIdentity_&&this.defaultIdentity_.getName().equals(a)&&(this.defaultIdentity_=null);var d=this;return this.initializePromise_(b).then(function(){return d.identities_.removePromise(a,
b)})};ea.prototype.setDefaultIdentityPromise_=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.identities_.addPromise(a,b)}).then(function(b){d.defaultIdentity_=b;return d.pibImpl_.setDefaultIdentityPromise(a)}).then(function(){return g.resolve(d.defaultIdentity_)})};ea.prototype.initializePromise_=function(a){if(this.isInitialized_)return g.resolve();var b=this;return jc.makePromise(this.pibImpl_,a).then(function(d){b.identities_=d;return null!=b.initializeTpm_?
b.initializeFromLocatorsPromise_(a):g.resolve()}).then(function(){b.isInitialized_=!0;return g.resolve()})};ea.prototype.initializeFromLocatorsPromise_=function(a){var b=[null],d=[null];y.parseAndCheckPibLocator_(this.initializePibLocator_,b,d);var f=b[0]+":"+d[0],x,m=this;return this.pibImpl_.getTpmLocatorPromise(a).then(function(b){var d=[null],aa=[null];y.parseAndCheckTpmLocator_(m.initializeTpmLocator_,d,aa);x=d[0]+":"+aa[0];var d=!1,Kb;Id&&(Kb=new Id);if(Id&&f==y.getDefaultPibLocator_(Kb))""!=
b&&b!=y.getDefaultTpmLocator_(Kb)&&(d=!0,x=y.getDefaultTpmLocator_(Kb));else if(""!=b&&b!=x)if(m.initializeAllowReset_)d=!0;else return g.reject(new Jd(Error("The supplied TPM locator does not match the TPM locator in the PIB: "+b+" != "+x)));return d?m.resetPromise_(a):g.resolve()}).then(function(){y.setUpTpm_(m.initializeTpm_,x);m.initializeTpm_.isInitialized_=!0;return m.doSetTpmLocatorPromise_(x,a)})};var y=a.KeyChain,Jd=a.LocatorMismatchError,jc=a.PibIdentityContainer,b=a.Name,ea=a.Pib,zc=a.PibKeyContainer,
g=a.SyncPromise,Tb=function(){};s.PibIdentityImpl=Tb;Tb.makePromise=function(a,d,f,m){var x=new Tb;return zc.makePromise(a,d,m).then(function(Fa){x.defaultKey_=null;x.identityName_=new b(a);x.keys_=Fa;x.pibImpl_=d;return null==d?g.reject(Error("The pibImpl is null")):f?d.addIdentityPromise(x.identityName_,m).then(function(){return g.resolve(x)}):d.hasIdentityPromise(x.identityName_,m).then(function(a){return a?g.resolve(x):g.reject(new ea.Error(Error("Identity "+x.identityName_.toUri()+" does not exist")))})})};
Tb.prototype.getName=function(){return this.identityName_};Tb.prototype.addKeyPromise=function(a,b,d){return this.keys_.addPromise(a,b,d)};Tb.prototype.removeKeyPromise=function(a,b){null!==this.defaultKey_&&this.defaultKey_.getName().equals(a)&&(this.defaultKey_=null);return this.keys_.removePromise(a,b)};Tb.prototype.getKeyPromise=function(a,b){return this.keys_.getPromise(a,b)};Tb.prototype.setDefaultKeyPromise=function(a,d,f){var m=this;if(a instanceof b){var x=a,Fa=d;return this.keys_.getPromise(x,
Fa).then(function(a){m.defaultKey_=a;return m.pibImpl_.setDefaultKeyOfIdentityPromise(m.identityName_,x,Fa)}).then(function(){return g.resolve(m.defaultKey_)})}x=d;Fa=f;return this.addKeyPromise(a,x,Fa).then(function(){return m.setDefaultKeyPromise(x,Fa)})};Tb.prototype.getDefaultKeyPromise=function(a){var b=this;return null===this.defaultKey_?this.pibImpl_.getDefaultKeyOfIdentityPromise(this.identityName_,a).then(function(d){return b.keys_.getPromise(d,a)}).then(function(a){b.defaultKey_=a;return g.resolve(b.defaultKey_)}):
g.resolve(this.defaultKey_)};b=a.Name;Ya=a.PublicKey;p=a.Blob;ea=a.Pib;ia=a.PibKey;W=a.PibImpl;yc=a.PibCertificateContainer;g=a.SyncPromise;xb=function(){};s.PibKeyImpl=xb;xb.makePromise=function(a,d,f,m){var x=new xb;x.defaultCertificate_=null;if(d instanceof W){var Fa=d,q=f;return null==Fa?g.reject(Error("The pibImpl is null")):yc.makePromise(a,Fa,q).then(function(d){x.identityName_=ia.extractIdentityFromKeyName(a);x.keyName_=new b(a);x.pibImpl_=Fa;x.certificates_=d;return x.pibImpl_.getKeyBitsPromise(x.keyName_,
q)}).then(function(a){x.keyEncoding_=a;try{publicKey=new Ya(x.keyEncoding_)}catch(b){return g.reject(new ea.Error(Error("Error decoding public key")))}x.keyType_=publicKey.getKeyType();return g.resolve(x)})}Fa=f;q=m;return null==Fa?g.reject(Error("The pibImpl is null")):yc.makePromise(a,Fa,q).then(function(f){x.identityName_=ia.extractIdentityFromKeyName(a);x.keyName_=new b(a);x.keyEncoding_=new p(d,!0);x.pibImpl_=Fa;x.certificates_=f;try{publicKey=new Ya(x.keyEncoding_),x.keyType_=publicKey.getKeyType()}catch(m){return g.reject(Error("Invalid key encoding"))}return x.pibImpl_.addKeyPromise(x.identityName_,
x.keyName_,d,q)}).then(function(){return g.resolve(x)})};xb.prototype.getName=function(){return this.keyName_};xb.prototype.getIdentityName=function(){return this.identityName_};xb.prototype.getKeyType=function(){return this.keyType_};xb.prototype.getPublicKey=function(){return this.keyEncoding_};xb.prototype.addCertificatePromise=function(a,b){return this.certificates_.addPromise(a,b)};xb.prototype.removeCertificatePromise=function(a,b){null!==this.defaultCertificate_&&this.defaultCertificate_.getName().equals(a)&&
(this.defaultCertificate_=null);return this.certificates_.removePromise(a,b)};xb.prototype.getCertificatePromise=function(a,b){return this.certificates_.getPromise(a,b)};xb.prototype.setDefaultCertificatePromise=function(a,d){var f=this,m;return g.resolve().then(function(){return a instanceof b?g.resolve(a):f.addCertificatePromise(a).then(function(){return g.resolve(a.getName())})}).then(function(a){m=a;return f.certificates_.getPromise(m,d)}).then(function(a){f.defaultCertificate_=a;return f.pibImpl_.setDefaultCertificateOfKeyPromise(f.keyName_,
m,d)}).then(function(){return g.resolve(f.defaultCertificate_)})};xb.prototype.getDefaultCertificatePromise=function(a){var b=this;return null===this.defaultCertificate_?this.pibImpl_.getDefaultCertificateOfKeyPromise(this.keyName_,a).then(function(a){b.defaultCertificate_=a;return g.resolve(b.defaultCertificate_)}):g.resolve(b.defaultCertificate_)};var da=a,b=a.Name,p=a.Blob,gb=a.KeyIdType,ia=a.PibKey,Oa=a.Tpm,g=a.SyncPromise,ra=function(){};s.TpmBackEnd=ra;ra.Error=function(a){if(a)return a.__proto__=
ra.Error.prototype,a};ra.Error.prototype=Error();ra.Error.prototype.name="TpmBackEndError";ra.prototype.hasKeyPromise=function(a,b){return this.doHasKeyPromise_(a,b)};ra.prototype.getKeyHandlePromise=function(a,b){return this.doGetKeyHandlePromise_(a,b)};ra.prototype.createKeyPromise=function(a,d,f){var m=this;return g.resolve().then(function(){if(d.getKeyIdType()==gb.USER_SPECIFIED){var x=ia.constructKeyName(a,d.getKeyId());return m.hasKeyPromise(x,f).then(function(a){return a?g.reject(new Oa.Error(Error("Key `"+
x.toUri()+"` already exists"))):g.resolve()})}if(d.getKeyIdType()==gb.SHA256)return g.resolve();if(d.getKeyIdType()==gb.RANDOM){var Fa,q=function(){var d=da.randomBytes(8);Fa=new b.Component(new p(d,!1));d=ia.constructKeyName(a,Fa);return m.hasKeyPromise(d,f).then(function(a){return a?q():g.resolve()})};return q().then(function(){d.setKeyId(Fa);return g.resolve()})}return g.reject(new Oa.Error(Error("Unsupported key id type")))}).then(function(){return m.doCreateKeyPromise_(a,d,f)})};ra.prototype.deleteKeyPromise=
function(a,b){return this.doDeleteKeyPromise_(a,b)};ra.prototype.exportKeyPromise=function(a,b,d){var f=this;return this.hasKeyPromise(a,d).then(function(x){return x?f.doExportKeyPromise_(a,b,d):g.reject(new ra.Error(Error("Key `"+a.toUri()+"` does not exist")))})};ra.prototype.importKeyPromise=function(a,b,d,f){var x=this;return this.hasKeyPromise(a,f).then(function(m){return m?g.reject(new ra.Error(Error("Key `"+a.toUri()+"` already exists"))):x.doImportKeyPromise_(a,b,d,f)})};ra.setKeyName=function(a,
d,g){if(g.getKeyIdType()==gb.USER_SPECIFIED)g=g.getKeyId();else if(g.getKeyIdType()==gb.SHA256)g=da.createHash("sha256"),g.update(a.derivePublicKey().buf()),g=b.Component(new p(g.digest(),!1));else if(g.getKeyIdType()==gb.RANDOM){if(0==g.getKeyId().getValue().size())throw new ra.Error(Error("setKeyName: The keyId is empty for type RANDOM"));g=g.getKeyId()}else throw new ra.Error(Error("setKeyName: unrecognized params.getKeyIdType()"));a.setKeyName(ia.constructKeyName(d,g))};ra.prototype.doHasKeyPromise_=
function(a,b){return g.reject(Error("TpmBackEnd.doHasKeyPromise_ is not implemented"))};ra.prototype.doGetKeyHandlePromise_=function(a,b){return g.reject(Error("TpmBackEnd.doGetKeyHandlePromise_ is not implemented"))};ra.prototype.doCreateKeyPromise_=function(a,b,d){return g.reject(Error("TpmBackEnd.doCreateKeyPromise_ is not implemented"))};ra.prototype.doDeleteKeyPromise_=function(a,b){return g.reject(Error("TpmBackEnd.doDeleteKeyPromise_ is not implemented"))};ra.prototype.doExportKeyPromise_=
function(a,b,d){return g.reject(Error("TpmBackEnd.doExportKeyPromise_ is not implemented"))};ra.prototype.doImportKeyPromise_=function(a,b,d,f){return g.reject(Error("TpmBackEnd.doImportKeyPromise_ is not implemented"))};var g=a.SyncPromise,K=a.TpmPrivateKey,Oc=a.TpmKeyHandleMemory,ra=a.TpmBackEnd,Hb=function(){ra.call(this);this.keys_={}};Hb.prototype=new ra;Hb.prototype.name="TpmBackEndMemory";s.TpmBackEndMemory=Hb;Hb.getScheme=function(){return"tpm-memory"};Hb.prototype.doHasKeyPromise_=function(a,
b){return g.resolve(a.toUri()in this.keys_)};Hb.prototype.doGetKeyHandlePromise_=function(a,b){var d=this.keys_[a.toUri()];return void 0==d?g.resolve(null):g.resolve(new Oc(d))};Hb.prototype.doCreateKeyPromise_=function(a,b,d){var f=this;return K.generatePrivateKeyPromise(b,d).then(function(d){var m=new Oc(d);ra.setKeyName(m,a,b);f.keys_[m.getKeyName().toUri()]=d;return g.resolve(m)},function(a){return g.reject(new ra.Error(Error("Error in TpmPrivateKey.generatePrivateKey: "+a)))})};Hb.prototype.doDeleteKeyPromise_=
function(a,b){delete this.keys_[a.toUri()];return g.resolve()};ra.prototype.doExportKeyPromise_=function(a,b,d){a=a.toUri();if(!(a in this.keys_))return g.reject(new ra.Error(Error("exportKey: The key does not exist")));try{return null!=b?g.resolve(this.keys_[a].toEncryptedPkcs8(b)):g.resolve(this.keys_[a].toPkcs8())}catch(f){return g.reject(new ra.Error(Error("Error in toPkcs8: "+f)))}};Hb.prototype.doImportKeyPromise_=function(a,b,d,f){try{var x=new K;null!=d?x.loadEncryptedPkcs8(b,d):x.loadPkcs8(b);
this.keys_[a.toUri()]=x;return g.resolve()}catch(m){return g.reject(new ra.Error(Error("Cannot import private key: "+m)))}};var b=a.Name,g=a.SyncPromise,Ub=function(){this.keyName_=new b};s.TpmKeyHandle=Ub;Ub.prototype.signPromise=function(a,b,d){return this.doSignPromise_(a,b,d)};Ub.prototype.decryptPromise=function(a,b){return this.doDecryptPromise_(a,b)};Ub.prototype.derivePublicKey=function(a){return this.doDerivePublicKey_(a)};Ub.prototype.setKeyName=function(a){this.keyName_=new b(a)};Ub.prototype.getKeyName=
function(){return this.keyName_};Ub.prototype.doSignPromise_=function(a,b,d){return g.reject(Error("TpmKeyHandle.doSignPromise_ is not implemented"))};Ub.prototype.doDecryptPromise_=function(a,b){return g.reject(Error("TpmKeyHandle.doDecryptPromise_ is not implemented"))};Ub.prototype.doDerivePublicKey_=function(a){return g.reject(Error("TpmKeyHandle.doDerivePublicKey_ is not implemented"))};p=a.Blob;g=a.SyncPromise;Na=a.DigestAlgorithm;K=a.TpmPrivateKey;ra=a.TpmBackEnd;Ub=a.TpmKeyHandle;Oc=function(a){Ub.call(this);
if(null==a)throw Error("The key is null");this.key_=a};Oc.prototype=new Ub;Oc.prototype.name="TpmKeyHandleMemory";s.TpmKeyHandleMemory=Oc;Oc.prototype.doSignPromise_=function(a,b,d){return a==Na.SHA256?this.key_.signPromise(b,a,d).catch(function(a){return g.reject(new ra.Error(Error("Error in TpmPrivateKey.sign: "+a)))}):g.resolve(new p)};Oc.prototype.doDecryptPromise_=function(a,b){return this.key_.decryptPromise(a,b).catch(function(a){return g.reject(new ra.Error(Error("Error in TpmPrivateKey.decrypt: "+
a)))})};Oc.prototype.doDerivePublicKey_=function(){try{return this.key_.derivePublicKey()}catch(a){throw new ra.Error(Error("Error in TpmPrivateKey.derivePublicKey: "+a));}};var Hd=a.constants,da=a,ga=a.KeyType,Ea=a.EncryptAlgorithmType,Na=a.DigestAlgorithm,H=a.DataUtils,g=a.SyncPromise,q=a.DerNode,vd=a.DerNode.DerSequence,Pc=a.DerNode.DerInteger,La=a.OID,p=a.Blob,Mb=a.UseSubtleCrypto,he=null;try{he=a}catch(Ce){}K=function(){this.decryptSubtleKey_=this.subtleKey_=this.privateKey_=this.keyType_=null;
this.encryptionAlgorithm_="des";this.encryptionAlgorithm_+="-ede3-cbc"};s.TpmPrivateKey=K;K.Error=function(a){if(a)return a.__proto__=K.Error.prototype,a};K.Error.prototype=Error();K.Error.prototype.name="TpmPrivateKeyError";K.prototype.loadPkcs1=function(a,b){a instanceof p&&(a=a.buf());if(void 0==b)try{var d=q.parse(a).getChildren();b=9==d.length&&d[0]instanceof Pc&&0==d[0].toVal()&&d[1]instanceof Pc&&d[2]instanceof Pc&&d[3]instanceof Pc&&d[4]instanceof Pc&&d[5]instanceof Pc&&d[6]instanceof Pc&&
d[7]instanceof Pc&&d[8]instanceof Pc?ga.RSA:ga.EC}catch(g){b=ga.EC}if(b==ga.EC){for(var d=a.toString("base64"),f="-----BEGIN EC PRIVATE KEY-----\n",m=0;m<d.length;m+=64)f+=d.substr(m,64)+"\n";this.privateKey_=f+"-----END EC PRIVATE KEY-----"}else if(b==ga.RSA){d=a.toString("base64");f="-----BEGIN RSA PRIVATE KEY-----\n";for(m=0;m<d.length;m+=64)f+=d.substr(m,64)+"\n";this.privateKey_=f+="-----END RSA PRIVATE KEY-----"}else throw new K.Error(Error("loadPkcs1: Unrecognized keyType: "+b));this.keyType_=
b;this.decryptSubtleKey_=this.subtleKey_=null};K.prototype.loadPkcs8=function(a,b){a instanceof p&&(a=a.buf());var d;if(void 0==b){var g;try{var f=q.parse(a),m=f.getChildren();g=q.getSequence(m,1).getChildren()[0].toVal();d=m[2].toVal()}catch(r){try{this.loadPkcs1(a);return}catch(Sa){throw new K.Error(Error("loadPkcs8: Error decoding private key: "+Sa));}}if(g==K.EC_ENCRYPTION_OID)b=ga.EC;else if(g==K.RSA_ENCRYPTION_OID)b=ga.RSA;else throw new K.Error(Error("loadPkcs8: Unrecognized private key OID: "+
g));}else f=q.parse(a),d=f.getChildren()[2].toVal();this.loadPkcs1(d,b)};K.prototype.loadEncryptedPkcs8=function(a,b){a instanceof p&&(a=a.buf());b instanceof p&&(b=b.buf());var d,g,x;try{var m=q.parse(a,0).getChildren(),r=q.getSequence(m,0).getChildren();d=r[0].toVal();g=r[1];x=m[1].toVal()}catch(Sa){throw new K.Error(Error("Cannot decode the PKCS #8 EncryptedPrivateKeyInfo: "+Sa));}var C;if(d==K.PBES2_OID){var s,A,u,La;try{var wb=g.getChildren(),bb=q.getSequence(wb,0).getChildren();s=bb[0].toVal();
A=bb[1];var wd=q.getSequence(wb,1).getChildren();u=wd[0].toVal();La=wd[1]}catch(yb){throw new K.Error(Error("Cannot decode the PBES2 parameters: "+yb));}d=null;if(s==K.PBKDF2_OID){var Pa,Kd;try{var me=A.getChildren();Pa=me[0].toVal();Kd=me[1].toVal()}catch(fc){throw new K.Error(Error("Cannot decode the PBES2 parameters: "+fc));}if(u==K.DES_EDE3_CBC_OID)s=K.DES_EDE3_KEY_LENGTH;else throw new K.Error(Error("Unrecognized PBES2 encryption scheme OID: "+u));try{d=da.pbkdf2Sync(b,Pa.buf(),Kd,s,"sha1")}catch(Ra){throw new K.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+
Ra));}}else throw new K.Error(Error("Unrecognized PBES2 key derivation OID: "+s));if(u==K.DES_EDE3_CBC_OID){var L;try{L=La.toVal()}catch(z){throw new K.Error(Error("Cannot decode the DES-EDE3-CBC parameters: "+z));}try{var y=da.createDecipheriv(this.encryptionAlgorithm_,d,L.buf());C=f.concat([y.update(x.buf()),y.final()])}catch(t){throw new K.Error(Error("Error decrypting PKCS #8 key with DES-EDE3-CBC: "+t));}}else throw new K.Error(Error("Unrecognized PBES2 encryption scheme OID: "+u));}else throw new K.Error(Error("Unrecognized PKCS #8 EncryptedPrivateKeyInfo OID: "+
d));this.loadPkcs8(C)};K.prototype.derivePublicKey=function(){if(this.keyType_!=ga.RSA)throw new K.Error(Error("derivePublicKey: The private key is not loaded"));try{var a=H.privateKeyPemToDer(this.privateKey_),b=q.parse(a,0).getChildren(),d=b[1].getPayload().buf(),g=b[2].getPayload().buf();return K.encodeRsaSubjectPublicKeyInfo(d,g)}catch(f){throw new K.Error(Error("derivePublicKey: Error decoding private key "+f));}};K.encodeRsaSubjectPublicKeyInfo=function(a,b){var d=new q.DerSequence;d.addChild(new q.DerInteger(a));
d.addChild(new q.DerInteger(b));var d=d.encode(),g=new q.DerSequence;g.addChild(new q.DerOid(new La(K.RSA_ENCRYPTION_OID)));g.addChild(new q.DerNull);var f=new q.DerSequence;f.addChild(g);f.addChild(new q.DerBitString(d.buf(),0));return f.encode()};K.prototype.decryptPromise=function(a,b,d){"boolean"===typeof b&&(d=b,b=void 0);void 0==b&&(b=Ea.RsaPkcs);if(null==this.keyType_)return g.reject(new K.Error(Error("decrypt: The private key is not loaded")));if(Mb()&&!d&&b!=Ea.RsaPkcs)return b==Ea.RsaOaep?
this.getDecryptSubtleKeyPromise_().then(function(b){return crypto.subtle.decrypt({name:"RSA-OAEP"},b,a)}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("Unsupported padding scheme"));if(b==Ea.RsaPkcs)b=Hd.RSA_PKCS1_PADDING;else if(b==Ea.RsaOaep)b=Hd.RSA_PKCS1_OAEP_PADDING;else return g.reject(new K.Error(Error("Unsupported padding scheme")));try{return g.resolve(new p(da.privateDecrypt({key:this.privateKey_,padding:b},a),!1))}catch(f){return g.reject(new K.Error(f))}};
K.prototype.signPromise=function(a,b,d){if(null==this.keyType_)return g.resolve(new p);if(b!=Na.SHA256)return g.reject(new K.Error(Error("TpmPrivateKey.sign: Unsupported digest algorithm")));if(Mb()&&!d){var m;if(this.keyType_===ga.RSA)m={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};else return g.reject(new K.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));return this.getSubtleKeyPromise_().then(function(b){return crypto.subtle.sign(m,b,a)}).then(function(a){a=new p(new Uint8Array(a),
!0);return Promise.resolve(a)})}if(this.keyType_===ga.RSA)b=da.createSign("RSA-SHA256");else if(this.keyType===ga.EC)b=da.createSign("sha256");else return g.reject(new K.Error(Error("signPromise: Unrecognized key type "+this.keyType_)));b.update(a);b=new f(H.toNumbersIfString(b.sign(this.privateKey_)));b=new p(b,!1);return g.resolve(b)};K.prototype.toPkcs1=function(){if(null==this.keyType_)throw new K.Error(Error("toPkcs1: The private key is not loaded"));return new p(H.privateKeyPemToDer(this.privateKey_),
!1)};K.prototype.toPkcs8=function(){if(null==this.keyType_)throw new K.Error(Error("toPkcs8: The private key is not loaded"));var a;if(this.keyType_===ga.RSA)a=new La(K.RSA_ENCRYPTION_OID);else if(this.keyType===ga.EC)a=new La(K.EC_ENCRYPTION_OID);else throw new K.Error(Error("toPkcs8: Unrecognized key type "+this.keyType_));return K.encodePkcs8PrivateKey(this.toPkcs1().buf(),a,new q.DerNull)};K.prototype.toEncryptedPkcs8=function(a){if(null==this.keyType_)throw new K.Error(Error("toPkcs8: The private key is not loaded"));
a instanceof p&&(a=a.buf());var b=da.randomBytes(8),d;try{d=da.pbkdf2Sync(a,b,2048,K.DES_EDE3_KEY_LENGTH,"sha1")}catch(g){throw new K.Error(Error("Error computing the derived key using PBKDF2 with HMAC SHA1: "+g));}var x;a=da.randomBytes(8);try{var m=da.createCipheriv(this.encryptionAlgorithm_,d,a);x=f.concat([m.update(this.toPkcs8().buf()),m.final()])}catch(r){throw new K.Error(Error("Error encrypting PKCS #8 key with DES-EDE3-CBC: "+r));}try{var Sa=new vd;Sa.addChild(new q.DerOctetString(b));Sa.addChild(new q.DerInteger(2048));
var C=new vd;C.addChild(new q.DerOid(K.PBKDF2_OID));C.addChild(Sa);var s=new vd;s.addChild(new q.DerOid(K.DES_EDE3_CBC_OID));s.addChild(new q.DerOctetString(a));var A=new vd;A.addChild(C);A.addChild(s);var u=new vd;u.addChild(new q.DerOid(K.PBES2_OID));u.addChild(A);var La=new vd;La.addChild(u);La.addChild(new q.DerOctetString(x));return La.encode()}catch(wb){throw new K.Error(Error("Error encoding the encryped PKCS #8 private key: "+wb));}};K.generatePrivateKeyPromise=function(a,b){if(Mb()&&!b){if(a.getKeyType()===
ga.RSA){var d=null;return crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:a.getKeySize(),publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){d=a.privateKey;return crypto.subtle.exportKey("pkcs8",a.privateKey)}).then(function(a){var b=new K;b.loadPkcs8(new p(new Uint8Array(a),!1),ga.RSA);b.subtleKey_=d;return g.resolve(b)})}return Promise.reject(Error("Cannot generate a key pair of type "+a.getKeyType()))}var f;if(a.getKeyType()===ga.RSA){if(!he)return g.reject(new K.Error(Error("Need to install rsa-keypair: sudo npm install rsa-keypair")));
f=he.generate(a.getKeySize()).privateKey.toString()}else return g.reject(Error("Cannot generate a key pair of type "+a.getKeyType()));var x=new K;x.privateKey_=f;x.keyType_=a.getKeyType();return g.resolve(x)};K.encodePkcs8PrivateKey=function(a,b,d){var g=new q.DerSequence;g.addChild(new q.DerOid(b));g.addChild(d);b=new q.DerSequence;b.addChild(new q.DerInteger(0));b.addChild(g);b.addChild(new q.DerOctetString(a));return b.encode()};K.encodePkcs1PrivateKeyFromRSAKey=function(a){var b=new q.DerSequence;
b.addChild(new q.DerInteger(0));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.n)));b.addChild(new q.DerInteger(a.e));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.d)));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.p)));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.q)));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.dmp1)));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.dmq1)));b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.coeff)));return b.encode()};K.encodePublicKeyFromRSAKey=
function(a){var b=new q.DerSequence;b.addChild(new q.DerInteger(K.bigIntegerToBuffer(a.n)));b.addChild(new q.DerInteger(a.e));a=new q.DerSequence;a.addChild(new q.DerOid(new La(K.RSA_ENCRYPTION_OID)));a.addChild(new q.DerNull);var d=new q.DerSequence;d.addChild(a);d.addChild(new q.DerBitString(b.encode().buf(),0));return d.encode()};K.bigIntegerToBuffer=function(a){a=a.toString(16);if("-"==a.substr(0,1))throw Error("TpmPrivateKey.bigIntegerToBuffer: Negative integers are not currently supported");
1==a.length%2?a="0"+a:a.match(/^[0-7]/)||(a="00"+a);return new f(a,"hex")};K.prototype.getSubtleKeyPromise_=function(){if(this.subtleKey_)return Promise.resolve(this.subtleKey_);if(this.keyType_===ga.RSA){var a=H.privateKeyPemToDer(this.privateKey_),a=K.encodePkcs8PrivateKey(a,new La(K.RSA_ENCRYPTION_OID),new q.DerNull).buf(),b=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]).then(function(a){b.subtleKey_=a;return Promise.resolve(b.subtleKey_)})}return g.reject(new K.Error(Error("Unrecognized key type "+
this.keyType_)))};K.prototype.getDecryptSubtleKeyPromise_=function(){if(this.decryptSubtleKey_)return Promise.resolve(this.decryptSubtleKey_);if(this.keyType_===ga.RSA){var a=H.privateKeyPemToDer(this.privateKey_),a=K.encodePkcs8PrivateKey(a,new La(K.RSA_ENCRYPTION_OID),new q.DerNull).buf(),b=this;return crypto.subtle.importKey("pkcs8",a,{name:"RSA-OAEP",hash:{name:"SHA-1"}},!1,["decrypt"]).then(function(a){b.decryptSubtleKey_=a;return Promise.resolve(b.decryptSubtleKey_)})}return g.reject(new K.Error(Error("Unrecognized key type "+
this.keyType_)))};K.RSA_ENCRYPTION_OID="1.2.840.113549.1.1.1";K.EC_ENCRYPTION_OID="1.2.840.10045.2.1";K.PBES2_OID="1.2.840.113549.1.5.13";K.PBKDF2_OID="1.2.840.113549.1.5.12";K.DES_EDE3_CBC_OID="1.2.840.113549.3.7";K.DES_EDE3_KEY_LENGTH=24;ga=a.KeyType;p=a.Blob;g=a.SyncPromise;Oa=function(a,b,d){this.keys_={};this.scheme_=a;this.location_=b;this.backEnd_=d;this.initializePib_=null;this.isInitialized_=!1};s.Tpm=Oa;Oa.Error=function(a){if(a)return a.__proto__=Oa.Error.prototype,a};Oa.Error.prototype=
Error();Oa.Error.prototype.name="TpmError";Oa.prototype.getTpmLocator=function(){if(!this.isInitialized_)throw new Oa.Error(Error("getTpmLocator: The Tpm is not initialized"));return this.scheme_+":"+this.location_};Oa.prototype.hasKeyPromise=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.backEnd_.hasKeyPromise(a,b)})};Oa.prototype.getPublicKeyPromise=function(a,b){var d=this;return this.initializePromise_(b).then(function(){return d.findKeyPromise_(a,b)}).then(function(a){return null==
a?g.resolve(new p):g.resolve(a.derivePublicKey())})};Oa.prototype.signPromise=function(a,b,d,f){var x=this;return this.initializePromise_(f).then(function(){return x.findKeyPromise_(b,f)}).then(function(b){return null==b?g.resolve(new p):b.signPromise(d,a,f)})};Oa.prototype.decryptPromise=function(a,b,d){var f=this;return this.initializePromise_(d).then(function(){return f.findKeyPromise_(b,d)}).then(function(b){return null==b?g.resolve(new p):b.decryptPromise(a,d)})};Oa.prototype.createKeyPromise_=
function(a,b,d){var f=this;return this.initializePromise_(d).then(function(){return b.getKeyType()==ga.RSA||b.getKeyType()==ga.EC?f.backEnd_.createKeyPromise(a,b,d).then(function(a){var b=a.getKeyName();f.keys_[b.toUri()]=a;return g.resolve(b)}):g.resolve(new Oa.Error(Error("createKey: Unsupported key type")))})};Oa.prototype.deleteKeyPromise_=function(a,b){var d=this;return this.initializePromise_(b).then(function(){delete d.keys_[a.toUri()];return d.backEnd_.deleteKeyPromise(a,b)})};Oa.prototype.exportPrivateKeyPromise_=
function(a,b,d){var g=this;return this.initializePromise_(d).then(function(){return g.backEnd_.exportKeyPromise(a,b,d)})};Oa.prototype.importPrivateKeyPromise_=function(a,b,d,g){var f=this;return this.initializePromise_(g).then(function(){return f.backEnd_.importKeyPromise(a,b,d,g)})};Oa.prototype.findKeyPromise_=function(a,b){var d=this;return this.initializePromise_(b).then(function(){var f=a.toUri(),x=d.keys_[f];return void 0!=x?g.resolve(x):d.backEnd_.getKeyHandlePromise(a,b).then(function(a){return null!=
a?(d.keys_[f]=a,g.resolve(a)):g.resolve(null)})})};Oa.prototype.initializePromise_=function(a){return this.isInitialized_?g.resolve():null==this.initializePib_?(this.isInitialized_=!0,g.resolve()):this.initializePib_.initializePromise_(a)};var b=a.Name,ia=a.PibKey,F=a.ValidationError,Ga=a.ConfigNameRelation,fb=a.NdnRegexTopMatcher,ka=a.ValidatorConfigError,hb=function(){};s.ConfigChecker=hb;hb.prototype.check=function(a,b,d,g){return a?2>b.size()?!1:this.checkNames(b.getPrefix(-2),d,g):this.checkNames(b,
d,g)};hb.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ka(Error("Expected <checker.type>"));if("customized"==b.toLowerCase())return hb.createCustomizedChecker_(a);if("hierarchical"==b.toLowerCase())return hb.createHierarchicalChecker_(a);throw new ka(Error("Unsupported checker type: "+b));};hb.prototype.checkNames=function(a,b,d){throw Error("ConfigChecker.checkNames is not implemented");};hb.createCustomizedChecker_=function(a){keyLocatorSection=a.get("key-locator");if(1!=
keyLocatorSection.length)throw new ka(Error("Expected one <checker.key-locator>"));return hb.createKeyLocatorChecker_(keyLocatorSection[0])};hb.createHierarchicalChecker_=function(a){return new xd("^(<>*)$","\\1","^(<>*)<KEY><>$","\\1",Ga.Relation.IS_PREFIX_OF)};hb.createKeyLocatorChecker_=function(a){var b=a.getFirstValue("type");if(null==b)throw new ka(Error("Expected <checker.key-locator.type>"));if("name"==b.toLowerCase())return hb.createKeyLocatorNameChecker_(a);throw new ka(Error("Unsupported checker.key-locator.type: "+
b));};hb.createKeyLocatorNameChecker_=function(a){var d=a.getFirstValue("name");if(null!=d){d=new b(d);a=a.getFirstValue("relation");if(null==a)throw new ka(Error("Expected <checker.key-locator.relation>"));m=Ga.getNameRelationFromString(a);return new Ld(d,m)}d=a.getFirstValue("regex");if(null!=d)try{return new Md(d)}catch(g){throw new ka(Error("Invalid checker.key-locator.regex: "+d));}a=a.get("hyper-relation");if(1==a.length){var f=a[0];a=f.getFirstValue("k-regex");if(null==a)throw new ka(Error("Expected <checker.key-locator.hyper-relation.k-regex>"));
d=f.getFirstValue("k-expand");if(null==d)throw new ka(Error("Expected <checker.key-locator.hyper-relation.k-expand"));m=f.getFirstValue("h-relation");if(null==m)throw new ka(Error("Expected <checker.key-locator.hyper-relation.h-relation>"));var x=f.getFirstValue("p-regex");if(null==x)throw new ka(Error("Expected <checker.key-locator.hyper-relation.p-regex>"));f=f.getFirstValue("p-expand");if(null==f)throw new ka(Error("Expected <checker.key-locator.hyper-relation.p-expand>"));var m=Ga.getNameRelationFromString(m);
try{return new xd(x,f,a,d,m)}catch(q){throw new ka(Error("Invalid regex for key-locator.hyper-relation"));}}throw new ka(Error("Unsupported checker.key-locator"));};var Ld=function(a,b){hb.call(this);this.name_=a;this.relation_=b};Ld.prototype=new hb;Ld.prototype.name="ConfigNameRelationChecker";s.ConfigNameRelationChecker=Ld;Ld.prototype.checkNames=function(a,b,d){var g=ia.extractIdentityFromKeyName(b),f=Ga.checkNameRelation(this.relation_,this.name_,g);f||d.fail(new F(F.POLICY_ERROR,"KeyLocator check failed: name relation "+
this.name_.toUri()+" "+Ga.toString(this.relation_)+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+", identity="+g.toUri()+")"));return f};var Md=function(a){hb.call(this);this.regex_=new fb(a)};Md.prototype=new hb;Md.prototype.name="ConfigRegexChecker";s.ConfigRegexChecker=Md;Md.prototype.checkNames=function(a,b,d){var g=this.regex_.match(b);g||d.fail(new F(F.POLICY_ERROR,"KeyLocator check failed: regex "+this.regex_.getExpr()+" for packet "+a.toUri()+" is invalid (KeyLocator="+b.toUri()+
")"));return g};var xd=function(a,b,d,g,f){hb.call(this);this.packetNameRegex_=new fb(a);this.packetNameExpansion_=b;this.keyNameRegex_=new fb(d);this.keyNameExpansion_=g;this.hyperRelation_=f};xd.prototype=new hb;xd.prototype.name="ConfigHyperRelationChecker";s.ConfigHyperRelationChecker=xd;xd.prototype.checkNames=function(a,b,d){if(!this.packetNameRegex_.match(a))return d.fail(new F(F.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation packet name regex "+
this.packetNameRegex_.getExpr())),!1;if(!this.keyNameRegex_.match(b))return d.fail(new F(F.POLICY_ERROR,"The packet "+a.toUri()+" (KeyLocator="+b.toUri()+") does not match the hyper relation key name regex "+this.keyNameRegex_.getExpr())),!1;var g=this.keyNameRegex_.expand(this.keyNameExpansion_),f=this.packetNameRegex_.expand(this.packetNameExpansion_),m=Ga.checkNameRelation(this.hyperRelation_,g,f);m||d.fail(new F(F.POLICY_ERROR,"KeyLocator check failed: hyper relation "+Ga.toString(this.hyperRelation_)+
" packet name match="+f.toUri()+", key name match="+g.toUri()+" of packet "+a.toUri()+" (KeyLocator="+b.toUri()+") is invalid"));return m};var b=a.Name,Ga=a.ConfigNameRelation,fb=a.NdnRegexTopMatcher,ka=a.ValidatorConfigError,Vb=function(){};s.ConfigFilter=Vb;Vb.prototype.match=function(a,b){return a?2>b.size()?!1:this.matchName(b.getPrefix(-2)):this.matchName(b)};Vb.create=function(a){var b=a.getFirstValue("type");if(null==b)throw new ka(Error("Expected <filter.type>"));if("name"==b.toLowerCase())return Vb.createNameFilter_(a);
throw new ka(Error("Unsupported filter.type: "+b));};Vb.prototype.matchName=function(a){throw Error("ConfigFilter.matchName is not implemented");};Vb.createNameFilter_=function(a){var d=a.getFirstValue("name");if(null!=d){d=new b(d);a=a.getFirstValue("relation");if(null==a)throw new ka(Error("Expected <filter.relation>"));a=Ga.getNameRelationFromString(a);return new Nd(d,a)}d=a.getFirstValue("regex");if(null!=d)try{return new Od(d)}catch(g){throw new ka(Error("Wrong filter.regex: "+d));}throw new ka(Error("Wrong filter(name) properties"));
};var Nd=function(a,d){Vb.call(this);this.name_=new b(a);this.relation_=d};Nd.prototype=new Vb;Nd.prototype.name="ConfigRelationNameFilter";s.ConfigRelationNameFilter=Nd;Nd.prototype.matchName=function(a){return Ga.checkNameRelation(this.relation_,this.name_,a)};var Od=function(a){Vb.call(this);this.regex_=new fb(a)};Od.prototype=new Vb;Od.prototype.name="ConfigRegexNameFilter";s.ConfigRegexNameFilter=Od;Od.prototype.matchName=function(a){return this.regex_.match(a)};ka=a.ValidatorConfigError;Ga=
function(){};s.ConfigNameRelation=Ga;Ga.Relation=function(){};Ga.Relation.EQUAL=0;Ga.Relation.IS_PREFIX_OF=1;Ga.Relation.IS_STRICT_PREFIX_OF=2;Ga.toString=function(a){return a==Ga.Relation.EQUAL?"equal":a==Ga.Relation.IS_PREFIX_OF?"is-prefix-of":a==Ga.Relation.IS_STRICT_PREFIX_OF?"is-strict-prefix-of":""};Ga.checkNameRelation=function(a,b,d){return a==Ga.Relation.EQUAL?b.equals(d):a==Ga.Relation.IS_PREFIX_OF?b.isPrefixOf(d):a==Ga.Relation.IS_STRICT_PREFIX_OF?b.isPrefixOf(d)&&b.size()<d.size():!1};
Ga.getNameRelationFromString=function(a){if("equal"==a.toLowerCase())return Ga.Relation.EQUAL;if("is-prefix-of"==a.toLowerCase())return Ga.Relation.IS_PREFIX_OF;if("is-strict-prefix-of"==a.toLowerCase())return Ga.Relation.IS_STRICT_PREFIX_OF;throw new ka(Error("Unsupported relation: "+a));};var hb=a.ConfigChecker,Vb=a.ConfigFilter,ka=a.ValidatorConfigError,d=a.Log.LOG,kc=function(a,b){this.id_=a;this.isForInterest_=b;this.filters_=[];this.checkers_=[]};s.ConfigRule=kc;kc.prototype.getId=function(){return this.id_};
kc.prototype.getIsForInterest=function(){return this.isForInterest_};kc.prototype.addFilter=function(a){this.filters_.push(a)};kc.prototype.addChecker=function(a){this.checkers_.push(a)};kc.prototype.match=function(a,b){3<d&&console.log("Trying to match "+b.toUri());if(a!=this.isForInterest_)throw new ka(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));if(0==this.filters_.length)return!0;for(var g=!1,f=0;f<this.filters_.length&&!(g=
g||this.filters_[f].match(a,b));++f);return g};kc.prototype.check=function(a,b,g,f){3<d&&console.log("Trying to check "+b.toUri()+" with keyLocator "+g.toUri());if(a!=this.isForInterest_)throw new ka(Error("Invalid packet type supplied ( "+(a?"interest":"data")+" != "+(this.isForInterest_?"interest":"data")+")"));for(var x=!1,m=0;m<this.checkers_.length;++m){x=this.checkers_[m].check(a,b,g,f);if(!x)break;x=!0}return x};kc.create=function(a){var b=a.getFirstValue("id");if(null==b)throw new ka(Error("Expecting <rule.id>"));
var d=a.getFirstValue("for");if(null==d)throw new ka(Error("Expecting <rule.for> in rule: "+b));if("data"==d.toLowerCase())d=!1;else if("interest"==d.toLowerCase())d=!0;else throw new ka(Error("Unrecognized <rule.for>: "+d+" in rule: "+b));for(var d=new kc(b,d),g=a.get("filter"),f=0;f<g.length;++f)d.addFilter(Vb.create(g[f]));a=a.get("checker");for(f=0;f<a.length;++f)d.addChecker(hb.create(a[f]));if(0==a.length)throw new ka(Error("No <rule.checker> is specified in rule: "+b));return d};var sc=a,p=
a.Blob,J=a.CertificateV2,Wb=function(a,b){this.certificates_=a;this.id_=b;this.anchorNameUris_={}};s.TrustAnchorGroup=Wb;Wb.prototype.getId=function(){return this.id_};Wb.prototype.size=function(){return Object.keys(this.anchorNameUris_).length};Wb.prototype.refresh=function(){};Wb.readCertificate=function(a){try{var b=sc.readFileSync(a).toString(),d=new f(b,"base64"),g=new J;g.wireDecode(new p(d,!1));return g}catch(m){return null}};var g=a.SyncPromise,F=a.ValidationError,d=a.Log.LOG,Ia=a.VerificationHelpers,
J=a.CertificateV2,lb=function(){this.certificateChain_=[];this.seenCertificateNameUris_={};this.outcome_=this.hasOutcome_=!1};s.ValidationState=lb;lb.prototype.hasOutcome=function(){return this.hasOutcome_};lb.prototype.isOutcomeFailed=function(){return this.hasOutcome_&&!1==this.outcome_};lb.prototype.isOutcomeSuccess=function(){return this.hasOutcome_&&!0==this.outcome_};lb.prototype.fail=function(a){throw Error("ValidationState.fail is not implemented");};lb.prototype.getDepth=function(){return this.certificateChain_.length};
lb.prototype.hasSeenCertificateName=function(a){a=a.toUri();if(void 0!==this.seenCertificateNameUris_[a])return!0;this.seenCertificateNameUris_[a]=!0;return!1};lb.prototype.addCertificate=function(a){this.certificateChain_.unshift(new J(a))};lb.prototype.setOutcome=function(a){if(this.hasOutcome_)throw Error("The ValidationState already has an outcome");this.hasOutcome_=!0;this.outcome_=a};lb.prototype.verifyOriginalPacketPromise_=function(a){return g.reject(Error("ValidationState.verifyOriginalPacketPromise_ is not implemented"))};
lb.prototype.bypassValidation_=function(){throw Error("ValidationState.bypassValidation_ is not implemented");};lb.prototype.verifyCertificateChainPromise_=function(a){var b=a,f=this,m=function(a){if(a>=f.certificateChain_.length)return g.resolve(b);var q=f.certificateChain_[a];return Ia.verifyDataSignaturePromise(q,b).then(function(r){if(r)3<d&&console.log("OK signature for certificate `"+q.getName().toUri()+"`"),b=q;else{for(f.fail(new F(F.INVALID_SIGNATURE,"Invalid signature of certificate `"+
q.getName().toUri()+"`"));f.certificateChain_.length>a;)f.certificateChain_.splice(a,1);return g.resolve(null)}++a;return m(a)})};return m(0)};var b=a.Name,r=a.WireFormat,J=a.CertificateV2,d=a.Log.LOG,Xb=function aa(a){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE;this.maxLifetimeMilliseconds_=void 0==a?aa.getDefaultLifetime():a;this.nowOffsetMilliseconds_=0};s.CertificateCacheV2=Xb;Xb.prototype.insert=function(a){var b=a.getValidityPeriod().getNotAfter(),g=(new Date).getTime()+
this.nowOffsetMilliseconds_;if(b<g)3<d&&console.log("Not adding "+a.getName().toUri()+": already expired at "+r.toIsoString(b));else{b=Math.min(b,g+this.maxLifetimeMilliseconds_);b<this.nextRefreshTime_&&(this.nextRefreshTime_=b);3<d&&console.log("Adding "+a.getName().toUri()+", will remove in "+(b-g)/36E5+" hours");a=new J(a);var g=a.getName(),f=this.findFirstByName_(g);if(0>f)f=this.certificatesByName_.length;else if(this.certificatesByName_[f].name.equals(g)){this.certificatesByName_[f].certificate=
a;this.certificatesByName_[f].removalTime=b;return}this.certificatesByName_.splice(f,0,{name:g,certificate:a,removalTime:b})}};Xb.prototype.find=function(a){if(a instanceof b){0<a.size()&&a.get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();var d=this.findFirstByName_(a);if(0>d)return null;d=this.certificatesByName_[d];return a.isPrefixOf(d.certificate.getName())?d.certificate:null}null!=a.getChildSelector()&&
console.log("Certificate search using a ChildSelector is not supported. Searching as if this selector not specified");0<a.getName().size()&&a.getName().get(-1).isImplicitSha256Digest()&&console.log("Certificate search using a name with an implicit digest is not yet supported");this.refresh_();d=this.findFirstByName_(a.getName());if(0>d)return null;for(;d<this.certificatesByName_.length;++d){var g=this.certificatesByName_[d].certificate;if(!a.getName().isPrefixOf(g.getName()))break;if(a.matchesData(g))return g}return null};
Xb.prototype.deleteCertificate=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(this.certificatesByName_[b].name.equals(a)){this.certificatesByName_.splice(b,1);break}};Xb.prototype.clear=function(){this.certificatesByName_=[];this.nextRefreshTime_=Number.MAX_VALUE};Xb.getDefaultLifetime=function(){return 36E5};Xb.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Xb.prototype.findFirstByName_=function(a){for(var b=0;b<this.certificatesByName_.length;++b)if(0<=
this.certificatesByName_[b].name.compare(a))return b;return-1};Xb.prototype.refresh_=function(){var a=(new Date).getTime()+this.nowOffsetMilliseconds_;if(!(a<this.nextRefreshTime_)){for(var b=Number.MAX_VALUE,d=this.certificatesByName_.length-1;0<=d;--d){var g=this.certificatesByName_[d];g.removalTime<=a?this.certificatesByName_.splice(d,1):b=Math.min(b,g.removalTime)}this.nextRefreshTime_=b}};var Pd=function(){};s.CertificateContainerInterface=Pd;Pd.prototype.add=function(a){throw Error("CertificateContainerInterface.add is unimplemented");
};Pd.prototype.remove=function(a){throw Error("CertificateContainerInterface.remove is unimplemented");};var d=a.Log.LOG,Yb=function(){this.certificateStorage_=null};s.CertificateFetcher=Yb;Yb.prototype.setCertificateStorage=function(a){this.certificateStorage_=a};Yb.prototype.fetch=function(a,b,g){if(null==this.certificateStorage_)throw Error("CertificateFetcher.fetch: You must first call setCertificateStorage");var f=this.certificateStorage_.getUnverifiedCertificateCache().find(a.interest_);if(null!=
f)3<d&&console.log("Found certificate in **un**verified key cache "+f.getName().toUri()),g(f,b);else{var m=this;this.doFetch_(a,b,function(a,b){m.certificateStorage_.cacheUnverifiedCertificate(a);g(a,b)})}};Yb.prototype.doFetch_=function(a,b,d){throw Error("CertificateFetcher.doFetch_ is not implemented");};var d=a.Log.LOG,J=a.CertificateV2,F=a.ValidationError,Yb=a.CertificateFetcher,kd=function(a){Yb.call(this);this.face_=a};kd.prototype=new Yb;kd.prototype.name="CertificateFetcherFromNetwork";s.CertificateFetcherFromNetwork=
kd;kd.prototype.doFetch_=function(a,b,g){var f=this;try{f.face_.expressInterest(a.interest_,function(a,f){3<d&&console.log("Fetched certificate from network "+f.getName().toUri());var m;try{m=new J(f)}catch(x){b.fail(new F(F.MALFORMED_CERTIFICATE,"Fetched a malformed certificate `"+f.getName().toUri()+"` ("+x+")"));return}try{g(m,b)}catch(q){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Error in continueValidation: "+q))}},function(m){3<d&&console.log("Timeout while fetching certificate "+a.interest_.getName().toUri()+
", retrying");--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{f.fetch(a,b,g)}catch(q){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Error in fetch: "+q))}else b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))},function(m,q){3<d&&console.log("NACK ("+q.getReason()+") while fetching certificate "+a.interest_.getName().toUri());--a.nRetriesLeft_;if(0<=a.nRetriesLeft_)try{f.fetch(a,b,g)}catch(r){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,
"Error in fetch: "+r))}else b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate after all retries `"+a.interest_.getName().toUri()+"`"))})}catch(m){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Error in expressInterest: "+m))}};var F=a.ValidationError,Yb=a.CertificateFetcher,bd=function(){Yb.call(this)};bd.prototype=new Yb;bd.prototype.name="CertificateFetcherOffline";s.CertificateFetcherOffline=bd;bd.prototype.doFetch_=function(a,b,d){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot fetch certificate "+
a.interest_.getName().toUri()+" in offline mode"))};var z=a.Interest,cd=function(a){void 0!=a?(this.interest_=new z(a),this.nRetriesLeft_=3):(this.interest_=new z,this.nRetriesLeft_=0)};s.CertificateRequest=cd;var b=a.Name,Za=a.TrustAnchorContainer,J=a.CertificateV2,Xb=a.CertificateCacheV2,zb=function(){this.trustAnchors_=new Za;this.verifiedCertificateCache_=new Xb(36E5);this.unverifiedCertificateCache_=new Xb(3E5)};s.CertificateStorage=zb;zb.prototype.findTrustedCertificate=function(a){var b=this.trustAnchors_.find(a);
return null!=b?b:b=this.verifiedCertificateCache_.find(a)};zb.prototype.isCertificateKnown=function(a){return null!=this.trustAnchors_.find(a)||null!=this.verifiedCertificateCache_.find(a)||null!=this.unverifiedCertificateCache_.find(a)};zb.prototype.cacheUnverifiedCertificate=function(a){this.unverifiedCertificateCache_.insert(a)};zb.prototype.getTrustAnchors=function(){return this.trustAnchors_};zb.prototype.getVerifiedCertificateCache=function(){return this.verifiedCertificateCache_};zb.prototype.getUnverifiedCertificateCache=
function(){return this.unverifiedCertificateCache_};zb.prototype.loadAnchor=function(a,b,d,g){this.trustAnchors_.insert(a,b,d,g)};zb.prototype.resetAnchors=function(){this.trustAnchors_.clear()};zb.prototype.cacheVerifiedCertificate=function(a){this.verifiedCertificateCache_.insert(a)};zb.prototype.resetVerifiedCertificates=function(){this.verifiedCertificateCache_.clear()};zb.prototype.setCacheNowOffsetMilliseconds_=function(a){this.verifiedCertificateCache_.setNowOffsetMilliseconds_(a);this.unverifiedCertificateCache_.setNowOffsetMilliseconds_(a)};
b=a.Name;O=a.Data;Y=a.KeyLocator;Da=a.KeyLocatorType;za=a.Sha256WithRsaSignature;Xa=a.Sha256WithEcdsaSignature;pa=a.ContentType;r=a.WireFormat;qa=a.ValidityPeriod;Ib=a.InvalidArgumentException;J=function(a){void 0!=a?(O.call(this,a),this.checkFormat_()):(O.call(this),this.getMetaInfo().setType(pa.KEY))};J.prototype=new O;J.prototype.name="CertificateV2";s.CertificateV2=J;J.Error=function(a){if(a)return a.__proto__=J.Error.prototype,a};J.Error.prototype=Error();J.Error.prototype.name="CertificateV2Error";
J.prototype.checkFormat_=function(){if(!J.isValidName(this.getName()))throw new J.Error(Error("The Data Name does not follow the certificate naming convention"));if(this.getMetaInfo().getType()!=pa.KEY)throw new J.Error(Error("The Data ContentType is not KEY"));if(0>this.getMetaInfo().getFreshnessPeriod())throw new J.Error(Error("The Data FreshnessPeriod is not set"));if(0==this.getContent().size())throw new J.Error(Error("The Data Content is empty"));};J.prototype.getKeyName=function(){return this.getName().getPrefix(J.KEY_ID_OFFSET+
1)};J.prototype.getIdentity=function(){return this.getName().getPrefix(J.KEY_COMPONENT_OFFSET)};J.prototype.getKeyId=function(){return this.getName().get(J.KEY_ID_OFFSET)};J.prototype.getIssuerId=function(){return this.getName().get(J.ISSUER_ID_OFFSET)};J.prototype.getPublicKey=function(){if(0==this.getContent().size())throw new J.Error(Error("The public key is not set (the Data content is empty)"));return this.getContent()};J.prototype.getValidityPeriod=function(){if(!qa.canGetFromSignature(this.getSignature()))throw new Ib(Error("The SignatureInfo does not have a ValidityPeriod"));
return qa.getFromSignature(this.getSignature())};J.prototype.isValid=function(a){return this.getValidityPeriod().isValid(a)};J.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();O.prototype.wireDecode.call(this,a,b);this.checkFormat_()};J.prototype.toString=function(){var a;a="Certificate name:\n"+("  "+this.getName().toUri()+"\n");a+="Validity:\n";a+="  NotBefore: "+r.toIsoString(this.getValidityPeriod().getNotBefore())+"\n";a+="  NotAfter: "+r.toIsoString(this.getValidityPeriod().getNotAfter())+
"\n";a+="Public key bits:\n";try{for(var b=this.getPublicKey().buf().toString("base64"),d=0;d<b.length;d+=64)a+=b.substr(d,64)+"\n"}catch(g){}a+="Signature Information:\n";a+="  Signature Type: ";a=this.getSignature()instanceof Xa?a+"SignatureSha256WithEcdsa\n":this.getSignature()instanceof za?a+"SignatureSha256WithRsa\n":a+"<unknown>\n";Y.canGetFromSignature(this.getSignature())&&(a+="  Key Locator: ",b=Y.getFromSignature(this.getSignature()),b.getType()==Da.KEYNAME?(b.getKeyName().equals(this.getKeyName())&&
(a+="Self-Signed "),a+="Name="+b.getKeyName().toUri()+"\n"):a+="<no KeyLocator key name>\n");return a};J.isValidName=function(a){return a.size()>=J.MIN_CERT_NAME_LENGTH&&a.get(J.KEY_COMPONENT_OFFSET).equals(J.KEY_COMPONENT)};J.extractIdentityFromCertName=function(a){if(!J.isValidName(a))throw new Ib(Error("Certificate name `"+a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(J.KEY_COMPONENT_OFFSET)};J.extractKeyNameFromCertName=function(a){if(!J.isValidName(a))throw new Ib(Error("Certificate name `"+
a.toUri()+"` does not follow the naming conventions"));return a.getPrefix(J.KEY_ID_OFFSET+1)};J.VERSION_OFFSET=-1;J.ISSUER_ID_OFFSET=-2;J.KEY_ID_OFFSET=-3;J.KEY_COMPONENT_OFFSET=-4;J.MIN_CERT_NAME_LENGTH=4;J.MIN_KEY_NAME_LENGTH=2;J.KEY_COMPONENT=new b.Component("KEY");var g=a.SyncPromise,O=a.Data,d=a.Log.LOG,F=a.ValidationError,lb=a.ValidationState,Ia=a.VerificationHelpers,U=a.NdnCommon,Qc=function(a,b,d){lb.call(this);this.data_=new O(a);this.successCallback_=b;this.failureCallback_=d;if(null==this.successCallback_)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Qc.prototype=new lb;Qc.prototype.name="DataValidationState";s.DataValidationState=Qc;Qc.prototype.fail=function(a){3<d&&console.log(""+a);try{this.failureCallback_(this.data_,a)}catch(b){console.log("Error in failureCallback: "+U.getErrorWithStackTrace(b))}this.setOutcome(!1)};Qc.prototype.getOriginalData=function(){return this.data_};Qc.prototype.verifyOriginalPacketPromise_=function(a){var b=this;return Ia.verifyDataSignaturePromise(this.data_,
a).then(function(a){if(a){3<d&&console.log("OK signature for data `"+b.data_.getName().toUri()+"`");try{b.successCallback_(b.data_)}catch(f){console.log("Error in successCallback: "+U.getErrorWithStackTrace(f))}b.setOutcome(!0)}else b.fail(new F(F.INVALID_SIGNATURE,"Invalid signature of data `"+b.data_.getName().toUri()+"`"));return g.resolve()})};Qc.prototype.bypassValidation_=function(){3<d&&console.log("Signature verification bypassed for data `"+this.data_.getName().toUri()+"`");try{this.successCallback_(this.data_)}catch(a){console.log("Error in successCallback: "+
U.getErrorWithStackTrace(a))}this.setOutcome(!0)};var Be=sc=a,Wb=a.TrustAnchorGroup,b=a.Name,d=a.Log.LOG,ld=function(a,b,g,f,m){Wb.call(this,a,b);this.isDirectory_=m;this.path_=g;this.refreshPeriod_=f;this.expireTime_=0;if(0>=f)throw Error("Refresh period for the dynamic group must be positive");0<d&&console.log("Create a dynamic trust anchor group "+b+" for file/dir "+g+" with refresh time "+f);this.refresh()};ld.prototype=new Wb;ld.prototype.name="DynamicTrustAnchorGroup";s.DynamicTrustAnchorGroup=
ld;ld.prototype.refresh=function(){var a=(new Date).getTime();if(!(this.expireTime_>a)){this.expireTime_=a+this.refreshPeriod_;0<d&&console.log("Reloading the dynamic trust anchor group");var a={},g;for(g in this.anchorNameUris_)a[g]=!0;if(this.isDirectory_){var f;try{f=sc.readdirSync(this.path_)}catch(m){throw Error("Cannot list files in directory "+this.path_);}for(var q=0;q<f.length;++q)this.loadCertificate_(Be.join(this.path_,f[q]),a)}else this.loadCertificate_(this.path_,a);for(g in a)delete this.anchorNameUris_[g],
this.certificates_.remove(new b(g))}};ld.prototype.loadCertificate_=function(a,b){var d=Wb.readCertificate(a);if(null!=d){var g=d.getName().toUri();this.anchorNameUris_[g]?delete b[g]:(this.anchorNameUris_[g]=!0,this.certificates_.add(d))}};var g=a.SyncPromise,z=a.Interest,d=a.Log.LOG,F=a.ValidationError,lb=a.ValidationState,Ia=a.VerificationHelpers,U=a.NdnCommon,Ac=function(a,b,d){lb.call(this);this.interest_=new z(a);this.successCallbacks_=[b];this.failureCallback_=d;if(null==b)throw Error("The successCallback is null");
if(null==this.failureCallback_)throw Error("The failureCallback is null");};Ac.prototype=new lb;Ac.prototype.name="InterestValidationState";s.InterestValidationState=Ac;Ac.prototype.fail=function(a){3<d&&console.log(""+a);try{this.failureCallback_(this.interest_,a)}catch(b){console.log("Error in failureCallback: "+U.getErrorWithStackTrace(b))}this.setOutcome(!1)};Ac.prototype.getOriginalInterest=function(){return this.interest_};Ac.prototype.addSuccessCallback=function(a){this.successCallbacks_.push(a)};
Ac.prototype.verifyOriginalPacketPromise_=function(a){var b=this;return Ia.verifyInterestSignaturePromise(this.interest_,a).then(function(a){if(a){3<d&&console.log("OK signature for interest `"+b.interest_.getName().toUri()+"`");for(a=0;a<b.successCallbacks_.length;++a)try{b.successCallbacks_[a](b.interest_)}catch(f){console.log("Error in successCallback: "+U.getErrorWithStackTrace(f))}b.setOutcome(!0)}else b.fail(new F(F.INVALID_SIGNATURE,"Invalid signature of interest `"+b.interest_.getName().toUri()+
"`"));return g.resolve()})};Ac.prototype.bypassValidation_=function(){3<d&&console.log("Signature verification bypassed for interest `"+this.interest_.getName().toUri()+"`");for(var a=0;a<this.successCallbacks_.length;++a)try{this.successCallbacks_[a](this.interest_)}catch(b){console.log("Error in successCallback: "+U.getErrorWithStackTrace(b))}this.setOutcome(!0)};var Wb=a.TrustAnchorGroup,dd=function(a,b){Wb.call(this,a,b)};dd.prototype=new Wb;dd.prototype.name="StaticTrustAnchorGroup";s.StaticTrustAnchorGroup=
dd;dd.prototype.add=function(a){var b=a.getName().toUri();this.anchorNameUris_[b]||(this.anchorNameUris_[b]=!0,this.certificates_.add(a))};dd.prototype.remove=function(a){delete this.anchorNameUris_[a.toUri()];this.certificates_.remove(a)};b=a.Name;dd=a.StaticTrustAnchorGroup;ld=a.DynamicTrustAnchorGroup;J=a.CertificateV2;Pd=a.CertificateContainerInterface;Za=function Kb(){this.groups_={};this.anchors_=new Kb.AnchorContainer_};s.TrustAnchorContainer=Za;Za.Error=function(a){if(a)return a.__proto__=
Za.Error.prototype,a};Za.Error.prototype=Error();Za.Error.prototype.name="TrustAnchorContainerError";Za.prototype.insert=function(a,b,d,g){if(b instanceof J){d=this.groups_[a];void 0===d&&(d=new dd(this.anchors_,a),this.groups_[a]=d);if(!(d instanceof dd))throw new Za.Error(Error("Cannot add a static anchor to the non-static anchor group "+a));d.add(b)}else{null==g&&(g=!1);if(void 0!==this.groups_[a])throw new Za.Error(Error("Cannot create the dynamic group, because group "+a+" already exists"));
this.groups_[a]=new ld(this.anchors_,a,b,d,g)}};Za.prototype.clear=function(){this.groups_={};this.anchors_.clear()};Za.prototype.find=function(a){if(a instanceof b){this.refresh_();var d=this.anchors_.findFirstByName_(a);if(0>d)return null;var g=this.anchors_.anchorsByName_[d].certificate;return a.isPrefixOf(g.getName())?g:null}this.refresh_();d=this.anchors_.findFirstByName_(a.getName());if(0>d)return null;for(;d<this.anchors_.anchorsByName_.length;++d){g=this.anchors_.anchorsByName_[d].certificate;
if(!a.getName().isPrefixOf(g.getName()))break;if(a.matchesData(g))return g}return null};Za.prototype.getGroup=function(a){var b=this.groups_[a];if(void 0===b)throw new Za.Error(Error("Trust anchor group "+a+" does not exist"));return b};Za.prototype.size=function(){return this.anchors_.size()};Za.AnchorContainer_=function(){this.anchorsByName_=[]};Za.AnchorContainer_.prototype=new Pd;Za.AnchorContainer_.prototype.name="TrustAnchorContainerAnchorContainer";Za.AnchorContainer_.prototype.add=function(a){a=
new J(a);var b=a.getName(),d=this.findFirstByName_(b);if(0>d)d=this.anchorsByName_.length;else if(this.anchorsByName_[d].name.equals(b)){this.anchorsByName_[d].certificate=a;return}this.anchorsByName_.splice(d,0,{name:b,certificate:a})};Za.AnchorContainer_.prototype.remove=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(this.anchorsByName_[b].name.equals(a)){this.anchorsByName_.splice(b,1);break}};Za.AnchorContainer_.prototype.clear=function(){this.anchorsByName_=[]};Za.AnchorContainer_.prototype.size=
function(){return this.anchorsByName_.length};Za.AnchorContainer_.prototype.findFirstByName_=function(a){for(var b=0;b<this.anchorsByName_.length;++b)if(0<=this.anchorsByName_[b].name.compare(a))return b;return-1};Za.prototype.refresh_=function(){for(var a in this.groups_)this.groups_[a].refresh()};F=function(a,b){this.code_=a;this.info_=void 0!=b?b:""};s.ValidationError=F;F.NO_ERROR=0;F.INVALID_SIGNATURE=1;F.NO_SIGNATURE=2;F.CANNOT_RETRIEVE_CERTIFICATE=3;F.EXPIRED_CERTIFICATE=4;F.LOOP_DETECTED=5;
F.MALFORMED_CERTIFICATE=6;F.EXCEEDED_DEPTH_LIMIT=7;F.INVALID_KEY_LOCATOR=8;F.POLICY_ERROR=9;F.IMPLEMENTATION_ERROR=255;F.USER_MIN=256;F.prototype.getCode=function(){return this.code_};F.prototype.getInfo=function(){return this.info_};F.prototype.toString=function(){var a;a=this.code_===F.NO_ERROR?"No error":this.code_===F.INVALID_SIGNATURE?"Invalid signature":this.code_===F.NO_SIGNATURE?"Missing signature":this.code_===F.CANNOT_RETRIEVE_CERTIFICATE?"Cannot retrieve certificate":this.code_===F.EXPIRED_CERTIFICATE?
"Certificate expired":this.code_===F.LOOP_DETECTED?"Loop detected in certification chain":this.code_===F.MALFORMED_CERTIFICATE?"Malformed certificate":this.code_===F.EXCEEDED_DEPTH_LIMIT?"Exceeded validation depth limit":this.code_===F.INVALID_KEY_LOCATOR?"Key locator violates validation policy":this.code_===F.POLICY_ERROR?"Validation policy error":this.code_===F.IMPLEMENTATION_ERROR?"Internal implementation error":this.code_>=F.USER_MIN?"Custom error code "+this.code_:"Unrecognized error code "+
this.code_;0<this.info_.length&&(a+=" ("+this.info_+")");return a};var b=a.Name,O=a.Data,Y=a.KeyLocator,Da=a.KeyLocatorType,r=a.WireFormat,F=a.ValidationError,J=a.CertificateV2,Aa=function(){this.innerPolicy_=this.validator_=null};s.ValidationPolicy=Aa;Aa.prototype.setInnerPolicy=function(a){if(null==a)throw Error("The innerPolicy argument cannot be null");null!=this.validator_&&a.setValidator(this.validator_);null==this.innerPolicy_?this.innerPolicy_=a:this.innerPolicy_.setInnerPolicy(a)};Aa.prototype.hasInnerPolicy=
function(){return null!=this.innerPolicy_};Aa.prototype.getInnerPolicy=function(){return this.innerPolicy_};Aa.prototype.setValidator=function(a){this.validator_=a;null!=this.innerPolicy_&&this.innerPolicy_.setValidator(a)};Aa.prototype.checkPolicy=function(a,b,d){throw Error("ValidationPolicy.checkPolicy is not implemented");};Aa.prototype.checkCertificatePolicy=function(a,b,d){this.checkPolicy(a,b,d)};Aa.getKeyLocatorName=function(a,d){if(a instanceof O)return Aa.getKeyLocatorNameFromSignature_(a.getSignature(),
d);if(2>a.getName().size())return d.fail(new F(F.INVALID_KEY_LOCATOR,"Invalid signed Interest: name too short")),new b;var g;try{g=r.getDefaultWireFormat().decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf())}catch(f){return d.fail(new F(F.INVALID_KEY_LOCATOR,"Invalid signed Interest: "+f)),new b}return Aa.getKeyLocatorNameFromSignature_(g,d)};Aa.getKeyLocatorNameFromSignature_=function(a,d){if(!Y.canGetFromSignature(a))return d.fail(new F(F.INVALID_KEY_LOCATOR,
"KeyLocator is missing")),new b;var g=Y.getFromSignature(a);return g.getType()!=Da.KEYNAME?(d.fail(new F(F.INVALID_KEY_LOCATOR,"KeyLocator type is not Name")),new b):g.getKeyName()};var Aa=a.ValidationPolicy,md=function(){Aa.call(this)};md.prototype=new Aa;md.prototype.name="ValidationPolicyAcceptAll";s.ValidationPolicyAcceptAll=md;md.prototype.checkPolicy=function(a,b,d){d(null,b)};var b=a.Name,O=a.Data,Sb=a.CommandInterestSigner,F=a.ValidationError,Aa=a.ValidationPolicy,Ab=function sa(a,b){Aa.call(this);
this.options_=void 0==b?new sa.Options:new sa.Options(b);this.container_=[];this.nowOffsetMilliseconds_=0;if(null==a)throw Error("inner policy is missing");this.setInnerPolicy(a);0>this.options_.gracePeriod_&&(this.options_.gracePeriod_=0)};Ab.prototype=new Aa;Ab.prototype.name="ValidationPolicyCommandInterest";s.ValidationPolicyCommandInterest=Ab;Ab.Options=function(a,b,d){a instanceof Ab.Options?(this.gracePeriod_=a.gracePeriod_,this.maxRecords_=a.maxRecords_,this.recordLifetime_=a.recordLifetime_):
(void 0==a&&(a=12E4),void 0==b&&(b=1E3),void 0==d&&(d=36E5),this.gracePeriod_=a,this.maxRecords_=b,this.recordLifetime_=d)};Ab.prototype.checkPolicy=function(a,b,d){if(a instanceof O)this.getInnerPolicy().checkPolicy(a,b,d);else{var g=[null],f=[0];Ab.parseCommandInterest_(a,b,g,f)&&this.checkTimestamp_(b,g[0],f[0])&&this.getInnerPolicy().checkPolicy(a,b,d)}};Ab.prototype.setNowOffsetMilliseconds_=function(a){this.nowOffsetMilliseconds_=a};Ab.LastTimestampRecord=function(a,d,g){this.keyName_=new b(a);
this.timestamp_=d;this.lastRefreshed_=g};Ab.prototype.cleanUp_=function(){for(var a=(new Date).getTime()+this.nowOffsetMilliseconds_-this.options_.recordLifetime_;0<this.container_.length&&this.container_[0].lastRefreshed_<=a||0<=this.options_.maxRecords_&&this.container_.length>this.options_.maxRecords_;)this.container_.shift()};Ab.parseCommandInterest_=function(a,d,g,f){g[0]=new b;f[0]=0;var m=a.getName();if(m.size()<Sb.MINIMUM_SIZE)return d.fail(new F(F.POLICY_ERROR,"Command interest name `"+a.getName().toUri()+
"` is too short")),!1;f[0]=m.get(Sb.POS_TIMESTAMP).toNumber();g[0]=Aa.getKeyLocatorName(a,d);return d.isOutcomeFailed()?!1:!0};Ab.prototype.checkTimestamp_=function(a,b,d){this.cleanUp_();var g=(new Date).getTime()+this.nowOffsetMilliseconds_;if(d<g-this.options_.gracePeriod_||d>g+this.options_.gracePeriod_)return a.fail(new F(F.POLICY_ERROR,"Timestamp is outside the grace period for key "+b.toUri())),!1;g=this.findByKeyName_(b);if(0<=g&&d<=this.container_[g].timestamp_)return a.fail(new F(F.POLICY_ERROR,
"Timestamp is reordered for key "+b.toUri())),!1;var f=this;a.addSuccessCallback(function(a){f.insertNewRecord_(a,b,d)});return!0};Ab.prototype.insertNewRecord_=function(a,b,d){a=(new Date).getTime()+this.nowOffsetMilliseconds_;d=new Ab.LastTimestampRecord(b,d,a);b=this.findByKeyName_(b);0<=b&&this.container_.splice(b,1);this.container_.push(d)};Ab.prototype.findByKeyName_=function(a){for(var b=0;b<this.container_.length;++b)if(this.container_[b].keyName_.equals(a))return b;return-1};var tc=a.BoostInfoParser,
cd=a.CertificateRequest,ka=a.ValidatorConfigError,F=a.ValidationError,J=a.CertificateV2,kc=a.ConfigRule,O=a.Data,z=a.Interest,Aa=a.ValidationPolicy,Lb=function(){Aa.call(this);this.isConfigured_=this.shouldBypass_=!1;this.dataRules_=[];this.interestRules_=[]};Lb.prototype=new Aa;Lb.prototype.name="ValidationPolicyConfig";s.ValidationPolicyConfig=Lb;Lb.prototype.load=function(a,b){if("string"===typeof a&&void 0==b){var d=new tc;d.read(a);this.load(d.getRoot(),a)}else if("string"===typeof a&&"string"===
typeof b)d=new tc,d.read(a,b),this.load(d.getRoot(),b);else{this.isConfigured_&&(this.shouldBypass_=!1,this.dataRules_=[],this.interestRules_=[],this.validator_.resetAnchors(),this.validator_.resetVerifiedCertificates());this.isConfigured_=!0;d=a.get("validator");if(1!=d.length)throw new ka(Error("ValidationPolicyConfig: Expected one validator section"));for(var g=d[0],f=g.get("rule"),d=0;d<f.length;++d){var m=kc.create(f[d]);m.getIsForInterest()?this.interestRules_.push(m):this.dataRules_.push(m)}g=
g.get("trust-anchor");for(d=0;d<g.length;++d)this.processConfigTrustAnchor_(g[d],b)}};Lb.prototype.checkPolicy=function(a,b,d){if(this.hasInnerPolicy())throw new ka(Error("ValidationPolicyConfig must be a terminal inner policy"));if(this.shouldBypass_)d(null,b);else{var g=Aa.getKeyLocatorName(a,b);if(!b.isOutcomeFailed())if(a instanceof O){for(var f=0;f<this.dataRules_.length;++f){var m=this.dataRules_[f];if(m.match(!1,a.getName())){m.check(!1,a.getName(),g,b)&&d(new cd(new z(g)),b);return}}b.fail(new F(F.POLICY_ERROR,
"No rule matched for data `"+a.getName().toUri()+"`"))}else{for(f=0;f<this.interestRules_.length;++f)if(m=this.interestRules_[f],m.match(!0,a.getName())){m.check(!0,a.getName(),g,b)&&d(new cd(new z(g)),b);return}b.fail(new F(F.POLICY_ERROR,"No rule matched for interest `"+a.getName().toUri()+"`"))}}};Lb.prototype.processConfigTrustAnchor_=function(a,b){var d=a.getFirstValue("type");if(null==d)throw new ka(Error("Expected <trust-anchor.type>"));if("file"==d.toLowerCase()){var g=a.getFirstValue("file-name");
if(null==g)throw new ka(Error("Expected <trust-anchor.file-name>"));d=Lb.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,d,!1)}else if("base64"==d.toLowerCase()){d=a.getFirstValue("base64-string");if(null==d)throw new ka(Error("Expected <trust-anchor.base64-string>"));d=new f(d,"base64");g=new J;try{g.wireDecode(d)}catch(m){throw new ka(Error("Cannot decode certificate from base64-string: "+m));}this.validator_.loadAnchor("",g)}else if("dir"==d.toLowerCase()){g=a.getFirstValue("dir");if(null==
g)throw new ka(Error("Expected <trust-anchor.dir>"));d=Lb.getRefreshPeriod_(a);this.validator_.loadAnchor(g,g,d,!0)}else if("any"==d.toLowerCase())this.shouldBypass_=!0;else throw new ka(Error("Unsupported trust-anchor.type"));};Lb.getRefreshPeriod_=function(a){var b=a.getFirstValue("refresh");if(null==b)return 1E14;a=0;b=b.match(/(\d+)([hms])/);null!=b&&(a=parseInt(b[1]),"s"!=b[2]&&(a*=60,"m"!=b[2]&&(a*=60)));return 0==a?36E5:1E3*a};var z=a.Interest,cd=a.CertificateRequest,ia=a.PibKey,F=a.ValidationError,
Aa=a.ValidationPolicy,Qd=function(a){Aa.call(this);this.pib_=a};Qd.prototype=new Aa;Qd.prototype.name="ValidationPolicyFromPib";s.ValidationPolicyFromPib=Qd;Qd.prototype.checkPolicy=function(a,b,d){a=Aa.getKeyLocatorName(a,b);b.isOutcomeFailed()||this.checkPolicyHelper_(a,b,d)};Qd.prototype.checkPolicyHelper_=function(a,b,d){var g;try{g=this.pib_.getIdentity(ia.extractIdentityFromKeyName(a))}catch(f){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB identity for key "+a.toUri()+": "+
f));return}var m;try{m=g.getKey(a)}catch(q){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the PIB key "+a.toUri()+": "+q));return}var r;try{r=m.getDefaultCertificate()}catch(p){b.fail(new F(F.CANNOT_RETRIEVE_CERTIFICATE,"Cannot get the default certificate for key "+a.toUri()+": "+p));return}this.validator_.resetAnchors();this.validator_.loadAnchor("",r);d(new cd(new z(a)),b);this.validator_.resetAnchors()};var cd=a.CertificateRequest,F=a.ValidationError,z=a.Interest,Aa=a.ValidationPolicy,
Zd=function(){Aa.call(this)};Zd.prototype=new Aa;Zd.prototype.name="ValidationPolicySimpleHierarchy";s.ValidationPolicySimpleHierarchy=Zd;Zd.prototype.checkPolicy=function(a,b,d){keyLocatorName=Aa.getKeyLocatorName(a,b);b.isOutcomeFailed()||(keyLocatorName.getPrefix(-2).isPrefixOf(a.getName())?d(new cd(new z(keyLocatorName)),b):b.fail(new F(F.INVALID_KEY_LOCATOR,"Signing policy violation for "+a.getName().toUri()+" by "+keyLocatorName.toUri())))};var g=a.SyncPromise,F=a.ValidationError,bd=a.CertificateFetcherOffline,
zb=a.CertificateStorage,Qc=a.DataValidationState,Ac=a.InterestValidationState,O=a.Data,d=a.Log.LOG,pb=function(a,b){zb.call(this);void 0==b&&(b=new bd);this.policy_=a;this.certificateFetcher_=b;this.maxDepth_=25;if(null==this.policy_)throw Error("The policy is null");if(null==this.certificateFetcher_)throw Error("The certificateFetcher is null");this.policy_.setValidator(this);this.certificateFetcher_.setCertificateStorage(this)};pb.prototype=new zb;pb.prototype.name="Validator";s.Validator=pb;pb.prototype.getPolicy=
function(){return this.policy_};pb.prototype.getFetcher=function(){return this.certificateFetcher_};pb.prototype.setMaxDepth=function(a){this.maxDepth_=a};pb.prototype.getMaxDepth=function(){return this.maxDepth_};pb.prototype.validate=function(a,b,g){a instanceof O?(b=new Qc(a,b,g),3<d&&console.log("Start validating data "+a.getName().toUri())):(b=new Ac(a,b,g),3<d&&console.log("Start validating interest "+a.getName().toUri()));var f=this;this.policy_.checkPolicy(a,b,function(a,b){null==a?b.bypassValidation_():
f.requestCertificate_(a,b)})};pb.prototype.validateCertificate_=function(a,b){3<d&&console.log("Start validating certificate "+a.getName().toUri());if(a.isValid()){var g=this;this.policy_.checkCertificatePolicy(a,b,function(b,d){null==b?d.fail(new F(F.POLICY_ERROR,"Validation policy is not allowed to designate `"+a.getName().toUri()+"` as a trust anchor")):(d.addCertificate(a),g.requestCertificate_(b,d))})}else b.fail(new F(F.EXPIRED_CERTIFICATE,"Retrieved certificate is not yet valid or expired `"+
a.getName().toUri()+"`"))};pb.prototype.requestCertificate_=function(a,b){if(b.getDepth()>=this.maxDepth_)b.fail(new F(F.EXCEEDED_DEPTH_LIMIT,"Exceeded validation depth limit"));else if(b.hasSeenCertificateName(a.interest_.getName()))b.fail(new F(F.LOOP_DETECTED,"Validation loop detected for certificate `"+a.interest_.getName().toUri()+"`"));else{3<d&&console.log("Retrieving "+a.interest_.getName().toUri());var f=this,m=this.findTrustedCertificate(a.interest_);null!=m?(3<d&&console.log("Found trusted certificate "+
m.getName().toUri()),b.verifyCertificateChainPromise_(m).then(function(a){return null!=a?b.verifyOriginalPacketPromise_(a):g.resolve()}).then(function(){for(var a=0;a<b.certificateChain_.length;++a)f.cacheVerifiedCertificate(b.certificateChain_[a])})):this.certificateFetcher_.fetch(a,b,function(a,b){f.validateCertificate_(a,b)})}};var da=sc=a,d=a.Log.LOG,b=a.Name,z=a.Interest,O=a.Data,pa=a.ContentType,p=a.Blob,r=a.WireFormat,L=a.SecurityException,Nc=a.RsaKeyParams,Oa=a.Tpm,$d=a.TpmBackEndFile,Hb=
a.TpmBackEndMemory,g=a.SyncPromise,J=a.CertificateV2,S=a.SigningInfo,za=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,vb=a.DigestSha256Signature,cb=a.HmacWithSha256Signature,Y=a.KeyLocator,Da=a.KeyLocatorType,Na=a.DigestAlgorithm,ga=a.KeyType,qa=a.ValidityPeriod,xc=a.SafeBag,Ia=a.VerificationHelpers,Ya=a.PublicKey,y=function x(a,b,d){this.tpm_=this.pib_=null;if(void 0==a){if(!Id)throw new L(Error("KeyChain: The default KeyChain constructor is not supported in the browser"));b=a=""}if("string"===
typeof a){void 0==d&&(d=!1);var g=[null],f=[null];x.parseAndCheckPibLocator_(a,g,f);this.pib_=x.createPib_(g[0]+":"+f[0]);this.tpm_=new Oa("","",null);this.pib_.initializeTpm_=this.tpm_;this.pib_.initializePibLocator_=a;this.pib_.initializeTpmLocator_=b;this.pib_.initializeAllowReset_=d;this.tpm_.initializePib_=this.pib_}else a instanceof W&&(this.pib_=new ea("","",a),this.tpm_=new Oa("","",b))};s.KeyChain=y;y.Error=function(a){if(a)return a.__proto__=y.Error.prototype,a};y.Error.prototype=Error();
y.Error.prototype.name="KeyChainError";y.prototype.getPib=function(){return this.pib_};y.prototype.getTpm=function(){return this.tpm_};y.prototype.createIdentityV2Promise=function(a,b,f){f="boolean"===typeof b?b:f;b="boolean"!==typeof b&&b?b:void 0;void 0==b&&(b=y.getDefaultKeyParams());var m=this,q;return this.pib_.addIdentityPromise_(a,f).then(function(a){q=a;return q.getDefaultKeyPromise(f).catch(function(a){return a instanceof ea.Error?m.createKeyPromise(q,b,f):g.reject(a)})}).then(function(a){return a.getDefaultCertificatePromise(f).catch(function(b){return b instanceof
ea.Error?(2<d&&console.log("No default cert for "+a.getName()+", requesting self-signing"),m.selfSignPromise(a,f)):g.reject(b)})}).then(function(){return g.resolve(q)})};y.prototype.createIdentityV2=function(a,b,d,f){f="function"===typeof b?d:f;d="function"===typeof b?b:d;return g.complete(d,f,this.createIdentityV2Promise(a,"function"!==typeof b&&b?b:void 0,!d))};y.prototype.deleteIdentityPromise=function(a,b){function d(a){return a>=q.length?g.resolve():f.tpm_.deleteKeyPromise_(q[a],b).then(function(){return d(a+
1)})}var f=this,m=a.getName(),q=a.getKeys_().getKeyNames();return d(0).then(function(){return f.pib_.removeIdentityPromise_(m,b)})};y.prototype.deleteIdentity=function(a,b,d){return g.complete(b,d,this.deleteIdentityPromise(a,!b))};y.prototype.setDefaultIdentityPromise=function(a,b){return this.pib_.setDefaultIdentityPromise_(a.getName(),b)};y.prototype.setDefaultIdentity=function(a,b,d){return g.complete(b,d,this.setDefaultIdentityPromise(a,!b))};y.prototype.createKeyPromise=function(a,b,f){f="boolean"===
typeof b?b:f;b="boolean"!==typeof b&&b?b:void 0;void 0==b&&(b=y.getDefaultKeyParams());var m=this,q,r;return this.tpm_.createKeyPromise_(a.getName(),b,f).then(function(a){r=a;return m.tpm_.getPublicKeyPromise(r,f)}).then(function(b){return a.addKeyPromise_(b.buf(),r,f)}).then(function(a){q=a;2<d&&console.log("Requesting self-signing for newly created key "+q.getName().toUri());return m.selfSignPromise(q,f)}).then(function(){return g.resolve(q)})};y.prototype.createKey=function(a,b,d,f){f="function"===
typeof b?d:f;d="function"===typeof b?b:d;return g.complete(d,f,this.createKeyPromise(a,"function"!==typeof b&&b?b:void 0,!d))};y.prototype.deleteKeyPromise=function(a,b,d){var f=b.getName();if(!a.getName().equals(b.getIdentityName()))return g.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+f.toUri()+"`"));var m=this;return a.removeKeyPromise_(f,d).then(function(){return m.tpm_.deleteKeyPromise_(f,d)})};y.prototype.deleteKey=function(a,b,d,f){return g.complete(d,f,this.deleteKeyPromise(a,
b,!d))};y.prototype.setDefaultKeyPromise=function(a,b,d){return a.getName().equals(b.getIdentityName())?a.setDefaultKeyPromise_(b.getName(),d):g.reject(Error("Identity `"+a.getName().toUri()+"` does not match key `"+b.getName().toUri()+"`"))};y.prototype.setDefaultKey=function(a,b,d,f){return g.complete(d,f,this.setDefaultKeyPromise(a,b,!d))};y.prototype.addCertificatePromise=function(a,b,d){return a.getName().equals(b.getKeyName())&&b.getContent().equals(a.getPublicKey())?a.addCertificatePromise_(b,
d):g.reject(Error("Key `"+a.getName().toUri()+"` does not match certificate `"+b.getKeyName().toUri()+"`"))};y.prototype.addCertificate=function(a,b,d,f){return g.complete(d,f,this.addCertificatePromise(a,b,!d))};y.prototype.deleteCertificatePromise=function(a,b,d){return J.isValidName(b)?a.removeCertificatePromise_(b,d):g.reject(Error("Wrong certificate name `"+b.toUri()+"`"))};y.prototype.deleteCertificate=function(a,b,d,f){return g.complete(d,f,this.deleteCertificatePromise(a,b,!d))};y.prototype.setDefaultCertificatePromise=
function(a,b,d){return this.addCertificatePromise(a,b,d).then(function(){return a.setDefaultCertificatePromise_(b.getName(),d)})};y.prototype.setDefaultCertificate=function(a,b,d,f){return g.complete(d,f,this.setDefaultCertificatePromise(a,b,!d))};y.prototype.signPromise=function(a,d,f,m){var q=d,p=f,C=m;d=q instanceof S||q instanceof b?q:void 0;f=q instanceof r?q:p instanceof r?p:void 0;m="boolean"===typeof q?q:"boolean"===typeof p?p:"boolean"===typeof C?C:!1;void 0==f&&(f=r.getDefaultWireFormat());
var s=this;return g.resolve().then(function(){void 0==d&&(d=y.defaultSigningInfo_);return g.resolve()}).then(function(){if(d instanceof b){var q=d;if(!(a instanceof z||a instanceof O))return g.reject(new L(Error("sign(buffer, certificateName) is not supported for security v2. Use sign with SigningInfo.")));var wb=new S;wb.setSigningCertificateName(q);return s.signPromise(a,wb,f,m).catch(function(a){return g.reject(new L(Error("Error in sign: "+a)))})}var bb=d;if(a instanceof O){var r=[null];return s.prepareSignatureInfoPromise_(bb,
r,m).then(function(b){a.setSignature(b);b=a.wireEncode(f);return s.signBufferPromise_(b.signedBuf(),r[0],bb.getDigestAlgorithm(),m)}).then(function(b){a.getSignature().setSignature(b);a.wireEncode(f);return g.resolve(a)})}if(a instanceof z){var yb,r=[null];return s.prepareSignatureInfoPromise_(bb,r,m).then(function(d){yb=d;a.getName().append(f.encodeSignatureInfo(yb));a.getName().append(new b.Component);d=a.wireEncode(f);return s.signBufferPromise_(d.signedBuf(),r[0],bb.getDigestAlgorithm(),m)}).then(function(b){yb.setSignature(b);
a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(yb)));return g.resolve(a)})}r=[null];return s.prepareSignatureInfoPromise_(bb,r,m).then(function(b){return s.signBufferPromise_(a,r[0],bb.getDigestAlgorithm(),m)})})};y.prototype.sign=function(a,d,f,m,q){var p=d,C=f,s=m;d=p instanceof S||p instanceof b?p:null;f=p instanceof r?p:C instanceof r?C:null;"function"===typeof p?(m=p,q=C):"function"===typeof C?(m=C,q=s):"function"===typeof s?m=s:q=m=null;return g.complete(m,q,this.signPromise(a,
d,f,!m))};y.prototype.selfSignPromise=function(a,d,f){var m=d,q=f;d=m instanceof r?m:void 0;f="boolean"===typeof m?m:"boolean"===typeof q?q:!1;void 0==d&&(d=r.getDefaultWireFormat());var p=new J,m=(new Date).getTime(),q=new b(a.getName());q.append("self").appendVersion(m);p.setName(q);p.getMetaInfo().setType(pa.KEY);p.getMetaInfo().setFreshnessPeriod(36E5);p.setContent(a.getPublicKey());signingInfo=new S(a);signingInfo.setValidityPeriod(new qa(m,m+63072E7));return this.signPromise(p,signingInfo,d,
f).then(function(){return a.addCertificatePromise_(p,f).catch(function(a){return g.reject(new y.Error(Error("Error encoding certificate: "+a)))})}).then(function(){return g.resolve(p)})};y.prototype.selfSign=function(a,b,d,f){"function"===typeof b&&(f=d,d=b,b=void 0);void 0==b&&(b=r.getDefaultWireFormat());return g.complete(d,f,this.selfSignPromise(a,b,!d))};y.prototype.exportSafeBagPromise=function(a,b,d){"boolean"===typeof b&&(d=b,b=void 0);var f=a.getKeyName(),m=this;return g.resolve().then(function(){return m.tpm_.exportPrivateKeyPromise_(f,
b,d)},function(a){return g.reject(new y.Error(Error("Failed to export private key `"+f.toUri()+"`: "+a)))}).then(function(b){return g.resolve(new xc(a,b))})};y.prototype.exportSafeBag=function(a,b,d,f){f="function"===typeof b?d:f;d="function"===typeof b?b:d;return g.complete(d,f,this.exportSafeBagPromise(a,"function"===typeof b?null:b,!d))};y.prototype.importSafeBagPromise=function(a,b,d){"boolean"===typeof b&&(d=b,b=void 0);var f;try{f=new J(a.getCertificate())}catch(m){return g.reject(Error("Error reading CertificateV2: "+
m))}var q=f.getIdentity(),r=f.getKeyName(),C=f.getPublicKey(),s=new p([1,2,3,4]),wb,bb=this;return g.resolve().then(function(){return bb.tpm_.hasKeyPromise(r,d)}).then(function(a){return a?g.reject(new y.Error(Error("Private key `"+r.toUri()+"` already exists"))):bb.pib_.getIdentityPromise(q,d).then(function(a){return a.getKeyPromise(r,d)}).then(function(){return g.reject(new y.Error(Error("Public key `"+r.toUri()+"` already exists")))},function(a){return g.resolve()})}).then(function(){return bb.tpm_.importPrivateKeyPromise_(r,
a.getPrivateKeyBag().buf(),b,d).catch(function(a){return g.reject(new y.Error(Error("Failed to import private key `"+r.toUri()+"`: "+a)))})}).then(function(){return bb.tpm_.signPromise(s.buf(),r,Na.SHA256,d).then(function(a){wb=a;return g.resolve()},function(a){return bb.tpm_.deleteKeyPromise_(r,d).then(function(){return g.reject(new y.Error(Error("Invalid private key `"+r.toUri()+"`")))})})}).then(function(){var a;try{a=new Ya(C)}catch(b){return bb.tpm_.deleteKeyPromise_(r,d).then(function(){return g.reject(new y.Error(Error("Error decoding public key "+
b)))})}return Ia.verifySignaturePromise(s,wb,a,d)}).then(function(a){return a?bb.pib_.addIdentityPromise_(q,d):bb.tpm_.deleteKeyPromise_(r,d).then(function(){return g.reject(new y.Error(Error("Certificate `"+f.getName().toUri()+"` and private key `"+r.toUri()+"` do not match")))})}).then(function(a){return a.addKeyPromise_(f.getPublicKey().buf(),r,d)}).then(function(a){return a.addCertificatePromise_(f,d)})};y.prototype.importSafeBag=function(a,b,d,f){f="function"===typeof b?d:f;d="function"===typeof b?
b:d;return g.complete(d,f,this.importSafeBagPromise(a,"function"===typeof b?null:b,!d))};y.registerPibBackend=function(a,b){y.getPibFactories_()[a]=b};y.registerTpmBackend=function(a,b){y.getTpmFactories_()[a]=b};y.prototype.getDefaultIdentity=function(a,b){return this.identityManager_.getDefaultIdentity(a,b)};y.prototype.getDefaultCertificateName=function(a,b){return g.complete(a,b,this.pib_.getDefaultIdentityPromise(!a).then(function(b){return b.getDefaultKeyPromise(!a)}).then(function(b){return b.getDefaultCertificatePromise(!a)}).then(function(a){return g.resolve(a.getName())}))};
y.prototype.signWithSha256=function(a,b){var d=S();d.setSha256Signing();this.sign(a,d,b)};y.signWithHmacWithSha256=function(a,d,g,f){g instanceof r&&(f=g,g=void 0);f=f||r.getDefaultWireFormat();if(a instanceof O)g=a.wireEncode(f),d=da.createHmac("sha256",d.buf()),d.update(g.signedBuf()),a.getSignature().setSignature(new p(d.digest(),!1));else if(a instanceof z){if(null==g)throw new L(Error("signWithHmacWithSha256: keyName is required to sign an Interest"));var m=new cb;m.getKeyLocator().setType(Da.KEYNAME);
m.getKeyLocator().setKeyName(g);a.getName().append(f.encodeSignatureInfo(m));a.getName().append(new b.Component);g=a.wireEncode(f);d=da.createHmac("sha256",d.buf());d.update(g.signedBuf());m.setSignature(new p(d.digest(),!1));a.setName(a.getName().getPrefix(-1).append(f.encodeSignatureValue(m)))}else throw new L(Error("signWithHmacWithSha256: Unrecognized target type"));};y.verifyDataWithHmacWithSha256=function(a,b,d){d=d||r.getDefaultWireFormat();d=a.wireEncode(d);b=da.createHmac("sha256",b.buf());
b.update(d.signedBuf());return(new p(b.digest(),!1)).equals(a.getSignature().getSignature())};y.verifyInterestWithHmacWithSha256=function(a,b,d){d=d||r.getDefaultWireFormat();var g=d.decodeSignatureInfoAndValue(a.getName().get(-2).getValue().buf(),a.getName().get(-1).getValue().buf());a=a.wireEncode(d);b=da.createHmac("sha256",b.buf());b.update(a.signedBuf());return(new p(b.digest(),!1)).equals(g.getSignature())};y.getDefaultKeyParams=function(){return y.defaultKeyParams_};y.DEFAULT_KEY_PARAMS=new Nc;
y.getPibFactories_=function(){null==y.pibFactories_&&(y.pibFactories_={},ae&&(y.pibFactories_[ae.getScheme()]=function(a){return new ae(a)}),y.pibFactories_[oa.getScheme()]=function(a){return new oa});return y.pibFactories_};y.getTpmFactories_=function(){null==y.tpmFactories_&&(y.tpmFactories_={},$d&&(y.tpmFactories_[$d.getScheme()]=function(a){return new $d(a)}),y.tpmFactories_[Hb.getScheme()]=function(a){return new Hb});return y.tpmFactories_};y.parseLocatorUri_=function(a,b,d){iColon=a.indexOf(":");
0<=iColon?(b[0]=a.substring(0,iColon),d[0]=a.substring(iColon+1)):(b[0]=a,d[0]="")};y.parseAndCheckPibLocator_=function(a,b,d){y.parseLocatorUri_(a,b,d);""==b[0]&&(b[0]=y.getDefaultPibScheme_());if(void 0==y.getPibFactories_()[b[0]])throw new y.Error(Error("PIB scheme `"+b[0]+"` is not supported"));};y.parseAndCheckTpmLocator_=function(a,b,d){y.parseLocatorUri_(a,b,d);""==b[0]&&(b[0]=y.getDefaultTpmScheme_());if(void 0==y.getTpmFactories_()[b[0]])throw new y.Error(Error("TPM scheme `"+b[0]+"` is not supported"));
};y.getDefaultPibScheme_=function(){return ae.getScheme()};y.getDefaultTpmScheme_=function(){if("darwin"===process.platform)throw new y.Error(Error("TpmBackEndOsx is not implemented. You must use tpm-file."));return $d.getScheme()};y.createPib_=function(a){var b=[null],d=[null];y.parseAndCheckPibLocator_(a,b,d);a=y.getPibFactories_()[b[0]];return new ea(b[0],d[0],a(d[0]))};y.setUpTpm_=function(a,b){var d=[null],g=[null];y.parseAndCheckTpmLocator_(b,d,g);var f=y.getTpmFactories_()[d[0]];a.scheme_=
d[0];a.location_=g[0];a.backEnd_=f(g[0])};y.getDefaultPibLocator_=function(a){if(null!=y.defaultPibLocator_)return y.defaultPibLocator_;var b=process.env.NDN_CLIENT_PIB;y.defaultPibLocator_=void 0!=b&&""!=b?b:a.get("pib",y.getDefaultPibScheme_()+":");return y.defaultPibLocator_};y.getDefaultTpmLocator_=function(a){if(null!=y.defaultTpmLocator_)return y.defaultTpmLocator_;var b=process.env.NDN_CLIENT_TPM;y.defaultTpmLocator_=void 0!=b&&""!=b?b:a.get("tpm",y.getDefaultTpmScheme_()+":");return y.defaultTpmLocator_};
y.prototype.prepareSignatureInfoPromise_=function(a,b,d){var f=null,m=null,q=this;return g.resolve().then(function(){if(a.getSignerType()==S.SignerType.NULL)return q.pib_.getDefaultIdentityPromise(d).then(function(a){f=a;return g.resolve(null)},function(a){b[0]=S.getDigestSha256Identity();return g.resolve(new vb)});if(a.getSignerType()==S.SignerType.ID)return f=a.getPibIdentity(),null==f?q.pib_.getIdentityPromise(a.getSignerName(),d).then(function(a){f=a;return g.resolve(null)},function(b){return g.reject(new Bc(Error("Signing identity `"+
a.getSignerName().toUri()+"` does not exist")))}):g.resolve(null);if(a.getSignerType()==S.SignerType.KEY)return m=a.getPibKey(),null==m?(r=ia.extractIdentityFromKeyName(a.getSignerName()),q.pib_.getIdentityPromise(r,d).then(function(b){return b.getKeyPromise(a.getSignerName(),d).then(function(a){m=a;f=null;return g.resolve(null)})},function(b){return g.reject(new Bc(Error("Signing key `"+a.getSignerName().toUri()+"` does not exist")))})):g.resolve(null);if(a.getSignerType()==S.SignerType.CERT){var r=
J.extractIdentityFromCertName(a.getSignerName());return q.pib_.getIdentityPromise(r,d).then(function(b){f=b;return f.getKeyPromise(J.extractKeyNameFromCertName(a.getSignerName()),d).then(function(a){m=a;return g.resolve(null)})},function(b){return g.reject(new Bc(Error("Signing certificate `"+a.getSignerName().toUri()+"` does not exist")))})}return a.getSignerType()==S.SignerType.SHA256?(b[0]=S.getDigestSha256Identity(),g.resolve(new vb)):g.reject(new Bc(Error("Unrecognized signer type")))}).then(function(q){return null!=
q?g.resolve(q):null==f&&null==m?g.reject(new Bc(Error("Cannot determine signing parameters"))):g.resolve().then(function(){return null!=f&&null==m?f.getDefaultKeyPromise(d).then(function(a){m=a;return g.resolve(null)},function(a){return g.reject(new Bc(Error("Signing identity `"+f.getName().toUri()+"` does not have default certificate")))}):g.resolve()}).then(function(){if(m.getKeyType()==ga.RSA&&a.getDigestAlgorithm()==Na.SHA256)signatureInfo=new za;else if(m.getKeyType()==ga.EC&&a.getDigestAlgorithm()==
Na.SHA256)signatureInfo=new Xa;else return g.reject(new y.Error(Error("Unsupported key type")));a.getValidityPeriod().hasPeriod()&&qa.canGetFromSignature(signatureInfo)&&qa.getFromSignature(signatureInfo).setPeriod(a.getValidityPeriod().getNotBefore(),a.getValidityPeriod().getNotAfter());var d=Y.getFromSignature(signatureInfo);d.setType(Da.KEYNAME);d.setKeyName(m.getName());b[0]=m.getName();return g.resolve(signatureInfo)})})};y.prototype.signBufferPromise_=function(a,b,d,f){return b.equals(S.getDigestSha256Identity())?
(b=da.createHash("sha256"),b.update(a),g.resolve(new p(b.digest(),!1))):this.tpm_.signPromise(a,b,d,f)};y.defaultPibLocator_=null;y.defaultTpmLocator_=null;y.pibFactories_=null;y.tpmFactories_=null;y.defaultSigningInfo_=new S;y.defaultKeyParams_=new Nc;var Bc=function(a){y.Error.call(this,a)};Bc.prototype=new y.Error;Bc.prototype.name="InvalidSigningInfoError";s.InvalidSigningInfoError=Bc;s.InvalidSigningInfoError=Bc;Jd=function(a){y.Error.call(this,a)};Jd.prototype=new y.Error;Jd.prototype.name=
"LocatorMismatchError";s.LocatorMismatchError=Jd;var Id=a.ConfigFile,ea=a.Pib,W=a.PibImpl,ia=a.PibKey,ae=a.PibSqlite3,oa=a.PibMemory,ka=function Fa(a){if(a)return a.__proto__=Fa.prototype,a};ka.prototype=Error();ka.prototype.name="ValidatorConfigError";s.ValidatorConfigError=ka;var Yb=a.CertificateFetcher,Lb=a.ValidationPolicyConfig,kd=a.CertificateFetcherFromNetwork,pb=a.Validator,be=function(a){a instanceof Yb?pb.call(this,new Lb,a):pb.call(this,new Lb,new kd(a));this.policyConfig_=this.getPolicy()};
be.prototype=new pb(new Lb,new kd(null));be.prototype.name="ValidatorConfig";s.ValidatorConfig=be;be.prototype.load=function(a,b){this.policyConfig_.load(a,b)};var md=a.ValidationPolicyAcceptAll,bd=a.CertificateFetcherOffline,pb=a.Validator,ie=function(){pb.call(this,new md,new bd)};ie.prototype=new pb(new md);ie.prototype.name="ValidatorNull";s.ValidatorNull=ie;var b=a.Name,H=a.DataUtils,p=a.Blob,Ta=function ke(a){this.values=[];if("object"===typeof a&&a instanceof ke)this.values=a.values.slice(0);
else if(a)for(var b=this.changeCount=0;b<a.length;++b)a[b]==ke.ANY?this.appendAny():this.appendComponent(a[b]);this.changeCount=0};s.Exclude=Ta;Ta.ANY="*";Ta.prototype.size=function(){return this.values.length};Ta.prototype.get=function(a){return this.values[a]};Ta.prototype.appendAny=function(){this.values.push(Ta.ANY);++this.changeCount;return this};Ta.prototype.appendComponent=function(a){this.values.push(new b.Component(a));++this.changeCount;return this};Ta.prototype.clear=function(){++this.changeCount;
this.values=[]};Ta.prototype.toUri=function(){if(null==this.values||0==this.values.length)return"";for(var a="",b=0;b<this.values.length;++b)0<b&&(a+=","),a=this.values[b]==Ta.ANY?a+"*":a+this.values[b].toEscapedString();return a};Ta.prototype.matches=function(a){"object"==typeof a&&a instanceof b.Component||(a=new b.Component(a));for(var d=0;d<this.values.length;++d)if(this.values[d]==Ta.ANY){var g=null;0<d&&(g=this.values[d-1]);var f,m=null;for(f=d+1;f<this.values.length;++f)if(this.values[f]!=
Ta.ANY){m=this.values[f];break}if(null!=m){if(null!=g){if(0<a.compare(g)&&0>a.compare(m))return!0}else if(0>a.compare(m))return!0;d=f-1}else if(null!=g){if(0<a.compare(g))return!0}else return!0}else if(a.equals(this.values[d]))return!0;return!1};Ta.compareComponents=function(a,d){"object"==typeof a&&a instanceof b.Component&&(a=a.getValue().buf());"object"==typeof d&&d instanceof b.Component&&(d=d.getValue().buf());return b.Component.compareBuffers(a,d)};Ta.prototype.getChangeCount=function(){return this.changeCount};
var da=a,p=a.Blob,Ka=a.SignedBlob,ha=a.ChangeCounter,b=a.Name,Ta=a.Exclude,lc=a.Link,Y=a.KeyLocator,Ua=a.DelegationSet,ic=a.IncomingFaceId,r=a.WireFormat,z=function Sa(a,d,g,f,m,wb,bb,q,yb,Pa){if(null!=f)throw Error("Interest constructor: PublisherPublicKeyDigest support has been removed.");if(null!=bb)throw Error("Interest constructor: answerOriginKind support has been removed. Use setMustBeFresh().");if(null!=q)throw Error("Interest constructor: scope support has been removed.");if(null!=Pa)throw Error("Interest constructor: nonce support in the constructor has been removed.");
null!=d&&console.log("Interest constructor: The minSuffixComponents param is deprecated. Use setMinSuffixComponents().");null!=g&&console.log("Interest constructor: The maxSuffixComponents param is deprecated. Use setMaxSuffixComponents().");null!=m&&console.log("Interest constructor: The exclude param is deprecated. Use setExclude().");null!=wb&&console.log("Interest constructor: The childSelector param is deprecated. Use setChildSelector().");null!=yb&&console.log("Interest constructor: The interestLifetimeMilliseconds param is deprecated. Use setInterestLifetimeMilliseconds().");
"object"===typeof a&&a instanceof Sa?(this.name_=new ha(new b(a.getName())),this.maxSuffixComponents_=a.maxSuffixComponents_,this.didSetCanBePrefix_=a.didSetCanBePrefix_,this.minSuffixComponents_=a.minSuffixComponents_,this.keyLocator_=new ha(new Y(a.getKeyLocator())),this.exclude_=new ha(new Ta(a.getExclude())),this.childSelector_=a.childSelector_,this.mustBeFresh_=a.mustBeFresh_,this.interestLifetimeMilliseconds_=a.interestLifetimeMilliseconds_,this.forwardingHint_=new ha(new Ua(a.getForwardingHint())),
this.applicationParameters_=a.applicationParameters_,this.nonce_=a.nonce_,this.linkWireEncoding_=a.linkWireEncoding_,this.linkWireEncodingFormat_=a.linkWireEncodingFormat_,this.link_=new ha(null),null!=a.link_.get()&&this.link_.set(new lc(a.link_.get())),this.selectedDelegationIndex_=a.selectedDelegationIndex_,this.defaultWireEncoding_=a.getDefaultWireEncoding(),this.defaultWireEncodingFormat_=a.defaultWireEncodingFormat_):(this.name_=new ha(new b(a)),this.maxSuffixComponents_=null!=g?g:Sa.defaultCanBePrefix_?
null:1,this.didSetCanBePrefix_=Sa.didSetDefaultCanBePrefix_,this.minSuffixComponents_=d,this.keyLocator_=new ha(new Y),this.exclude_=new ha("object"===typeof m&&m instanceof Ta?new Ta(m):new Ta),this.childSelector_=wb,this.mustBeFresh_=!1,this.interestLifetimeMilliseconds_=yb,this.forwardingHint_=new ha(new Ua),this.applicationParameters_=new p,this.nonce_=new p,this.linkWireEncoding_=new p,this.linkWireEncodingFormat_=null,this.link_=new ha(null),this.selectedDelegationIndex_=null,this.defaultWireEncoding_=
new Ka,this.defaultWireEncodingFormat_=null);this.changeCount_=this.getDefaultWireEncodingChangeCount_=this.getNonceChangeCount_=0;this.lpPacket_=null};s.Interest=z;z.RECURSIVE_POSTFIX="*";z.CHILD_SELECTOR_LEFT=0;z.CHILD_SELECTOR_RIGHT=1;z.defaultCanBePrefix_=!0;z.didSetDefaultCanBePrefix_=!1;z.getDefaultCanBePrefix=function(){return z.defaultCanBePrefix_};z.setDefaultCanBePrefix=function(a){z.defaultCanBePrefix_=a;z.didSetDefaultCanBePrefix_=!0};z.prototype.matchesName=function(a){return!this.getName().match(a)||
null!=this.minSuffixComponents_&&!(a.size()+1-this.getName().size()>=this.minSuffixComponents_)||null!=this.maxSuffixComponents_&&!(a.size()+1-this.getName().size()<=this.maxSuffixComponents_)||null!=this.getExclude()&&a.size()>this.getName().size()&&this.getExclude().matches(a.get(this.getName().size()))?!1:!0};z.prototype.matches_name=function(a){return this.matchesName(a)};z.prototype.matchesData=function(a,b){b=b||r.getDefaultWireFormat();var d=this.getName().size(),g=a.getName(),f=g.size()+1,
m=null!=this.getMinSuffixComponents()?this.getMinSuffixComponents():0;if(!(d+m<=f&&(null==this.getMaxSuffixComponents()||d+this.getMaxSuffixComponents()>=f)))return!1;if(d===f)if(this.getName().get(-1).isImplicitSha256Digest()){if(!this.getName().equals(a.getFullName(b)))return!1}else return!1;else if(!this.getName().isPrefixOf(g))return!1;if(0<this.getExclude().size()&&f>d)if(d==f-1){if(this.getExclude().matches(a.getFullName(b).get(d)))return!1}else if(this.getExclude().matches(g.get(d)))return!1;
d=this.getKeyLocator();return!d.getType()||(g=a.getSignature(),Y.canGetFromSignature(g)&&d.equals(Y.getFromSignature(g)))?!0:!1};z.prototype.clone=function(){return new z(this)};z.prototype.getName=function(){return this.name_.get()};z.prototype.getMinSuffixComponents=function(){return this.minSuffixComponents_};z.prototype.getMaxSuffixComponents=function(){return this.maxSuffixComponents_};z.prototype.getCanBePrefix=function(){return 1!=this.maxSuffixComponents_};z.prototype.getKeyLocator=function(){return this.keyLocator_.get()};
z.prototype.getExclude=function(){return this.exclude_.get()};z.prototype.getChildSelector=function(){return this.childSelector_};z.prototype.getMustBeFresh=function(){return this.mustBeFresh_};z.prototype.getNonce=function(){this.getNonceChangeCount_!=this.getChangeCount()&&(this.nonce_=new p,this.getNonceChangeCount_=this.getChangeCount());return this.nonce_};z.prototype.getForwardingHint=function(){return this.forwardingHint_.get()};z.prototype.hasApplicationParameters=function(){return 0<this.applicationParameters_.size()};
z.prototype.hasParameters=function(){return this.hasApplicationParameters()};z.prototype.getApplicationParameters=function(){return this.applicationParameters_};z.prototype.getParameters=function(){return this.getApplicationParameters()};z.prototype.getNonceAsBuffer=function(){return this.getNonce().buf()};z.prototype.hasLink=function(){return null!=this.link_.get()||!this.linkWireEncoding_.isNull()};z.prototype.getLink=function(){if(null!=this.link_.get())return this.link_.get();if(this.linkWireEncoding_.isNull())return null;
var a=new lc;a.wireDecode(this.linkWireEncoding_,this.linkWireEncodingFormat_);this.link_.set(a);this.linkWireEncoding_=new p;this.linkWireEncodingFormat_=null;return a};z.prototype.getLinkWireEncoding=function(a){a=a||r.getDefaultWireFormat();if(!this.linkWireEncoding_.isNull()&&this.linkWireEncodingFormat_==a)return this.linkWireEncoding_;var b=this.getLink();return null!=b?b.wireEncode(a):new p};z.prototype.getSelectedDelegationIndex=function(){return this.selectedDelegationIndex_};z.prototype.getInterestLifetimeMilliseconds=
function(){return this.interestLifetimeMilliseconds_};z.prototype.getDefaultWireEncoding=function(){this.getDefaultWireEncodingChangeCount_!=this.getChangeCount()&&(this.defaultWireEncoding_=new Ka,this.defaultWireEncodingFormat_=null,this.getDefaultWireEncodingChangeCount_=this.getChangeCount());return this.defaultWireEncoding_};z.prototype.getDefaultWireEncodingFormat=function(){return this.defaultWireEncodingFormat_};z.prototype.getIncomingFaceId=function(){var a=null===this.lpPacket_?null:ic.getFirstHeader(this.lpPacket_);
return null===a?null:a.getFaceId()};z.prototype.setName=function(a){this.name_.set("object"===typeof a&&a instanceof b?new b(a):new b);++this.changeCount_;return this};z.prototype.setMinSuffixComponents=function(a){this.minSuffixComponents_=a;++this.changeCount_;return this};z.prototype.setMaxSuffixComponents=function(a){this.maxSuffixComponents_=a;++this.changeCount_;return this};z.prototype.setCanBePrefix=function(a){this.maxSuffixComponents_=a?null:1;this.didSetCanBePrefix_=!0;++this.changeCount_;
return this};z.prototype.setKeyLocator=function(a){this.keyLocator_.set("object"===typeof a&&a instanceof Y?new Y(a):new Y);++this.changeCount_;return this};z.prototype.setExclude=function(a){this.exclude_.set("object"===typeof a&&a instanceof Ta?new Ta(a):new Ta);++this.changeCount_;return this};z.prototype.setForwardingHint=function(a){this.forwardingHint_.set("object"===typeof a&&a instanceof Ua?new Ua(a):new Ua);++this.changeCount_;return this};z.prototype.setApplicationParameters=function(a){this.applicationParameters_=
"object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;return this};z.prototype.setParameters=function(a){return this.setApplicationParameters(a)};z.prototype.appendParametersDigestToName=function(){if(!this.hasParameters())return this;var a=da.createHash("sha256");a.update(this.applicationParameters_.buf());this.getName().appendParametersSha256Digest(new p(a.digest(),!1));return this};z.prototype.setLinkWireEncoding=function(a,b){b=b||r.getDefaultWireFormat();this.linkWireEncoding_=
a;this.linkWireEncodingFormat_=b;this.link_.set(null);++this.changeCount_;return this};z.prototype.unsetLink=function(){return this.setLinkWireEncoding(new p,null)};z.prototype.setSelectedDelegationIndex=function(a){this.selectedDelegationIndex_=a;++this.changeCount_;return this};z.prototype.setChildSelector=function(a){this.childSelector_=a;++this.changeCount_;return this};z.prototype.setMustBeFresh=function(a){this.mustBeFresh_=a?!0:!1;++this.changeCount_;return this};z.prototype.setInterestLifetimeMilliseconds=
function(a){this.interestLifetimeMilliseconds_=a;++this.changeCount_;return this};z.prototype.setNonce=function(a){this.nonce_="object"===typeof a&&a instanceof p?a:new p(a,!0);++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount();return this};z.prototype.toUri=function(){var a="";null!=this.minSuffixComponents_&&(a+="&ndn.MinSuffixComponents="+this.minSuffixComponents_);null!=this.maxSuffixComponents_&&(a+="&ndn.MaxSuffixComponents="+this.maxSuffixComponents_);null!=this.childSelector_&&
(a+="&ndn.ChildSelector="+this.childSelector_);a+="&ndn.MustBeFresh="+(this.mustBeFresh_?1:0);null!=this.interestLifetimeMilliseconds_&&(a+="&ndn.InterestLifetime="+this.interestLifetimeMilliseconds_);0<this.getNonce().size()&&(a+="&ndn.Nonce="+b.toEscapedString(this.getNonce().buf()));null!=this.getExclude()&&0<this.getExclude().size()&&(a+="&ndn.Exclude="+this.getExclude().toUri());var d=this.getName().toUri();""!=a&&(d+="?"+a.substr(1));return d};z.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();
if(!this.getDefaultWireEncoding().isNull()&&this.getDefaultWireEncodingFormat()==a)return this.getDefaultWireEncoding();var b=a.encodeInterest(this),b=new Ka(b.encoding,b.signedPortionBeginOffset,b.signedPortionEndOffset);a==r.getDefaultWireFormat()&&this.setDefaultWireEncoding(b,r.getDefaultWireFormat());return b};z.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();var d;d="object"===typeof a&&a instanceof p?b.decodeInterest(this,a.buf(),!1):b.decodeInterest(this,a,!0);b==r.getDefaultWireFormat()?
this.setDefaultWireEncoding(new Ka(new p(a,!0),d.signedPortionBeginOffset,d.signedPortionEndOffset),r.getDefaultWireFormat()):this.setDefaultWireEncoding(new Ka,null)};z.prototype.refreshNonce=function(){var a=this.getNonce();if(0!==a.size()){for(var b;b=new p(da.randomBytes(a.size()),!1),b.equals(a););this.nonce_=b;++this.changeCount_;this.getNonceChangeCount_=this.getChangeCount()}};z.prototype.setLpPacket=function(a){this.lpPacket_=a;return this};z.prototype.getChangeCount=function(){var a=this.name_.checkChanged(),
a=this.keyLocator_.checkChanged()||a,a=this.exclude_.checkChanged()||a;(a=this.forwardingHint_.checkChanged()||a)&&++this.changeCount_;return this.changeCount_};z.prototype.setDefaultWireEncoding=function(a,b){this.defaultWireEncoding_=a;this.defaultWireEncodingFormat_=b;this.getDefaultWireEncodingChangeCount_=this.getChangeCount()};Object.defineProperty(z.prototype,"name",{get:function(){return this.getName()},set:function(a){this.setName(a)}});Object.defineProperty(z.prototype,"minSuffixComponents",
{get:function(){return this.getMinSuffixComponents()},set:function(a){this.setMinSuffixComponents(a)}});Object.defineProperty(z.prototype,"maxSuffixComponents",{get:function(){return this.getMaxSuffixComponents()},set:function(a){this.setMaxSuffixComponents(a)}});Object.defineProperty(z.prototype,"keyLocator",{get:function(){return this.getKeyLocator()},set:function(a){this.setKeyLocator(a)}});Object.defineProperty(z.prototype,"exclude",{get:function(){return this.getExclude()},set:function(a){this.setExclude(a)}});
Object.defineProperty(z.prototype,"childSelector",{get:function(){return this.getChildSelector()},set:function(a){this.setChildSelector(a)}});Object.defineProperty(z.prototype,"interestLifetime",{get:function(){return this.getInterestLifetimeMilliseconds()},set:function(a){this.setInterestLifetimeMilliseconds(a)}});Object.defineProperty(z.prototype,"nonce",{get:function(){return this.getNonceAsBuffer()},set:function(a){this.setNonce(a)}});na=function xe(a){"object"===typeof a&&a instanceof xe?(this.childInherit=
a.childInherit,this.capture=a.capture,this.origin=a.origin):(this.childInherit=!0,this.capture=!1,this.origin=null)};s.RegistrationOptions=na;na.NfdForwardingFlags_CHILD_INHERIT=1;na.NfdForwardingFlags_CAPTURE=2;na.prototype.getNfdForwardingFlags=function(){var a=0;this.childInherit&&(a|=na.NfdForwardingFlags_CHILD_INHERIT);this.capture&&(a|=na.NfdForwardingFlags_CAPTURE);return a};na.prototype.setNfdForwardingFlags=function(a){this.childInherit=0!=(a&na.NfdForwardingFlags_CHILD_INHERIT);this.capture=
0!=(a&na.NfdForwardingFlags_CAPTURE);return this};na.prototype.getChildInherit=function(){return this.childInherit};na.prototype.getCapture=function(){return this.capture};na.prototype.getOrigin=function(){return this.origin};na.prototype.setChildInherit=function(a){this.childInherit=a;return this};na.prototype.setCapture=function(a){this.capture=a;return this};na.prototype.setOrigin=function(a){this.origin=a;return this};var na=a.RegistrationOptions,ce=function(a){na.call(this,a)};ce.prototype=new na;
s.ForwardingFlags=ce;ce.NfdForwardingFlags_CHILD_INHERIT=na.NfdForwardingFlags_CHILD_INHERIT;ce.NfdForwardingFlags_CAPTURE=na.NfdForwardingFlags_CAPTURE;var na=a.RegistrationOptions,b=a.Name,r=a.WireFormat,p=a.Blob,Ba=function ye(a){"object"===typeof a&&a instanceof ye?(this.name=null==a.name?null:new b(a.name),this.faceId=a.faceId,this.uri=a.uri,this.localControlFeature=a.localControlFeature,this.origin=a.origin,this.cost=a.cost,this.flags=new na(a.flags),this.strategy=new b(a.strategy),this.expirationPeriod=
a.expirationPeriod):(this.faceId=this.name=null,this.uri="",this.cost=this.origin=this.localControlFeature=null,this.flags=new na,this.strategy=new b,this.expirationPeriod=null)};s.ControlParameters=Ba;Ba.prototype.clear=function(){this.faceId=this.name=null;this.uri="";this.cost=this.origin=this.localControlFeature=null;this.flags=new na;this.strategy=new b;this.expirationPeriod=null};Ba.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeControlParameters(this)};Ba.prototype.wireDecode=
function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlParameters(this,a.buf(),!1):b.decodeControlParameters(this,a,!0)};Ba.prototype.getName=function(){return this.name};Ba.prototype.getFaceId=function(){return this.faceId};Ba.prototype.getUri=function(){return this.uri};Ba.prototype.getLocalControlFeature=function(){return this.localControlFeature};Ba.prototype.getOrigin=function(){return this.origin};Ba.prototype.getCost=function(){return this.cost};Ba.prototype.getForwardingFlags=
function(){return this.flags};Ba.prototype.getStrategy=function(){return this.strategy};Ba.prototype.getExpirationPeriod=function(){return this.expirationPeriod};Ba.prototype.setName=function(a){this.name="object"===typeof a&&a instanceof b?new b(a):null};Ba.prototype.setFaceId=function(a){this.faceId=a};Ba.prototype.setUri=function(a){this.uri=a||""};Ba.prototype.setLocalControlFeature=function(a){this.localControlFeature=a};Ba.prototype.setOrigin=function(a){this.origin=a};Ba.prototype.setCost=
function(a){this.cost=a};Ba.prototype.setForwardingFlags=function(a){this.flags="object"===typeof a&&a instanceof na?new na(a):new na};Ba.prototype.setStrategy=function(a){this.strategy="object"===typeof a&&a instanceof b?new b(a):new b};Ba.prototype.setExpirationPeriod=function(a){this.expirationPeriod=a};var Ba=a.ControlParameters,r=a.WireFormat,p=a.Blob,Zb=function ze(a){"object"===typeof a&&a instanceof ze?(this.statusCode_=a.statusCode_,this.statusText_=a.statusText_,this.bodyAsControlParameters_=
null==a.bodyAsControlParameters_?null:new Ba(a.bodyAsControlParameters_)):(this.statusCode_=null,this.statusText_="",this.bodyAsControlParameters_=null)};s.ControlResponse=Zb;Zb.prototype.clear=function(){this.statusCode_=null;this.statusText_="";this.bodyAsControlParameters_=null};Zb.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeControlResponse(this)};Zb.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeControlResponse(this,
a.buf(),!1):b.decodeControlResponse(this,a,!0)};Zb.prototype.getStatusCode=function(){return this.statusCode_};Zb.prototype.getStatusText=function(){return this.statusText_};Zb.prototype.getBodyAsControlParameters=function(){return this.bodyAsControlParameters_};Zb.prototype.setStatusCode=function(a){this.statusCode_=a;return this};Zb.prototype.setStatusText=function(a){this.statusText_=a||"";return this};Zb.prototype.setBodyAsControlParameters=function(a){this.bodyAsControlParameters_="object"===
typeof a&&a instanceof Ba?new Ba(a):null;return this};b=a.Name;fb=a.NdnRegexTopMatcher;gc=function le(a,d){"object"===typeof a&&a instanceof le?(this.prefix=new b(a.prefix),this.regexFilter=a.regexFilter,this.regexFilterPattern=a.regexFilterPattern):(this.prefix=new b(a),d?(this.regexFilter=d,this.regexFilterPattern=le.makePattern(d)):this.regexFilterPattern=this.regexFilter=null)};s.InterestFilter=gc;gc.prototype.doesMatch=function(a){return a.size()<this.prefix.size()?!1:this.hasRegexFilter()?this.prefix.match(a)?
(new fb(this.regexFilterPattern)).match(a.getSubName(this.prefix.size())):!1:this.prefix.match(a)};gc.prototype.getPrefix=function(){return this.prefix};gc.prototype.hasRegexFilter=function(){return null!=this.regexFilter};gc.prototype.getRegexFilter=function(){return this.regexFilter};gc.makePattern=function(a){1<=a.length&&"^"==a[0]||(a="^"+a);1<=a.length&&"$"==a[-1]||(a+="$");return a};b=a.Name;p=a.Blob;r=a.WireFormat;Ua=function Ae(a){this.delegations_="object"===typeof a&&a instanceof Ae?a.delegations_.slice(0):
[];this.changeCount_=0};s.DelegationSet=Ua;Ua.Delegation=function(a,d){this.preference_=a;this.name_=new b(d)};Ua.Delegation.prototype.getPreference=function(){return this.preference_};Ua.Delegation.prototype.getName=function(){return this.name_};Ua.Delegation.prototype.compare=function(a){return this.preference_<a.preference_?-1:this.preference_>a.preference_?1:this.name_.compare(a.name_)};Ua.prototype.add=function(a,b){this.remove(b);for(var d=new Ua.Delegation(a,b),g=0;g<this.delegations_.length&&
!(0<=this.delegations_[g].compare(d));)++g;this.delegations_.splice(g,0,d);++this.changeCount_};Ua.prototype.addUnsorted=function(a,b){this.delegations_.push(new Ua.Delegation(a,b));++this.changeCount_};Ua.prototype.remove=function(a){for(var b=!1,d=this.delegations_.length-1;0<=d;--d)this.delegations_[d].getName().equals(a)&&(b=!0,this.delegations_.splice(d,1));b&&++this.changeCount_;return b};Ua.prototype.clear=function(){this.delegations_=[];++this.changeCount_};Ua.prototype.size=function(){return this.delegations_.length};
Ua.prototype.get=function(a){return this.delegations_[a]};Ua.prototype.find=function(a){for(var b=0;b<this.delegations_.length;++b)if(this.delegations_[b].getName().equals(a))return b;return-1};Ua.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeDelegationSet(this)};Ua.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeDelegationSet(this,a.buf(),!1):b.decodeDelegationSet(this,a,!0)};Ua.prototype.getChangeCount=
function(){return this.changeCount_};Ua=a.DelegationSet;pa=a.ContentType;r=a.WireFormat;O=a.Data;lc=function(a){this.delegations_=new Ua;if(a instanceof O){if(O.call(this,a),!this.getContent().isNull())try{this.delegations_.wireDecode(this.getContent()),this.getMetaInfo().setType(pa.LINK)}catch(b){this.delegations_.clear()}}else void 0!=a?O.call(this,a):O.call(this),this.getMetaInfo().setType(pa.LINK)};lc.prototype=new O;lc.prototype.name="Link";s.Link=lc;lc.prototype.wireDecode=function(a,b){b=b||
r.getDefaultWireFormat();O.prototype.wireDecode.call(this,a,b);if(this.getMetaInfo().getType()!=pa.LINK)throw Error("Link.wireDecode: MetaInfo ContentType is not LINK.");this.delegations_.wireDecode(this.getContent())};lc.prototype.addDelegation=function(a,b,d){d=d||r.getDefaultWireFormat();this.delegations_.add(a,b);this.encodeContent(d);return this};lc.prototype.removeDelegation=function(a,b){b=b||r.getDefaultWireFormat();var d=this.delegations_.remove(a);d&&this.encodeContent(b);return d};lc.prototype.getDelegations=
function(){return this.delegations_};lc.prototype.encodeContent=function(a){this.setContent(this.delegations_.wireEncode(a));this.getMetaInfo().setType(pa.LINK)};var $a=function wb(){this.reason_=wb.Reason.NONE;this.otherReasonCode_=-1};s.NetworkNack=$a;$a.Reason={NONE:0,CONGESTION:50,DUPLICATE:100,NO_ROUTE:150,OTHER_CODE:32767};$a.prototype.getReason=function(){return this.reason_};$a.prototype.getOtherReasonCode=function(){return this.otherReasonCode_};$a.prototype.setReason=function(a){this.reason_=
a;return this};$a.prototype.setOtherReasonCode=function(a){if(0>a)throw Error("NetworkNack other reason code must be non-negative");this.otherReasonCode_=a;return this};$a.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var d=a.getHeaderField(b);if(d instanceof $a)return d}return null};var da=a,p=a.Blob,b=a.Name,Wa=a.ComponentType,na=a.RegistrationOptions,m=a.Tlv,la=a.TlvEncoder,ja=a.TlvDecoder,r=a.WireFormat,Ta=a.Exclude,pa=a.ContentType,Da=a.KeyLocatorType,za=a.Sha256WithRsaSignature,
Xa=a.Sha256WithEcdsaSignature,Gb=a.GenericSignature,cb=a.HmacWithSha256Signature,vb=a.DigestSha256Signature,Ba=a.ControlParameters,$a=a.NetworkNack,ic=a.IncomingFaceId,Lc=a.CongestionMark,M=a.DecodingException,B=function(){r.call(this)};B.prototype=new r;B.prototype.name="Tlv0_2WireFormat";s.Tlv0_2WireFormat=B;B.instance=null;B.didCanBePrefixWarning_=!1;B.prototype.encodeName=function(a){var b=new la;B.encodeName(a,b);return new p(b.getOutput(),!1)};B.prototype.decodeName=function(a,b,d){null==d&&
(d=!0);b=new ja(b);B.decodeName(a,b,d)};B.prototype.encodeInterest=function(a){a.didSetCanBePrefix_||B.didCanBePrefixWarning_||(console.log("WARNING: The default CanBePrefix will change. See Interest.setDefaultCanBePrefix() for details."),B.didCanBePrefixWarning_=!0);if(a.hasApplicationParameters())return B.encodeInterestV03_(a,d,Pa);var b=new la(256),d=b.getLength();if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");Pa=b.getLength();B.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(m.ForwardingHint,b.getLength()-Pa)}b.writeOptionalNonNegativeIntegerTlv(m.SelectedDelegation,a.getSelectedDelegationIndex());Pa=a.getLinkWireEncoding(this);Pa.isNull()||b.writeBuffer(Pa.buf());b.writeOptionalNonNegativeIntegerTlv(m.InterestLifetime,a.getInterestLifetimeMilliseconds());if(a.getNonce().isNull()||0==
a.getNonce().size())b.writeBlobTlv(m.Nonce,da.randomBytes(4));else if(4>a.getNonce().size()){Pa=f(4);a.getNonce().buf().copy(Pa);for(var g=a.getNonce().size();4>g;++g)Pa[g]=da.randomBytes(1)[0];b.writeBlobTlv(m.Nonce,Pa)}else 4==a.getNonce().size()?b.writeBlobTlv(m.Nonce,a.getNonce().buf()):b.writeBlobTlv(m.Nonce,a.getNonce().buf().slice(0,4));B.encodeSelectors(a,b);Pa=B.encodeName(a.getName(),b);a=b.getLength()-Pa.signedPortionBeginOffset;Pa=b.getLength()-Pa.signedPortionEndOffset;b.writeTypeAndLength(m.Interest,
b.getLength()-d);var d=b.getLength()-a,Pa=b.getLength()-Pa;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:d,signedPortionEndOffset:Pa}};B.prototype.decodeInterest=function(a,b,d){try{return this.decodeInterestV02_(a,b,d)}catch(g){try{return B.decodeInterestV03_(a,b,d)}catch(f){throw g;}}};B.prototype.decodeInterestV02_=function(a,b,d){null==d&&(d=!0);b=new ja(b);var g=b.readNestedTlvsStart(m.Interest),f=B.decodeName(a.getName(),b,d);b.peekType(m.Selectors,g)?B.decodeSelectors(a,
b,d):(a.setMinSuffixComponents(null),a.setMaxSuffixComponents(null),a.getKeyLocator().clear(),a.getExclude().clear(),a.setChildSelector(null),a.setMustBeFresh(!1));var q=b.readBlobTlv(m.Nonce);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(m.InterestLifetime,g));if(b.peekType(m.ForwardingHint,g)){var r=b.readNestedTlvsStart(m.ForwardingHint);B.decodeDelegationSet_(a.getForwardingHint(),r,b,d);b.finishNestedTlvs(r)}if(b.peekType(m.Data,g)){var r=b.getOffset(),C=b.readNestedTlvsStart(m.Data);
b.seek(C);a.setLinkWireEncoding(new p(b.getSlice(r,C),d),this)}else a.unsetLink();a.setSelectedDelegationIndex(b.readOptionalNonNegativeIntegerTlv(m.SelectedDelegation,g));if(null!=a.getSelectedDelegationIndex()&&0<=a.getSelectedDelegationIndex()&&!a.hasLink())throw Error("Interest has a selected delegation, but no link object");a.setApplicationParameters(new p);a.setNonce(new p(q,d));b.finishNestedTlvs(g);return f};B.prototype.encodeData=function(a){var b=new la(1500),d=b.getLength();b.writeBlobTlv(m.SignatureValue,
a.getSignature().getSignature().buf());var g=b.getLength();B.encodeSignatureInfo_(a.getSignature(),b);b.writeBlobTlv(m.Content,a.getContent().buf());B.encodeMetaInfo(a.getMetaInfo(),b);B.encodeName(a.getName(),b);a=b.getLength();b.writeTypeAndLength(m.Data,b.getLength()-d);d=b.getLength()-a;g=b.getLength()-g;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:d,signedPortionEndOffset:g}};B.prototype.decodeData=function(a,b,d){null==d&&(d=!0);b=new ja(b);var g=b.readNestedTlvsStart(m.Data),
f=b.getOffset();B.decodeName(a.getName(),b,d);b.peekType(m.MetaInfo,g)?B.decodeMetaInfo(a.getMetaInfo(),b,d):a.getMetaInfo().clear();a.setContent(new p(b.readOptionalBlobTlv(m.Content,g),d));B.decodeSignatureInfo(a,b,d);var q=b.getOffset();a.getSignature().setSignature(new p(b.readBlobTlv(m.SignatureValue),d));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:q}};B.prototype.encodeControlParameters=function(a){var b=new la(256);B.encodeControlParameters(a,b);return new p(b.getOutput(),
!1)};B.prototype.decodeControlParameters=function(a,b,d){null==d&&(d=!0);b=new ja(b);B.decodeControlParameters(a,b,d)};B.prototype.encodeControlResponse=function(a){var b=new la(256),d=b.getLength();null!=a.getBodyAsControlParameters()&&B.encodeControlParameters(a.getBodyAsControlParameters(),b);b.writeBlobTlv(m.NfdCommand_StatusText,(new p(a.getStatusText())).buf());b.writeNonNegativeIntegerTlv(m.NfdCommand_StatusCode,a.getStatusCode());b.writeTypeAndLength(m.NfdCommand_ControlResponse,b.getLength()-
d);return new p(b.getOutput(),!1)};B.prototype.decodeControlResponse=function(a,b,d){null==d&&(d=!0);b=new ja(b);var g=b.readNestedTlvsStart(m.NfdCommand_ControlResponse);a.setStatusCode(b.readNonNegativeIntegerTlv(m.NfdCommand_StatusCode));var f=new p(b.readBlobTlv(m.NfdCommand_StatusText),!1);a.setStatusText(f.toString());b.peekType(m.ControlParameters_ControlParameters,g)?(a.setBodyAsControlParameters(new Ba),B.decodeControlParameters(a.getBodyAsControlParameters(),b,d)):a.setBodyAsControlParameters(null);
b.finishNestedTlvs(g)};B.prototype.encodeSignatureInfo=function(a){var b=new la(256);B.encodeSignatureInfo_(a,b);return new p(b.getOutput(),!1)};B.SignatureHolder=function(){};B.SignatureHolder.prototype.setSignature=function(a){this.signature=a};B.SignatureHolder.prototype.getSignature=function(){return this.signature};B.prototype.decodeSignatureInfoAndValue=function(a,b,d){null==d&&(d=!0);var g=new B.SignatureHolder;a=new ja(a);B.decodeSignatureInfo(g,a,d);a=new ja(b);g.getSignature().setSignature(new p(a.readBlobTlv(m.SignatureValue),
d));return g.getSignature()};B.prototype.encodeSignatureValue=function(a){var b=new la(256);b.writeBlobTlv(m.SignatureValue,a.getSignature().buf());return new p(b.getOutput(),!1)};B.prototype.decodeLpPacket=function(a,b,d){null==d&&(d=!0);a.clear();for(var g=new ja(b),f=g.readNestedTlvsStart(m.LpPacket_LpPacket);g.getOffset()<f;){var q=g.readVarNumber(),r=g.readVarNumber(),C=g.getOffset()+r;if(C>b.length)throw new M(Error("TLV length exceeds the buffer length"));if(q==m.LpPacket_Fragment){a.setFragmentWireEncoding(new p(g.getSlice(g.getOffset(),
C),d));g.seek(C);break}else if(q==m.LpPacket_Nack)r=new $a,q=g.readOptionalNonNegativeIntegerTlv(m.LpPacket_NackReason,C),0>q||q==$a.Reason.NONE?r.setReason($a.Reason.NONE):q==$a.Reason.CONGESTION||q==$a.Reason.DUPLICATE||q==$a.Reason.NO_ROUTE?r.setReason(q):(r.setReason($a.Reason.OTHER_CODE),r.setOtherReasonCode(q)),a.addHeaderField(r);else if(q==m.LpPacket_IncomingFaceId)q=new ic,q.setFaceId(g.readNonNegativeInteger(r)),a.addHeaderField(q);else if(q==m.LpPacket_CongestionMark)q=new Lc,q.setCongestionMark(g.readNonNegativeInteger(r)),
a.addHeaderField(q);else{if(!(q>=m.LpPacket_IGNORE_MIN&&q<=m.LpPacket_IGNORE_MAX&&0==(q&3)))throw new M(Error("Did not get the expected TLV type"));g.seek(C)}g.finishNestedTlvs(C)}g.finishNestedTlvs(f)};B.prototype.encodeDelegationSet=function(a){var b=new la(256);B.encodeDelegationSet_(a,b);return new p(b.getOutput(),!1)};B.prototype.decodeDelegationSet=function(a,b,d){null==d&&(d=!0);var g=new ja(b);B.decodeDelegationSet_(a,b.length,g,d)};B.prototype.encodeEncryptedContentV2=function(a){var b=new la(256),
d=b.getLength();b.writeOptionalNonNegativeIntegerTlv(m.Encrypt_EncryptionAlgorithm,a.getAlgorithmType());a.getKeyLocator().getType()==Da.KEYNAME&&B.encodeName(a.getKeyLocator().getKeyName(),b);b.writeOptionalBlobTlv(m.Encrypt_EncryptedPayloadKey,a.getPayloadKey().buf());b.writeOptionalBlobTlv(m.Encrypt_InitialVector,a.getInitialVector().buf());b.writeBlobTlv(m.Encrypt_EncryptedPayload,a.getPayload().buf());b.writeTypeAndLength(m.Encrypt_EncryptedContent,b.getLength()-d);return new p(b.getOutput(),
!1)};B.prototype.decodeEncryptedContentV2=function(a,b,d){null==d&&(d=!0);b=new ja(b);var g=b.readNestedTlvsStart(m.Encrypt_EncryptedContent);a.clear();a.setPayload(new p(b.readBlobTlv(m.Encrypt_EncryptedPayload),d));a.setInitialVector(new p(b.readOptionalBlobTlv(m.Encrypt_InitialVector,g),d));a.setPayloadKey(new p(b.readOptionalBlobTlv(m.Encrypt_EncryptedPayloadKey,g),d));b.peekType(m.Name,g)&&(B.decodeName(a.getKeyLocator().getKeyName(),b,d),a.getKeyLocator().setType(Da.KEYNAME));a.setAlgorithmType(b.readOptionalNonNegativeIntegerTlv(m.Encrypt_EncryptionAlgorithm,
g));b.finishNestedTlvs(g)};B.get=function(){null===B.instance&&(B.instance=new B);return B.instance};B.encodeNameComponent=function(a,b){var d;d=a.getType()===Wa.OTHER_CODE?a.getOtherTypeCode():a.getType();b.writeBlobTlv(d,a.getValue().buf())};B.decodeNameComponent=function(a,d){null==d&&(d=!0);var g=a.getOffset(),f=a.readVarNumber();a.seek(g);g=new p(a.readBlobTlv(f),d);return f===m.ImplicitSha256DigestComponent?b.Component.fromImplicitSha256Digest(g):f===m.ParametersSha256DigestComponent?b.Component.fromParametersSha256Digest(g):
f===m.NameComponent?new b.Component(g):new b.Component(g,Wa.OTHER_CODE,f)};B.encodeName=function(a,b){for(var d=b.getLength(),g,f=a.size()-1;0<=f;--f)B.encodeNameComponent(a.get(f),b),f==a.size()-1&&(g=b.getLength());f=b.getLength();b.writeTypeAndLength(m.Name,b.getLength()-d);d=b.getLength()-f;g=0==a.size()?d:b.getLength()-g;return{signedPortionBeginOffset:d,signedPortionEndOffset:g}};B.decodeName=function(a,b,d){a.clear();for(var g=b.readNestedTlvsStart(m.Name),f=b.getOffset(),q=f;b.getOffset()<
g;)q=b.getOffset(),a.append(B.decodeNameComponent(b,d));b.finishNestedTlvs(g);return{signedPortionBeginOffset:f,signedPortionEndOffset:q}};B.encodeSelectors=function(a,b){var d=b.getLength();a.getMustBeFresh()&&b.writeTypeAndLength(m.MustBeFresh,0);b.writeOptionalNonNegativeIntegerTlv(m.ChildSelector,a.getChildSelector());0<a.getExclude().size()&&B.encodeExclude(a.getExclude(),b);null!=a.getKeyLocator().getType()&&B.encodeKeyLocator(m.PublisherPublicKeyLocator,a.getKeyLocator(),b);b.writeOptionalNonNegativeIntegerTlv(m.MaxSuffixComponents,
a.getMaxSuffixComponents());b.writeOptionalNonNegativeIntegerTlv(m.MinSuffixComponents,a.getMinSuffixComponents());b.getLength()!=d&&b.writeTypeAndLength(m.Selectors,b.getLength()-d)};B.decodeSelectors=function(a,b,d){null==d&&(d=!0);var g=b.readNestedTlvsStart(m.Selectors);a.setMinSuffixComponents(b.readOptionalNonNegativeIntegerTlv(m.MinSuffixComponents,g));a.setMaxSuffixComponents(b.readOptionalNonNegativeIntegerTlv(m.MaxSuffixComponents,g));b.peekType(m.PublisherPublicKeyLocator,g)?B.decodeKeyLocator(m.PublisherPublicKeyLocator,
a.getKeyLocator(),b,d):a.getKeyLocator().clear();b.peekType(m.Exclude,g)?B.decodeExclude(a.getExclude(),b,d):a.getExclude().clear();a.setChildSelector(b.readOptionalNonNegativeIntegerTlv(m.ChildSelector,g));a.setMustBeFresh(b.readBooleanTlv(m.MustBeFresh,g));b.finishNestedTlvs(g)};B.encodeExclude=function(a,b){for(var d=b.getLength(),g=a.size()-1;0<=g;--g){var f=a.get(g);f==Ta.ANY?b.writeTypeAndLength(m.Any,0):B.encodeNameComponent(f,b)}b.writeTypeAndLength(m.Exclude,b.getLength()-d)};B.decodeExclude=
function(a,b,d){null==d&&(d=!0);var g=b.readNestedTlvsStart(m.Exclude);for(a.clear();b.getOffset()<g;)b.peekType(m.Any,g)?(b.readBooleanTlv(m.Any,g),a.appendAny()):a.appendComponent(B.decodeNameComponent(b,d));b.finishNestedTlvs(g)};B.encodeKeyLocator=function(a,b,d){var g=d.getLength();if(null!=b.getType())if(b.getType()==Da.KEYNAME)B.encodeName(b.getKeyName(),d);else if(b.getType()==Da.KEY_LOCATOR_DIGEST&&0<b.getKeyData().size())d.writeBlobTlv(m.KeyLocatorDigest,b.getKeyData().buf());else throw Error("Unrecognized KeyLocatorType "+
b.getType());d.writeTypeAndLength(a,d.getLength()-g)};B.decodeKeyLocator=function(a,b,d,g){null==g&&(g=!0);a=d.readNestedTlvsStart(a);b.clear();if(d.getOffset()!=a){if(d.peekType(m.Name,a))b.setType(Da.KEYNAME),B.decodeName(b.getKeyName(),d,g);else if(d.peekType(m.KeyLocatorDigest,a))b.setType(Da.KEY_LOCATOR_DIGEST),b.setKeyData(new p(d.readBlobTlv(m.KeyLocatorDigest),g));else throw new M(Error("decodeKeyLocator: Unrecognized key locator type"));d.finishNestedTlvs(a)}};B.encodeValidityPeriod_=function(a,
b){var d=b.getLength();b.writeBlobTlv(m.ValidityPeriod_NotAfter,(new p(r.toIsoString(a.getNotAfter()))).buf());b.writeBlobTlv(m.ValidityPeriod_NotBefore,(new p(r.toIsoString(a.getNotBefore()))).buf());b.writeTypeAndLength(m.ValidityPeriod_ValidityPeriod,b.getLength()-d)};B.decodeValidityPeriod_=function(a,b){var d=b.readNestedTlvsStart(m.ValidityPeriod_ValidityPeriod);a.clear();var g=new p(b.readBlobTlv(m.ValidityPeriod_NotBefore),!1),f=r.fromIsoString(g.toString()),g=new p(b.readBlobTlv(m.ValidityPeriod_NotAfter),
!1),g=r.fromIsoString(g.toString());a.setPeriod(f,g);b.finishNestedTlvs(d)};B.encodeSignatureInfo_=function(a,b){if(a instanceof Gb){var d=a.getSignatureInfoEncoding();try{var g=new ja(d.buf()),f=g.readNestedTlvsStart(m.SignatureInfo);g.readNonNegativeIntegerTlv(m.SignatureType);g.finishNestedTlvs(f,!0)}catch(q){throw Error("The GenericSignature encoding is not a valid NDN-TLV SignatureInfo: "+q.message);}b.writeBuffer(d.buf())}else{d=b.getLength();if(a instanceof za)a.getValidityPeriod().hasPeriod()&&
B.encodeValidityPeriod_(a.getValidityPeriod(),b),B.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureSha256WithRsa);else if(a instanceof Xa)a.getValidityPeriod().hasPeriod()&&B.encodeValidityPeriod_(a.getValidityPeriod(),b),B.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureSha256WithEcdsa);else if(a instanceof cb)B.encodeKeyLocator(m.KeyLocator,a.getKeyLocator(),
b),b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_SignatureHmacWithSha256);else if(a instanceof vb)b.writeNonNegativeIntegerTlv(m.SignatureType,m.SignatureType_DigestSha256);else throw Error("encodeSignatureInfo: Unrecognized Signature object type");b.writeTypeAndLength(m.SignatureInfo,b.getLength()-d)}};B.decodeSignatureInfo=function(a,b,d){null==d&&(d=!0);var g=b.getOffset(),f=b.readNestedTlvsStart(m.SignatureInfo),q=b.readNonNegativeIntegerTlv(m.SignatureType);q==m.SignatureType_SignatureSha256WithRsa?
(a.setSignature(new za),a=a.getSignature(),B.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,d),b.peekType(m.ValidityPeriod_ValidityPeriod,f)&&B.decodeValidityPeriod_(a.getValidityPeriod(),b)):q==m.SignatureType_SignatureSha256WithEcdsa?(a.setSignature(new Xa),a=a.getSignature(),B.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,d),b.peekType(m.ValidityPeriod_ValidityPeriod,f)&&B.decodeValidityPeriod_(a.getValidityPeriod(),b)):q==m.SignatureType_SignatureHmacWithSha256?(a.setSignature(new cb),
a=a.getSignature(),B.decodeKeyLocator(m.KeyLocator,a.getKeyLocator(),b,d)):q==m.SignatureType_DigestSha256?a.setSignature(new vb):(a.setSignature(new Gb),a=a.getSignature(),a.setSignatureInfoEncoding(new p(b.getSlice(g,f),d),q),b.finishNestedTlvs(f,!0));b.finishNestedTlvs(f)};B.encodeMetaInfo=function(a,b){var d=b.getLength(),g=a.getFinalBlockId().getValue().buf();null!=g&&0<g.length&&(g=b.getLength(),B.encodeNameComponent(a.getFinalBlockId(),b),b.writeTypeAndLength(m.FinalBlockId,b.getLength()-g));
b.writeOptionalNonNegativeIntegerTlv(m.FreshnessPeriod,a.getFreshnessPeriod());if(a.getType()!=pa.BLOB)if(a.getType()==pa.LINK||a.getType()==pa.KEY||a.getType()==pa.NACK)b.writeNonNegativeIntegerTlv(m.ContentType,a.getType());else if(a.getType()==pa.OTHER_CODE)b.writeNonNegativeIntegerTlv(m.ContentType,a.getOtherTypeCode());else throw Error("unrecognized TLV ContentType");b.writeTypeAndLength(m.MetaInfo,b.getLength()-d)};B.decodeMetaInfo=function(a,b,d){null==d&&(d=!0);var g=b.readNestedTlvsStart(m.MetaInfo),
f=b.readOptionalNonNegativeIntegerTlv(m.ContentType,g);null==f||0>f||f===pa.BLOB?a.setType(pa.BLOB):f===pa.LINK||f===pa.KEY||f===pa.NACK?a.setType(f):(a.setType(pa.OTHER_CODE),a.setOtherTypeCode(f));a.setFreshnessPeriod(b.readOptionalNonNegativeIntegerTlv(m.FreshnessPeriod,g));b.peekType(m.FinalBlockId,g)?(f=b.readNestedTlvsStart(m.FinalBlockId),a.setFinalBlockId(B.decodeNameComponent(b,d)),b.finishNestedTlvs(f)):a.setFinalBlockId(null);b.finishNestedTlvs(g)};B.encodeControlParameters=function(a,
b){var d=b.getLength();b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_ExpirationPeriod,a.getExpirationPeriod());if(0<a.getStrategy().size()){var g=b.getLength();B.encodeName(a.getStrategy(),b);b.writeTypeAndLength(m.ControlParameters_Strategy,b.getLength()-g)}g=a.getForwardingFlags().getNfdForwardingFlags();g!=(new na).getNfdForwardingFlags()&&b.writeNonNegativeIntegerTlv(m.ControlParameters_Flags,g);b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_Cost,a.getCost());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_Origin,
a.getOrigin());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_LocalControlFeature,a.getLocalControlFeature());0!=a.getUri().length&&b.writeBlobTlv(m.ControlParameters_Uri,(new p(a.getUri())).buf());b.writeOptionalNonNegativeIntegerTlv(m.ControlParameters_FaceId,a.getFaceId());null!=a.getName()&&B.encodeName(a.getName(),b);b.writeTypeAndLength(m.ControlParameters_ControlParameters,b.getLength()-d)};B.decodeControlParameters=function(a,d,g){null==g&&(g=!0);a.clear();var f=d.readNestedTlvsStart(m.ControlParameters_ControlParameters);
if(d.peekType(m.Name,f)){var q=new b;B.decodeName(q,d,g);a.setName(q)}a.setFaceId(d.readOptionalNonNegativeIntegerTlv(m.ControlParameters_FaceId,f));d.peekType(m.ControlParameters_Uri,f)&&(q=new p(d.readOptionalBlobTlv(m.ControlParameters_Uri,f),!1),a.setUri(q.toString()));d.skipOptionalTlv(m.ControlParameters_LocalUri,f);a.setLocalControlFeature(d.readOptionalNonNegativeIntegerTlv(m.ControlParameters_LocalControlFeature,f));a.setOrigin(d.readOptionalNonNegativeIntegerTlv(m.ControlParameters_Origin,
f));a.setCost(d.readOptionalNonNegativeIntegerTlv(m.ControlParameters_Cost,f));d.skipOptionalTlv(m.ControlParameters_Capacity,f);d.skipOptionalTlv(m.ControlParameters_Count,f);d.skipOptionalTlv(m.ControlParameters_BaseCongestionMarkingInterval,f);d.skipOptionalTlv(m.ControlParameters_DefaultCongestionThreshold,f);d.skipOptionalTlv(m.ControlParameters_Mtu,f);d.peekType(m.ControlParameters_Flags,f)&&(q=new na,q.setNfdForwardingFlags(d.readNonNegativeIntegerTlv(m.ControlParameters_Flags,f)),a.setForwardingFlags(q));
d.skipOptionalTlv(m.ControlParameters_Mask,f);d.peekType(m.ControlParameters_Strategy,f)&&(q=d.readNestedTlvsStart(m.ControlParameters_Strategy),B.decodeName(a.getStrategy(),d,g),d.finishNestedTlvs(q));a.setExpirationPeriod(d.readOptionalNonNegativeIntegerTlv(m.ControlParameters_ExpirationPeriod,f));d.finishNestedTlvs(f)};B.encodeDelegationSet_=function(a,b){for(var d=a.size()-1;0<=d;--d){var g=b.getLength();B.encodeName(a.get(d).getName(),b);b.writeNonNegativeIntegerTlv(m.Link_Preference,a.get(d).getPreference());
b.writeTypeAndLength(m.Link_Delegation,b.getLength()-g)}};B.decodeDelegationSet_=function(a,d,g,f){for(a.clear();g.getOffset()<d;){g.readTypeAndLength(m.Link_Delegation);var q=g.readNonNegativeIntegerTlv(m.Link_Preference),r=new b;B.decodeName(r,g,f);a.addUnsorted(q,r)}};B.encodeInterestV03_=function(a){var b=new la(256),d=b.getLength();b.writeOptionalBlobTlv(m.ApplicationParameters,a.getApplicationParameters().buf());b.writeOptionalNonNegativeIntegerTlv(m.InterestLifetime,a.getInterestLifetimeMilliseconds());
if(a.getNonce().isNull()||0==a.getNonce().size())b.writeBlobTlv(m.Nonce,da.randomBytes(4));else if(4>a.getNonce().size()){var g=f(4);a.getNonce().buf().copy(g);for(var q=a.getNonce().size();4>q;++q)g[q]=da.randomBytes(1)[0];b.writeBlobTlv(m.Nonce,g)}else 4==a.getNonce().size()?b.writeBlobTlv(m.Nonce,a.getNonce().buf()):b.writeBlobTlv(m.Nonce,a.getNonce().buf().slice(0,4));if(0<a.getForwardingHint().size()){if(null!=a.getSelectedDelegationIndex())throw Error("An Interest may not have a selected delegation when encoding a forwarding hint");
if(a.hasLink())throw Error("An Interest may not have a link object when encoding a forwarding hint");g=b.getLength();B.encodeDelegationSet_(a.getForwardingHint(),b);b.writeTypeAndLength(m.ForwardingHint,b.getLength()-g)}a.getMustBeFresh()&&b.writeTypeAndLength(m.MustBeFresh,0);a.getCanBePrefix()&&b.writeTypeAndLength(m.CanBePrefix,0);g=B.encodeName(a.getName(),b);a=b.getLength()-g.signedPortionBeginOffset;g=b.getLength()-g.signedPortionEndOffset;b.writeTypeAndLength(m.Interest,b.getLength()-d);d=
b.getLength()-a;a=b.getLength()-g;return{encoding:new p(b.getOutput(),!1),signedPortionBeginOffset:d,signedPortionEndOffset:a}};B.decodeInterestV03_=function(a,b,d){null==d&&(d=!0);b=new ja(b);var g=b.readNestedTlvsStart(m.Interest),f=B.decodeName(a.getName(),b,d);a.setCanBePrefix(b.readBooleanTlv(m.CanBePrefix,g));a.setMustBeFresh(b.readBooleanTlv(m.MustBeFresh,g));if(b.peekType(m.ForwardingHint,g)){var q=b.readNestedTlvsStart(m.ForwardingHint);B.decodeDelegationSet_(a.getForwardingHint(),q,b,d);
b.finishNestedTlvs(q)}else a.getForwardingHint().clear();q=b.readOptionalBlobTlv(m.Nonce,g);a.setInterestLifetimeMilliseconds(b.readOptionalNonNegativeIntegerTlv(m.InterestLifetime,g));a.setMinSuffixComponents(null);a.getKeyLocator().clear();a.getExclude().clear();a.setChildSelector(null);a.unsetLink();a.setSelectedDelegationIndex(null);b.readOptionalBlobTlv(m.HopLimit,g);a.setApplicationParameters(new p(b.readOptionalBlobTlv(m.ApplicationParameters,g),d));a.setNonce(null==q?new p:new p(q,d));b.finishNestedTlvs(g);
return f};var B=a.Tlv0_2WireFormat,$b=function(){B.call(this)};$b.prototype=new B;$b.prototype.name="Tlv0_1_1WireFormat";s.Tlv0_1_1WireFormat=$b;$b.instance=null;$b.get=function(){null===$b.instance&&($b.instance=new $b);return $b.instance};var r=a.WireFormat,$b=a.Tlv0_1_1WireFormat,Rc=function(){$b.call(this)};Rc.prototype=new $b;Rc.prototype.name="Tlv0_1WireFormat";s.Tlv0_1WireFormat=Rc;Rc.instance=null;Rc.get=function(){null===Rc.instance&&(Rc.instance=new Rc);return Rc.instance};r=a.WireFormat;
B=a.Tlv0_2WireFormat;ab=function(){B.call(this)};ab.prototype=new B;ab.prototype.name="TlvWireFormat";s.TlvWireFormat=ab;ab.instance=null;ab.get=function(){null===ab.instance&&(ab.instance=new ab);return ab.instance};r.setDefaultWireFormat(ab.get());var H=a.DataUtils,Da=a.KeyLocatorType,z=a.Interest,O=a.Data,za=a.Sha256WithRsaSignature,Xa=a.Sha256WithEcdsaSignature,cb=a.HmacWithSha256Signature,vb=a.DigestSha256Signature,pa=a.ContentType,r=a.WireFormat,nd=function(){};s.EncodingUtils=nd;nd.encodeToHexInterest=
function(a,b){b=b||r.getDefaultWireFormat();return H.toHex(a.wireEncode(b).buf())};nd.encodeToHexData=function(a,b){b=b||r.getDefaultWireFormat();return H.toHex(a.wireEncode(b).buf())};nd.decodeHexInterest=function(a,b){b=b||r.getDefaultWireFormat();var d=new z;d.wireDecode(H.toNumbers(a),b);return d};nd.decodeHexData=function(a,b){b=b||r.getDefaultWireFormat();var d=new O;d.wireDecode(H.toNumbers(a),b);return d};nd.decodeSubjectPublicKeyInfo=function(a){a=H.toHex(a).toLowerCase();a=_x509_getPublicKeyHexArrayFromCertHex(a,
_x509_getSubjectPublicKeyPosFromCertHex(a,0));var b=new v;b.setPublic(a[0],a[1]);return b};nd.dataToHtml=function(a){function b(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");d+=a;d+="<br/>"}if(-1==a)return"NO CONTENT FOUND";if(-2==a)return"CONTENT NAME IS EMPTY";var d="";b("name: "+a.getName().toUri());0<a.getContent().size()?(b("content (raw): "+a.getContent().buf().toString("binary")),b("content (hex): "+a.getContent().toHex())):b("content: <empty>");a.getMetaInfo().getType()!=pa.BLOB&&
(a.getMetaInfo().getType()==pa.KEY?b("metaInfo.type: KEY"):a.getMetaInfo().getType()==pa.LINK?b("metaInfo.type: LINK"):a.getMetaInfo().getType()==pa.NACK?b("metaInfo.type: NACK"):a.getMetaInfo().getType()==pa.OTHER_CODE&&b("metaInfo.type: other code "+a.getMetaInfo().getOtherTypeCode()));b("metaInfo.freshnessPeriod (milliseconds): "+(0<=a.getMetaInfo().getFreshnessPeriod()?""+a.getMetaInfo().getFreshnessPeriod():"<none>"));b("metaInfo.finalBlockId: "+(0<a.getMetaInfo().getFinalBlockId().getValue().size()?
a.getMetaInfo().getFinalBlockId().getValue().toHex():"<none>"));var g=null,f=a.getSignature();f instanceof za?(f=a.getSignature(),b("Sha256WithRsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof Xa?(f=a.getSignature(),b("Sha256WithEcdsa signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof cb?(f=a.getSignature(),b("HmacWithSha256 signature.signature: "+(0<f.getSignature().size()?
f.getSignature().toHex():"<none>")),g=f.getKeyLocator()):f instanceof vb&&(f=a.getSignature(),b("DigestSha256 signature.signature: "+(0<f.getSignature().size()?f.getSignature().toHex():"<none>")));null!==g&&(null==g.getType()?b("signature.keyLocator: <none>"):g.getType()==Da.KEY_LOCATOR_DIGEST?b("signature.keyLocator: KeyLocatorDigest: "+g.getKeyData().toHex()):g.getType()==Da.KEYNAME?b("signature.keyLocator: KeyName: "+g.getKeyName().toUri()):b("signature.keyLocator: <unrecognized ndn_KeyLocatorType>"));
return d};var b=a.Name,O=a.Data,yd=function(){this.cache_=[]};s.InMemoryStorageRetaining=yd;yd.prototype.insert=function(a){this.cache_[a.getFullName().toUri()]=new O(a)};yd.prototype.find=function(a){for(var d in this.cache_)if(a.getName().isPrefixOf(new b(d)))return this.cache_[d]};yd.prototype.size=function(){return Object.keys(this.cache_).length};var da=a,p=a.Blob,Ea=a.EncryptAlgorithmType,Mb=a.UseSubtleCrypto,g=a.SyncPromise,mc=function(){};s.AesAlgorithm=mc;mc.decryptPromise=function(a,b,d,
m){if(Mb()&&!m&&d.getAlgorithmType()!=Ea.AesEcb)return d.getAlgorithmType()==Ea.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.decrypt({name:"AES-CBC",iv:d.getInitialVector().buf()},a,b.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode"));if(d.getAlgorithmType()==Ea.AesCbc)try{var q=da.createDecipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",
a.buf(),d.getInitialVector().buf());return g.resolve(new p(f.concat([q.update(b.buf()),q.final()]),!1))}catch(r){return g.reject(r)}else return g.reject(Error("unsupported encryption mode"))};mc.decrypt=function(a,b,d){return g.getValue(this.decryptPromise(a,b,d,!0))};mc.encryptPromise=function(a,b,d,m){return d.getAlgorithmType()==Ea.AesCbc&&d.getInitialVector().size()!=mc.BLOCK_SIZE?g.reject(Error("incorrect initial vector size")):Mb()&&!m&&d.getAlgorithmType()!=Ea.AesEcb?d.getAlgorithmType()==
Ea.AesCbc?crypto.subtle.importKey("raw",a.buf(),{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(a){return crypto.subtle.encrypt({name:"AES-CBC",iv:d.getInitialVector().buf()},a,b.buf())}).then(function(a){return Promise.resolve(new p(new Uint8Array(a),!1))}):Promise.reject(Error("unsupported encryption mode")):d.getAlgorithmType()==Ea.AesCbc?(a=da.createCipheriv(32==a.size()?"aes-256-cbc":"aes-128-cbc",a.buf(),d.getInitialVector().buf()),g.resolve(new p(f.concat([a.update(b.buf()),a.final()]),
!1))):g.reject(Error("unsupported encryption mode"))};mc.encrypt=function(a,b,d){return g.getValue(this.encryptPromise(a,b,d,!0))};mc.BLOCK_SIZE=16;da=a;p=a.Blob;Ea=function(){};s.EncryptAlgorithmType=Ea;Ea.AesEcb=0;Ea.AesCbc=1;Ea.RsaPkcs=2;Ea.RsaOaep=3;var Sc=function(a,b){this.algorithmType_=a;if(null!=b&&0<b){var d=da.randomBytes(b);this.initialVector_=new p(d,!1)}else this.initialVector_=new p};s.EncryptParams=Sc;Sc.prototype.getAlgorithmType=function(){return this.algorithmType_};Sc.prototype.getInitialVector=
function(){return this.initialVector_};Sc.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};Sc.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};var b=a.Name,z=a.Interest,O=a.Data,$=a.EncryptError,y=a.KeyChain,xc=a.SafeBag,ba=a.EncryptorV2,$=a.EncryptError,Ha=a.EncryptedContent,Sc=a.EncryptParams,Ea=a.EncryptAlgorithmType,mc=a.AesAlgorithm,U=a.NdnCommon,ea=a.Pib,g=a.SyncPromise,Da=a.KeyLocatorType,d=a.Log.LOG,
kb=function(a,b,d,g){this.contentKeys_={};this.credentialsKey_=a;this.validator_=b;this.face_=g;this.keyChain_=d;this.internalKeyChain_=new y("pib-memory:","tpm-memory:")};s.DecryptorV2=kb;kb.prototype.shutdown=function(){for(var a in this.contentKeys_){var b=this.contentKeys_[a];if(0<b.pendingInterest){this.face_.removePendingInterest(b.pendingInterest);b.pendingInterest=0;for(var d in b.pendingDecrypts)b.pendingDecrypts[d].onError($.ErrorCode.CkRetrievalFailure,"Canceling pending decrypt as ContentKey is being destroyed");
b.pendingDecrypts=[]}}};kb.prototype.decrypt=function(a,b,g){if(a instanceof O){var f=new Ha;try{f.wireDecodeV2(a.getContent())}catch(m){g($.ErrorCode.DecryptionFailure,"Error decoding the Data content as EncryptedContent: "+m);return}this.decrypt(f,b,g)}else if(a instanceof z){f=new Ha;try{f.wireDecodeV2(a.getApplicationParameters())}catch(q){g($.ErrorCode.DecryptionFailure,"Error decoding the Interest ApplicationParameters as EncryptedContent: "+q);return}this.decrypt(f,b,g)}else if(f=a,f.getKeyLocator().getType()!=
Da.KEYNAME)3<d&&console.log("Missing required KeyLocator in the supplied EncryptedContent block"),g($.ErrorCode.MissingRequiredKeyLocator,"Missing required KeyLocator in the supplied EncryptedContent block");else if(f.hasInitialVector()){a=f.getKeyLocatorName();var r=a.toUri(),p=this.contentKeys_[r],C=void 0===p;C&&(p=new kb.ContentKey,this.contentKeys_[r]=p);p.isRetrieved?kb.doDecrypt_(f,p.bits,b,g):(3<d&&console.log("CK "+a.toUri()+" not yet available, so adding to the pending decrypt queue"),p.pendingDecrypts.push(new kb.ContentKey.PendingDecrypt(f,
b,g)));C&&(2<=a.size()&&a.get(-2).equals(ba.NAME_COMPONENT_GCK)?this.fetchGck_(a,p,g,ba.N_RETRIES):this.fetchCk_(a,p,g,ba.N_RETRIES))}else 3<d&&console.log("Missing required initial vector in the supplied EncryptedContent block"),g($.ErrorCode.MissingRequiredInitialVector,"Missing required initial vector in the supplied EncryptedContent block")};kb.ContentKey=function(){this.isRetrieved=!1;this.bits=null;this.pendingInterest=0;this.pendingDecrypts=[]};kb.ContentKey.PendingDecrypt=function(a,b,d){this.encryptedContent=
a;this.onSuccess=b;this.onError=d};kb.prototype.fetchCk_=function(a,b,g,f){3<d&&console.log("Fetching CK "+a.toUri());var m=this,q=function(a,f){b.pendingInterest=0;m.validator_.validate(f,function(q){try{q=[null];var r=[null],p=[null];if(kb.extractKdkInfoFromCkName_(f.getName(),a.getName(),g,q,r,p)){var yb=null;try{yb=m.internalKeyChain_.getPib().getIdentity(r[0])}catch(C){if(!(C instanceof ea.Error))throw C;}if(null!=yb){r=null;try{r=yb.getKey(p[0])}catch(Kd){if(!(Kd instanceof ea.Error))throw Kd;
}if(null!=r){3<d&&console.log("KDK "+p.toUri()+" already exists, so directly using it to decrypt the CK");m.decryptCkAndProcessPendingDecrypts_(b,f,p[0],g);return}}m.fetchKdk_(b,q[0],f,g,ba.N_RETRIES)}}catch(s){g($.ErrorCode.General,"Error in fetchCk onData: "+s)}},function(a,b){g($.ErrorCode.CkRetrievalFailure,"Validate CK Data failure: "+b.toString())})},r=function(d){b.pendingInterest=0;1<f?m.fetchCk_(a,b,g,f-1):g($.ErrorCode.CkRetrievalTimeout,"Retrieval of CK ["+d.getName().toUri()+"] timed out")},
p=function(a,d){b.pendingInterest=0;g($.ErrorCode.CkRetrievalFailure,"Retrieval of CK ["+a.getName().toUri()+"] failed. Got NACK ("+d.getReason()+")")};try{b.pendingInterest=this.face_.expressInterest((new z(a)).setMustBeFresh(!1).setCanBePrefix(!0),q,r,p)}catch(C){g($.ErrorCode.General,"expressInterest error: "+C)}};kb.prototype.fetchKdk_=function(a,g,f,m,q){var r=new b(g);r.append(ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());3<d&&console.log("Fetching KDK "+r.toUri());
var p=this,C=function(b,d){a.pendingInterest=0;p.validator_.validate(d,function(b){p.decryptAndImportKdk_(d,function(){var b=g.getPrefix(-2).append("KEY").append(g.get(-1));p.decryptCkAndProcessPendingDecrypts_(a,f,b,m)},m)},function(a,b){m($.ErrorCode.CkRetrievalFailure,"Validate KDK Data failure: "+b.toString())})},s=function(b){a.pendingInterest=0;1<q?p.fetchKdk_(a,g,f,m,q-1):m($.ErrorCode.KdkRetrievalTimeout,"Retrieval of KDK ["+b.getName().toUri()+"] timed out")},A=function(b,d){a.pendingInterest=
0;m($.ErrorCode.KdkRetrievalFailure,"Retrieval of KDK ["+b.getName().toUri()+"] failed. Got NACK ("+d.getReason()+")")};try{a.pendingInterest=this.face_.expressInterest((new z(r)).setMustBeFresh(!0).setCanBePrefix(!1),C,s,A)}catch(u){m($.ErrorCode.General,"expressInterest error: "+u)}};kb.prototype.decryptAndImportKdk_=function(a,b,f){3<d&&console.log("Decrypting and importing KDK "+a.getName().toUri());var m=new Ha;m.wireDecodeV2(a.getContent());var q=new xc(m.getPayload()),r=this;this.keyChain_.getTpm().decryptPromise(m.getPayloadKey().buf(),
this.credentialsKey_.getName()).then(function(a){if(a.isNull())return f($.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+this.credentialsKey_.getName().toUri()+" not found in TPM"),g.resolve();r.internalKeyChain_.importSafeBag(q,a.buf());b();return g.resolve()}).catch(function(b){f($.ErrorCode.DecryptionFailure,"Failed to decrypt KDK ["+a.getName().toUri()+"]: "+b)})};kb.prototype.fetchGck_=function(a,g,f,m){var q=new b(a);q.append(ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());
3<d&&console.log("DecryptorV2: Fetching GCK "+q.toUri());var r=this,p=function(a,d){try{g.pendingInterest=0,r.validator_.validate(d,function(a){r.decryptCkAndProcessPendingDecrypts_(g,d,new b,f)},function(a,b){f($.ErrorCode.CkRetrievalFailure,"Validate GCK Data failure: "+b.toString())})}catch(m){f($.ErrorCode.General,"Error in fetchGck onData: "+m)}},C=function(b){g.pendingInterest=0;1<m?r.fetchGck_(a,g,f,m-1):f($.ErrorCode.CkRetrievalTimeout,"Retrieval of GCK ["+b.getName().toUri()+"] timed out")},
s=function(a,b){g.pendingInterest=0;f($.ErrorCode.CkRetrievalFailure,"Retrieval of GCK ["+a.getName().toUri()+"] failed. Got NACK ("+b.getReason()+")")};try{g.pendingInterest=this.face_.expressInterest((new z(q)).setMustBeFresh(!1).setCanBePrefix(!0),p,C,s)}catch(A){f($.ErrorCode.General,"expressInterest error: "+A)}};kb.prototype.decryptCkAndProcessPendingDecrypts_=function(a,b,f,m){function q(b){a.bits=b;a.isRetrieved=!0;for(var d in a.pendingDecrypts)b=a.pendingDecrypts[d],kb.doDecrypt_(b.encryptedContent,
a.bits,b.onSuccess,b.onError);a.pendingDecrypts=[]}3<d&&console.log("Decrypting CK data "+b.getName().toUri());var r=new Ha;try{r.wireDecodeV2(b.getContent())}catch(p){m($.ErrorCode.InvalidEncryptedFormat,"Error decrypting EncryptedContent: "+p);return}if(0==f.size()){var C=this;this.keyChain_.getTpm().decryptPromise(r.getPayload().buf(),this.credentialsKey_.getName()).then(function(a){if(a.isNull())return m($.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+C.credentialsKey_.getName().toUri()+
" not found in TPM"),g.resolve();q(a);return g.resolve()}).catch(function(a){m($.ErrorCode.DecryptionFailure,"Error decrypting the GCK "+a)})}else this.internalKeyChain_.getTpm().decryptPromise(r.getPayload().buf(),f).then(function(a){if(a.isNull())return m($.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+f.toUri()+" not found in TPM"),g.resolve();q(a);return g.resolve()}).catch(function(a){m($.ErrorCode.DecryptionFailure,"Error decrypting the CK EncryptedContent "+a)})};kb.doDecrypt_=function(a,
b,d,g){if(a.hasInitialVector()){var f;try{var m=new Sc(Ea.AesCbc);m.setInitialVector(a.getInitialVector());f=mc.decrypt(b,a.getPayload(),m)}catch(q){g($.ErrorCode.DecryptionFailure,"Decryption error in doDecrypt: "+q);return}try{d(f)}catch(r){console.log("Error in onSuccess: "+U.getErrorWithStackTrace(r))}}else g($.ErrorCode.MissingRequiredInitialVector,"Expecting Initial Vector in the encrypted content, but it is not present")};kb.convertKekNameToKdkPrefix_=function(a,b){return 2>a.size()||!a.get(-2).equals(ba.NAME_COMPONENT_KEK)?
(b($.ErrorCode.KekInvalidName,"Invalid KEK name ["+a.toUri()+"]"),null):a.getPrefix(-2).append(ba.NAME_COMPONENT_KDK).append(a.get(-1))};kb.extractKdkInfoFromCkName_=function(a,b,d,g,f,m){if(a.size()<b.size()+1||!a.getPrefix(b.size()).equals(b)||!a.get(b.size()).equals(ba.NAME_COMPONENT_ENCRYPTED_BY))return d($.ErrorCode.CkInvalidName,"Invalid CK name ["+a.toUri()+"]"),!1;a=a.getSubName(b.size()+1);g[0]=kb.convertKekNameToKdkPrefix_(a,d);if(null==g[0])return!1;f[0]=a.getPrefix(-2);m[0]=a.getPrefix(-2).append("KEY").append(a.get(-1));
return!0};$=function(){};s.EncryptError=$;$.ErrorCode={KekRetrievalFailure:1,KekRetrievalTimeout:2,KekInvalidName:3,KdkRetrievalFailure:11,KdkRetrievalTimeout:12,KdkInvalidName:13,KdkDecryptionFailure:14,CkRetrievalFailure:21,CkRetrievalTimeout:22,CkInvalidName:23,MissingRequiredKeyLocator:101,TpmKeyNotFound:102,EncryptionFailure:103,DecryptionFailure:104,MissingRequiredInitialVector:110,General:200,Timeout:1001,Validation:1002,UnsupportedEncryptionScheme:1032,InvalidEncryptedFormat:1033,NoDecryptKey:1034,
DataRetrievalFailure:1036};Y=a.KeyLocator;Da=a.KeyLocatorType;r=a.WireFormat;p=a.Blob;Ha=function bb(a){"object"===typeof a&&a instanceof bb?(this.algorithmType_=a.algorithmType_,this.keyLocator_=new Y(a.keyLocator_),this.initialVector_=a.initialVector_,this.payload_=a.payload_,this.payloadKey_=a.payloadKey_):this.clear()};s.EncryptedContent=Ha;Ha.prototype.getAlgorithmType=function(){return this.algorithmType_};Ha.prototype.getKeyLocator=function(){return this.keyLocator_};Ha.prototype.getKeyLocatorName=
function(){if(this.keyLocator_.getType()!=Da.KEYNAME)throw Error("getKeyLocatorName: The KeyLocator type must be KEYNAME");return this.keyLocator_.getKeyName()};Ha.prototype.hasInitialVector=function(){return!this.initialVector_.isNull()};Ha.prototype.getInitialVector=function(){return this.initialVector_};Ha.prototype.getPayload=function(){return this.payload_};Ha.prototype.getPayloadKey=function(){return this.payloadKey_};Ha.prototype.setAlgorithmType=function(a){this.algorithmType_=a;return this};
Ha.prototype.setKeyLocator=function(a){this.keyLocator_="object"===typeof a&&a instanceof Y?new Y(a):new Y;return this};Ha.prototype.setKeyLocatorName=function(a){this.keyLocator_.setType(Da.KEYNAME);this.keyLocator_.setKeyName(a);return this};Ha.prototype.setInitialVector=function(a){this.initialVector_="object"===typeof a&&a instanceof p?a:new p(a);return this};Ha.prototype.setPayload=function(a){this.payload_="object"===typeof a&&a instanceof p?a:new p(a);return this};Ha.prototype.setPayloadKey=
function(a){this.payloadKey_="object"===typeof a&&a instanceof p?a:new p(a);return this};Ha.prototype.clear=function(){this.algorithmType_=null;this.keyLocator_=new Y;this.initialVector_=new p;this.payload_=new p;this.payloadKey_=new p};Ha.prototype.wireEncode=function(a){a=a||r.getDefaultWireFormat();return a.encodeEncryptedContent(this)};Ha.prototype.wireEncodeV2=function(a){a=a||r.getDefaultWireFormat();return a.encodeEncryptedContentV2(this)};Ha.prototype.wireDecode=function(a,b){b=b||r.getDefaultWireFormat();
"object"===typeof a&&a instanceof p?b.decodeEncryptedContent(this,a.buf(),!1):b.decodeEncryptedContent(this,a,!0)};Ha.prototype.wireDecodeV2=function(a,b){b=b||r.getDefaultWireFormat();"object"===typeof a&&a instanceof p?b.decodeEncryptedContentV2(this,a.buf(),!1):b.decodeEncryptedContentV2(this,a,!0)};da=a;p=a.Blob;b=a.Name;O=a.Data;z=a.Interest;S=a.SigningInfo;yd=a.InMemoryStorageRetaining;Ya=a.PublicKey;Ha=a.EncryptedContent;Sc=a.EncryptParams;Ea=a.EncryptAlgorithmType;mc=a.AesAlgorithm;U=a.NdnCommon;
$=a.EncryptError;r=a.WireFormat;g=a.SyncPromise;d=a.Log.LOG;ba=function wd(a,d,g,m,q,r,p){var C=null;if("function"===typeof d){p=m;var s=q,A=r;m=d;C=g;q=p;r=s;p=A}this.accessPrefix_=new b(a);this.ckName_=new b;this.ckBits_=f.alloc(wd.AES_KEY_SIZE);this.onError_=m;this.ckPrefix_=new b(d);this.isKekRetrievalInProgress_=!1;this.kekData_=null;this.ckDataSigningInfo_=new S(g);this.storage_=new yd;this.kekPendingInterestId_=this.ckRegisteredPrefixId_=0;this.checkForNewGckIntervalMilliseconds_=6E4;this.nextCheckForNewGck_=
0;this.gckLatestPrefix_=new b;this.isGckRetrievalInProgress_=!1;this.gckPendingInterestId_=0;this.pendingEncrypts_=[];this.credentialsKey_=C;this.validator_=q;this.keyChain_=r;this.face_=p;null!=C?this.gckLatestPrefix_=(new b(this.accessPrefix_)).append(wd.NAME_COMPONENT_GCK).append(wd.NAME_COMPONENT_LATEST):this.initializeCk_()};ba.prototype.initializeCk_=function(){this.regenerateCk();var a=this;this.ckRegisteredPrefixId_=this.face_.registerPrefix((new b(this.ckPrefix_)).append(ba.NAME_COMPONENT_CK),
function(b,g,f,m,q){b=a.storage_.find(g);if(null!=b){3<d&&console.log("Serving "+b.getName().toUri()+" from InMemoryStorage");try{f.putData(b)}catch(r){console.log("Error in Face.putData: "+U.getErrorWithStackTrace(r))}}else 3<d&&console.log("Didn't find CK data for "+g.getName().toUri())},function(a){0<d&&console.log("Failed to register prefix "+a.toUri())})};s.EncryptorV2=ba;ba.prototype.shutdown=function(){this.face_.unsetInterestFilter(this.ckRegisteredPrefixId_);0<this.kekPendingInterestId_&&
this.face_.removePendingInterest(this.kekPendingInterestId_);0<this.gckPendingInterestId_&&this.face_.removePendingInterest(this.gckPendingInterestId_)};ba.prototype.encrypt=function(a,b,d){if("function"===typeof b)if(a instanceof O){var g=a;this.encrypt(g.getContent(),function(a){g.setContent(a.wireEncodeV2());b(g,a)},d)}else if(a instanceof z){var f=a;-1!=f.getName().findParametersSha256Digest()?d($.ErrorCode.EncryptionFailure,"The Interest name already has a ParametersSha256Digest component: "+
f.getName().toUri()):this.encrypt(f.getApplicationParameters(),function(a){f.setApplicationParameters(a.wireEncodeV2());f.appendParametersDigestToName();b(f,a)},d)}else this.encryptSync_(a,b,d);else{if(this.isUsingGck_()&&0==this.ckName_.size())throw Error("EncryptorV2 has not fetched the first group content key (GCK)");d=da.randomBytes(ba.AES_IV_SIZE);var m=new Sc(Ea.AesCbc);m.setInitialVector(new p(d,!1));a instanceof p||(a=new p(a));a=mc.encrypt(new p(this.ckBits_,!1),a,m);m=new Ha;m.setInitialVector(new p(d,
!1));m.setPayload(a);m.setKeyLocatorName(this.ckName_);return m}};ba.prototype.encryptSync_=function(a,b,g){g||(g=this.onError_);if(this.isUsingGck_()){var f=(new Date).getTime();if(0==this.ckName_.size()){3<d&&console.log("The GCK is not yet available, so adding to the pending encrypt queue");this.pendingEncrypts_.push(new ba.PendingEncrypt(a,b,g));this.isGckRetrievalInProgress_||(this.nextCheckForNewGck_=f+this.checkForNewGckIntervalMilliseconds_,this.checkForNewGck_(g));return}f>this.nextCheckForNewGck_&&
(this.nextCheckForNewGck_=f+this.checkForNewGckIntervalMilliseconds_,this.isGckRetrievalInProgress_||this.checkForNewGck_(g))}a=this.encrypt(a);try{b(a)}catch(m){console.log("Error in onSuccess: "+U.getErrorWithStackTrace(m))}};ba.prototype.regenerateCk=function(){if(this.isUsingGck_())throw Error("This EncryptorV2 uses a group content key. Cannot regenerateCk()");this.ckName_=new b(this.ckPrefix_);this.ckName_.append(ba.NAME_COMPONENT_CK);this.ckName_.appendVersion((new Date).getTime());3<d&&console.log("Generating new CK: "+
this.ckName_.toUri());this.ckBits_=da.randomBytes(ba.AES_KEY_SIZE);null==this.kekData_?this.retryFetchingKek_():this.makeAndPublishCkData_(function(){},this.onError_)};ba.prototype.setCheckForNewGckInterval=function(a){this.checkForNewGckIntervalMilliseconds_=a};ba.prototype.size=function(){return this.storage_.size()};ba.PendingEncrypt=function(a,b,d){this.plainData=a;this.onSuccess=b;this.onError=d};ba.prototype.retryFetchingKek_=function(){if(!this.isKekRetrievalInProgress_){3<d&&console.log("Retrying fetching of the KEK");
this.isKekRetrievalInProgress_=!0;var a=this;this.fetchKekAndPublishCkData_(function(){3<d&&console.log("The KEK was retrieved and published");a.isKekRetrievalInProgress_=!1},function(b,g){3<d&&console.log("Failed to retrieve KEK: "+g);a.isKekRetrievalInProgress_=!1;a.onError_(b,g)},ba.N_RETRIES)}};ba.prototype.fetchKekAndPublishCkData_=function(a,g,f){3<d&&console.log("Fetching KEK: "+(new b(this.accessPrefix_)).append(ba.NAME_COMPONENT_KEK).toUri());if(0<this.kekPendingInterestId_)g($.ErrorCode.General,
"fetchKekAndPublishCkData: There is already a kekPendingInterestId_");else{var m=this,q=function(b,d){m.kekPendingInterestId_=0;m.validator_.validate(d,function(b){m.kekData_=d;m.makeAndPublishCkData_(a,g)},function(a,b){g($.ErrorCode.CkRetrievalFailure,"Validate KEK Data failure: "+b.toString())})},r=function(b){m.kekPendingInterestId_=0;1<f?m.fetchKekAndPublishCkData_(a,g,f-1):(g($.ErrorCode.KekRetrievalTimeout,"Retrieval of KEK ["+b.getName().toUri()+"] timed out"),3<d&&console.log("Scheduling retry after all timeouts"),
setTimeout(function(){m.retryFetchingKek_()},ba.RETRY_DELAY_KEK_RETRIEVAL_MS))},p=function(b,q){m.kekPendingInterestId_=0;1<f?setTimeout(function(){m.fetchKekAndPublishCkData_(a,g,f-1)},ba.RETRY_DELAY_AFTER_NACK_MS):(g($.ErrorCode.KekRetrievalFailure,"Retrieval of KEK ["+b.getName().toUri()+"] failed. Got NACK ("+q.getReason()+")"),3<d&&console.log("Scheduling retry from NACK"),setTimeout(function(){m.retryFetchingKek_()},ba.RETRY_DELAY_KEK_RETRIEVAL_MS))};try{this.kekPendingInterestId_=this.face_.expressInterest((new z((new b(this.accessPrefix_)).append(ba.NAME_COMPONENT_KEK))).setMustBeFresh(!0).setCanBePrefix(!0),
q,r,p)}catch(C){g($.ErrorCode.General,"expressInterest error: "+C)}}};ba.prototype.makeAndPublishCkData_=function(a,f){try{var m=new Ya(this.kekData_.getContent()),q=new Ha,r=m.encrypt(this.ckBits_,Ea.RsaPkcs);q.setPayload(r);var p=new O((new b(this.ckName_)).append(ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.kekData_.getName()));p.setContent(q.wireEncodeV2());p.getMetaInfo().setFreshnessPeriod(ba.DEFAULT_CK_FRESHNESS_PERIOD_MS);var C=this;this.keyChain_.signPromise(p,this.ckDataSigningInfo_).then(function(){C.storage_.insert(p);
3<d&&console.log("Publishing CK data: "+p.getName().toUri());a();return g.resolve()}).catch(function(a){f($.ErrorCode.EncryptionFailure,"Failed to sign CK data "+p.getName().toUri()+": "+a)})}catch(s){f($.ErrorCode.EncryptionFailure,"Failed to encrypt generated CK with KEK "+this.kekData_.getName().toUri())}};ba.prototype.checkForNewGck_=function(a){if(!this.isGckRetrievalInProgress_){this.isGckRetrievalInProgress_=!0;var d=this,g=function(g,f){d.validator_.validate(f,function(g){g=new b;try{g.wireDecode(f.getContent())}catch(m){d.isGckRetrievalInProgress_=
!1,a($.ErrorCode.CkRetrievalFailure,"Error decoding GCK name in: "+f.getName().toUri())}g.equals(d.ckName_)?d.isGckRetrievalInProgress_=!1:d.fetchGck_(g,a,ba.N_RETRIES)},function(b,g){d.isGckRetrievalInProgress_=!1;a($.ErrorCode.CkRetrievalFailure,"Validate GCK latest_ Data failure: "+g.toString())})},f=function(b){d.isGckRetrievalInProgress_=!1;a($.ErrorCode.CkRetrievalTimeout,"Timeout for GCK _latest packet: "+b.getName().toUri())},m=function(b,g){d.isGckRetrievalInProgress_=!1;a($.ErrorCode.CkRetrievalFailure,
"Network nack for GCK _latest packet: "+b.getName().toUri()+". Got NACK ("+g.getReason()+")")};try{this.face_.expressInterest((new z(this.gckLatestPrefix_)).setMustBeFresh(!0).setCanBePrefix(!0),g,f,m)}catch(q){d.isGckRetrievalInProgress_=!1,a($.ErrorCode.General,"expressInterest error: "+q)}}};ba.prototype.fetchGck_=function(a,g,f){var m=new b(a);m.append(ba.NAME_COMPONENT_ENCRYPTED_BY).append(this.credentialsKey_.getName());3<d&&console.log("EncryptorV2: Fetching GCK "+m.toUri());var q=this,r=function(b,
d){try{q.gckPendingInterestId_=0,q.decryptGckAndProcessPendingDecrypts_(a,d,g)}catch(f){g($.ErrorCode.General,"Error in EncryptorV2::fetchGck onData: "+f)}},p=function(b){q.gckPendingInterestId_=0;1<f?q.fetchGck_(a,g,f-1):(q.isGckRetrievalInProgress_=!1,g($.ErrorCode.CkRetrievalTimeout,"Retrieval of GCK ["+b.getName().toUri()+"] timed out"))},C=function(a,b){q.gckPendingInterestId_=0;q.isGckRetrievalInProgress_=!1;g($.ErrorCode.CkRetrievalFailure,"Retrieval of GCK ["+a.getName().toUri()+"] failed. Got NACK ("+
b.getReason()+")")};try{this.gckPendingInterestId_=this.face_.expressInterest((new z(m)).setMustBeFresh(!0).setCanBePrefix(!0),r,p,C)}catch(s){g($.ErrorCode.General,"expressInterest error: "+s)}};ba.prototype.decryptGckAndProcessPendingDecrypts_=function(a,f,m){3<d&&console.log("EncryptorV2: Decrypting GCK data "+f.getName().toUri());var q=new Ha;try{q.wireDecodeV2(f.getContent())}catch(r){this.isGckRetrievalInProgress_=!1;m($.ErrorCode.InvalidEncryptedFormat,"Error decrypting EncryptedContent: "+
r);return}var p=this;this.keyChain_.getTpm().decryptPromise(q.getPayload().buf(),this.credentialsKey_.getName()).then(function(d){if(d.isNull())return p.isGckRetrievalInProgress_=!1,m($.ErrorCode.TpmKeyNotFound,"Could not decrypt secret, "+p.credentialsKey_.getName().toUri()+" not found in TPM"),g.resolve();if(d.size()!=p.ckBits_.length)return p.isGckRetrievalInProgress_=!1,m($.ErrorCode.DecryptionFailure,"The decrypted group content key is not the correct size for the encryption algorithm"),g.resolve();
p.ckName_=new b(a);d.buf().copy(p.ckBits_);p.isGckRetrievalInProgress_=!1;for(var f in p.pendingEncrypts_){d=p.pendingEncrypts_[f];var q=p.encrypt(d.plainData);try{d.onSuccess(q)}catch(r){console.log("Error in onSuccess: "+U.getErrorWithStackTrace(r))}}p.pendingEncrypts=[];return g.resolve()}).catch(function(a){this.isGckRetrievalInProgress_=!1;m($.ErrorCode.DecryptionFailure,"Error decrypting the GCK: "+a)})};ba.prototype.isUsingGck_=function(){return 0!==this.gckLatestPrefix_.size()};ba.NAME_COMPONENT_ENCRYPTED_BY=
new b.Component("ENCRYPTED-BY");ba.NAME_COMPONENT_NAC=new b.Component("NAC");ba.NAME_COMPONENT_KEK=new b.Component("KEK");ba.NAME_COMPONENT_KDK=new b.Component("KDK");ba.NAME_COMPONENT_CK=new b.Component("CK");ba.NAME_COMPONENT_GCK=new b.Component("GCK");ba.NAME_COMPONENT_LATEST=new b.Component("_latest");ba.RETRY_DELAY_AFTER_NACK_MS=1E3;ba.RETRY_DELAY_KEK_RETRIEVAL_MS=6E4;ba.AES_KEY_SIZE=32;ba.AES_IV_SIZE=16;ba.N_RETRIES=3;ba.DEFAULT_CK_FRESHNESS_PERIOD_MS=36E5;var db=a.DigestTree,z=a.Interest,O=
a.Data,b=a.Name,p=a.Blob,ya=a.MemoryContentCache,de=a.SyncStateProto,U=a.NdnCommon,ta=function yb(b,d,g,f,m,q,r,p,C,s){this.onReceivedSyncState=b;this.onInitialized=d;this.applicationDataPrefixUri=g.toUri();this.applicationBroadcastPrefix=f;this.session=m;this.face=q;this.keyChain=r;this.certificateName=p;this.sync_lifetime=C;this.usrseq=-1;this.digest_tree=new db;this.contentCache=new ya(q);this.digest_log=[];this.digest_log.push(new yb.DigestLogEntry("00",[]));this.contentCache.registerPrefix(this.applicationBroadcastPrefix,
s,this.onInterest.bind(this));this.enabled=!0;b=new z(this.applicationBroadcastPrefix);b.getName().append("00");b.setInterestLifetimeMilliseconds(1E3);var A;try{A=dcodeIO.ProtoBuf.newBuilder().import(de).build("Sync")}catch(u){A=a.newBuilder().import(de).build("Sync")}this.SyncStateMsg=A.SyncStateMsg;this.SyncState=A.SyncState;this.face.expressInterest(b,this.onData.bind(this),this.initialTimeOut.bind(this))};s.ChronoSync2013=ta;ta.prototype.getProducerPrefixes=function(){for(var a=[],b=0;b<this.digest_tree.digestnode.length;++b){var d=
this.digest_tree.get(b);a.push(new ta.PrefixAndSessionNo(d.getDataPrefix(),d.getSessionNo()))}return a};ta.prototype.getProducerSequenceNo=function(a,b){var d=this.digest_tree.find(a,b);return 0>d?-1:this.digest_tree.get(d).getSequenceNo()};ta.prototype.publishNextSequenceNo=function(a){a=a instanceof p?a:new p(a,!0);this.usrseq++;var b={name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}};!a.isNull()&&0<a.size()&&(b.application_info=a.buf());a=[new this.SyncState(b)];
b=new this.SyncStateMsg({ss:a});this.broadcastSyncState(this.digest_tree.getRoot(),b);this.update(a)||console.log("Warning: ChronoSync: update did not create a new digest log entry");a=new z(this.applicationBroadcastPrefix);a.getName().append(this.digest_tree.getRoot());a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};ta.prototype.getSequenceNo=function(){return this.usrseq};ta.DigestLogEntry=function(a,b){this.digest=
a;this.data=b};ta.DigestLogEntry.prototype.getDigest=function(){return this.digest};ta.DigestLogEntry.prototype.getData=function(){return this.data};ta.prototype.shutdown=function(){this.enabled=!1;this.contentCache.unregisterAll()};ta.SyncState=function(a,b,d,g){this.dataPrefixUri_=a;this.sessionNo_=b;this.sequenceNo_=d;this.applicationInfo_=g};ta.SyncState.prototype.getDataPrefix=function(){return this.dataPrefixUri_};ta.SyncState.prototype.getSessionNo=function(){return this.sessionNo_};ta.SyncState.prototype.getSequenceNo=
function(){return this.sequenceNo_};ta.SyncState.prototype.getApplicationInfo=function(){return this.applicationInfo_};ta.PrefixAndSessionNo=function(a,b){this.dataPrefixUri_=a;this.sessionNo_=b};ta.PrefixAndSessionNo.prototype.getDataPrefix=function(){return this.dataPrefixUri_};ta.PrefixAndSessionNo.prototype.getSessionNo=function(){return this.sessionNo_};ta.prototype.broadcastSyncState=function(a,b){var d=new Uint8Array(b.toArrayBuffer()),g=new O(this.applicationBroadcastPrefix);g.getName().append(a);
g.setContent(new p(d,!1));var f=this;this.keyChain.sign(g,this.certificateName,function(){f.contentCache.add(g)})};ta.prototype.update=function(a){for(var b=0;b<a.length;b++)0==a[b].type&&this.digest_tree.update(a[b].name,a[b].seqno.session,a[b].seqno.seq)&&this.applicationDataPrefixUri==a[b].name&&(this.usrseq=a[b].seqno.seq);return-1==this.logfind(this.digest_tree.getRoot())?(a=new ta.DigestLogEntry(this.digest_tree.getRoot(),a),this.digest_log.push(a),!0):!1};ta.prototype.logfind=function(a){for(var b=
0;b<this.digest_log.length;b++)if(a==this.digest_log[b].digest)return b;return-1};ta.prototype.onInterest=function(a,d,g,f,m){this.enabled&&(a=d.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString(),d.getName().size()==this.applicationBroadcastPrefix.size()+2&&(a=d.getName().get(this.applicationBroadcastPrefix.size()+1).toEscapedString()),d.getName().size()==this.applicationBroadcastPrefix.size()+2||"00"==a?this.processRecoveryInst(d,a,g):(this.contentCache.storePendingInterest(d,
g),a!=this.digest_tree.getRoot()&&(d=this.logfind(a),-1==d?(d=new z(new b("/local/timeout")),d.setInterestLifetimeMilliseconds(2E3),this.face.expressInterest(d,this.dummyOnData,this.judgeRecovery.bind(this,d,a,g))):this.processSyncInst(d,a,g))))};ta.prototype.onData=function(a,d){if(this.enabled){var g=new Uint8Array(d.getContent().size());g.set(d.getContent().buf());var g=this.SyncStateMsg.decode(g.buffer).ss,m=!1;"00"==this.digest_tree.getRoot()?(m=!0,this.initialOndata(g)):(this.update(g),m=a.getName().size()==
this.applicationBroadcastPrefix.size()+2?!0:!1);for(var q=[],r=0;r<g.length;r++)if(0==g[r].type){var C;g[r].application_info?(C=g[r].application_info.toBinary(),C=0<C.length?new p(new f(C,"binary"),!1):new p):C=new p;q.push(new ta.SyncState(g[r].name,g[r].seqno.session,g[r].seqno.seq,C))}try{this.onReceivedSyncState(q,m)}catch(s){console.log("Error in onReceivedSyncState: "+U.getErrorWithStackTrace(s))}g=new b(this.applicationBroadcastPrefix);g.append(this.digest_tree.getRoot());a=new z(g);a.setInterestLifetimeMilliseconds(this.sync_lifetime);
this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};ta.prototype.initialTimeOut=function(a){if(this.enabled){console.log("no other people");this.usrseq++;try{this.onInitialized()}catch(d){console.log("Error in onInitialized: "+U.getErrorWithStackTrace(d))}a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})];this.update(a);a=new b(this.applicationBroadcastPrefix);a.append(this.digest_tree.getRoot());a=
new z(a);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))}};ta.prototype.processRecoveryInst=function(a,b,d){if(-1!=this.logfind(b)){b=[];for(var g=0;g<this.digest_tree.digestnode.length;g++)b[g]=new this.SyncState({name:this.digest_tree.digestnode[g].getDataPrefix(),type:"UPDATE",seqno:{seq:this.digest_tree.digestnode[g].getSequenceNo(),session:this.digest_tree.digestnode[g].getSessionNo()}});if(0!=b.length){b=new this.SyncStateMsg({ss:b});
b=new Uint8Array(b.toArrayBuffer());var f=new O(a.getName());f.setContent(new p(b,!1));"00"==a.getName().get(-1).toEscapedString()&&f.getMetaInfo().setFreshnessPeriod(1E3);this.keyChain.sign(f,this.certificateName,function(){try{d.putData(f)}catch(a){console.log(a.toString())}})}}};ta.prototype.processSyncInst=function(a,d,g){for(var f=[],m=[],q=[],r=[],C=a+1;C<this.digest_log.length;C++)for(var s=this.digest_log[C].getData(),A=0;A<s.length;A++)0==s[A].type&&-1!=this.digest_tree.find(s[A].name,s[A].seqno.session)&&
(a=m.indexOf(s[A].name),-1==a?(m.push(s[A].name),q.push(s[A].seqno.seq),r.push(s[A].seqno.session)):(q[a]=s[A].seqno.seq,r[a]=s[A].seqno.session));for(A=0;A<m.length;A++)f[A]=new this.SyncState({name:m[A],type:"UPDATE",seqno:{seq:q[A],session:r[A]}});if(0!=f.length){f=new this.SyncStateMsg({ss:f});f=new Uint8Array(f.toArrayBuffer());a=new b(this.prefix);a.append(this.chatroom).append(d);var u=new O(a);u.setContent(new p(f,!1));this.keyChain.sign(u,this.certificateName,function(){try{g.putData(u)}catch(a){console.log(a.toString())}})}};
ta.prototype.sendRecovery=function(a){var d=new b(this.applicationBroadcastPrefix);d.append("recovery").append(a);a=new z(d);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(a,this.onData.bind(this),this.syncTimeout.bind(this))};ta.prototype.judgeRecovery=function(a,b,d){a=this.logfind(b);-1!=a?b!=this.digest_tree.root&&this.processSyncInst(a,b,d):this.sendRecovery(b)};ta.prototype.syncTimeout=function(a){if(this.enabled&&a.getName().get(this.applicationBroadcastPrefix.size()).toEscapedString()==
this.digest_tree.root){var d=new b(a.getName()),d=new z(d);a.setInterestLifetimeMilliseconds(this.sync_lifetime);this.face.expressInterest(d,this.onData.bind(this),this.syncTimeout.bind(this))}};ta.prototype.initialOndata=function(a){this.update(a);for(var b=this.digest_tree.getRoot(),d=0;d<a.length;d++)if(a[d].name==this.applicationDataPrefixUri&&a[d].seqno.session==this.session){var g=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:a[d].seqno.seq+1,session:this.session}})];
if(this.update(g)){g=new ta.DigestLogEntry(this.digest_tree.getRoot(),g);this.digest_log.push(g);try{this.onInitialized()}catch(f){console.log("Error in onInitialized: "+U.getErrorWithStackTrace(f))}}}g=0<=this.usrseq?new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}}):new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:0,session:this.session}});a=new this.SyncStateMsg({ss:g});this.broadcastSyncState(b,a);
if(-1==this.digest_tree.find(this.applicationDataPrefixUri,this.session)&&(this.usrseq++,a=[new this.SyncState({name:this.applicationDataPrefixUri,type:"UPDATE",seqno:{seq:this.usrseq,session:this.session}})],this.update(a)))try{this.onInitialized()}catch(m){console.log("Error in onInitialized: "+U.getErrorWithStackTrace(m))}};ta.prototype.dummyOnData=function(a,b){console.log("*** dummyOnData called. ***")};da=a;db=function(){this.root="00";this.digestnode=[]};s.DigestTree=db;db.Node=function(a,
b,d){this.dataPrefix=a;this.seqno_session=b;this.seqno_seq=d;this.recomputeDigest()};db.Node.prototype.getDataPrefix=function(){return this.dataPrefix};db.Node.prototype.getSessionNo=function(){return this.seqno_session};db.Node.prototype.getSequenceNo=function(){return this.seqno_seq};db.Node.prototype.getDigest=function(){return this.digest};db.Node.prototype.setSequenceNo=function(a){this.seqno_seq=a;this.recomputeDigest()};db.Node.prototype.Int32ToBuffer=function(a){for(var b=new f(4),d=0;4>d;d++)b[d]=
a%256,a=Math.floor(a/256);return b};db.Node.prototype.recomputeDigest=function(){var a=da.createHash("sha256");a.update(this.Int32ToBuffer(this.seqno_session));a.update(this.Int32ToBuffer(this.seqno_seq));var a=a.digest(),b=da.createHash("sha256");b.update(this.dataPrefix);var b=b.digest(),d=da.createHash("sha256");d.update(b);d.update(a);this.digest=d.digest("hex")};db.Node.Compare=function(a,b){return a.dataPrefix!=b.dataPrefix?a.dataPrefix<b.dataPrefix:a.seqno_session<b.seqno_session};db.prototype.update=
function(a,b,d){var g=this.find(a,b);if(0<=g)if(this.digestnode[g].getSequenceNo()<d)this.digestnode[g].setSequenceNo(d);else return!1;else a=new db.Node(a,b,d),this.digestnode.push(a),this.digestnode.sort(this.sortNodes);this.recomputeRoot();return!0};db.prototype.sortNodes=function(){for(var a,b=this.digestnode.length;0<b;b--)for(var d=0;d<b-1;d++)this.digestnode[d].getDataPrefix()>this.digestnode[d+1].getDataPrefix()&&(a=this.digestnode[d],this.digestnode[d]=this.digestnode[d+1],this.digestnode[d+
1]=a)};db.prototype.sortNodes=function(a,b){return a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()==b.getSessionNo()?0:a.getDataPrefix()>b.getDataPrefix()||a.getDataPrefix()==b.getDataPrefix()&&a.getSessionNo()>b.getSessionNo()?1:-1};db.prototype.find=function(a,b){for(var d=0;d<this.digestnode.length;++d)if(this.digestnode[d].getDataPrefix()==a&&this.digestnode[d].getSessionNo()==b)return d;return-1};db.prototype.size=function(){return this.digestnode.size()};db.prototype.get=function(a){return this.digestnode[a]};
db.prototype.getRoot=function(){return this.root};db.prototype.recomputeRoot=function(){for(var a=da.createHash("sha256"),b=0;b<this.digestnode.length;b++)a.update(new f(this.digestnode[b].digest,"hex"));this.root=a.digest("hex")};de={"package":"Sync",messages:[{name:"SyncState",fields:[{rule:"required",type:"string",name:"name",id:1,options:{}},{rule:"required",type:"ActionType",name:"type",id:2,options:{}},{rule:"optional",type:"SeqNo",name:"seqno",id:3,options:{}},{rule:"optional",type:"bytes",
name:"application_info",id:4,options:{}}],enums:[{name:"ActionType",values:[{name:"UPDATE",id:0},{name:"DELETE",id:1},{name:"OTHER",id:2}],options:{}}],messages:[{name:"SeqNo",fields:[{rule:"required",type:"uint32",name:"seq",id:1,options:{}},{rule:"required",type:"uint32",name:"session",id:2,options:{}}],enums:[],messages:[],options:{}}],options:{}},{name:"SyncStateMsg",fields:[{rule:"repeated",type:"SyncState",name:"ss",id:1,options:{}}],enums:[],messages:[],options:{}}],enums:[],imports:[],options:{}};
s.SyncStateProto=de;var r=a.WireFormat,Mc=a.CommandInterestPreparer,zd=function(){Mc.call(this)};zd.prototype=new Mc;zd.prototype.name="CommandInterestGenerator";s.CommandInterestGenerator=zd;zd.prototype.generate=function(a,b,d,g,f){f="function"===typeof g?g:f;g="function"!==typeof g&&g?g:r.getDefaultWireFormat();this.prepareCommandInterestName(a,g);b.sign(a,d,g,function(){(null==a.getInterestLifetimeMilliseconds()||0>a.getInterestLifetimeMilliseconds())&&a.setInterestLifetimeMilliseconds(1E3);f&&
f()})};var d=a.Log.LOG,ac=function(){this.table_=[]};s.InterestFilterTable=ac;ac.Entry=function(a,b,d,g){this.interestFilterId_=a;this.filter_=b;this.onInterest_=d;this.face_=g};ac.Entry.prototype.getInterestFilterId=function(){return this.interestFilterId_};ac.Entry.prototype.getFilter=function(){return this.filter_};ac.Entry.prototype.getOnInterest=function(){return this.onInterest_};ac.Entry.prototype.getFace=function(){return this.face_};ac.prototype.setInterestFilter=function(a,b,d,g){this.table_.push(new ac.Entry(a,
b,d,g))};ac.prototype.getMatchedFilters=function(a,b){for(var d=0;d<this.table_.length;++d){var g=this.table_[d];g.getFilter().doesMatch(a.getName())&&b.push(g)}};ac.prototype.unsetInterestFilter=function(a){for(var b=0,g=this.table_.length-1;0<=g;--g)this.table_[g].getInterestFilterId()==a&&(++b,this.table_.splice(g,1));0===b&&0<d&&console.log("unsetInterestFilter: Didn't find interestFilterId "+a)};var U=a.NdnCommon,d=a.Log.LOG,ub=function(){this.table_=[];this.removeRequests_=[]};s.PendingInterestTable=
ub;ub.Entry=function(a,b,d,g,f){this.pendingInterestId_=a;this.interest_=b;this.onData_=d;this.onTimeout_=g;this.onNetworkNack_=f;this.timerId_=-1};ub.Entry.prototype.getPendingInterestId=function(){return this.pendingInterestId_};ub.Entry.prototype.getInterest=function(){return this.interest_};ub.Entry.prototype.getOnData=function(){return this.onData_};ub.Entry.prototype.getOnNetworkNack=function(){return this.onNetworkNack_};ub.Entry.prototype.callTimeout=function(){if(this.onTimeout_)try{this.onTimeout_(this.interest_)}catch(a){console.log("Error in onTimeout: "+
U.getErrorWithStackTrace(a))}};ub.Entry.prototype.setTimeout=function(a,b){-1===this.timerId_&&(this.timerId_=setTimeout(a,b))};ub.Entry.prototype.clearTimeout=function(){-1!==this.timerId_&&(clearTimeout(this.timerId_),this.timerId_=-1)};ub.prototype.add=function(a,b,g,f,m){var q=this.removeRequests_.indexOf(a);if(0<=q)return this.removeRequests_.splice(q,1),null;var r=new ub.Entry(a,b,g,f,m);this.table_.push(r);a=b.getInterestLifetimeMilliseconds()||4E3;var p=this;r.setTimeout(function(){1<d&&console.log("Interest time out: "+
b.getName().toUri());var a=p.table_.indexOf(r);0<=a&&p.table_.splice(a,1);r.callTimeout()},a);return r};ub.prototype.extractEntriesForExpressedInterest=function(a,b){for(var d=this.table_.length-1;0<=d;--d){var g=this.table_[d];g.getInterest().matchesData(a)&&(g.clearTimeout(),b.push(g),this.table_.splice(d,1))}};ub.prototype.extractEntriesForNackInterest=function(a,b){for(var d=a.wireEncode(),g=this.table_.length-1;0<=g;--g){var f=this.table_[g];null!=f.getOnNetworkNack()&&f.getInterest().wireEncode().equals(d)&&
(f.clearTimeout(),b.push(f),this.table_.splice(g,1))}};ub.prototype.removePendingInterest=function(a){if(null!=a){for(var b=0,g=this.table_.length-1;0<=g;--g){var f=this.table_[g];f.getPendingInterestId()==a&&(f.clearTimeout(),this.table_.splice(g,1),++b)}0===b&&0<d&&console.log("removePendingInterest: Didn't find pendingInterestId "+a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)}};var d=a.Log.LOG,Cc=function(a){this.interestFilterTable_=a;this.table_=[];this.removeRequests_=
[]};s.RegisteredPrefixTable=Cc;Cc.prototype.add=function(a,b,d){var g=this.removeRequests_.indexOf(a);if(0<=g)return this.removeRequests_.splice(g,1),!1;this.table_.push(new Cc._Entry(a,b,d));return!0};Cc.prototype.removeRegisteredPrefix=function(a){for(var b=0,g=this.table_.length-1;0<=g;--g){var f=this.table_[g];f.getRegisteredPrefixId()==a&&(++b,0<f.getRelatedInterestFilterId()&&this.interestFilterTable_.unsetInterestFilter(f.getRelatedInterestFilterId()),this.table_.splice(g,1))}0===b&&0<d&&console.log("removeRegisteredPrefix: Didn't find registeredPrefixId "+
a);0===b&&0>this.removeRequests_.indexOf(a)&&this.removeRequests_.push(a)};Cc._Entry=function(a,b,d){this.registeredPrefixId_=a;this.prefix_=b;this.relatedInterestFilterId_=d};Cc._Entry.prototype.getRegisteredPrefixId=function(){return this.registeredPrefixId_};Cc._Entry.prototype.getPrefix=function(){return this.prefix_};Cc._Entry.prototype.getRelatedInterestFilterId=function(){return this.relatedInterestFilterId_};Lc=function(){this.congestionMark_=0};s.CongestionMark=Lc;Lc.prototype.getCongestionMark=
function(){return this.congestionMark_};Lc.prototype.setCongestionMark=function(a){this.congestionMark_=a};Lc.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var d=a.getHeaderField(b);if(d instanceof Lc)return d}return null};ic=function(){this.faceId_=null};s.IncomingFaceId=ic;ic.prototype.getFaceId=function(){return this.faceId_};ic.prototype.setFaceId=function(a){this.faceId_=a};ic.getFirstHeader=function(a){for(var b=0;b<a.countHeaderFields();++b){var d=a.getHeaderField(b);
if(d instanceof ic)return d}return null};var p=a.Blob,Tc=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};s.LpPacket=Tc;Tc.prototype.getFragmentWireEncoding=function(){return this.fragmentWireEncoding_};Tc.prototype.countHeaderFields=function(){return this.headerFields_.length};Tc.prototype.getHeaderField=function(a){return this.headerFields_[a]};Tc.prototype.clear=function(){this.headerFields_=[];this.fragmentWireEncoding_=new p};Tc.prototype.setFragmentWireEncoding=function(a){this.fragmentWireEncoding_=
"object"===typeof a&&a instanceof p?a:new p(a)};Tc.prototype.addHeaderField=function(a){this.headerFields_.push(a)};var H=a.DataUtils,b=a.Name,z=a.Interest,O=a.Data,Ba=a.ControlParameters,Zb=a.ControlResponse,gc=a.InterestFilter,r=a.WireFormat,ab=a.TlvWireFormat,m=a.Tlv,ja=a.TlvDecoder,la=a.TlvEncoder,na=a.RegistrationOptions,jb=a.Transport,ee=a.TcpTransport,je=a.UnixTransport,zd=a.CommandInterestGenerator,p=a.Blob,U=a.NdnCommon,$a=a.NetworkNack,Tc=a.LpPacket,ac=a.InterestFilterTable,ub=a.PendingInterestTable,
Cc=a.RegisteredPrefixTable,sc=a,d=a.Log.LOG;V=function Pa(a,g){if(!Pa.supported)throw Error("The necessary JavaScript support is not available on this platform.");var f;if("object"==typeof a&&a instanceof jb){if(this.getConnectionInfo=null,this.transport=a,this.connectionInfo=g||null,f={},null==this.connectionInfo&&this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name){var m=Pa.getUnixSocketFilePathForLocalhost();null!=m?this.connectionInfo=new je.ConnectionInfo(m):
console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport");0<d&&console.log("Using "+this.connectionInfo.toString())}}else f=a||{},this.transport=(f.getTransport||function(){return new ee})(),this.getConnectionInfo=f.getConnectionInfo||this.transport.defaultGetConnectionInfo,this.connectionInfo=f.connectionInfo||null,null==this.connectionInfo&&(m=void 0!==f.host?f.host:null,this.transport&&this.transport.__proto__&&"UnixTransport"==this.transport.__proto__.name?
null!=m?this.connectionInfo=new je.ConnectionInfo(m):null==this.getConnectionInfo&&(m=Pa.getUnixSocketFilePathForLocalhost(),null!=m?this.connectionInfo=new je.ConnectionInfo(m):console.log("Face constructor: Cannot determine the default Unix socket file path for UnixTransport")):null!=m&&(this.connectionInfo="undefined"!=typeof nb?new nb.ConnectionInfo(m,f.port||9696):new ee.ConnectionInfo(m,f.port||6363)));null==this.connectionInfo?this.host=this.host=null:(this.host=this.connectionInfo.host,this.host=
this.connectionInfo.port);this.readyStatus=Pa.UNOPEN;this.onopen=f.onopen||function(){3<d&&console.log("Face connection established.")};this.onclose=f.onclose||function(){3<d&&console.log("Face connection closed.")};this.onConnectedCallbacks=[];this.commandKeyChain=null;this.commandCertificateName=new b;this.commandInterestGenerator=new zd;this.timeoutPrefix=new b("/local/timeout");this.pendingInterestTable_=new ub;this.interestFilterTable_=new ac;this.registeredPrefixTable_=new Cc(this.interestFilterTable_);
this.lastEntryId=0;this.interestLoopbackEnabled_=!1};s.Face=V;V.UNOPEN=0;V.OPEN_REQUESTED=1;V.OPENED=2;V.CLOSED=3;ee.importFace(V);V.getUnixSocketFilePathForLocalhost=function(){var a="/var/run/nfd.sock";if(sc.existsSync(a))return a;a="/tmp/.ndnd.sock";return sc.existsSync(a)?a:""};V.getSupported=function(){try{(new f(1)).slice(0,1)}catch(a){return console.log("NDN not available: Buffer not supported. "+a),!1}return!0};V.supported=V.getSupported();V.prototype.createRoute=function(a,b){this.connectionInfo=
a instanceof jb.ConnectionInfo?a:new ee.ConnectionInfo(a,b);this.host=this.connectionInfo.host;this.host=this.connectionInfo.port};V.prototype.close=function(){this.readyStatus==V.OPENED&&(this.readyStatus=V.CLOSED,this.transport.close())};V.prototype.getNextEntryId=function(){return++this.lastEntryId};V.makeShuffledHostGetConnectionInfo=function(a,b,d){a=a.slice(0,a.length);H.shuffle(a);return function(){return 0==a.length?null:d(a.splice(0,1)[0],b)}};V.prototype.setInterestLoopbackEnabled=function(a){this.interestLoopbackEnabled_=
a};V.prototype.expressInterest=function(a,b,d,g,f,m){var q;"object"===typeof a&&a instanceof z?q=new z(a):b&&"object"===typeof b&&b instanceof z?(q=new z(b),q.setName(a),b=d,d=g,g=f,f=m):(q=new z(a),q.setInterestLifetimeMilliseconds(4E3));var p=b,C,s,A;C="function"===typeof d?d:function(){};s="function"===typeof g?g:null;A=d instanceof r?d:g instanceof r?g:f instanceof r?f:r.getDefaultWireFormat();var u=this.getNextEntryId();0===q.getNonce().size()&&(q.setNonce(V.nonceTemplate_),q.refreshNonce());
if(null==this.connectionInfo)if(null==this.getConnectionInfo)console.log("ERROR: connectionInfo is NOT SET");else{var La=this;this.connectAndExecute(function(){La.reconnectAndExpressInterest(u,q,p,C,s,A)})}else this.reconnectAndExpressInterest(u,q,p,C,s,A);return u};V.prototype.reconnectAndExpressInterest=function(a,b,d,g,f,m){var q=this;if(this.connectionInfo.equals(this.transport.connectionInfo)&&this.readyStatus!==V.UNOPEN)if(this.readyStatus===V.OPEN_REQUESTED)this.onConnectedCallbacks.push(function(){q.expressInterestHelper(a,
b,d,g,f,m)});else if(this.readyStatus===V.OPENED)this.expressInterestHelper(a,b,d,g,f,m);else throw Error("reconnectAndExpressInterest: unexpected connection is not opened");else this.readyStatus=V.OPEN_REQUESTED,this.onConnectedCallbacks.push(function(){q.expressInterestHelper(a,b,d,g,f,m)}),this.transport.connect(this.connectionInfo,this,function(){for(q.readyStatus=V.OPENED;0<q.onConnectedCallbacks.length;)try{q.onConnectedCallbacks.shift()()}catch(a){console.log("Face.reconnectAndExpressInterest: ignoring exception from onConnectedCallbacks: "+
a)}if(q.onopen)q.onopen()},function(){q.closeByTransport()})};V.prototype.expressInterestHelper=function(a,b,d,g,f,m){if(null!=this.pendingInterestTable_.add(a,b,d,g,f)&&!this.timeoutPrefix.match(b.getName())){a=b.wireEncode(m);if(a.size()>V.getMaxNdnPacketSize())throw Error("The encoded interest size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a.buf());this.interestLoopbackEnabled_&&dispatchInterest(b)}};V.prototype.removePendingInterest=function(a){this.pendingInterestTable_.removePendingInterest(a)};
V.prototype.setCommandSigningInfo=function(a,d){this.commandKeyChain=a;this.commandCertificateName=new b(d)};V.prototype.setCommandCertificateName=function(a){this.commandCertificateName=new b(a)};V.prototype.makeCommandInterest=function(a,b,d){d="function"===typeof b?b:d;b="function"!==typeof b&&b?b:r.getDefaultWireFormat();this.nodeMakeCommandInterest(a,this.commandKeyChain,this.commandCertificateName,b,d)};V.prototype.nodeMakeCommandInterest=function(a,b,d,g,f){this.commandInterestGenerator.generate(a,
b,d,g,f)};V.prototype.registerPrefix=function(a,b,d,g,f,m){var q=g,p=f,C=m;g="function"===typeof q?q:null;f=q instanceof na?q:p instanceof na?p:new na;m=q instanceof r?q:p instanceof r?p:C instanceof r?C:r.getDefaultWireFormat();d||(d=function(){});var s=this.getNextEntryId(),A=this,q=function(){A.nfdRegisterPrefix(s,a,b,f,d,g,A.commandKeyChain,A.commandCertificateName,m)};null==this.connectionInfo?null==this.getConnectionInfo?console.log("ERROR: connectionInfo is NOT SET"):this.connectAndExecute(q):
q();return s};V.getMaxNdnPacketSize=function(){return U.MAX_NDN_PACKET_SIZE};V.RegisterResponse=function(a,b,d,g,f,m){this.prefix=a;this.onRegisterFailed=b;this.onRegisterSuccess=d;this.registeredPrefixId=g;this.parent=f;this.onInterest=m};V.RegisterResponse.prototype.onData=function(a,b){var g=new Zb;try{g.wireDecode(b.getContent(),ab.get())}catch(f){0<d&&console.log("Register prefix failed: Error decoding the NFD response: "+f);if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(m){console.log("Error in onRegisterFailed: "+
U.getErrorWithStackTrace(m))}return}if(200!=g.getStatusCode()){if(0<d&&console.log("Register prefix failed: Expected NFD status code 200, got: "+g.getStatusCode()),this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(q){console.log("Error in onRegisterFailed: "+U.getErrorWithStackTrace(q))}}else{if(0!=this.registeredPrefixId&&(g=0,null!=this.onInterest&&(g=this.parent.setInterestFilter(new gc(this.prefix),this.onInterest)),!this.parent.registeredPrefixTable_.add(this.registeredPrefixId,
this.prefix,g))){0<g&&this.parent.unsetInterestFilter(g);return}2<d&&console.log("Register prefix succeeded with the NFD forwarder for prefix "+this.prefix.toUri());if(null!=this.onRegisterSuccess)try{this.onRegisterSuccess(this.prefix,this.registeredPrefixId)}catch(r){console.log("Error in onRegisterSuccess: "+U.getErrorWithStackTrace(r))}}};V.RegisterResponse.prototype.onTimeout=function(a){2<d&&console.log("Timeout for NFD register prefix command.");if(this.onRegisterFailed)try{this.onRegisterFailed(this.prefix)}catch(b){console.log("Error in onRegisterFailed: "+
U.getErrorWithStackTrace(b))}};V.prototype.nfdRegisterPrefix=function(a,g,f,m,q,r,p,C,s){if(null==p)throw Error("registerPrefix: The command KeyChain has not been set. You must call setCommandSigningInfo.");if(0==C.size())throw Error("registerPrefix: The command certificate name has not been set. You must call setCommandSigningInfo.");var A=new Ba;A.setName(g);A.setForwardingFlags(m);null!=m.getOrigin()&&0<=m.getOrigin()&&(A.setOrigin(m.getOrigin()),A.getForwardingFlags().setOrigin(null));var u=this;
this.isLocal(function(d){var m=new z;m.setCanBePrefix(!0);m.setMustBeFresh(!0);d?(m.setName(new b("/localhost/nfd/rib/register")),m.setInterestLifetimeMilliseconds(2E3)):(m.setName(new b("/localhop/nfd/rib/register")),m.setInterestLifetimeMilliseconds(4E3));m.getName().append(A.wireEncode(ab.get()));u.nodeMakeCommandInterest(m,p,C,ab.get(),function(){var b=new V.RegisterResponse(g,q,r,a,u,f);u.reconnectAndExpressInterest(null,m,b.onData.bind(b),b.onTimeout.bind(b),null,s)})},function(a){0<d&&console.log("Error in Transport.isLocal: "+
a);if(q)try{q(g)}catch(b){console.log("Error in onRegisterFailed: "+U.getErrorWithStackTrace(b))}})};V.prototype.removeRegisteredPrefix=function(a){this.registeredPrefixTable_.removeRegisteredPrefix(a)};V.prototype.setInterestFilter=function(a,b){var d=this.getNextEntryId();this.interestFilterTable_.setInterestFilter(d,new gc(a),b,this);return d};V.prototype.unsetInterestFilter=function(a){this.interestFilterTable_.unsetInterestFilter(a)};V.prototype.putData=function(a,b){b=b||r.getDefaultWireFormat();
if(!this.interestLoopbackEnabled_||!this.satisfyPendingInterests(a)){var d=a.wireEncode(b);if(d.size()>V.getMaxNdnPacketSize())throw Error("The encoded Data packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(d.buf())}};V.prototype.putNack=function(a,b){var d=V.encodeLpNack_(a,b);if(d.size()>V.getMaxNdnPacketSize())throw Error("The encoded Nack packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(d.buf())};V.prototype.send=function(a){if(a.length>
V.getMaxNdnPacketSize())throw Error("The encoded packet size exceeds the maximum limit getMaxNdnPacketSize()");this.transport.send(a)};V.prototype.isLocal=function(a,b){null==this.connectionInfo?a(!1):this.transport.isLocal(this.connectionInfo,a,b)};V.prototype.onReceivedElement=function(a){3<d&&console.log("Complete element received. Length "+a.length+". Start decoding.");var b=null;a[0]==m.LpPacket_LpPacket&&(b=new Tc,ab.get().decodeLpPacket(b,a,!1),a=b.getFragmentWireEncoding().buf());var g=null,
f=null;if(a[0]==m.Interest||a[0]==m.Data){var q=new ja(a);q.peekType(m.Interest,a.length)?(g=new z,g.wireDecode(a,ab.get()),null!=b&&g.setLpPacket(b)):q.peekType(m.Data,a.length)&&(f=new O,f.wireDecode(a,ab.get()),null!=b&&f.setLpPacket(b))}if(null!==b&&(b.setFragmentWireEncoding(new p),a=$a.getFirstHeader(b),null!=a)){if(null==g)return;f=[];this.pendingInterestTable_.extractEntriesForNackInterest(g,f);for(g=0;g<f.length;++g){b=f[g];try{b.getOnNetworkNack()(b.getInterest(),a)}catch(r){console.log("Error in onNetworkNack: "+
U.getErrorWithStackTrace(r))}}return}null!==g?(3<d&&console.log("Interest packet received."),this.dispatchInterest_(g)):null!==f&&(3<d&&console.log("Data packet received."),this.satisfyPendingInterests_(f))};V.prototype.dispatchInterest_=function(a){var b=[];this.interestFilterTable_.getMatchedFilters(a,b);for(var g=0;g<b.length;++g){var f=b[g];3<d&&console.log("Found interest filter for "+a.getName().toUri());try{f.getOnInterest()(f.getFilter().getPrefix(),a,this,f.getInterestFilterId(),f.getFilter())}catch(m){console.log("Error in onInterest: "+
U.getErrorWithStackTrace(m))}}};V.prototype.satisfyPendingInterests_=function(a){var b=!1,d=[];this.pendingInterestTable_.extractEntriesForExpressedInterest(a,d);for(var g=0;g<d.length;++g){var f=d[g],b=!0;try{f.getOnData()(f.getInterest(),a)}catch(m){console.log("Error in onData: "+U.getErrorWithStackTrace(m))}}return b};V.prototype.connectAndExecute=function(a){var g=this.getConnectionInfo();if(null==g)console.log("ERROR: No more connectionInfo from getConnectionInfo"),this.host=this.host=this.connectionInfo=
null;else if(g.equals(this.connectionInfo))console.log("ERROR: The host returned by getConnectionInfo is not alive: "+this.connectionInfo.toString());else{this.connectionInfo=g;0<d&&console.log("connectAndExecute: trying host from getConnectionInfo: "+this.connectionInfo.toString());this.host=this.connectionInfo.host;this.host=this.connectionInfo.port;g=new z(new b("/"));g.setInterestLifetimeMilliseconds(4E3);var f=this,m=setTimeout(function(){0<d&&console.log("connectAndExecute: timeout waiting for host "+
f.host);f.connectAndExecute(a)},3E3);this.reconnectAndExpressInterest(null,g,function(b,g){clearTimeout(m);0<d&&console.log("connectAndExecute: connected to host "+f.host);a()},function(a){},null,r.getDefaultWireFormat())}};V.prototype.closeByTransport=function(){this.readyStatus=V.CLOSED;this.onclose()};V.encodeLpNack_=function(a,b){var d=new la(256),g=d.getLength();d.writeBlobTlv(m.LpPacket_Fragment,a.wireEncode(ab.get()).buf());var f;if(b.getReason()==$a.Reason.NONE||b.getReason()==$a.Reason.CONGESTION||
b.getReason()==$a.Reason.DUPLICATE||b.getReason()==$a.Reason.NO_ROUTE)f=b.getReason();else if(b.getReason()==$a.Reason.OTHER_CODE)f=b.getOtherReasonCode();else throw Error("unrecognized NetworkNack.getReason() value");var q=d.getLength();d.writeNonNegativeIntegerTlv(m.LpPacket_NackReason,f);d.writeTypeAndLength(m.LpPacket_Nack,d.getLength()-q);d.writeTypeAndLength(m.LpPacket_LpPacket,d.getLength()-g);return new p(d.getOutput(),!1)};V.nonceTemplate_=new p(new f(4),!1);var fe={};Object.keys(a).forEach(function(b){fe[b]=
fa[b];fa[b]=a[b]});a.noConflict=function(){Object.keys(fe).forEach(function(b){fa[b]===a[b]&&("undefined"==typeof fe[b]?delete fa[b]:fa[b]=fe[b])});return a};fa.ndn=a})(this);
(function(fa,t,E){function N(f,t){"object"!==typeof t&&(t=t());Object.keys(t).forEach(function(w){f[w]=t[w]});return f}function P(f){return{from:function(t){f.prototype=Object.create(t.prototype);f.prototype.constructor=f;return{extend:function(w){N(f.prototype,"object"!==typeof w?w(t.prototype):w)}}}}}function Q(f,t){return t(f)}function G(L,t){function w(a){this._cfg={version:a,storesSource:null,dbschema:{},tables:{},contentUpgrade:null};this.stores({})}function Ib(f,b,m,p){if(0===f){Object.keys(X).forEach(function(a){s(b,
a,X[a].primKey,X[a].indexes)});var r=H._createTransaction(g,Ic,X);r.idbtrans=b;r.idbtrans.onerror=xa(m,["populating database"]);r.on("error").subscribe(m);M.newPSD(function(){M.PSD.trans=r;try{H.on("populate").fire(r)}catch(a){p.onerror=b.onerror=function(a){a.preventDefault()};try{b.abort()}catch(d){}b.db.close();m(a)}})}else{var u=[],d=rc.filter(function(a){return a._cfg.version===f})[0];if(!d)throw new ua("Dexie specification of currently installed DB version is missing");X=H._dbSchema=d._cfg.dbschema;
var fc=!1;rc.filter(function(a){return a._cfg.version>f}).forEach(function(d){var f=X,r=d._cfg.dbschema;qc(f,b);qc(r,b);X=H._dbSchema=r;f=a(f,r);f.add.forEach(function(a){u.push(function(b,d){s(b,a[0],a[1].primKey,a[1].indexes);d()})});f.change.forEach(function(a){if(a.recreate)throw new ua("Not yet support for changing primary key");u.push(function(b,d){var g=b.objectStore(a.name);a.add.forEach(function(a){Db(g,a)});a.change.forEach(function(a){g.deleteIndex(a.name);Db(g,a)});a.del.forEach(function(a){g.deleteIndex(a)});
d()})});d._cfg.contentUpgrade&&u.push(function(a,b){fc=!0;var f=H._createTransaction(g,[].slice.call(a.db.objectStoreNames,0),r);f.idbtrans=a;var p=0;f._promise=Q(f._promise,function(a){return function(d,g,f){function m(a){return function(){a.apply(this,arguments);0===--p&&b()}}++p;return a.call(this,d,function(a,b,d){arguments[0]=m(a);arguments[1]=m(b);g.apply(this,arguments)},f)}});a.onerror=xa(m,["running upgrader function for version",d._cfg.version]);f.on("error").subscribe(m);d._cfg.contentUpgrade(f);
0===p&&b()});fc&&(0<=navigator.userAgent.indexOf("Trident")||0<=navigator.userAgent.indexOf("MSIE"))||u.push(function(a,b){for(var d=0;d<a.db.objectStoreNames.length;++d){var g=a.db.objectStoreNames[d];null!==r[g]&&r[g]!==E||a.db.deleteObjectStore(g)}b()})});var A=function(){try{u.length?u.shift()(b,A):fa(X,b)}catch(a){p.onerror=b.onerror=function(a){a.preventDefault()};try{b.abort()}catch(d){}b.db.close();m(a)}};A()}}function a(a,b){var g={del:[],add:[],change:[]},f;for(f in a)b[f]||g.del.push(f);
for(f in b){var m=a[f],p=b[f];if(m){var d={name:f,def:b[f],recreate:!1,del:[],add:[],change:[]};if(m.primKey.src!==p.primKey.src)d.recreate=!0,g.change.push(d);else{var m=m.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),p=p.indexes.reduce(function(a,b){a[b.name]=b;return a},{}),s;for(s in m)p[s]||d.del.push(s);for(s in p){var A=m[s],q=p[s];A?A.src!==q.src&&d.change.push(q):d.add.push(q)}(d.recreate||0<d.del.length||0<d.add.length||0<d.change.length)&&g.change.push(d)}}else g.add.push([f,p])}return g}
function s(a,b,g,f){var m=a.db.createObjectStore(b,g.keyPath?{keyPath:g.keyPath,autoIncrement:g.auto}:{autoIncrement:g.auto});f.forEach(function(a){Db(m,a)});return m}function fa(a,b){Object.keys(a).forEach(function(g){b.db.objectStoreNames.contains(g)||s(b,g,a[g].primKey,a[g].indexes)})}function Db(a,b){a.createIndex(b.name,b.keyPath,{unique:b.unique,multiEntry:b.multi})}function jd(a,b){throw new ua("Table "+b[0]+" not part of transaction. Original Scope Function Source: "+G.Promise.PSD.trans.scopeFunc.toString());
}function Bb(a,b,g,f){this.name=a;this.schema=g;this.hook=U[a]?U[a].hook:Wc(null,{creating:[pd,v],reading:[Uc,od],updating:[Rd,v],deleting:[Ud,v]});this._tpf=b;this._collClass=f||ib}function ed(a,b,g,f){Bb.call(this,a,b,g,f||wa)}function fd(a,b,g,f){function m(a,b,d,g){return p._promise(a,d,g)}var p=this;this.db=H;this.mode=a;this.storeNames=b;this.idbtrans=null;this.on=Wc(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=!0;this._dbschema=g;f&&(this.parent=
f);this._tpf=m;this.tables=Object.create(Xc);for(f=b.length-1;-1!==f;--f){var d=b[f],s=H._tableFactory(a,g[d],m);this.tables[d]=s;this[d]||(this[d]=s)}}function dc(a,b,g){this._ctx={table:a,index:":id"===b?null:b,collClass:a._collClass,or:g}}function ib(a,b){var g=null,f=null;if(b)try{g=b()}catch(m){f=m}var p=a._ctx;this._ctx={table:p.table,index:p.index,isPrimKey:!p.index||p.table.schema.primKey.keyPath&&p.index===p.table.schema.primKey.name,range:g,op:"openCursor",dir:"next",unique:"",algorithm:null,
filter:null,isMatch:null,offset:0,limit:Infinity,error:f,or:p.or}}function wa(){ib.apply(this,arguments)}function Gc(a,b){return a._cfg.version-b._cfg.version}function pc(a,b,g,f,m,p){g.forEach(function(d){var g=H._tableFactory(f,m[d],b);a.forEach(function(a){a[d]||(p?Object.defineProperty(a,d,{configurable:!0,enumerable:!0,get:function(){var a=M.PSD&&M.PSD.trans;return a&&a.db===H?a.tables[d]:g}}):a[d]=g)})})}function Nb(a){a.forEach(function(a){for(var g in a)a[g]instanceof Bb&&delete a[g]})}function sb(a,
b,g,f,m,p){var d=M.PSD;p=p||od;a.onerror||(a.onerror=xa(m));a.onsuccess=b?Z(function(d){var s=a.result;if(s){var q=function(){s.continue()};b(s,function(a){q=a},f,m)&&g(p(s.value),s,function(a){q=a});q()}else f()},m,d):Z(function(b){var d=a.result;if(d){var m=function(){d.continue()};g(p(d.value),d,function(a){m=a});m()}else f()},m,d)}function u(a){var b=[];a.split(",").forEach(function(a){a=a.trim();var g=a.replace("&","").replace("++","").replace("*",""),f=0!==g.indexOf("[")?g:a.substring(a.indexOf("[")+
1,a.indexOf("]")).split("+");b.push(new Ec(g,f||null,-1!==a.indexOf("&"),-1!==a.indexOf("*"),-1!==a.indexOf("++"),Array.isArray(f),-1!==f.indexOf(".")))});return b}function D(a,b){return a<b?-1:a>b?1:0}function qd(a,b){return a<b?1:a>b?-1:0}function ec(a){return function(b,g){for(var f=0;;){var m=a(b[f],g[f]);if(0!==m)return m;++f;if(f===b.length||f===g.length)return a(b.length,g.length)}}}function Cb(a,b){return a?b?function(){return a.apply(this,arguments)&&b.apply(this,arguments)}:a:b}function rb(){H.verno=
p.version/10;H._dbSchema=X={};Ic=[].slice.call(p.objectStoreNames,0);if(0!==Ic.length){var a=p.transaction(oc(Ic),"readonly");Ic.forEach(function(b){for(var g=a.objectStore(b),f=g.keyPath,m=f&&"string"===typeof f&&-1!==f.indexOf("."),p=new Ec(f,f||"",!1,!1,!!g.autoIncrement,f&&"string"!==typeof f,m),d=[],s=0;s<g.indexNames.length;++s){var A=g.index(g.indexNames[s]),m=(f=A.keyPath)&&"string"===typeof f&&-1!==f.indexOf("."),f=new Ec(A.name,f,!!A.unique,!!A.multiEntry,!1,f&&"string"!==typeof f,m);d.push(f)}X[b]=
new Fc(b,p,d,{})});pc([U],H._transPromiseFactory,Object.keys(X),g,X)}}function qc(a,b){for(var g=b.db.objectStoreNames,f=0;f<g.length;++f)for(var m=g[f],p=b.objectStore(m),d=0;d<p.indexNames.length;++d){var s=p.indexNames[d],A=p.index(s).keyPath,A="string"===typeof A?A:"["+[].slice.call(A).join("+")+"]";a[m]&&(A=a[m].idxByName[A])&&(A.name=s)}}var Eb=t&&t.addons||G.addons,eb=G.dependencies,mb=eb.indexedDB,I=eb.IDBKeyRange,Hc=eb.TypeError,ua=eb.Error,X=this._dbSchema={},rc=[],Ic=[],U={},Xc={},p=null,
Ka=!0,Qa=null,ha=!1,g="readwrite",H=this,m=[],la=!1,ja=!!f();this.version=function(a){if(p)throw new ua("Cannot add version when database is open");this.verno=Math.max(this.verno,a);var b=rc.filter(function(b){return b._cfg.version===a})[0];if(b)return b;b=new w(a);rc.push(b);rc.sort(Gc);return b};N(w.prototype,{stores:function(a){this._cfg.storesSource=this._cfg.storesSource?N(this._cfg.storesSource,a):a;var b={};rc.forEach(function(a){N(b,a._cfg.storesSource)});a=this._cfg.dbschema={};this._parseStoresSpec(b,
a);X=H._dbSchema=a;Nb([U,H,Xc]);pc([Xc],jd,Object.keys(a),g,a);pc([U,H,this._cfg.tables],H._transPromiseFactory,Object.keys(a),g,a,!0);Ic=Object.keys(a);return this},upgrade:function(a){var b=this;ma(function(){a(H._createTransaction(g,Object.keys(b._cfg.dbschema),b._cfg.dbschema))});this._cfg.contentUpgrade=a;return this},_parseStoresSpec:function(a,b){Object.keys(a).forEach(function(g){if(null!==a[g]){var f={},m=u(a[g]),p=m.shift();if(p.multi)throw new ua("Primary key cannot be multi-valued");p.keyPath&&
p.auto&&qb(f,p.keyPath,0);m.forEach(function(a){if(a.auto)throw new ua("Only primary key can be marked as autoIncrement (++)");if(!a.keyPath)throw new ua("Index must have a name and cannot be an empty string");qb(f,a.keyPath,a.compound?a.keyPath.map(function(){return""}):"")});b[g]=new Fc(g,p,m,f)}})}});this._allTables=U;this._tableFactory=function(a,b,g){return"readonly"===a?new Bb(b.name,g,b,ib):new ed(b.name,g,b)};this._createTransaction=function(a,b,g,f){return new fd(a,b,g,f)};this._transPromiseFactory=
function(a,b,g){if(!Ka||M.PSD&&M.PSD.letThrough){var f=H._createTransaction(a,b,X);return f._promise(a,function(a,b){f.error(function(a){H.on("error").fire(a)});g(function(b){f.complete(function(){a(b)})},b,f)})}var r=new M(function(f,d){m.push({resume:function(){var m=H._transPromiseFactory(a,b,g);r.onuncatched=m.onuncatched;m.then(f,d)}})});return r};this._whenReady=function(a){return!Ka||M.PSD&&M.PSD.letThrough?new M(a):new M(function(b,g){ma(function(){new M(function(){a(b,g)})});m.push({resume:function(){a(b,
g)}})})};this.verno=0;this.open=function(){return new M(function(a,b){function g(a){try{f.transaction.abort()}catch(d){}ha=!1;Qa=a;Ka=!1;b(Qa);m.forEach(function(a){a.resume()});m=[]}if(p||ha)throw new ua("Database already opened or being opened");var f;try{Qa=null;ha=!0;0===rc.length&&(la=!0);if(!mb)throw new ua("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");f=la?mb.open(L):mb.open(L,
Math.round(10*H.verno));f.onerror=xa(g,["opening database",L]);f.onblocked=function(a){H.on("blocked").fire(a)};f.onupgradeneeded=Z(function(a){la&&!H._allowEmptyDB?(f.onerror=function(a){a.preventDefault()},f.transaction.abort(),f.result.close(),a=mb.deleteDatabase(L),a.onsuccess=a.onerror=function(){g(new ua("Database '"+L+"' doesnt exist"))}):(f.transaction.onerror=xa(g),a=a.oldVersion>Math.pow(2,62)?0:a.oldVersion,Ib(a/10,f.transaction,g,f))},g);f.onsuccess=Z(function(b){ha=!1;p=f.result;la?rb():
0<p.objectStoreNames.length&&qc(X,p.transaction(oc(p.objectStoreNames),"readonly"));p.onversionchange=H.on("versionchange").fire;ja||sd(function(a){if(-1===a.indexOf(L))return a.push(L)});M.newPSD(function(){function b(){Ka=!1;m.forEach(function(a){a.resume()});m=[];a()}M.PSD.letThrough=!0;try{var f=H.on.ready.fire();f&&"function"===typeof f.then?f.then(b,function(a){p.close();p=null;g(a)}):gd(b)}catch(r){g(r)}})},g)}catch(r){g(r)}})};this.close=function(){p&&(p.close(),p=null,Ka=!0,Qa=null)};this.delete=
function(){var a=arguments;return new M(function(b,g){function f(){H.close();var a=mb.deleteDatabase(L);a.onsuccess=function(){ja||sd(function(a){var b=a.indexOf(L);if(0<=b)return a.splice(b,1)});b()};a.onerror=xa(g,["deleting",L]);a.onblocked=function(){H.on("blocked").fire()}}if(0<a.length)throw new ua("Arguments not allowed in db.delete()");ha?m.push({resume:f}):f()})};this.backendDB=function(){return p};this.isOpen=function(){return null!==p};this.hasFailed=function(){return null!==Qa};this.dynamicallyOpened=
function(){return la};this.name=L;Object.defineProperty(this,"tables",{get:function(){return Object.keys(U).map(function(a){return U[a]})}});this.on=Wc(this,"error","populate","blocked",{ready:[Ad,v],versionchange:[Td,v]});this.on.ready.subscribe=Q(this.on.ready.subscribe,function(a){return function(b,g){function f(){g||H.on.ready.unsubscribe(f);return b.apply(this,arguments)}a.call(this,f);H.isOpen()&&(Ka?m.push({resume:f}):f())}});ma(function(){H.on("populate").fire(H._createTransaction(g,Ic,X));
H.on("error").fire(new ua)});this.transaction=function(a,b,f){function m(b,g){var p=null;try{if(d)throw d;var p=H._createTransaction(a,s,X,r),u=s.map(function(a){return p.tables[a]});u.push(p);var L,t=0;M.newPSD(function(){M.PSD.trans=p;p.scopeFunc=f;r&&(p.idbtrans=r.idbtrans,p._promise=Q(p._promise,function(a){return function(b,d,g){function f(a){return function(b){var d;M._rootExec(function(){d=a(b);M._tickFinalize(function(){0===--t&&p.active&&(p.active=!1,p.on.complete.fire())})});return d}}++t;
return a.call(this,b,function(a,b,g){return d(f(a),f(b),g)},g)}}));p.complete(function(){b(L)});p.error(function(a){p.idbtrans&&(p.idbtrans.onerror=rd);try{p.abort()}catch(b){}r&&(r.active=!1,r.on.error.fire(a));var d=g(a);r||d||H.on.error.fire(a)});M._rootExec(function(){L=f.apply(p,u)})});(!p.idbtrans||r&&0===t)&&p._nop()}catch(w){p&&p.idbtrans&&(p.idbtrans.onerror=rd),p&&p.abort(),r&&r.on.error.fire(w),gd(function(){g(w)||H.on("error").fire(w)})}}b=[].slice.call(arguments,1,arguments.length-1);
f=arguments[arguments.length-1];var r=M.PSD&&M.PSD.trans;r&&r.db===H&&-1===a.indexOf("!")||(r=null);var p=-1!==a.indexOf("?");a=a.replace("!","").replace("?","");var d=null,s=(Array.isArray(b[0])?b.reduce(function(a,b){return a.concat(b)}):b).map(function(a){if("string"===typeof a)return a;a instanceof Bb||(d=d||new Hc("Invalid type. Arguments following mode must be instances of Table or String"));return a.name});"r"==a||"readonly"==a?a="readonly":"rw"==a||a==g?a=g:d=new ua("Invalid transaction mode: "+
a);r&&!d&&(r&&"readonly"===r.mode&&a===g&&(p?r=null:d=d||new ua("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY")),r&&s.forEach(function(a){r.tables.hasOwnProperty(a)||(p?r=null:d=d||new ua("Table "+a+" not included in parent transaction. Parent Transaction function: "+r.scopeFunc.toString()))}));return r?r._promise(a,m,"lock"):H._whenReady(m)};this.table=function(a){if(!la&&!U.hasOwnProperty(a))throw new ua("Table does not exist");return U[a]};N(Bb.prototype,
function(){function a(){throw new ua("Current Transaction is READONLY");}return{_trans:function(a,g,f){return this._tpf(a,[this.name],g,f)},_idbstore:function(a,g,f){var m=this;return this._tpf(a,[this.name],function(a,b,f){g(a,b,f.idbtrans.objectStore(m.name),f)},f)},get:function(a,g){var f=this;ma(function(){g(f.schema.instanceTemplate)});return this._idbstore("readonly",function(g,m,d){var p=d.get(a);p.onerror=xa(m,["getting",a,"from",f.name]);p.onsuccess=function(){g(f.hook.reading.fire(p.result))}}).then(g)},
where:function(a){return new dc(this,a)},count:function(a){return this.toCollection().count(a)},offset:function(a){return this.toCollection().offset(a)},limit:function(a){return this.toCollection().limit(a)},reverse:function(){return this.toCollection().reverse()},filter:function(a){return this.toCollection().and(a)},each:function(a){var g=this;ma(function(){a(g.schema.instanceTemplate)});return this._idbstore("readonly",function(f,m,p){p=p.openCursor();p.onerror=xa(m,["calling","Table.each()","on",
g.name]);sb(p,null,a,f,m,g.hook.reading.fire)})},toArray:function(a){var g=this;ma(function(){a([g.schema.instanceTemplate])});return this._idbstore("readonly",function(a,b,f){var d=[];f=f.openCursor();f.onerror=xa(b,["calling","Table.toArray()","on",g.name]);sb(f,null,function(a){d.push(a)},function(){a(d)},b,g.hook.reading.fire)}).then(a)},orderBy:function(a){return new this._collClass(new dc(this,a))},toCollection:function(){return new this._collClass(new dc(this))},mapToClass:function(a,g){this.schema.mappedClass=
a;var f=Object.create(a.prototype);this.schema.primKey.keyPath&&(qb(f,this.schema.primKey.keyPath,this.schema.primKey.auto?0:""),Vd(a.prototype,this.schema.primKey.keyPath));g&&bc(f,g);this.schema.instanceTemplate=f;f=Object.setPrototypeOf?function(g){if(!g)return g;Object.setPrototypeOf(g,a.prototype);return g}:function(g){if(!g)return g;var f=Object.create(a.prototype),d;for(d in g)g.hasOwnProperty(d)&&(f[d]=g[d]);return f};this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook);
this.schema.readHook=f;this.hook("reading",f);return a},defineClass:function(a){return this.mapToClass(G.defineClass(a),a)},add:a,put:a,"delete":a,clear:a,update:a}});P(ed).from(Bb).extend(function(){return{add:function(a,b){var f=this,m=this.hook.creating.fire;return this._idbstore(g,function(g,p,d,s){var u={};if(m!==v){var q=b||(d.keyPath?ca(a,d.keyPath):E);s=m.call(u,q,a,s);q===E&&s!==E&&(d.keyPath?qb(a,d.keyPath,s):b=s)}var L=b?d.add(a,b):d.add(a);L.onerror=xa(function(a){if(u.onerror)u.onerror(a);
return p(a)},["adding",a,"into",f.name]);L.onsuccess=function(b){var f=d.keyPath;f&&qb(a,f,b.target.result);if(u.onsuccess)u.onsuccess(b.target.result);g(L.result)}})},put:function(a,b){var f=this,m=this.hook.updating.fire;return this.hook.creating.fire!==v||m!==v?this._trans(g,function(g,m,d){var p=b||f.schema.primKey.keyPath&&ca(a,f.schema.primKey.keyPath);p===E?d.tables[f.name].add(a).then(g,m):(d._lock(),a=Dc(a),d.tables[f.name].where(":id").equals(p).modify(function(b){this.value=a}).then(function(g){return 0===
g?d.tables[f.name].add(a,b):p}).finally(function(){d._unlock()}).then(g,m))}):this._idbstore(g,function(g,m,d){var p=b?d.put(a,b):d.put(a);p.onerror=xa(m,["putting",a,"into",f.name]);p.onsuccess=function(b){var f=d.keyPath;f&&qb(a,f,b.target.result);g(p.result)}})},"delete":function(a){return this.hook.deleting.subscribers.length?this.where(":id").equals(a).delete():this._idbstore(g,function(b,g,f){var m=f.delete(a);m.onerror=xa(g,["deleting",a,"from",f.name]);m.onsuccess=function(a){b(m.result)}})},
clear:function(){return this.hook.deleting.subscribers.length?this.toCollection().delete():this._idbstore(g,function(a,b,g){var f=g.clear();f.onerror=xa(b,["clearing",g.name]);f.onsuccess=function(b){a(f.result)}})},update:function(a,b){if("object"!==typeof b||Array.isArray(b))throw new ua("db.update(keyOrObject, modifications). modifications must be an object.");if("object"!==typeof a||Array.isArray(a))return this.where(":id").equals(a).modify(b);Object.keys(b).forEach(function(g){qb(a,g,b[g])});
var g=ca(a,this.schema.primKey.keyPath);g===E&&M.reject(new ua("Object does not contain its primary key"));return this.where(":id").equals(g).modify(b)}}});N(fd.prototype,{_lock:function(){++this._reculock;1===this._reculock&&M.PSD&&(M.PSD.lockOwnerFor=this);return this},_unlock:function(){if(0===--this._reculock)for(M.PSD&&(M.PSD.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var a=this._blockedFuncs.shift();try{a()}catch(b){}}return this},_locked:function(){return this._reculock&&
(!M.PSD||M.PSD.lockOwnerFor!==this)},_nop:function(a){this.tables[this.storeNames[0]].get(0).then(a)},_promise:function(a,b,g){var f=this;return M.newPSD(function(){var m;f._locked()?m=new M(function(m,d){f._blockedFuncs.push(function(){f._promise(a,b,g).then(m,d)})}):(m=f.active?new M(function(m,d){if(!f.idbtrans&&a){if(!p)throw Qa?new ua("Database not open. Following error in populate, ready or upgrade function made Dexie.open() fail: "+Qa):new ua("Database not open");var r=f.idbtrans=p.transaction(oc(f.storeNames),
f.mode);r.onerror=function(a){f.on("error").fire(a&&a.target.error);a.preventDefault();f.abort()};r.onabort=function(a){f.active=!1;f.on("abort").fire(a)};r.oncomplete=function(a){f.active=!1;f.on("complete").fire(a)}}g&&f._lock();try{b(m,d,f)}catch(s){G.ignoreTransaction(function(){f.on("error").fire(s)}),f.abort(),d(s)}}):M.reject(ge(new ua("Transaction is inactive. Original Scope Function Source: "+f.scopeFunc.toString()))),f.active&&g&&m.finally(function(){f._unlock()}));m.onuncatched=function(a){G.ignoreTransaction(function(){f.on("error").fire(a)});
f.abort()};return m})},complete:function(a){return this.on("complete",a)},error:function(a){return this.on("error",a)},abort:function(){if(this.idbtrans&&this.active)try{this.active=!1,this.idbtrans.abort(),this.on.error.fire(new ua("Transaction Aborted"))}catch(a){}},table:function(a){if(!this.tables.hasOwnProperty(a))throw new ua("Table "+a+" not in transaction");return this.tables[a]}});N(dc.prototype,function(){function a(b,g){try{throw g;}catch(f){b._ctx.error=f}return b}function b(a){return Array.prototype.slice.call(1===
a.length&&Array.isArray(a[0])?a[0]:a)}function g(a){return"next"===a?function(a){return a.toUpperCase()}:function(a){return a.toLowerCase()}}function f(a){return"next"===a?function(a){return a.toLowerCase()}:function(a){return a.toUpperCase()}}function m(a,b,g,f,p,r){for(var s=Math.min(a.length,f.length),u=-1,L=0;L<s;++L){var t=b[L];if(t!==f[L])return 0>p(a[L],g[L])?a.substr(0,L)+g[L]+g.substr(L+1):0>p(a[L],f[L])?a.substr(0,L)+f[L]+g.substr(L+1):0<=u?a.substr(0,u)+b[u]+g.substr(u+1):null;0>p(a[L],
t)&&(u=L)}return s<f.length&&"next"===r?a+g.substr(a.length):s<a.length&&"prev"===r?a.substr(0,g.length):0>u?null:a.substr(0,u)+f[u]+g.substr(u+1)}function p(a,b,s){function q(a){u=g(a);L=f(a);t="next"===a?D:qd;w=u(s);C=L(s);cc=a}var u,L,t,w,C,cc;q("next");a._ondirectionchange=function(a){q(a)};a._addAlgorithm(function(a,d,g){var f=a.key;if("string"!==typeof f)return!1;var q=L(f);if(b(q,C))return d(function(){a.continue()}),!0;var p=m(f,q,w,C,t,cc);p?d(function(){a.continue(p)}):d(g);return!1})}return{between:function(a,
b,g,f){g=!1!==g;f=!0===f;return a>b||a===b&&!(!g&&!f||g&&f)?(new this._ctx.collClass(this,function(){return I.only(a)})).limit(0):new this._ctx.collClass(this,function(){return I.bound(a,b,!g,!f)})},equals:function(a){return new this._ctx.collClass(this,function(){return I.only(a)})},above:function(a){return new this._ctx.collClass(this,function(){return I.lowerBound(a,!0)})},aboveOrEqual:function(a){return new this._ctx.collClass(this,function(){return I.lowerBound(a)})},below:function(a){return new this._ctx.collClass(this,
function(){return I.upperBound(a,!0)})},belowOrEqual:function(a){return new this._ctx.collClass(this,function(){return I.upperBound(a)})},startsWith:function(b){return"string"!==typeof b?a(new this._ctx.collClass(this),new Hc("String expected")):this.between(b,b+String.fromCharCode(65535),!0,!0)},startsWithIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Hc("String expected"));if(""===b)return this.startsWith(b);var g=new this._ctx.collClass(this,function(){return I.bound(b.toUpperCase(),
b.toLowerCase()+String.fromCharCode(65535))});p(g,function(a,b){return 0===a.indexOf(b)},b);g._ondirectionchange=function(){a(g,new ua("reverse() not supported with WhereClause.startsWithIgnoreCase()"))};return g},equalsIgnoreCase:function(b){if("string"!==typeof b)return a(new this._ctx.collClass(this),new Hc("String expected"));var g=new this._ctx.collClass(this,function(){return I.bound(b.toUpperCase(),b.toLowerCase())});p(g,function(a,b){return a===b},b);return g},anyOf:function(a){var g=this._ctx,
f=g.table.schema,m=(g=g.index?f.idxByName[g.index]:f.primKey)&&g.compound,p=b(arguments),r=m?ec(D):D;p.sort(r);if(0===p.length)return(new this._ctx.collClass(this,function(){return I.only("")})).limit(0);g=new this._ctx.collClass(this,function(){return I.bound(p[0],p[p.length-1])});g._ondirectionchange=function(a){r="next"===a?D:qd;m&&(r=ec(r));p.sort(r)};var s=0;g._addAlgorithm(function(a,b,d){for(var g=a.key;0<r(g,p[s]);)if(++s,s===p.length)return b(d),!1;if(0===r(g,p[s]))return b(function(){a.continue()}),
!0;b(function(){a.continue(p[s])});return!1});return g}}});N(ib.prototype,function(){function a(b,g){b.filter=Cb(b.filter,g)}function b(a,b){a.isMatch=Cb(a.isMatch,b)}function f(a,b){if(a.isPrimKey)return b;var g=a.table.schema.idxByName[a.index];if(!g)throw new ua("KeyPath "+a.index+" on object store "+b.name+" is not indexed");return a.isPrimKey?b:b.index(g.name)}function m(a,b){return f(a,b)[a.op](a.range||null,a.dir+a.unique)}function p(a,b,g,f,r){a.or?function(){function p(){2===++t&&g()}function s(a,
d,g){if(!u||u(d,g,p,f)){var m=d.primaryKey.toString();L.hasOwnProperty(m)||(L[m]=!0,b(a,d,g))}}var u=a.filter,L={},t=0;a.or._iterate(s,p,f,r);sb(m(a,r),a.algorithm,s,p,f,a.table.hook.reading.fire)}():sb(m(a,r),Cb(a.algorithm,a.filter),b,g,f,a.table.hook.reading.fire)}function s(a){return a.table.schema.instanceTemplate}return{_read:function(a,b){var g=this._ctx;return g.error?g.table._trans(null,function(a,b){b(g.error)}):g.table._idbstore("readonly",a).then(b)},_write:function(a){var b=this._ctx;
return b.error?b.table._trans(null,function(a,d){d(b.error)}):b.table._idbstore(g,a,"locked")},_addAlgorithm:function(a){var b=this._ctx;b.algorithm=Cb(b.algorithm,a)},_iterate:function(a,b,g,f){return p(this._ctx,a,b,g,f)},each:function(a){var b=this._ctx;ma(function(){a(s(b))});return this._read(function(g,f,m){p(b,a,g,f,m)})},count:function(a){ma(function(){a(0)});var b=this,g=this._ctx;if(g.filter||g.algorithm||g.or){var m=0;return this._read(function(a,b,d){p(g,function(){++m;return!1},function(){a(m)},
b,d)},a)}return this._read(function(a,d,m){m=f(g,m);m=g.range?m.count(g.range):m.count();m.onerror=xa(d,["calling","count()","on",b.name]);m.onsuccess=function(b){a(Math.min(b.target.result,Math.max(0,g.limit-g.offset)))}},a)},sortBy:function(a,b){function g(a,b){return b?g(a[p[b]],b-1):a[r]}function f(a,b){var d=g(a,u),m=g(b,u);return d<m?-L:d>m?L:0}var m=this._ctx;ma(function(){b([s(m)])});var p=a.split(".").reverse(),r=p[0],u=p.length-1,L="next"===this._ctx.dir?1:-1;return this.toArray(function(a){return a.sort(f)}).then(b)},
toArray:function(a){var b=this._ctx;ma(function(){a([s(b)])});return this._read(function(a,d,g){var f=[];p(b,function(a){f.push(a)},function(){a(f)},d,g)},a)},offset:function(b){var g=this._ctx;if(0>=b)return this;g.offset+=b;g.or||g.algorithm||g.filter?a(g,function(a,g,f){return 0>--b}):a(g,function(a,g,f){if(0===b)return!0;if(1===b)return--b,!1;g(function(){a.advance(b);b=0});return!1});return this},limit:function(b){this._ctx.limit=Math.min(this._ctx.limit,b);a(this._ctx,function(a,g,f){0>=--b&&
g(f);return 0<=b});return this},until:function(b,g){var f=this._ctx;ma(function(){b(s(f))});a(this._ctx,function(a,f,m){return b(a.value)?(f(m),g):!0});return this},first:function(a){var b=this;ma(function(){a(s(b._ctx))});return this.limit(1).toArray(function(a){return a[0]}).then(a)},last:function(a){return this.reverse().first(a)},and:function(d){var g=this;ma(function(){d(s(g._ctx))});a(this._ctx,function(a){return d(a.value)});b(this._ctx,d);return this},or:function(a){return new dc(this._ctx.table,
a,this)},reverse:function(){this._ctx.dir="prev"===this._ctx.dir?"next":"prev";this._ondirectionchange&&this._ondirectionchange(this._ctx.dir);return this},desc:function(){return this.reverse()},eachKey:function(a){var b=this,g=this._ctx;ma(function(){a(s(b._ctx)[b._ctx.index])});g.isPrimKey||(g.op="openKeyCursor");return this.each(function(b,g){a(g.key,g)})},eachUniqueKey:function(a){this._ctx.unique="unique";return this.eachKey(a)},keys:function(a){ma(function(){a([s(g)[b._ctx.index]])});var b=
this,g=this._ctx;g.isPrimKey||(g.op="openKeyCursor");var f=[];return this.each(function(a,b){f.push(b.key)}).then(function(){return f}).then(a)},uniqueKeys:function(a){this._ctx.unique="unique";return this.keys(a)},firstKey:function(a){return this.limit(1).keys(function(a){return a[0]}).then(a)},lastKey:function(a){return this.reverse().firstKey(a)},distinct:function(){var b={};a(this._ctx,function(a){a=a.primaryKey.toString();var g=b.hasOwnProperty(a);b[a]=!0;return!g});return this}}});P(wa).from(ib).extend({modify:function(a){var b=
this,g=this._ctx,f=g.table.hook,m=f.updating.fire,p=f.deleting.fire;ma(function(){"function"===typeof a&&a.call({value:g.table.schema.instanceTemplate},g.table.schema.instanceTemplate)});return this._write(function(d,f,s,q){function u(a){a&&(H.push(a),pc.push(Ib));return f(new id("Error modifying one or more objects",H,y,pc))}function L(){I&&y+H.length===z&&(0<H.length?u():d(y))}var t;if("function"===typeof a)t=m===v&&p===v?a:function(b){var d=Dc(b);if(!1===a.call(this,b))return!1;if(this.hasOwnProperty("value")){var g=
nc(d,this.value),f=m.call(this,g,this.primKey,d,q);f&&(b=this.value,Object.keys(f).forEach(function(a){qb(b,a,f[a])}))}else p.call(this,this.primKey,b,q)};else if(m===v){var w=Object.keys(a),D=w.length;t=function(b){for(var d=!1,g=0;g<D;++g){var f=w[g],m=a[f];ca(b,f)!==m&&(qb(b,f,m),d=!0)}return d}}else{var cc=a;a=Cd(cc);t=function(b){var d=!1,g=m.call(this,a,this.primKey,Dc(b),q);g&&N(a,g);Object.keys(a).forEach(function(g){var f=a[g];ca(b,g)!==f&&(qb(b,g,f),d=!0)});g&&(a=Cd(cc));return d}}var z=
0,y=0,I=!1,H=[],pc=[],Ib=null;b._iterate(function(a,b,d){Ib=b.primaryKey;var f={primKey:b.primaryKey,value:a};if(!1!==t.call(f,a))b=(d=!f.hasOwnProperty("value"))?b.delete():b.update(f.value),++z,b.onerror=xa(function(a){H.push(a);pc.push(f.primKey);if(f.onerror)f.onerror(a);L();return!0},d?["deleting",a,"from",g.table.name]:["modifying",a,"on",g.table.name]),b.onsuccess=function(a){if(f.onsuccess)f.onsuccess(f.value);++y;L()};else if(f.onsuccess)f.onsuccess(f.value)},function(){I=!0;L()},u,s)})},
"delete":function(){return this.modify(function(){delete this.value})}});N(this,{Collection:ib,Table:Bb,Transaction:fd,Version:w,WhereClause:dc,WriteableCollection:wa,WriteableTable:ed});(function(){H.on("versionchange",function(a){H.close();H.on("error").fire(new ua("Database version changed by other database connection."))})})();Eb.forEach(function(a){a(H)})}function v(){}function od(f){return f}function Uc(f,t){return f===od?t:function(w){return t(f(w))}}function mb(f,t){return function(){f.apply(this,
arguments);t.apply(this,arguments)}}function pd(f,t){return f===v?t:function(){var w=f.apply(this,arguments);w!==E&&(arguments[0]=w);var v=this.onsuccess,a=this.onerror;delete this.onsuccess;delete this.onerror;var s=t.apply(this,arguments);v&&(this.onsuccess=this.onsuccess?mb(v,this.onsuccess):v);a&&(this.onerror=this.onerror?mb(a,this.onerror):a);return s!==E?s:w}}function Rd(f,t){return f===v?t:function(){var w=f.apply(this,arguments);w!==E&&N(arguments[0],w);var v=this.onsuccess,a=this.onerror;
delete this.onsuccess;delete this.onerror;var s=t.apply(this,arguments);v&&(this.onsuccess=this.onsuccess?mb(v,this.onsuccess):v);a&&(this.onerror=this.onerror?mb(a,this.onerror):a);return w===E?s===E?E:s:s===E?w:N(w,s)}}function Sd(f,t){return f===v?t:function(){return!1===f.apply(this,arguments)?!1:t.apply(this,arguments)}}function Td(f,t){return f===v?t:function(){return!1===t.apply(this,arguments)?!1:f.apply(this,arguments)}}function Ud(f,t){return f===v?t:function(){f.apply(this,arguments);t.apply(this,
arguments)}}function Ad(f,t){return f===v?t:function(){var w=f.apply(this,arguments);if(w&&"function"===typeof w.then){var v=this,a=arguments;return w.then(function(){return t.apply(v,a)})}return t.apply(this,arguments)}}function Wc(f,t){function w(f,s,t){if(Array.isArray(f))return a(f);if("object"===typeof f)return G(f);s||(s=Sd);t||(t=v);var L={subscribers:[],fire:t,subscribe:function(a){L.subscribers.push(a);L.fire=s(L.fire,a)},unsubscribe:function(a){L.subscribers=L.subscribers.filter(function(f){return f!==
a});L.fire=L.subscribers.reduce(s,t)}};return E[f]=M[f]=L}function G(a){Object.keys(a).forEach(function(f){var s=a[f];if(Array.isArray(s))w(f,a[f][0],a[f][1]);else if("asap"===s){var t=w(f,null,function(){var a=arguments;t.subscribers.forEach(function(f){gd(function(){f.apply(fa,a)})})});t.subscribe=function(a){-1===t.subscribers.indexOf(a)&&t.subscribers.push(a)};t.unsubscribe=function(a){a=t.subscribers.indexOf(a);-1!==a&&t.subscribers.splice(a,1)}}else throw Error("Invalid event config");})}function a(a){function f(){if(s)return!1;
s=!0}var s=!1;a.forEach(function(a){w(a).subscribe(f)})}var s=arguments,E={},M=function(a,s){if(s){var t=[].slice.call(arguments,1),w=E[a];w.subscribe.apply(w,t);return f}if("string"===typeof a)return E[a]};M.addEventType=w;for(var N=1,P=s.length;N<P;++N)w(s[N]);return M}function gd(f){fa.setImmediate?setImmediate(f):setTimeout(f,0)}function Bd(f){f=setTimeout(f,1E3);clearTimeout(f)}function Z(f,t,w){return function(){var v=M.PSD;M.PSD=w;try{f.apply(this,arguments)}catch(a){t(a)}finally{M.PSD=v}}}
function ca(f,t){if(f.hasOwnProperty(t))return f[t];if(!t)return f;if("string"!==typeof t){for(var w=[],v=0,a=t.length;v<a;++v){var s=ca(f,t[v]);w.push(s)}return w}w=t.indexOf(".");return-1!==w?(v=f[t.substr(0,w)],v===E?E:ca(v,t.substr(w+1))):E}function qb(f,t,w){if(f&&t!==E)if("string"!==typeof t&&"length"in t){if(!("string"!==typeof w&&"length"in w))throw Error("Assertion failed");for(var v=0,a=t.length;v<a;++v)qb(f,t[v],w[v])}else a=t.indexOf("."),-1!==a?(v=t.substr(0,a),t=t.substr(a+1),""===t?
w===E?delete f[v]:f[v]=w:((a=f[v])||(a=f[v]={}),qb(a,t,w))):w===E?delete f[t]:f[t]=w}function Vd(f,t){qb(f,t,E)}function Cd(f){var t={},w;for(w in f)f.hasOwnProperty(w)&&(t[w]=f[w]);return t}function Dc(f){if(!f||"object"!==typeof f)return f;var t;if(Array.isArray(f)){t=[];for(var w=0,v=f.length;w<v;++w)t.push(Dc(f[w]))}else if(f instanceof Date)t=new Date,t.setTime(f.getTime());else for(w in t=f.constructor?Object.create(f.constructor.prototype):{},f)f.hasOwnProperty(w)&&(t[w]=Dc(f[w]));return t}
function nc(f,t){var w={},v;for(v in f)f.hasOwnProperty(v)&&(t.hasOwnProperty(v)?f[v]!==t[v]&&JSON.stringify(f[v])!=JSON.stringify(t[v])&&(w[v]=t[v]):w[v]=E);for(v in t)t.hasOwnProperty(v)&&!f.hasOwnProperty(v)&&(w[v]=t[v]);return w}function hd(f){if("function"===typeof f)return new f;if(Array.isArray(f))return[hd(f[0])];if(f&&"object"===typeof f){var t={};bc(t,f);return t}return f}function bc(f,t){Object.keys(t).forEach(function(w){var v=hd(t[w]);f[w]=v})}function xa(f,t){return function(w){var v=
w&&w.target.error||Error();if(t){var a=" occurred when "+t.map(function(a){switch(typeof a){case "function":return a();case "string":return a;default:return JSON.stringify(a)}}).join(" ");v.name?v.toString=function(){return v.name+a+(v.message?". "+v.message:"")}:v+=a}f(v);w&&(w.stopPropagation&&w.stopPropagation(),w.preventDefault&&w.preventDefault());return!1}}function ge(f){try{throw f;}catch(t){return t}}function rd(f){f.preventDefault()}function sd(f){var t,v=G.dependencies.localStorage;if(!v)return f([]);
try{t=JSON.parse(v.getItem("Dexie.DatabaseNames")||"[]")}catch(E){t=[]}f(t)&&v.setItem("Dexie.DatabaseNames",JSON.stringify(t))}function Ec(f,t,v,E,a,s,G){this.name=f;this.keyPath=t;this.unique=v;this.multi=E;this.auto=a;this.compound=s;this.dotted=G;f="string"===typeof t?t:t&&"["+[].join.call(t,"+")+"]";this.src=(v?"&":"")+(E?"*":"")+(a?"++":"")+f}function Fc(f,t,v,E){this.name=f;this.primKey=t||new Ec;this.indexes=v||[new Ec];this.instanceTemplate=E;this.mappedClass=null;this.idxByName=v.reduce(function(a,
f){a[f.name]=f;return a},{})}function id(f,t,v,E){this.name="ModifyError";this.failures=t;this.failedKeys=E;this.successCount=v;this.message=t.join("\n")}function oc(f){return 1===f.length?f[0]:f}function f(){var f=G.dependencies.indexedDB,t=f&&(f.getDatabaseNames||f.webkitGetDatabaseNames);return t&&t.bind(f)}var M=function(){function f(a,s){wa.push([a,Q.call(arguments,1)])}function t(){var a=wa;wa=[];for(var f=0,s=a.length;f<s;++f){var u=a[f];u[0].apply(fa,u[1])}}function w(a){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");
if("function"!==typeof a)throw new TypeError("not a function");this._value=this._state=null;this._deferreds=[];this._catched=!1;var f=this,t=!0;this._PSD=w.PSD;try{P(this,a,function(a){t?ca(s,f,a):s(f,a)},function(a){return t?(ca(G,f,a),!1):G(f,a)})}finally{t=!1}}function E(s,v){if(null===s._state)s._deferreds.push(v);else{var G=s._state?v.onFulfilled:v.onRejected;if(null===G)return(s._state?v.resolve:v.reject)(s._value);var u,D=ma;ma=!1;ca=f;try{var M=w.PSD;w.PSD=s._PSD;u=G(s._value);s._state||u&&
"function"===typeof u.then&&!1===u._state||a(s);v.resolve(u)}catch(N){if(!v.reject(N)&&s.onuncatched)try{s.onuncatched(N)}catch(P){}}finally{if(w.PSD=M,D){do{for(;0<wa.length;)t();if(G=xa.pop())try{G()}catch(Q){}}while(0<xa.length||0<wa.length);ca=Z;ma=!0}}}}function a(f){f._catched=!0;f._parent&&a(f._parent)}function s(a,f){var t=w.PSD;w.PSD=a._PSD;try{if(f===a)throw new TypeError("A promise cannot be resolved with itself.");!f||"object"!==typeof f&&"function"!==typeof f||"function"!==typeof f.then?
(a._state=!0,a._value=f,M.call(a)):P(a,function(a,s){f.then(a,s)},function(f){s(a,f)},function(f){G(a,f)})}catch(u){G(u)}finally{w.PSD=t}}function G(a,f){var s=w.PSD;w.PSD=a._PSD;a._state=!1;a._value=f;M.call(a);if(!a._catched)try{if(a.onuncatched)a.onuncatched(a._value);w.on.error.fire(a._value)}catch(t){}w.PSD=s;return a._catched}function M(){for(var a=0,f=this._deferreds.length;a<f;a++)E(this,this._deferreds[a]);this._deferreds=[]}function N(a,f,s,t){this.onFulfilled="function"===typeof a?a:null;
this.onRejected="function"===typeof f?f:null;this.resolve=s;this.reject=t}function P(a,f,s,t){var v=!1;try{f(function(a){v||(v=!0,s(a))},function(f){if(v)return a._catched;v=!0;return t(f)})}catch(w){if(!v)return t(w)}}var Q=[].slice,Z="undefined"===typeof setImmediate?function(a,f,s,t){var v=arguments;setTimeout(function(){a.apply(fa,Q.call(v,1))},0)}:setImmediate,ca=Z,ma=!0,wa=[],xa=[];w.on=Wc(null,"error");w.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&Array.isArray(arguments[0])?
arguments[0]:arguments);return new w(function(f,s){function t(w,E){try{if(E&&("object"===typeof E||"function"===typeof E)){var G=E.then;if("function"===typeof G){G.call(E,function(a){t(w,a)},s);return}}a[w]=E;0===--v&&f(a)}catch(L){s(L)}}if(0===a.length)return f([]);for(var v=a.length,w=0;w<a.length;w++)t(w,a[w])})};w.prototype.then=function(a,f){var s=this,t=new w(function(t,u){null===s._state?E(s,new N(a,f,t,u)):ca(E,s,new N(a,f,t,u))});t._PSD=this._PSD;t.onuncatched=this.onuncatched;t._parent=
this;return t};w.prototype._then=function(a,f){E(this,new N(a,f,v,v))};w.prototype["catch"]=function(a){if(1===arguments.length)return this.then(null,a);var f=arguments[0],s=arguments[1];return"function"===typeof f?this.then(null,function(a){return a instanceof f?s(a):w.reject(a)}):this.then(null,function(a){return a&&a.name===f?s(a):w.reject(a)})};w.prototype["finally"]=function(a){return this.then(function(f){a();return f},function(f){a();return w.reject(f)})};w.prototype.onuncatched=null;w.resolve=
function(a){var f=new w(function(){});f._state=!0;f._value=a;return f};w.reject=function(a){var f=new w(function(){});f._state=!1;f._value=a;return f};w.race=function(a){return new w(function(f,s){a.map(function(a){a.then(f,s)})})};w.PSD=null;w.newPSD=function(a){var f=w.PSD;w.PSD=f?Object.create(f):{};try{return a()}finally{w.PSD=f}};w._rootExec=function(a){var s=ma;ma=!1;ca=f;try{a()}finally{if(s){do{for(;0<wa.length;)t();if(a=xa.pop())try{a()}catch(v){}}while(0<xa.length||0<wa.length);ca=Z;ma=
!0}}};w._tickFinalize=function(a){if(ma)throw Error("Not in a virtual tick");xa.push(a)};return w}(),ma=function(){};P(id).from(Error);G.delete=function(f){var t=new G(f);f=t.delete();f.onblocked=function(f){t.on("blocked",f);return this};return f};G.getDatabaseNames=function(t){return(new M(function(t,v){var E=f();E?(E=E(),E.onsuccess=function(a){t([].slice.call(a.target.result,0))},E.onerror=xa(v)):sd(function(a){t(a);return!1})})).then(t)};G.defineClass=function(f){function t(f){f&&N(this,f)}bc(t.prototype,
f);return t};G.ignoreTransaction=function(f){return M.newPSD(function(){M.PSD.trans=null;return f()})};G.spawn=function(){fa.console&&console.warn("Dexie.spawn() is deprecated. Use Dexie.ignoreTransaction() instead.");return G.ignoreTransaction.apply(this,arguments)};G.vip=function(f){return M.newPSD(function(){M.PSD.letThrough=!0;return f()})};Object.defineProperty(G,"currentTransaction",{get:function(){return M.PSD&&M.PSD.trans||null}});G.Promise=M;G.derive=P;G.extend=N;G.override=Q;G.events=Wc;
G.getByKeyPath=ca;G.setByKeyPath=qb;G.delByKeyPath=Vd;G.shallowClone=Cd;G.deepClone=Dc;G.addons=[];G.fakeAutoComplete=ma;G.asap=gd;G.ModifyError=id;G.MultiModifyError=id;G.IndexSpec=Ec;G.TableSchema=Fc;var rb=fa.idbModules&&fa.idbModules.shimIndexedDB?fa.idbModules:{};G.dependencies={indexedDB:rb.shimIndexedDB||fa.indexedDB||fa.mozIndexedDB||fa.webkitIndexedDB||fa.msIndexedDB,IDBKeyRange:rb.IDBKeyRange||fa.IDBKeyRange||fa.webkitIDBKeyRange,IDBTransaction:rb.IDBTransaction||fa.IDBTransaction||fa.webkitIDBTransaction,
Error:fa.Error||String,SyntaxError:fa.SyntaxError||String,TypeError:fa.TypeError||String,DOMError:fa.DOMError||String,localStorage:null!=("undefined"!==typeof chrome&&null!==chrome?chrome.storage:void 0)?null:fa.localStorage};G.version=1.1;t("Dexie",G);Bd(function(){ma=Bd})}).apply(null,"function"===typeof define&&define.amd?[self||window,function(fa,t){define(fa,function(){return t})}]:"undefined"!==typeof global&&"undefined"!==typeof module&&module.exports?[global,function(fa,t){module.exports=
t}]:[self||window,function(fa,t){(self||window)[fa]=t}]);
